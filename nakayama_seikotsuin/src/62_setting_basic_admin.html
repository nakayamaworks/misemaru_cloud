<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>ğŸ“ äºˆç´„è¨­å®š</title>
</head>
<body class="loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­...</p>
  </div>
  <div id="app" style="display:none;">

  <div class="container py-3">
    <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('40_setting_main_admin')">â† æˆ»ã‚‹</button>
    <h4 class="text-center mb-0">ğŸ“ åº—èˆ—æƒ…å ±ãƒ»äºˆç´„è¨­å®š</h4>

    <div id="feedback-message" class="alert text-center d-none" role="alert"></div>

    <!-- å…¨ä½“è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="main-content">
      
      <form id="setting-form" class="form-wrapper">
        <div class="mb-3">
          <label class="form-label">åº—èˆ—å</label>
          <input type="text" id="setting-store-name" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">åº—èˆ—é›»è©±ç•ªå·</label>
          <input type="tel" id="setting-store-phone" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">åº—èˆ—ä½æ‰€</label>
          <input type="tel" id="setting-store-address" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">ä»£è¡¨è€…åï¼ˆäºˆç´„ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºç”¨ï¼ä»»æ„ï¼‰</label>
          <input type="text" id="setting-representative-name" class="form-control" placeholder="ä¾‹ï¼šã¿ã›ã¾ã‚‹ å¤ªéƒ" />
          <div class="form-text">ãƒ¡ãƒ¼ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼ã«ã€Œä»£è¡¨ï¼šâ—¯â—¯ã€ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ï¼ˆç©ºæ¬„ãªã‚‰éè¡¨ç¤ºï¼‰ã€‚</div>
        </div>

        <!-- ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹1 -->
        <div class="mb-3">
          <label class="form-label">ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹1</label>
          <input type="email" id="setting-admin-email1" class="form-control" required />
        </div>

        <!-- ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹2 (ä»»æ„) -->
        <div class="mb-3">
          <label class="form-label">ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹2</label>
          <input type="email" id="setting-admin-email2" class="form-control" />
        </div>

        <!-- ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹3 (ä»»æ„) -->
        <div class="mb-3">
          <label class="form-label">ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹3</label>
          <input type="email" id="setting-admin-email3" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">äºˆç´„ã®æœ€å°å˜ä½ (åˆ†)</label>
          <select id="setting-min-unit" class="form-select">
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="45">45</option>
            <option value="60">60</option>
            <option value="90">90</option>
            <option value="120">120</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">äºˆç´„å—ä»˜ã®ç· åˆ‡</label>
          <div class="input-group">
            <input type="number" id="setting-deadline-value" class="form-control" placeholder="ä¾‹: 1" />
            <select id="setting-deadline-unit" class="form-select" style="max-width: 120px;">
              <option value="minutes">åˆ†å‰</option>
              <option value="hours">æ™‚é–“å‰</option>
              <option value="days">æ—¥å‰</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">äºˆç´„å¯èƒ½æœŸé–“ã®ä¸Šé™ï¼ˆæ—¥æ•°ï¼‰</label>
          <input type="number" id="setting-max-advance-days" class="form-control" min="0" placeholder="ä¾‹: 90ï¼ˆç©ºæ¬„=ç„¡åˆ¶é™ï¼‰" />
          <div class="form-text" id="max-advance-preview">ç©ºæ¬„ã®å ´åˆã¯ä¸Šé™ãªã—</div>
        </div>

        <!--
        <div class="mb-3">
          <label class="form-label">åŒæ™‚äºˆç´„å¯èƒ½æ•° (äºº)</label>
          <input type="number" id="setting-max-parallel" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">ç¨ç‡ (ï¼…)</label>
          <input type="number" id="setting-tax-rate" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</label>
          <select id="setting-theme" class="form-select">
            <option value="light">light</option>
            <option value="dark">dark</option>
            <option value="custom">custom</option>
          </select>
        </div>
        -->

        <div class="mb-3">
          <label class="form-label">äºˆç´„å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
          <input type="text" id="setting-complete-msg" class="form-control" />
        </div>

        <button type="submit" class="btn btn-primary w-100" disabled>ä¿å­˜</button>
      </form>
    </div>

    <!-- âœ… ä¿å­˜ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmModalLabel">ä¿å­˜ã®ç¢ºèª</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
          </div>
          <div class="modal-body" id="confirm-modal-body">
            <!-- ã“ã“ã«å…¥åŠ›å†…å®¹ã‚’å‹•çš„ã«å‡ºã™ -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" class="btn btn-primary" id="confirmSaveBtn">ä¿å­˜ã™ã‚‹</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ”„ åˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ -->
    <div id="loading-init" class="text-center my-5" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3">è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</p>
    </div>

    <!-- ğŸ”„ ä¿å­˜ä¸­ -->
    <div id="saving-spinner" class="text-center my-3" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2" id="saving-spinner-text">å‡¦ç†ä¸­...</p>  <!-- â† ã“ã“ã ã‘å‹•çš„ã«å¤‰æ›´ -->
    </div>
  </div>  

  <script>
    const FIELD_IDS = {
      "åº—èˆ—å": "setting-store-name",
      "åº—èˆ—é›»è©±ç•ªå·": "setting-store-phone",
      "åº—èˆ—ä½æ‰€": "setting-store-address",
      "ä»£è¡¨è€…å": "setting-representative-name", 
      "ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹1": "setting-admin-email1",
      "ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹2": "setting-admin-email2",
      "ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹3": "setting-admin-email3",
      "äºˆç´„ã®æœ€å°å˜ä½ï¼ˆåˆ†ï¼‰": "setting-min-unit",
      "äºˆç´„å¯èƒ½æœŸé–“ã®ä¸Šé™ï¼ˆæ—¥æ•°ï¼‰": "setting-max-advance-days",
      //"åŒæ™‚äºˆç´„å¯èƒ½æ•°ï¼ˆäººï¼‰": "setting-max-parallel",
      //"ç¨ç‡ï¼ˆï¼…ï¼‰": "setting-tax-rate",
      //"è¡¨ç¤ºãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼": "setting-theme",
      "äºˆç´„å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸": "setting-complete-msg"
    };

    window.addEventListener("DOMContentLoaded", () => {
      console.log("[CHILD] DOMContentLoaded â†’ child-ready ã‚’è¦ªã¸é€ä¿¡");
      try {
        window.top.postMessage(
          { type: "misemaru:child-ready", origin: location.origin },
          "*" // è¦ªå´ã§å¿…ãš event.origin ã‚’æ¤œè¨¼ã™ã‚‹ã®ã§å®‰å…¨
        );
      } catch (err) {
        console.error("[CHILD] child-ready é€ä¿¡å¤±æ•—:", err);
      }

      startInitialLoad();
      google.script.run.withSuccessHandler(data => {
        displaySettings(data);
        endInitialLoad();
        setupBasicSettingFormDetection();
        checkBasicSettingFormDiff();
      }).getBasicSettingList();
    });


    let originalSettings = {};

    function displaySettings(settings) {
      console.log("[displaySettings] settings:", JSON.stringify(settings));

      originalSettings = {};  // åˆæœŸåŒ–

      if (!Array.isArray(settings) || settings.length === 0) {
        console.log("[displaySettings] åˆå›ç™»éŒ²ï¼šå–å¾—ãƒ‡ãƒ¼ã‚¿ãªã—");
        return;
      }

      settings.forEach(setting => {
        console.log("[displaySettings] èª­ã¿è¾¼ã¿é …ç›®ï¼š", setting["é …ç›®å"], "å€¤ï¼š", setting["å€¤"]);

        const fieldId = FIELD_IDS[setting["é …ç›®å"]];
        if (fieldId && document.getElementById(fieldId)) {
          document.getElementById(fieldId).value = setting["å€¤"] || "";
          originalSettings[fieldId] = setting["å€¤"] || "";
        }

        if (setting["é …ç›®å"] === "äºˆç´„å—ä»˜ã®ç· åˆ‡ï¼ˆå€¤ï¼‰") {
          document.getElementById("setting-deadline-value").value = setting["å€¤"] || "";
          originalSettings["setting-deadline-value"] = setting["å€¤"] || "";
        }
        if (setting["é …ç›®å"] === "äºˆç´„å—ä»˜ã®ç· åˆ‡ï¼ˆå˜ä½ï¼‰") {
          document.getElementById("setting-deadline-unit").value = setting["å€¤"] || "minutes";
          originalSettings["setting-deadline-unit"] = setting["å€¤"] || "";
        }
      });

      console.log("[displaySettings] originalSettings å®Œæˆå½¢ï¼š", JSON.stringify(originalSettings));
    }



    document.getElementById("setting-form").addEventListener("submit", e => {
      e.preventDefault();
      openConfirmModal();
    });

    function previewMaxAdvance() {
      const v = document.getElementById("setting-max-advance-days").value.trim();
      const el = document.getElementById("max-advance-preview");
      if (!v) { el.textContent = "ç©ºæ¬„ã®å ´åˆã¯ä¸Šé™ãªã—"; return; }
      const days = Math.max(0, Number(v));
      const d = new Date(); // ä»Šæ—¥
      d.setDate(d.getDate() + days);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      el.textContent = `ä»Šæ—¥ã‹ã‚‰ ${days}æ—¥å…ˆï¼ˆ${y}-${m}-${dd}ï¼‰ã¾ã§äºˆç´„å¯`;
    }

    document.getElementById("setting-max-advance-days")
      ?.addEventListener("input", previewMaxAdvance);
    window.addEventListener("DOMContentLoaded", previewMaxAdvance);



    function openConfirmModal() {
      console.log("[openConfirmModal] originalSettings:", JSON.stringify(originalSettings));

      const isNew = originalSettings._isFirstTime || Object.values(originalSettings).every(val => !val);

      console.log("[openConfirmModal] isNew =", isNew);

      const modalTitle = isNew ? "ã“ã®å†…å®¹ã§ç™»éŒ²ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ" : "ã“ã®å†…å®¹ã§æ›´æ–°ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
      const confirmBtnText = isNew ? "ç™»éŒ²" : "æ›´æ–°";

      document.querySelector("#confirmModal .modal-title").textContent = modalTitle;
      document.getElementById("confirmSaveBtn").textContent = confirmBtnText;

      const isFirstLoad = Object.keys(originalSettings).length === 0;

      // âœ… é †ç•ªã‚’ãƒ•ã‚©ãƒ¼ãƒ ã¨å®Œå…¨ä¸€è‡´ã•ã›ã‚‹
      const fields = [
        { label: "åº—èˆ—å", id: "setting-store-name" },
        { label: "åº—èˆ—é›»è©±ç•ªå·", id: "setting-store-phone" },
        { label: "åº—èˆ—ä½æ‰€", id: "setting-store-address" },
        { label: "ä»£è¡¨è€…å", id: "setting-representative-name" }, 
        { label: "ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹1", id: "setting-admin-email1" },
        { label: "ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹2", id: "setting-admin-email2" },
        { label: "ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹3", id: "setting-admin-email3" },
        { label: "äºˆç´„ã®æœ€å°å˜ä½", id: "setting-min-unit", suffix: "åˆ†" },
        { label: "äºˆç´„å¯èƒ½æœŸé–“ã®ä¸Šé™ï¼ˆæ—¥æ•°ï¼‰", id: "setting-max-advance-days", suffix: "æ—¥" },
      ];

      const rows = fields.map(({ label, id, suffix = "" }) => {
        const current = document.getElementById(id)?.value ?? "";
        const original = originalSettings[id] ?? "";
        const changed = String(current) !== String(original);

        const displayCurrent = current ? `${current}${suffix}` : "-";
        const displayOriginal = original ? `${original}${suffix}` : "-";

        const klass = (!isFirstLoad && changed) ? "text-danger fw-bold" : "";
        const arrowPart = (!isFirstLoad && changed) ? ` â†’ ${displayCurrent}` : "";

        return `<li class="list-group-item ${klass}">
          ${label}ï¼š${displayOriginal}${arrowPart}
        </li>`;
      });

      // ğŸ”½ äºˆç´„å—ä»˜ã®ç· åˆ‡ï¼ˆã“ã®ä½ç½®ï¼ï¼‰
      const deadlineValue = document.getElementById("setting-deadline-value").value ?? "";
      const deadlineUnit = document.getElementById("setting-deadline-unit").value ?? "";
      const currentDeadline = deadlineValue && deadlineUnit ? `${deadlineValue} ${convertDeadlineUnit(deadlineUnit)}å‰` : "-";

      const origDeadlineValue = originalSettings["setting-deadline-value"] ?? "";
      const origDeadlineUnit = originalSettings["setting-deadline-unit"] ?? "";
      const origDeadline = origDeadlineValue && origDeadlineUnit ? `${origDeadlineValue} ${convertDeadlineUnit(origDeadlineUnit)}å‰` : "-";

      const deadlineChanged = String(deadlineValue) !== String(origDeadlineValue) || String(deadlineUnit) !== String(origDeadlineUnit);
      const deadlineClass = (!isFirstLoad && deadlineChanged) ? "text-danger fw-bold" : "";
      const deadlineArrowPart = (!isFirstLoad && deadlineChanged) ? ` â†’ ${currentDeadline}` : "";

      rows.push(`<li class="list-group-item ${deadlineClass}">
        äºˆç´„å—ä»˜ã®ç· åˆ‡ï¼š${origDeadline}${deadlineArrowPart}
      </li>`);

      // ğŸ”½ æ®‹ã‚Šã®é …ç›®
      const moreFields = [
        //{ label: "åŒæ™‚äºˆç´„å¯èƒ½æ•°", id: "setting-max-parallel", suffix: "äºº" },
        //{ label: "ç¨ç‡", id: "setting-tax-rate", suffix: "%" },
        //{ label: "è¡¨ç¤ºãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼", id: "setting-theme" },
        { label: "äºˆç´„å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", id: "setting-complete-msg" },
      ];

      rows.push(...moreFields.map(({ label, id, suffix = "" }) => {
        const current = document.getElementById(id)?.value ?? "";
        const original = originalSettings[id] ?? "";
        const changed = String(current) !== String(original);

        const displayCurrent = current ? `${current}${suffix}` : "-";
        const displayOriginal = original ? `${original}${suffix}` : "-";

        const klass = (!isFirstLoad && changed) ? "text-danger fw-bold" : "";
        const arrowPart = (!isFirstLoad && changed) ? ` â†’ ${displayCurrent}` : "";

        return `<li class="list-group-item ${klass}">
          ${label}ï¼š${displayOriginal}${arrowPart}
        </li>`;
      }));

      // ğŸ”½ å…¨ä½“åæ˜ 
      document.getElementById("confirm-modal-body").innerHTML = `<ul class="list-group list-group-flush">${rows.join("")}</ul>`;

      // ğŸ”½ ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
      const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
      modal.show();

      // ğŸ”½ ä¿å­˜ãƒœã‚¿ãƒ³å†ç™»éŒ²ï¼ˆå¤šé‡ç™»éŒ²é˜²æ­¢ï¼‰
      const saveBtn = document.getElementById("confirmSaveBtn");
      saveBtn.replaceWith(saveBtn.cloneNode(true));
      document.getElementById("confirmSaveBtn").addEventListener("click", () => {
        modal.hide();
        startSaving();
        performSave();
      });
    }

    // å˜ä½ã®æ—¥æœ¬èªè¡¨è¨˜
    function convertDeadlineUnit(unit) {
      switch (unit) {
        case "minutes": return "åˆ†";
        case "hours": return "æ™‚é–“";
        case "days": return "æ—¥";
        default: return unit;
      }
    }

    function performSave() {
      const name = document.getElementById("setting-store-name").value.trim();
      const phone = document.getElementById("setting-store-phone").value.trim();
      const address = document.getElementById("setting-store-address").value.trim();
      const representativeName = document.getElementById("setting-representative-name").value.trim();
      const adminEmail1 = document.getElementById("setting-admin-email1").value.trim();
      const adminEmail2 = document.getElementById("setting-admin-email2").value.trim();
      const adminEmail3 = document.getElementById("setting-admin-email3").value.trim();
      const minUnit = document.getElementById("setting-min-unit").value;
      const deadlineValue = document.getElementById("setting-deadline-value").value.trim();
      const deadlineUnit = document.getElementById("setting-deadline-unit").value;
      const maxAdvanceDays = document.getElementById("setting-max-advance-days").value.trim();
      //const maxParallel = document.getElementById("setting-max-parallel").value.trim();
      //const taxRate = document.getElementById("setting-tax-rate").value.trim();
      const completeMsg = document.getElementById("setting-complete-msg").value.trim();

      const settingData = {
        name, phone, adminEmail1, adminEmail2, adminEmail3,
        minUnit, deadlineValue, deadlineUnit, completeMsg, maxAdvanceDays, representativeName //maxParallel, //taxRate, 
      };

      // âœ… ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
      if (!validateSafeInputs(settingData)) {
        alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
        return;
      }

      // åº—èˆ—åãƒã‚§ãƒƒã‚¯
      if (!name) {
        alert("åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        endSaving();
        return;
      }

      // é›»è©±ç•ªå·ãƒã‚§ãƒƒã‚¯ï¼ˆ0ã‹ã‚‰å§‹ã¾ã‚‹10ã€œ11æ¡ï¼‰
      if (!/^[0-9]{10,11}$/.test(phone)) {
        alert("é›»è©±ç•ªå·ã¯10ã€œ11æ¡ã®æ•°å­—ï¼ˆãƒã‚¤ãƒ•ãƒ³ãªã—ï¼‰ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
        endSaving();
        return;
      }

      if (adminEmail1 && !validateEmail(adminEmail1)) {
        alert("ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹1ãŒç„¡åŠ¹ã§ã™");
        endSaving();
        return;
      }
      if (adminEmail2 && !validateEmail(adminEmail2)) {
        alert("ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹2ãŒç„¡åŠ¹ã§ã™");
        endSaving();
        return;
      }
      if (adminEmail3 && !validateEmail(adminEmail3)) {
        alert("ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹3ãŒç„¡åŠ¹ã§ã™");
        endSaving();
        return;
      }

      const emails = [adminEmail1, adminEmail2, adminEmail3].filter(email => email);

      const savePromises = [
      // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ1ã€œ3ï¼‰
      ...emails.map((email, index) =>
        new Promise(resolve => {
          google.script.run.withSuccessHandler(resolve)
            .saveBasicSetting({ "é …ç›®å": `ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹${index + 1}`, "å€¤": email });
        })
      ),

      // ãã®ä»–ã®åŸºæœ¬è¨­å®šï¼ˆç· åˆ‡ä»¥å¤–ï¼‰
      ...Object.entries(FIELD_IDS)
        .filter(([label]) => !["äºˆç´„å—ä»˜ã®ç· åˆ‡ï¼ˆåˆ†å‰ï¼‰"].includes(label)) // â† å¤ã„ç· åˆ‡é …ç›®ã‚’é™¤å¤–
        .map(([label, id]) =>
          new Promise(resolve => {
            const value = document.getElementById(id).value;
            google.script.run.withSuccessHandler(resolve)
              .saveBasicSetting({ "é …ç›®å": label, "å€¤": value });
          })
        ),

      // âœ… æ–°ãŸã«ç· åˆ‡ã®å€¤ã¨å˜ä½ã‚’ä¿å­˜
      new Promise(resolve => {
        google.script.run.withSuccessHandler(resolve)
          .saveBasicSetting({ "é …ç›®å": "äºˆç´„å—ä»˜ã®ç· åˆ‡ï¼ˆå€¤ï¼‰", "å€¤": deadlineValue });
      }),
      new Promise(resolve => {
        google.script.run.withSuccessHandler(resolve)
          .saveBasicSetting({ "é …ç›®å": "äºˆç´„å—ä»˜ã®ç· åˆ‡ï¼ˆå˜ä½ï¼‰", "å€¤": deadlineUnit });
      })
    ];


      Promise.all(savePromises).then(() => {
        endSaving();

        const isNew = Object.keys(originalSettings).length === 0 ||
        Object.entries(originalSettings).every(([key, val]) => {
          // ç· åˆ‡ã®å˜ä½ã ã‘ã¯ã€Œminutesã€ã‚‚åˆæœŸå€¤æ‰±ã„
          if (key === "setting-deadline-unit") return val === "" || val === "minutes";
          return val === "";
        });

        showFeedbackMessage(isNew ? "ç™»éŒ²ã—ã¾ã—ãŸï¼" : "æ›´æ–°ã—ã¾ã—ãŸï¼", "success");

        updateOriginalSettings();
        checkBasicSettingFormDiff();
        updateSubmitButtonLabel();

        google.script.run.withSuccessHandler(displaySettings).getBasicSettingList();
      });
    }

    function startInitialLoad() {
      document.getElementById("main-content").style.display = "none";
      document.getElementById("loading-init").style.display = "block";
    }

    function endInitialLoad() {
      document.getElementById("loading-init").style.display = "none";
      document.getElementById("main-content").style.display = "block";

      updateSubmitButtonLabel();
    }

    function updateSubmitButtonLabel() {
      const isNew = Object.values(originalSettings).every(val => !val);
      const submitBtn = document.querySelector("#setting-form button[type='submit']");
      submitBtn.textContent = isNew ? "ç™»éŒ²" : "æ›´æ–°";
    }

    function startSaving() {
      document.getElementById("main-content").style.display = "none";
      document.getElementById("saving-spinner").style.display = "block";

      // âœ… ç™»éŒ² or æ›´æ–° ã®åˆ‡ã‚Šæ›¿ãˆ
      const isNew = Object.values(originalSettings).every(val => !val);
      document.getElementById("saving-spinner-text").textContent = isNew
        ? "è¨­å®šã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™â€¦"
        : "è¨­å®šã‚’æ›´æ–°ã—ã¦ã„ã¾ã™â€¦";
    }


    function endSaving() {
      document.getElementById("saving-spinner").style.display = "none";
      document.getElementById("main-content").style.display = "block";
    }

    function validateEmail(email) {
      const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      return regex.test(email);
    }

    function showFeedbackMessage(message = "ä¿å­˜ã—ã¾ã—ãŸï¼", type = "success", duration = 3000) {
      const el = document.getElementById("feedback-message");
      el.textContent = message;
      el.className = `alert alert-${type} text-center`;
      el.classList.remove("d-none");

      // âœ… 3ç§’å¾Œã«éè¡¨ç¤º
      setTimeout(() => {
        el.classList.add("d-none");
      }, duration);
    }

    function updateOriginalSettings() {
      const fields = [
        "setting-store-name",
        "setting-store-phone",
        "setting-store-address",
        "setting-representative-name",
        "setting-admin-email1",
        "setting-admin-email2",
        "setting-admin-email3",
        "setting-min-unit",
        "setting-max-advance-days", 
        "setting-deadline-value",
        "setting-deadline-unit",
        //"setting-max-parallel",
        //"setting-tax-rate",
        //"setting-theme",
        "setting-complete-msg"
      ];

      originalSettings = {};
      fields.forEach(id => {
        originalSettings[id] = document.getElementById(id)?.value || "";
      });
    }

    function checkBasicSettingFormDiff() {
      const fields = [
        "setting-store-name",
        "setting-store-phone",
        "setting-store-address",
        "setting-representative-name",
        "setting-admin-email1",
        "setting-admin-email2",
        "setting-admin-email3",
        "setting-min-unit",
        "setting-max-advance-days",
        "setting-deadline-value",
        "setting-deadline-unit",
        //"setting-max-parallel",
        //"setting-tax-rate",
        //"setting-theme",
        "setting-complete-msg"
      ];

      const hasChanged = fields.some(id => {
        const currentValue = document.getElementById(id)?.value ?? "";
        return String(currentValue) !== String(originalSettings[id] ?? "");
      });

      // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’åˆ¶å¾¡
      document.querySelector("#setting-form button[type='submit']").disabled = !hasChanged;
    }

    function setupBasicSettingFormDetection() {
      const formElements = document.querySelectorAll("#setting-form input, #setting-form select");
      formElements.forEach(el => {
        el.addEventListener("input", checkBasicSettingFormDiff);
        el.addEventListener("change", checkBasicSettingFormDiff);
      });
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
