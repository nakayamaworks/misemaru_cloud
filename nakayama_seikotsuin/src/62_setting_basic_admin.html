<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>📝 予約設定</title>
</head>
<body class="loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>認証チェック中...</p>
  </div>
  <div id="app" style="display:none;">

  <div class="container py-3">
    <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('40_setting_main_admin')">← 戻る</button>
    <h4 class="text-center mb-0">📝 店舗情報・予約設定</h4>

    <div id="feedback-message" class="alert text-center d-none" role="alert"></div>

    <!-- 全体設定フォーム -->
    <div id="main-content">
      
      <form id="setting-form" class="form-wrapper">
        <div class="mb-3">
          <label class="form-label">店舗名</label>
          <input type="text" id="setting-store-name" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">店舗電話番号</label>
          <input type="tel" id="setting-store-phone" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">店舗住所</label>
          <input type="tel" id="setting-store-address" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">代表者名（予約メール表示用／任意）</label>
          <input type="text" id="setting-representative-name" class="form-control" placeholder="例：みせまる 太郎" />
          <div class="form-text">メールフッターに「代表：◯◯」として表示します（空欄なら非表示）。</div>
        </div>

        <!-- 管理者メールアドレス1 -->
        <div class="mb-3">
          <label class="form-label">管理者メールアドレス1</label>
          <input type="email" id="setting-admin-email1" class="form-control" required />
        </div>

        <!-- 管理者メールアドレス2 (任意) -->
        <div class="mb-3">
          <label class="form-label">管理者メールアドレス2</label>
          <input type="email" id="setting-admin-email2" class="form-control" />
        </div>

        <!-- 管理者メールアドレス3 (任意) -->
        <div class="mb-3">
          <label class="form-label">管理者メールアドレス3</label>
          <input type="email" id="setting-admin-email3" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">予約の最小単位 (分)</label>
          <select id="setting-min-unit" class="form-select">
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="45">45</option>
            <option value="60">60</option>
            <option value="90">90</option>
            <option value="120">120</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">予約受付の締切</label>
          <div class="input-group">
            <input type="number" id="setting-deadline-value" class="form-control" placeholder="例: 1" />
            <select id="setting-deadline-unit" class="form-select" style="max-width: 120px;">
              <option value="minutes">分前</option>
              <option value="hours">時間前</option>
              <option value="days">日前</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">予約可能期間の上限（日数）</label>
          <input type="number" id="setting-max-advance-days" class="form-control" min="0" placeholder="例: 90（空欄=無制限）" />
          <div class="form-text" id="max-advance-preview">空欄の場合は上限なし</div>
        </div>

        <!--
        <div class="mb-3">
          <label class="form-label">同時予約可能数 (人)</label>
          <input type="number" id="setting-max-parallel" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">税率 (％)</label>
          <input type="number" id="setting-tax-rate" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">テーマカラー</label>
          <select id="setting-theme" class="form-select">
            <option value="light">light</option>
            <option value="dark">dark</option>
            <option value="custom">custom</option>
          </select>
        </div>
        -->

        <div class="mb-3">
          <label class="form-label">予約完了メッセージ</label>
          <input type="text" id="setting-complete-msg" class="form-control" />
        </div>

        <button type="submit" class="btn btn-primary w-100" disabled>保存</button>
      </form>
    </div>

    <!-- ✅ 保存確認モーダル -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmModalLabel">保存の確認</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
          </div>
          <div class="modal-body" id="confirm-modal-body">
            <!-- ここに入力内容を動的に出す -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            <button type="button" class="btn btn-primary" id="confirmSaveBtn">保存する</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 🔄 初期ロード中 -->
    <div id="loading-init" class="text-center my-5" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3">設定を読み込み中です…</p>
    </div>

    <!-- 🔄 保存中 -->
    <div id="saving-spinner" class="text-center my-3" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2" id="saving-spinner-text">処理中...</p>  <!-- ← ここだけ動的に変更 -->
    </div>
  </div>  

  <script>
    const FIELD_IDS = {
      "店舗名": "setting-store-name",
      "店舗電話番号": "setting-store-phone",
      "店舗住所": "setting-store-address",
      "代表者名": "setting-representative-name", 
      "管理者メールアドレス1": "setting-admin-email1",
      "管理者メールアドレス2": "setting-admin-email2",
      "管理者メールアドレス3": "setting-admin-email3",
      "予約の最小単位（分）": "setting-min-unit",
      "予約可能期間の上限（日数）": "setting-max-advance-days",
      //"同時予約可能数（人）": "setting-max-parallel",
      //"税率（％）": "setting-tax-rate",
      //"表示テーマカラー": "setting-theme",
      "予約完了メッセージ": "setting-complete-msg"
    };

    window.addEventListener("DOMContentLoaded", () => {
      console.log("[CHILD] DOMContentLoaded → child-ready を親へ送信");
      try {
        window.top.postMessage(
          { type: "misemaru:child-ready", origin: location.origin },
          "*" // 親側で必ず event.origin を検証するので安全
        );
      } catch (err) {
        console.error("[CHILD] child-ready 送信失敗:", err);
      }

      startInitialLoad();
      google.script.run.withSuccessHandler(data => {
        displaySettings(data);
        endInitialLoad();
        setupBasicSettingFormDetection();
        checkBasicSettingFormDiff();
      }).getBasicSettingList();
    });


    let originalSettings = {};

    function displaySettings(settings) {
      console.log("[displaySettings] settings:", JSON.stringify(settings));

      originalSettings = {};  // 初期化

      if (!Array.isArray(settings) || settings.length === 0) {
        console.log("[displaySettings] 初回登録：取得データなし");
        return;
      }

      settings.forEach(setting => {
        console.log("[displaySettings] 読み込み項目：", setting["項目名"], "値：", setting["値"]);

        const fieldId = FIELD_IDS[setting["項目名"]];
        if (fieldId && document.getElementById(fieldId)) {
          document.getElementById(fieldId).value = setting["値"] || "";
          originalSettings[fieldId] = setting["値"] || "";
        }

        if (setting["項目名"] === "予約受付の締切（値）") {
          document.getElementById("setting-deadline-value").value = setting["値"] || "";
          originalSettings["setting-deadline-value"] = setting["値"] || "";
        }
        if (setting["項目名"] === "予約受付の締切（単位）") {
          document.getElementById("setting-deadline-unit").value = setting["値"] || "minutes";
          originalSettings["setting-deadline-unit"] = setting["値"] || "";
        }
      });

      console.log("[displaySettings] originalSettings 完成形：", JSON.stringify(originalSettings));
    }



    document.getElementById("setting-form").addEventListener("submit", e => {
      e.preventDefault();
      openConfirmModal();
    });

    function previewMaxAdvance() {
      const v = document.getElementById("setting-max-advance-days").value.trim();
      const el = document.getElementById("max-advance-preview");
      if (!v) { el.textContent = "空欄の場合は上限なし"; return; }
      const days = Math.max(0, Number(v));
      const d = new Date(); // 今日
      d.setDate(d.getDate() + days);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      el.textContent = `今日から ${days}日先（${y}-${m}-${dd}）まで予約可`;
    }

    document.getElementById("setting-max-advance-days")
      ?.addEventListener("input", previewMaxAdvance);
    window.addEventListener("DOMContentLoaded", previewMaxAdvance);



    function openConfirmModal() {
      console.log("[openConfirmModal] originalSettings:", JSON.stringify(originalSettings));

      const isNew = originalSettings._isFirstTime || Object.values(originalSettings).every(val => !val);

      console.log("[openConfirmModal] isNew =", isNew);

      const modalTitle = isNew ? "この内容で登録してよろしいですか？" : "この内容で更新してよろしいですか？";
      const confirmBtnText = isNew ? "登録" : "更新";

      document.querySelector("#confirmModal .modal-title").textContent = modalTitle;
      document.getElementById("confirmSaveBtn").textContent = confirmBtnText;

      const isFirstLoad = Object.keys(originalSettings).length === 0;

      // ✅ 順番をフォームと完全一致させる
      const fields = [
        { label: "店舗名", id: "setting-store-name" },
        { label: "店舗電話番号", id: "setting-store-phone" },
        { label: "店舗住所", id: "setting-store-address" },
        { label: "代表者名", id: "setting-representative-name" }, 
        { label: "管理者メールアドレス1", id: "setting-admin-email1" },
        { label: "管理者メールアドレス2", id: "setting-admin-email2" },
        { label: "管理者メールアドレス3", id: "setting-admin-email3" },
        { label: "予約の最小単位", id: "setting-min-unit", suffix: "分" },
        { label: "予約可能期間の上限（日数）", id: "setting-max-advance-days", suffix: "日" },
      ];

      const rows = fields.map(({ label, id, suffix = "" }) => {
        const current = document.getElementById(id)?.value ?? "";
        const original = originalSettings[id] ?? "";
        const changed = String(current) !== String(original);

        const displayCurrent = current ? `${current}${suffix}` : "-";
        const displayOriginal = original ? `${original}${suffix}` : "-";

        const klass = (!isFirstLoad && changed) ? "text-danger fw-bold" : "";
        const arrowPart = (!isFirstLoad && changed) ? ` → ${displayCurrent}` : "";

        return `<li class="list-group-item ${klass}">
          ${label}：${displayOriginal}${arrowPart}
        </li>`;
      });

      // 🔽 予約受付の締切（この位置！）
      const deadlineValue = document.getElementById("setting-deadline-value").value ?? "";
      const deadlineUnit = document.getElementById("setting-deadline-unit").value ?? "";
      const currentDeadline = deadlineValue && deadlineUnit ? `${deadlineValue} ${convertDeadlineUnit(deadlineUnit)}前` : "-";

      const origDeadlineValue = originalSettings["setting-deadline-value"] ?? "";
      const origDeadlineUnit = originalSettings["setting-deadline-unit"] ?? "";
      const origDeadline = origDeadlineValue && origDeadlineUnit ? `${origDeadlineValue} ${convertDeadlineUnit(origDeadlineUnit)}前` : "-";

      const deadlineChanged = String(deadlineValue) !== String(origDeadlineValue) || String(deadlineUnit) !== String(origDeadlineUnit);
      const deadlineClass = (!isFirstLoad && deadlineChanged) ? "text-danger fw-bold" : "";
      const deadlineArrowPart = (!isFirstLoad && deadlineChanged) ? ` → ${currentDeadline}` : "";

      rows.push(`<li class="list-group-item ${deadlineClass}">
        予約受付の締切：${origDeadline}${deadlineArrowPart}
      </li>`);

      // 🔽 残りの項目
      const moreFields = [
        //{ label: "同時予約可能数", id: "setting-max-parallel", suffix: "人" },
        //{ label: "税率", id: "setting-tax-rate", suffix: "%" },
        //{ label: "表示テーマカラー", id: "setting-theme" },
        { label: "予約完了メッセージ", id: "setting-complete-msg" },
      ];

      rows.push(...moreFields.map(({ label, id, suffix = "" }) => {
        const current = document.getElementById(id)?.value ?? "";
        const original = originalSettings[id] ?? "";
        const changed = String(current) !== String(original);

        const displayCurrent = current ? `${current}${suffix}` : "-";
        const displayOriginal = original ? `${original}${suffix}` : "-";

        const klass = (!isFirstLoad && changed) ? "text-danger fw-bold" : "";
        const arrowPart = (!isFirstLoad && changed) ? ` → ${displayCurrent}` : "";

        return `<li class="list-group-item ${klass}">
          ${label}：${displayOriginal}${arrowPart}
        </li>`;
      }));

      // 🔽 全体反映
      document.getElementById("confirm-modal-body").innerHTML = `<ul class="list-group list-group-flush">${rows.join("")}</ul>`;

      // 🔽 モーダル開く
      const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
      modal.show();

      // 🔽 保存ボタン再登録（多重登録防止）
      const saveBtn = document.getElementById("confirmSaveBtn");
      saveBtn.replaceWith(saveBtn.cloneNode(true));
      document.getElementById("confirmSaveBtn").addEventListener("click", () => {
        modal.hide();
        startSaving();
        performSave();
      });
    }

    // 単位の日本語表記
    function convertDeadlineUnit(unit) {
      switch (unit) {
        case "minutes": return "分";
        case "hours": return "時間";
        case "days": return "日";
        default: return unit;
      }
    }

    function performSave() {
      const name = document.getElementById("setting-store-name").value.trim();
      const phone = document.getElementById("setting-store-phone").value.trim();
      const address = document.getElementById("setting-store-address").value.trim();
      const representativeName = document.getElementById("setting-representative-name").value.trim();
      const adminEmail1 = document.getElementById("setting-admin-email1").value.trim();
      const adminEmail2 = document.getElementById("setting-admin-email2").value.trim();
      const adminEmail3 = document.getElementById("setting-admin-email3").value.trim();
      const minUnit = document.getElementById("setting-min-unit").value;
      const deadlineValue = document.getElementById("setting-deadline-value").value.trim();
      const deadlineUnit = document.getElementById("setting-deadline-unit").value;
      const maxAdvanceDays = document.getElementById("setting-max-advance-days").value.trim();
      //const maxParallel = document.getElementById("setting-max-parallel").value.trim();
      //const taxRate = document.getElementById("setting-tax-rate").value.trim();
      const completeMsg = document.getElementById("setting-complete-msg").value.trim();

      const settingData = {
        name, phone, adminEmail1, adminEmail2, adminEmail3,
        minUnit, deadlineValue, deadlineUnit, completeMsg, maxAdvanceDays, representativeName //maxParallel, //taxRate, 
      };

      // ✅ サニタイズチェック
      if (!validateSafeInputs(settingData)) {
        alert("❌ 入力内容に不正なタグが含まれています。");
        return;
      }

      // 店舗名チェック
      if (!name) {
        alert("店舗名を入力してください");
        endSaving();
        return;
      }

      // 電話番号チェック（0から始まる10〜11桁）
      if (!/^[0-9]{10,11}$/.test(phone)) {
        alert("電話番号は10〜11桁の数字（ハイフンなし）で入力してください");
        endSaving();
        return;
      }

      if (adminEmail1 && !validateEmail(adminEmail1)) {
        alert("管理者メールアドレス1が無効です");
        endSaving();
        return;
      }
      if (adminEmail2 && !validateEmail(adminEmail2)) {
        alert("管理者メールアドレス2が無効です");
        endSaving();
        return;
      }
      if (adminEmail3 && !validateEmail(adminEmail3)) {
        alert("管理者メールアドレス3が無効です");
        endSaving();
        return;
      }

      const emails = [adminEmail1, adminEmail2, adminEmail3].filter(email => email);

      const savePromises = [
      // 管理者メールアドレス（1〜3）
      ...emails.map((email, index) =>
        new Promise(resolve => {
          google.script.run.withSuccessHandler(resolve)
            .saveBasicSetting({ "項目名": `管理者メールアドレス${index + 1}`, "値": email });
        })
      ),

      // その他の基本設定（締切以外）
      ...Object.entries(FIELD_IDS)
        .filter(([label]) => !["予約受付の締切（分前）"].includes(label)) // ← 古い締切項目を除外
        .map(([label, id]) =>
          new Promise(resolve => {
            const value = document.getElementById(id).value;
            google.script.run.withSuccessHandler(resolve)
              .saveBasicSetting({ "項目名": label, "値": value });
          })
        ),

      // ✅ 新たに締切の値と単位を保存
      new Promise(resolve => {
        google.script.run.withSuccessHandler(resolve)
          .saveBasicSetting({ "項目名": "予約受付の締切（値）", "値": deadlineValue });
      }),
      new Promise(resolve => {
        google.script.run.withSuccessHandler(resolve)
          .saveBasicSetting({ "項目名": "予約受付の締切（単位）", "値": deadlineUnit });
      })
    ];


      Promise.all(savePromises).then(() => {
        endSaving();

        const isNew = Object.keys(originalSettings).length === 0 ||
        Object.entries(originalSettings).every(([key, val]) => {
          // 締切の単位だけは「minutes」も初期値扱い
          if (key === "setting-deadline-unit") return val === "" || val === "minutes";
          return val === "";
        });

        showFeedbackMessage(isNew ? "登録しました！" : "更新しました！", "success");

        updateOriginalSettings();
        checkBasicSettingFormDiff();
        updateSubmitButtonLabel();

        google.script.run.withSuccessHandler(displaySettings).getBasicSettingList();
      });
    }

    function startInitialLoad() {
      document.getElementById("main-content").style.display = "none";
      document.getElementById("loading-init").style.display = "block";
    }

    function endInitialLoad() {
      document.getElementById("loading-init").style.display = "none";
      document.getElementById("main-content").style.display = "block";

      updateSubmitButtonLabel();
    }

    function updateSubmitButtonLabel() {
      const isNew = Object.values(originalSettings).every(val => !val);
      const submitBtn = document.querySelector("#setting-form button[type='submit']");
      submitBtn.textContent = isNew ? "登録" : "更新";
    }

    function startSaving() {
      document.getElementById("main-content").style.display = "none";
      document.getElementById("saving-spinner").style.display = "block";

      // ✅ 登録 or 更新 の切り替え
      const isNew = Object.values(originalSettings).every(val => !val);
      document.getElementById("saving-spinner-text").textContent = isNew
        ? "設定を登録しています…"
        : "設定を更新しています…";
    }


    function endSaving() {
      document.getElementById("saving-spinner").style.display = "none";
      document.getElementById("main-content").style.display = "block";
    }

    function validateEmail(email) {
      const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      return regex.test(email);
    }

    function showFeedbackMessage(message = "保存しました！", type = "success", duration = 3000) {
      const el = document.getElementById("feedback-message");
      el.textContent = message;
      el.className = `alert alert-${type} text-center`;
      el.classList.remove("d-none");

      // ✅ 3秒後に非表示
      setTimeout(() => {
        el.classList.add("d-none");
      }, duration);
    }

    function updateOriginalSettings() {
      const fields = [
        "setting-store-name",
        "setting-store-phone",
        "setting-store-address",
        "setting-representative-name",
        "setting-admin-email1",
        "setting-admin-email2",
        "setting-admin-email3",
        "setting-min-unit",
        "setting-max-advance-days", 
        "setting-deadline-value",
        "setting-deadline-unit",
        //"setting-max-parallel",
        //"setting-tax-rate",
        //"setting-theme",
        "setting-complete-msg"
      ];

      originalSettings = {};
      fields.forEach(id => {
        originalSettings[id] = document.getElementById(id)?.value || "";
      });
    }

    function checkBasicSettingFormDiff() {
      const fields = [
        "setting-store-name",
        "setting-store-phone",
        "setting-store-address",
        "setting-representative-name",
        "setting-admin-email1",
        "setting-admin-email2",
        "setting-admin-email3",
        "setting-min-unit",
        "setting-max-advance-days",
        "setting-deadline-value",
        "setting-deadline-unit",
        //"setting-max-parallel",
        //"setting-tax-rate",
        //"setting-theme",
        "setting-complete-msg"
      ];

      const hasChanged = fields.some(id => {
        const currentValue = document.getElementById(id)?.value ?? "";
        return String(currentValue) !== String(originalSettings[id] ?? "");
      });

      // 保存ボタンを制御
      document.querySelector("#setting-form button[type='submit']").disabled = !hasChanged;
    }

    function setupBasicSettingFormDetection() {
      const formElements = document.querySelectorAll("#setting-form input, #setting-form select");
      formElements.forEach(el => {
        el.addEventListener("input", checkBasicSettingFormDiff);
        el.addEventListener("change", checkBasicSettingFormDiff);
      });
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
