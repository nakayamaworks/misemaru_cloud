<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>ğŸ“‡ é¡§å®¢ç®¡ç†</title>
  <style>
  @media (max-width: 576px) {
    th, td {
      font-size: 0.9rem;
      min-width: 80px;
      max-width: 80px;
      padding: 0.1rem;
    }
  }
  </style>
</head>
<body class="loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­...</p>
  </div>
  <div id="app" style="display:none;">

  <div class="container pt-2 py-3">

    <!-- âœ… ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
      <div class="container-fluid px-0">
        <a class="navbar-brand" onclick="closeToAdmin()">
          <img src="https://raw.githubusercontent.com/WataruNakayama1203/misemaru-cloud-assets/main/misemaru_text_only.png" alt="ã¿ã›ã¾ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ­ã‚´" class="top-logo" />
        </a>
        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-lg-end" id="navbarNav">
          <div class="d-flex flex-column flex-lg-row align-items-center gap-2 mt-2 mt-lg-0">
            <button type="button" class="btn btn-red fw-bold px-3" onclick="goTo('10_availability_staff')">ğŸ“… äºˆç´„ç®¡ç†</button>
            <button type="button" class="btn btn-green fw-bold px-3" onclick="goTo('20_staff_main_staff')">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</button>
            <!--<button type="button" class="btn btn-blue fw-bold px-3" onclick="goTo('30_register_staff')">ğŸ“‡ é¡§å®¢ç®¡ç†</button>-->
            <button type="button" class="btn btn-gray fw-bold px-3" onclick="goTo('40_setting_main_admin')">ğŸª åº—èˆ—è¨­å®š</button>
          </div>
        </div>
      </div>
    </nav>


    <h4 class="mb-1 text-center">ğŸ“‡ é¡§å®¢ç®¡ç†</h4>
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>

    <form id="customer-form" class="form-wrapper">
    <div class="mb-3">
      <label for="customer-select" class="form-label">ç™»éŒ²æ¸ˆã¿é¡§å®¢ï¼ˆé¸æŠå¼ï¼‰</label>
      <select id="customer-select" class="form-select">
        <option value="">æ–°è¦ç™»éŒ²</option>
      </select>
    </div>

      <input type="hidden" id="customer-id" />
      <div class="row mb-3">
        <div class="col">
          <label for="lastName" class="form-label">å§“ <span class="text-danger">*</span></label>
          <input type="text" id="lastName" class="form-control" required />
        </div>
        <div class="col">
          <label for="firstName" class="form-label">å <span class="text-danger">*</span></label>
          <input type="text" id="firstName" class="form-control" required />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col">
          <label for="lastKana" class="form-label">ã‚»ã‚¤ï¼ˆå§“ã‚«ãƒŠï¼‰ <span class="text-danger">*</span></label>
          <input type="text" id="lastKana" class="form-control" required pattern="^[ã‚¡-ãƒ¶ãƒ¼ã€€]+$" title="å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„" />
        </div>
        <div class="col">
          <label for="firstKana" class="form-label">ãƒ¡ã‚¤ï¼ˆåã‚«ãƒŠï¼‰ <span class="text-danger">*</span></label>
          <input type="text" id="firstKana" class="form-control" required pattern="^[ã‚¡-ãƒ¶ãƒ¼ã€€]+$" title="å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„" />
        </div>
      </div>

    <div class="mb-3">
      <label for="phone" class="form-label">é›»è©±ç•ªå· <span class="text-danger">*</span></label>
      <input type="tel" id="phone" class="form-control" required pattern="^[0-9\-]+$" title="é›»è©±ç•ªå·ã¯åŠè§’æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ã§ã™" />
    </div>

    <div class="mb-3">
      <label for="email" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
      <input type="email" id="email" class="form-control"  pattern="^[^@\s]+@[^@\s]+\.[^@\s]+$" title="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“" />
    </div>

    <div class="mb-3">
      <label for="cutStyle" class="form-label">ã‚«ãƒƒãƒˆã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä»»æ„ï¼‰</label>
      <textarea id="cutStyle" class="form-control" rows="2"></textarea>
    </div>

    <div class="mb-3">
      <label for="note" class="form-label">å‚™è€ƒæ¬„ï¼ˆä»»æ„ï¼‰</label>
      <textarea id="note" class="form-control" rows="2"></textarea>
    </div>

      <div class="form-check mb-3">
        <input type="hidden" id="regularFlag" value="true" />
      </div>

      <button type="submit" class="btn btn-success w-100" id="submit-btn" disabled>ç™»éŒ²ã™ã‚‹</button>
      <button type="button" class="btn btn-danger w-100 mt-2" id="delete-btn" disabled>å‰Šé™¤ã™ã‚‹</button>
    </form>


    <div id="loading" class="text-center my-3" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
      </div>
      <p class="mt-3" id="loading-message">å‡¦ç†ä¸­ã§ã™â€¦</p>
    </div>
  </div>

  <!-- æ–°è¦ç™»éŒ²ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="confirmNewModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">æ–°è¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h5></div>
      <div class="modal-body">ã“ã®å†…å®¹ã§æ–°ã—ãé¡§å®¢ã‚’ç™»éŒ²ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="confirm-new-save-btn">ç™»éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- ä¸Šæ›¸ãç™»éŒ²ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="confirmUpdateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">ä¸Šæ›¸ãç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h5></div>
      <div class="modal-body">ã“ã®å†…å®¹ã§ä¸Šæ›¸ãç™»éŒ²ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="confirm-update-btn">ä¸Šæ›¸ãã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h5></div>
      <div class="modal-body">é¸æŠä¸­ã®é¡§å®¢æƒ…å ±ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-danger" id="confirm-delete-btn">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>


 <script>
let customerCache = [];
let originalValues = {};

window.addEventListener("DOMContentLoaded", () => {
  console.log("[CHILD] DOMContentLoaded â†’ child-ready ã‚’è¦ªã¸é€ä¿¡");
  try {
    window.top.postMessage(
      { type: "misemaru:child-ready", origin: location.origin },
      "*" // è¦ªå´ã§å¿…ãš event.origin ã‚’æ¤œè¨¼ã™ã‚‹ã®ã§å®‰å…¨
    );
  } catch (err) {
    console.error("[CHILD] child-ready é€ä¿¡å¤±æ•—:", err);
  }
});

google.script.run.withSuccessHandler(populateCustomerSelect).getCustomerList();

function populateCustomerSelect(customers) {
  customerCache = customers;
    
  const select = document.getElementById("customer-select");
  select.innerHTML = '<option value="">æ–°è¦ç™»éŒ²</option>';

  const gojuonMap = {
    ã‚¢: "ã‚¢è¡Œ", ã‚¤: "ã‚¢è¡Œ", ã‚¦: "ã‚¢è¡Œ", ã‚¨: "ã‚¢è¡Œ", ã‚ª: "ã‚¢è¡Œ",
    ã‚«: "ã‚«è¡Œ", ã‚­: "ã‚«è¡Œ", ã‚¯: "ã‚«è¡Œ", ã‚±: "ã‚«è¡Œ", ã‚³: "ã‚«è¡Œ",
    ã‚µ: "ã‚µè¡Œ", ã‚·: "ã‚µè¡Œ", ã‚¹: "ã‚µè¡Œ", ã‚»: "ã‚µè¡Œ", ã‚½: "ã‚µè¡Œ",
    ã‚¿: "ã‚¿è¡Œ", ãƒ: "ã‚¿è¡Œ", ãƒ„: "ã‚¿è¡Œ", ãƒ†: "ã‚¿è¡Œ", ãƒˆ: "ã‚¿è¡Œ",
    ãƒŠ: "ãƒŠè¡Œ", ãƒ‹: "ãƒŠè¡Œ", ãƒŒ: "ãƒŠè¡Œ", ãƒ: "ãƒŠè¡Œ", ãƒ: "ãƒŠè¡Œ",
    ãƒ: "ãƒè¡Œ", ãƒ’: "ãƒè¡Œ", ãƒ•: "ãƒè¡Œ", ãƒ˜: "ãƒè¡Œ", ãƒ›: "ãƒè¡Œ",
    ãƒ: "ãƒè¡Œ", ãƒŸ: "ãƒè¡Œ", ãƒ : "ãƒè¡Œ", ãƒ¡: "ãƒè¡Œ", ãƒ¢: "ãƒè¡Œ",
    ãƒ¤: "ãƒ¤è¡Œ", ãƒ¦: "ãƒ¤è¡Œ", ãƒ¨: "ãƒ¤è¡Œ",
    ãƒ©: "ãƒ©è¡Œ", ãƒª: "ãƒ©è¡Œ", ãƒ«: "ãƒ©è¡Œ", ãƒ¬: "ãƒ©è¡Œ", ãƒ­: "ãƒ©è¡Œ",
    ãƒ¯: "ãƒ¯è¡Œ", ãƒ²: "ãƒ¯è¡Œ", ãƒ³: "ãƒ¯è¡Œ"
  };

  const toKatakana = str =>
    str.replace(/[\u3041-\u3096]/g, ch =>
      String.fromCharCode(ch.charCodeAt(0) + 0x60)
    );

  const grouped = {};
  customers.forEach(c => {
    const kana = toKatakana(c.lastKana || "").charAt(0);
    const group = gojuonMap[kana] || "ãã®ä»–";
    if (!grouped[group]) grouped[group] = [];
    grouped[group].push(c);
  });

  const gojuonOrder = [
    "ã‚¢è¡Œ", "ã‚«è¡Œ", "ã‚µè¡Œ", "ã‚¿è¡Œ", "ãƒŠè¡Œ",
    "ãƒè¡Œ", "ãƒè¡Œ", "ãƒ¤è¡Œ", "ãƒ©è¡Œ", "ãƒ¯è¡Œ", "ãã®ä»–"
  ];

  gojuonOrder.forEach(group => {
    if (!grouped[group]) return;
    const optGroup = document.createElement("optgroup");
    optGroup.label = group;

    grouped[group].forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = `${c.lastName} ${c.firstName}`;
      optGroup.appendChild(opt);
    });

    select.appendChild(optGroup);
  });

  // ã‚¤ãƒ™ãƒ³ãƒˆå†ç™»éŒ²ï¼ˆåŒã˜ã¾ã¾ã§OKï¼‰
  select.addEventListener("change", function () {
    const selected = customerCache.find(c => String(c.id) === this.value);
    const submitBtn = document.getElementById("submit-btn");

    if (!selected) {
      clearForm();
    } else {
      document.getElementById("customer-id").value = selected.id;
      document.getElementById("lastName").value = selected.lastName;
      document.getElementById("firstName").value = selected.firstName;
      document.getElementById("lastKana").value = selected.lastKana;
      document.getElementById("firstKana").value = selected.firstKana;
      document.getElementById("phone").value = selected.phone;
      document.getElementById("email").value = selected.email;
      document.getElementById("cutStyle").value = selected.cutStyle || "";
      document.getElementById("note").value = selected.note || "";
      document.getElementById("regularFlag").checked = selected.regularFlag === true;

      originalValues = { ...selected };
      submitBtn.textContent = "ä¸Šæ›¸ãç™»éŒ²";
    }

    updateSubmitButtonState();
    updateDeleteButtonState();
  });
}


document.getElementById("customer-form").addEventListener("submit", function (e) {
  e.preventDefault();

  const id = document.getElementById("customer-id").value.trim();
  const modalId = id ? "confirmUpdateModal" : "confirmNewModal";
  const modal = new bootstrap.Modal(document.getElementById(modalId));
  modal.show();
});

document.getElementById("confirm-new-save-btn").addEventListener("click", () => {
  const modal = bootstrap.Modal.getInstance(document.getElementById("confirmNewModal"));
  modal.hide();
  doSaveCustomer(); // ç™»éŒ²å‡¦ç†å®Ÿè¡Œ
});

document.getElementById("confirm-update-btn").addEventListener("click", () => {
  const modal = bootstrap.Modal.getInstance(document.getElementById("confirmUpdateModal"));
  modal.hide();
  doSaveCustomer(); // ç™»éŒ²å‡¦ç†å®Ÿè¡Œ
});


document.getElementById("delete-btn").addEventListener("click", function () {
  const id = document.getElementById("customer-id").value.trim();
  if (!id) return showError("å‰Šé™¤ã™ã‚‹é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

  const modal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
  modal.show();
});

document.getElementById("confirm-delete-btn").addEventListener("click", function () {
  const id = document.getElementById("customer-id").value.trim();
  if (!id) return showError("å‰Šé™¤å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  const modal = bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal"));
  modal.hide();

  clearMessage();
  document.getElementById("customer-form").style.display = "none";
  document.getElementById("loading").style.display = "block";
  document.getElementById("loading-message").textContent = "é¡§å®¢æƒ…å ±ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™â€¦";

  google.script.run
    .withSuccessHandler((msg) => {
      document.getElementById("loading").style.display = "none";
      showSuccess(msg);
      clearForm();
      document.getElementById("customer-form").style.display = "block";
      google.script.run.withSuccessHandler(populateCustomerSelect).getCustomerList();
    })
    .withFailureHandler((err) => {
      document.getElementById("loading").style.display = "none";
      showError("å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼š" + err.message);
      document.getElementById("customer-form").style.display = "block";
    })
    .deleteCustomer(id);
});


function clearForm() {
  document.getElementById("customer-form").reset();
  document.getElementById("customer-id").value = "";
  document.getElementById("regularFlag").checked = false;
  originalValues = {};
  updateSubmitButtonState();
  updateDeleteButtonState();
  document.getElementById("submit-btn").textContent = "æ–°è¦ç™»éŒ²";
}

function doSaveCustomer() {
  const data = {
    id: document.getElementById("customer-id").value.trim(),
    lastName: document.getElementById("lastName").value.trim(),
    firstName: document.getElementById("firstName").value.trim(),
    lastKana: document.getElementById("lastKana").value.trim(),
    firstKana: document.getElementById("firstKana").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    email: document.getElementById("email").value.trim(),
    cutStyle: document.getElementById("cutStyle").value.trim(),
    note: document.getElementById("note").value.trim(),
    regularFlag: true
  };

  // âœ… ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
  if (!validateSafeInputs(data)) {
    alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
    return;
  }

  clearMessage();

  // ğŸŒ€ ã“ã“ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«ã—ã¦ã€ãã‚‹ãã‚‹è¡¨ç¤º
  document.getElementById("customer-form").style.display = "none";
  const loading = document.getElementById("loading");
  loading.style.display = "block";
  document.getElementById("loading-message").textContent = "é¡§å®¢æƒ…å ±ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™â€¦";

  google.script.run
    .withSuccessHandler((msg) => {
      loading.style.display = "none";
      showSuccess(msg || "ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
      clearForm();
      document.getElementById("customer-form").style.display = "block";
      google.script.run.withSuccessHandler(populateCustomerSelect).getCustomerList();
    })
    .withFailureHandler((err) => {
      loading.style.display = "none";
      showError("ã‚¨ãƒ©ãƒ¼ï¼š" + err.message);
      document.getElementById("customer-form").style.display = "block";
    })
    .saveCustomer(data);
}



// âœ… å…¥åŠ›æ¬„ã™ã¹ã¦ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆinput + changeï¼‰ã‚’ã¤ã‘ã‚‹
const triggerFields = ["lastName", "firstName", "lastKana", "firstKana", "phone", "email", "cutStyle", "note", "regularFlag"];
triggerFields.forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener("input", updateSubmitButtonState);
    el.addEventListener("change", updateSubmitButtonState);
  }
});



function updateDeleteButtonState() {
  const hasId = document.getElementById("customer-id").value.trim() !== "";
  document.getElementById("delete-btn").disabled = !hasId;
}

function showError(msg) {
  const el = document.getElementById("error-message");
  el.textContent = msg;
  el.className = "alert alert-danger";
  el.style.display = "block";

  // âœ… ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚3ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤ºï¼ˆä»»æ„ï¼‰
  setTimeout(() => {
    el.style.display = "none";
  }, 3000);
}


function showSuccess(msg) {
  const el = document.getElementById("error-message");
  el.textContent = msg;
  el.className = "alert alert-success";
  el.style.display = "block";

  // âœ… 3ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
  setTimeout(() => {
    el.style.display = "none";
  }, 3000);
}

function clearMessage() {
  const el = document.getElementById("error-message");
  el.style.display = "none";
  el.textContent = "";
  el.className = "alert";
}

function updateSubmitButtonState() {
  const current = {
    lastName: document.getElementById("lastName").value.trim(),
    firstName: document.getElementById("firstName").value.trim(),
    lastKana: document.getElementById("lastKana").value.trim(),
    firstKana: document.getElementById("firstKana").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    email: document.getElementById("email").value.trim(),
    cutStyle: document.getElementById("cutStyle").value.trim(),
    note: document.getElementById("note").value.trim(),
    regularFlag: document.getElementById("regularFlag").checked
  };

  const isChanged = Object.keys(current).some(
    key => current[key] !== (originalValues[key] ?? "")
  );

  const hasRequiredFields =
    current.lastName &&
    current.firstName &&
    current.lastKana &&
    current.firstKana &&
    current.phone;

  document.getElementById("submit-btn").disabled = !hasRequiredFields || !isChanged;
}

</script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
