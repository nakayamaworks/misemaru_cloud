<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼</title>
  <style>
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-responsive table {
      table-layout: auto !important;
      min-width: 700px; /* â† ç‹¬è‡ªå¹… */
    }

    .table-responsive th,
    .table-responsive td {
      white-space: nowrap !important; /* ä¸Šæ›¸ã */
    }

    td.note-cell,
    td.name-cell {
      white-space: pre-wrap !important;
      word-break: break-word;
      max-width: 160px;
    }

    .btn-register-wrapper {
      max-width: 440px;
      margin-left: auto;
      margin-right: auto;
      width: 100%;
    }
  </style>
</head>
<body class="container-fluid py-3 loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­...</p>
  </div>
  <div id="app" style="display:none;">

  <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('40_setting_main_admin')">â† æˆ»ã‚‹</button>
  <h4 class="text-center mb-4">ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼è¨­å®š</h4>

  <!-- ğŸ”„ åˆæœŸèª­ã¿è¾¼ã¿ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="loading-spinner" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <p class="mt-3">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</p>
  </div>

  <div id="form-container">
    <!-- âœ… ä¸€è¦§è¡¨ç¤º -->
    <div id="policy-list-area" class="mb-1">
      <div id="save-message" class="alert alert-success text-center" style="display: none;">ç™»éŒ²ã—ã¾ã—ãŸï¼</div>
      <div id="delete-message" class="alert alert-danger text-center" style="display: none;">å‰Šé™¤ã—ã¾ã—ãŸï¼</div>
      <h5>ç™»éŒ²æ¸ˆã¿ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼</h5>
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-fixed">
          <thead>
            <tr>
              <th>ãƒãƒªã‚·ãƒ¼å</th>
              <th>é©ç”¨æ—¥ï¼ˆæ—¥å‰ï¼‰</th>
              <th>æ–™ç‡ï¼ˆ%ï¼‰</th>
              <th>å‚™è€ƒ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="policyTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- âœ… ï¼‹æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ -->
    <div class="form-wrapper d-grid">
      <button id="toggleFormBtn" class="btn btn-primary w-100 mb-2" ...>ï¼‹ æ–°è¦ä½œæˆ</button>
    </div>

      <!-- âœ… ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="form-wrapper collapse" id="policyForm">
        <h5 class="mb-2 mt-0">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ç™»éŒ²</h5>

        <!-- âœ… ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="error-message" class="alert alert-danger" style="display: none;"></div>

        <input type="hidden" id="policyId">

        <div class="mb-3">
          <label class="form-label">ãƒãƒªã‚·ãƒ¼å</label>
          <input type="text" class="form-control" id="policyName">
        </div>

        <div class="mb-3">
          <label class="form-label">é©ç”¨æ—¥ï¼ˆäºˆç´„æ—¥ã‹ã‚‰ã€‡æ—¥å‰ï¼‰</label>
          <input type="number" class="form-control" id="applyDay">
        </div>

        <div class="mb-3">
          <label class="form-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ï¼ˆ%ï¼‰</label>
          <input type="number" class="form-control" id="feePercent">
        </div>

        <div class="mb-3">
          <label class="form-label">å‚™è€ƒ</label>
          <input type="text" class="form-control" id="note">
        </div>

        <div class="d-grid">
          <button class="btn btn-primary" id="submitBtn" onclick="openConfirmModal()">ç™»éŒ²</button>
        </div>
      </div>


    </div>
  </div>

  <!-- ğŸ”„ ä¿å­˜ä¸­ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="saving-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ç™»éŒ²ä¸­...</span>
    </div>
    <p class="mt-2">ç™»éŒ²ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  <!-- ğŸ”„ å‰Šé™¤ä¸­ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="deleting-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-danger" role="status">
      <span class="visually-hidden">å‰Šé™¤ä¸­...</span>
    </div>
    <p class="mt-2">å‰Šé™¤ã—ã¦ã„ã¾ã™â€¦</p>
  </div>


  <!-- âœ… ç™»éŒ²ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ã“ã®å†…å®¹ã§ç™»éŒ²ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modal-body-text">
          å†…å®¹ã‚’ç¢ºèªã—ã€ã€Œç™»éŒ²ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-primary" id="confirm-register-btn">ç™»éŒ²</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ã“ã®ãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="delete-modal-body">ä¸€åº¦å‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn">å‰Šé™¤ã™ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

<script>
  let policyData = [];
  let collapseInstance;
  let isFormOpened = false;
  let deleteTargetIndex = null;
  let originalPolicyData = {};
  let isEditMode = false;

  window.addEventListener("DOMContentLoaded", () => {
    console.log("[CHILD] DOMContentLoaded â†’ child-ready ã‚’è¦ªã¸é€ä¿¡");
    try {
      window.top.postMessage(
        { type: "misemaru:child-ready", origin: location.origin },
        "*" // è¦ªå´ã§å¿…ãš event.origin ã‚’æ¤œè¨¼ã™ã‚‹ã®ã§å®‰å…¨
      );
    } catch (err) {
      console.error("[CHILD] child-ready é€ä¿¡å¤±æ•—:", err);
    }

    const formEl = document.getElementById("policyForm");
    const btnEl = document.getElementById("toggleFormBtn");
    const submitBtn = document.getElementById("submitBtn");
    collapseInstance = new bootstrap.Collapse(formEl, { toggle: false });

    // âœ… collapse é–‹ã„ãŸã¨ã â†’ æ–°è¦ã‹ã©ã†ã‹ã§å‡¦ç†åˆ†å²
    formEl.addEventListener("show.bs.collapse", () => {
      btnEl.textContent = "âˆ’ é–‰ã˜ã‚‹";
      isFormOpened = true;

      // ã€Œæ–°è¦ä½œæˆãƒœã‚¿ãƒ³ã€ã‹ã‚‰é–‹ã„ãŸæ™‚ã ã‘ãƒªã‚»ãƒƒãƒˆ
      if (!isEditMode) {
        resetForm();
      }

      setTimeout(scrollToForm, 200);
    });

    formEl.addEventListener("hide.bs.collapse", () => {
      btnEl.textContent = "ï¼‹ æ–°è¦ä½œæˆ";
      resetForm();  // é–‰ã˜ãŸã‚‰å¸¸ã«æ–°è¦çŠ¶æ…‹ã«æˆ»ã™
      isEditMode = false;
      isFormOpened = false;
    });

    btnEl.addEventListener("click", () => {
      isEditMode = false; // â† ã“ã“é‡è¦ï¼æ–°è¦ãƒœã‚¿ãƒ³ã‹ã‚‰é–‹ãã¨ãã ã‘ false
      const collapse = bootstrap.Collapse.getInstance(formEl) || new bootstrap.Collapse(formEl, { toggle: false });
      if (formEl.classList.contains("show")) {
        collapse.hide();
      } else {
        collapse.show();
      }
    });

    ["policyName", "applyDay", "feePercent", "note"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("input", checkFormDiff);
      el.addEventListener("change", checkFormDiff);
    });

    submitBtn.disabled = true;
  });

  function initApp(email, role) {
    // èªè¨¼ã‚¹ãƒ”ãƒŠãƒ¼ã‚’æ¶ˆã™ï¼ˆå…±é€šå‡¦ç†ã§ã‚‚æ¶ˆã—ã¦ã‚‹ã‘ã©å®‰å…¨ã®ãŸã‚å†åº¦ï¼‰
    const loadingEl = document.getElementById("loading");
    if (loadingEl) loadingEl.style.display = "none";

    // ã‚¢ãƒ—ãƒªã®æ ã ã‘è¡¨ç¤ºï¼ˆä¸­èº«ã¯ã¾ã ï¼‰
    const appEl = document.getElementById("app");
    if (appEl) appEl.style.display = "block";

    // ---- ã“ã“ã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼å›ºæœ‰ã®å‡¦ç† ----
    document.getElementById("policy-list-area").style.display = "none";
    document.getElementById("toggleFormBtn").closest(".d-grid").style.display = "none";
    document.getElementById("form-container").style.display = "none";

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ç”¨ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤º
    document.getElementById("loading-spinner").style.display = "block";

    google.script.run.withSuccessHandler(data => {
      // ãƒ‡ãƒ¼ã‚¿å–ã‚ŒãŸã‚‰ã‚¹ãƒ”ãƒŠãƒ¼ã‚’æ¶ˆã—ã¦UIè¡¨ç¤º
      document.getElementById("loading-spinner").style.display = "none";
      document.getElementById("policy-list-area").style.display = "block";
      document.getElementById("toggleFormBtn").closest(".d-grid").style.display = "block";
      document.getElementById("form-container").style.display = "block";

      renderPolicyList(data);
    }).getCancelPolicyList();
  }

  function renderPolicyList(data) {
    policyData = data;
    const tbody = document.getElementById("policyTableBody");
    tbody.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }

    data.forEach((item, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="name-cell">${item.name}</td>
        <td>${item.applyDay}</td>
        <td>${item.fee}</td>
        <td class="note-cell">${item.note || "-"}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editPolicy(${i})">ç·¨é›†</button>
          <button class="btn btn-sm btn-danger" onclick="openDeleteModal(${i})">å‰Šé™¤</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openConfirmModal() {
    const errorMessage = validateForm();
    const errorEl = document.getElementById("error-message");

    if (errorMessage) {
      errorEl.textContent = errorMessage;
      errorEl.style.display = "block";
      return;
    }

    errorEl.style.display = "none";

    const data = getFormData();

    // âœ… ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    if (!validateSafeInputs(data)) {
      alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
      return;
    }

    const isUpdate = !!data.id;

    const modalTitle = isUpdate
      ? "ã“ã®å†…å®¹ã§æ›´æ–°ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
      : "ã“ã®å†…å®¹ã§ç™»éŒ²ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
    const confirmBtnText = isUpdate ? "æ›´æ–°" : "ç™»éŒ²";

    document.querySelector("#confirmModal .modal-title").textContent = modalTitle;
    document.getElementById("confirm-register-btn").textContent = confirmBtnText;

    let msg = "";

    if (isUpdate) {
      // âœ… æ›´æ–°æ™‚ â†’ å·®åˆ†å¼·èª¿
      const fields = [
        { label: "ãƒãƒªã‚·ãƒ¼å", key: "name" },
        { label: "é©ç”¨æ—¥", key: "applyDay", suffix: "æ—¥å‰" },
        { label: "æ–™ç‡", key: "fee", suffix: "%" },
        { label: "å‚™è€ƒ", key: "note" },
      ];

      msg += `<ul class="list-group list-group-flush">`;
      fields.forEach(({ label, key, suffix = "" }) => {
        const before = originalPolicyData[key] || "-";
        const after = data[key] || "-";

        const changed = String(before) !== String(after);
        const rowClass = changed ? "text-danger fw-bold" : "";
        const arrow = changed ? ` â†’ ${after}${suffix}` : "";

        msg += `<li class="list-group-item ${rowClass}">
          ${label}ï¼š${before}${suffix}${arrow}
        </li>`;
      });
      msg += `</ul>`;
    } else {
      // âœ… æ–°è¦æ™‚ â†’ ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤º
      msg = `
        <ul class="list-group list-group-flush">
          <li class="list-group-item">ãƒãƒªã‚·ãƒ¼åï¼š${data.name}</li>
          <li class="list-group-item">é©ç”¨æ—¥ï¼š${data.applyDay}æ—¥å‰</li>
          <li class="list-group-item">æ–™ç‡ï¼š${data.fee}%</li>
          <li class="list-group-item">å‚™è€ƒï¼š${data.note || "-"}</li>
        </ul>
      `;
    }

    document.getElementById("modal-body-text").innerHTML = msg;
    new bootstrap.Modal(document.getElementById("confirmModal")).show();
  }




  document.getElementById("confirm-register-btn").addEventListener("click", () => {
    const modal = bootstrap.Modal.getInstance(document.getElementById("confirmModal"));
    modal.hide();
    savePolicy();
  });

  function savePolicy() {
    const payload = getFormData();

    // âœ… ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    if (!validateSafeInputs(payload)) {
      alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
      return;
    }

    document.getElementById("saving-spinner").style.display = "block";
    document.getElementById("policy-list-area").style.display = "none";
    document.getElementById("toggleFormBtn").style.display = "none";
    document.getElementById("form-container").style.display = "none";

    google.script.run.withSuccessHandler(() => {
      google.script.run.withSuccessHandler(data => {
        renderPolicyList(data);
        document.getElementById("saving-spinner").style.display = "none";
        document.getElementById("policy-list-area").style.display = "block";
        document.getElementById("toggleFormBtn").style.display = "block";
        document.getElementById("form-container").style.display = "block";
        document.getElementById("save-message").style.display = "block";
        setTimeout(() => document.getElementById("save-message").style.display = "none", 3000);
        originalPolicyData = {};  // åˆæœŸåŒ–
        collapseInstance.hide();
      }).getCancelPolicyList();
    }).saveCancelPolicy(payload);
  }

  function getFormData() {
    return {
      id: document.getElementById("policyId").value || "",
      name: document.getElementById("policyName").value,
      applyDay: document.getElementById("applyDay").value,
      fee: document.getElementById("feePercent").value,
      note: document.getElementById("note").value
    };
  }

  function resetForm() {
    document.getElementById("policyId").value = "";
    document.getElementById("policyName").value = "";
    document.getElementById("applyDay").value = "";
    document.getElementById("feePercent").value = "";
    document.getElementById("note").value = "";

    // ãƒœã‚¿ãƒ³æ–‡è¨€
    document.querySelector("#policyForm .btn-primary").textContent = "ç™»éŒ²";
    document.querySelector("#policyForm .btn-primary").disabled = true;

    // åˆæœŸå€¤ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆç©ºã®çŠ¶æ…‹ï¼‰
    originalPolicyData = getFormData();
  }

  function editPolicy(index) {
    const data = policyData[index];
    document.getElementById("policyId").value = data.id;
    document.getElementById("policyName").value = data.name;
    document.getElementById("applyDay").value = data.applyDay;
    document.getElementById("feePercent").value = data.fee;
    document.getElementById("note").value = data.note;

    document.getElementById("submitBtn").textContent = "æ›´æ–°";
    document.getElementById("submitBtn").disabled = true;

    originalPolicyData = getFormData();

    isEditMode = true; // â† ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š

    if (!isFormOpened) {
      collapseInstance.show();
      setTimeout(scrollToForm, 200);
    } else {
      scrollToForm();
    }
  }


  function checkFormDiff() {
    const current = getFormData();

    // æ¯”è¼ƒï¼šæ–°è¦ã¯ã€Œç©ºã¨ã®å·®ã€ã€æ›´æ–°ã¯ã€ŒoriginalPolicyDataã¨ã®å·®ã€
    const isNew = !current.id;
    const hasDiff = JSON.stringify(current) !== JSON.stringify(originalPolicyData);

    // æ´»æ€§åŒ–æ¡ä»¶
    const isActive = isNew ? !!(current.name || current.applyDay || current.fee || current.note) : hasDiff;

    document.querySelector("#policyForm .btn-primary").disabled = !isActive;
  }



  function openDeleteModal(index) {
    deleteTargetIndex = index;
    const name = policyData[index].name;
    document.getElementById("delete-modal-body").innerHTML = `ãƒãƒªã‚·ãƒ¼åï¼š<strong>${name}</strong><br>ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
    new bootstrap.Modal(document.getElementById("deleteModal")).show();
  }

  document.getElementById("confirm-delete-btn").addEventListener("click", () => {
    if (deleteTargetIndex === null) return;
    const id = policyData[deleteTargetIndex].id;

    // ğŸ”„ ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤º
    document.getElementById("deleting-spinner").style.display = "block";
    document.getElementById("policy-list-area").style.display = "none";
    document.getElementById("toggleFormBtn").style.display = "none";
    document.getElementById("form-container").style.display = "none";

    const modal = bootstrap.Modal.getInstance(document.getElementById("deleteModal"));
    modal.hide();

    google.script.run
      .withSuccessHandler(() => {
        // å‰Šé™¤æˆåŠŸå¾Œã«ä¸€è¦§å†å–å¾—
        google.script.run.withSuccessHandler(data => {
          renderPolicyList(data);

          // âœ… ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éè¡¨ç¤ºã«æˆ»ã™
          document.getElementById("deleting-spinner").style.display = "none";

          // âœ… ä¸€è¦§ãªã©ã‚’è¡¨ç¤º
          document.getElementById("policy-list-area").style.display = "block";
          document.getElementById("toggleFormBtn").style.display = "block";
          document.getElementById("form-container").style.display = "block";

          // âœ… å‰Šé™¤å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
          document.getElementById("delete-message").style.display = "block";
          setTimeout(() => document.getElementById("delete-message").style.display = "none", 3000);
        }).getCancelPolicyList();
      })
      .deleteCancelPolicy(id);
  });


  function scrollToForm() {
    const form = document.getElementById("policyForm");
    if (form) {
      form.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }

  function validateForm() {
    const name = document.getElementById("policyName").value.trim();
    const applyDay = document.getElementById("applyDay").value.trim();
    const fee = document.getElementById("feePercent").value.trim();

    if (!name) return "ãƒãƒªã‚·ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    if (!applyDay || isNaN(applyDay) || Number(applyDay) < 0) return "é©ç”¨æ—¥ï¼ˆæ—¥å‰ï¼‰ã«ã¯0ä»¥ä¸Šã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    if (!fee || isNaN(fee) || Number(fee) < 0 || Number(fee) > 100) return "ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ï¼ˆ%ï¼‰ã¯0ã€œ100ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„";

    return null;
  }


</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>