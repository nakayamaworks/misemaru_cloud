<!DOCTYPE html>
<html lang="ja">
<head>
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>ğŸ“… äºˆç´„ç®¡ç†ï¼ˆç©ºãçŠ¶æ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰</title>
 <style>
 /* è¡¨å…¨ä½“ */
  .table {
    margin: 0;
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
  }

  .table-wrap {
    overflow: auto;
    max-height: 80vh;
    position: relative;
    border: 2px solid #ccc;
    border-radius: 6px;
    background-color: #fff;
    padding: 0 !important;
  }

  @supports (height: 100dvh) {
    .table-wrap { max-height: 80dvh; }
  }

  .table th, .table td {
    background-color: #fff;
    height: var(--slot-height);
    max-height: var(--slot-height);
    box-shadow: inset -1px 0 #dee2e6,  /* å·¦ */
      inset 1px 0 #dee2e6,   /* å³ */
      inset 0 -1px #dee2e6,  /* ä¸‹ */
      inset 0 1px #dee2e6;   /* ä¸Š */
  }

  /* å®Ÿç·šãƒ»ç‚¹ç·š */
  .border-solid {
    border-top: 1px solid #999 !important;
  }
  .border-dotted {}

  /* å›ºå®šã‚»ãƒ« */
  .table th[rowspan="2"]:first-child {
    position: sticky;
    top: 0;
    left: 0;
    z-index: 1000;
    height: 72px;
    vertical-align: middle;
    text-align: center;
    padding: 0.4rem;
  }

  .table thead tr:first-child th {
    position: sticky;
    top: 0;
    z-index: 900;
    height: 36px;
    padding: 0.4rem;
  }

  .table thead tr:nth-child(2) th {
    position: sticky;
    top: 36px;
    z-index: 800;
    height: 36px;
    padding: 0.4rem;
    font-size: 0.75rem;
    line-height: 1.4;
  }

  .table td:first-child {
    position: sticky;
    left: 0;
    top: 72px;
    z-index: 700;
    padding: 0.4rem;
  }

  .table th, .table td {
    min-width: 90px;
    max-width: 90px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center;
    vertical-align: middle;
    font-size: 0.85rem;
    line-height: 1.4;
  }

  /* ã‚¹ãƒãƒ›å‘ã‘èª¿æ•´ */
  @media (max-width: 576px) {
    #display-mode-toggle .btn,
    .calendar-wrapper .btn,
    .d-flex.justify-content-center .btn {
      font-size: 0.9rem;
      padding: 0.25rem 0.5rem;
    }
    .calendar-wrapper input[type="date"] {
      width: 30px;
      height: 32px;
    }
    #week-label { font-size: 0.9rem; }
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table { table-layout: fixed !important; }
    .table th, .table td {
      min-width: 48px !important;
      max-width: 48px !important;
      font-size: 0.75rem !important;
      padding: 2px !important;
    }
    .table thead tr:first-child th[colspan] {
      font-size: 0.9rem !important;
      line-height: 1.1;
      white-space: normal;
    }
    .day-split {
      display: block;
      font-size: 0.75rem;
      margin-top: 2px;
      text-align: center;
    }
    .text-danger .day-split { color: #dc3545 !important; }
    .text-primary .day-split { color: #0d6efd !important; }
    .staff-name-cell {
      white-space: normal !important;
      word-break: break-word;
      font-size: 0.65rem;
      line-height: 1.2;
    }
    .vertical-name {
      writing-mode: vertical-rl;
      text-orientation: upright;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-height: 5em;
      display: block;
      font-size: 0.75rem;
      line-height: 1;
      margin: 0 auto;
      text-align: center;
    }
  }

  .table th:first-child {
    position: sticky;
    left: 0;
    z-index: 600;
    background-color: #fff;
  }

  td a {
    display: block;
    width: 100%;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  #display-mode-toggle, #service-tabs,
  #reservation-overlay {
    display: none;
  }

  .selectable-cell { cursor: pointer; }
  td.selectable-cell:hover { background-color: #e6f7ff !important; }

  select option:disabled { color: #aaa; font-style: italic; }
  select option:disabled:hover { background-color: #fff; cursor: not-allowed; }

  .available-slot {
    color: #66bb66 !important;
    font-weight: bold;
  }
  .other-reserved-slot {
    color: #B22D35 !important;
    font-weight: bold;
  }

  /* ã‚¿ãƒ– */
  .tab-bar {
    display: flex;
    justify-content: flex-start;
    border-bottom: none;
    background-color: #e3f4fd;
    padding: 0 0.5rem;
    gap: 0.25rem;
  }
  .tab-bar button {
    font-size: 0.8rem;
    border: 1px solid #ccc;
    border-bottom: none;
    border-radius: 0.5rem 0.5rem 0 0;
    background-color: #e9ecef;
    padding: 6px 12px;
    font-weight: 500;
    color: #333;
    transition: background-color 0.2s ease;
    margin-bottom: -1px;
  }
  .tab-bar button:hover { background-color: #dee2e6; }
  .tab-bar .btn-outline-primary:hover {
    border-color: #ccc !important;
    background-color: #e0e0e0;
    color: #000;
  }
  .tab-bar .btn-outline-primary.active {
    background-color: #fff;
    color: #000;
    border-color: #ccc !important;
  }
  .tab-bar button.active {
    background-color: #fff;
    color: #000;
    border-bottom: none !important;
    z-index: 2;
    font-weight: bold;
    position: relative;
    margin-bottom: -1px;
  }
  .tab-wrapper .table-responsive {
    border-top: none;
    margin-top: 0;
    z-index: 1;
    position: relative;
  }


</style>
<?!= commonCss ?>
<style>
  #display-mode-toggle .btn {
    margin-right: 0.5rem;
    opacity: 0.4;
    font-weight: bold;
  }
  #display-mode-toggle .btn.active {
    opacity: 1;
    background-color: #0d6efd;
    color: white;
  }

</style>
</head>
<body class="loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­...</p>
  </div>
  <div id="app" style="display:none;">


<div class="container pt-2 py-3">

<!-- âœ… ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
<nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
  <div class="container-fluid px-0">
    <a class="navbar-brand" onclick="closeToAdmin()">
      <img src="https://raw.githubusercontent.com/WataruNakayama1203/misemaru-cloud-assets/main/misemaru_text_only.png" alt="ã¿ã›ã¾ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ­ã‚´" class="top-logo" />
    </a>
    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-lg-end" id="navbarNav">
      <div class="d-flex flex-column flex-lg-row align-items-center gap-2 mt-2 mt-lg-0">
        <!--<button type="button" class="btn btn-red fw-bold px-3" onclick="goTo('10_availability_staff')">ğŸ“… äºˆç´„ç®¡ç†</button>-->
        <button type="button" class="btn btn-green fw-bold px-3" onclick="goTo('20_staff_main_staff')">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</button>
        <button type="button" class="btn btn-blue fw-bold px-3" onclick="goTo('30_register_staff')">ğŸ“‡ é¡§å®¢ç®¡ç†</button>
        <button type="button" class="btn btn-gray fw-bold px-3" onclick="goTo('40_setting_main_admin')">ğŸª åº—èˆ—è¨­å®š</button>
      </div>
    </div>
  </div>
</nav>

  <h5 class="text-center mb-2">ğŸ“… äºˆç´„ç®¡ç†ï¼ˆç©ºãçŠ¶æ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰</h5>

  <div id="display-mode-toggle" class="text-center mb-2">
    <button id="mode-staff" class="btn btn-outline-secondary">ã‚¹ã‚¿ãƒƒãƒ•</button>
    <button id="mode-service" class="btn btn-outline-secondary active">ã‚µãƒ¼ãƒ“ã‚¹</button>
  </div>

  <div id="category-main-wrap" class="text-center mb-2" style="display:none;">
    <select id="category-main-select"
            class="form-select form-select-sm d-inline-block"
            style="width:220px;"></select>
  </div>

  <!-- ğŸ“† é€±ãƒ©ãƒ™ãƒ« -->
  <div class="text-center mb-2">
    <span id="week-label" class="fs-6"></span>
  </div>

  <!-- â®â­ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="d-flex justify-content-center align-items-center mb-3 gap-2 flex-wrap">
    <button class="btn btn-outline-secondary" onclick="changeWeek(-7)">ï¼œå‰é€±</button>

    <!-- ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ -->
    <div class="calendar-wrapper" style="position: relative; display: inline-block;">
      <input type="date" id="date-picker"
            style="opacity: 0; position: absolute; top: 0; left: 0; width: 40px; height: 38px; cursor: pointer; z-index: 2;" 
            onchange="handleDateSelect()" />
      <button id="calendar-button" class="btn btn-outline-secondary"
              onclick="document.getElementById('date-picker').focus()">ğŸ“…</button>
    </div>

    <button class="btn btn-outline-secondary" onclick="changeWeek(7)">æ¬¡é€±ï¼</button>
  </div>
  <!-- âœ… ã‚¿ãƒ– + è¡¨ã‚’1ã¤ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã«ã¾ã¨ã‚ã‚‹ -->
  <div class="tab-wrapper">
    <!-- ğŸ” ã‚µãƒ¼ãƒ“ã‚¹åˆ‡æ›¿ã‚¿ãƒ–ï¼ˆChromeé¢¨ï¼‰ -->
    <div id="service-tabs" class="tab-bar">
      <!-- JSã§ãƒœã‚¿ãƒ³ãŒå…¥ã‚‹ -->
    </div>

    <!-- ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ -->
    <div id="table-area" class="table-responsive"></div>
  </div>

</div>

<!-- ğŸ“… äºˆç´„ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="viewConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">äºˆç´„ç¢ºèª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="confirm-modal-body">
        <!-- ã“ã“ã«è©³ç´°æƒ…å ±ã‚’åŸ‹ã‚è¾¼ã‚€ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-primary" id="edit-reserve-btn">å¤‰æ›´</button>
        <button type="button" class="btn btn-danger" id="delete-btn">å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>


<!-- âš ï¸ å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-delete-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-danger" id="confirm-delete-btn">å‰Šé™¤</button>
      </div>
    </div>
  </div>
</div>

<!--  äºˆç´„ã‚»ãƒ«ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<!-- ğŸŸ¢ äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆçµ±ä¸€ç‰ˆï¼‰ -->
<div class="modal fade" id="viewReserveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">äºˆç´„å…¥åŠ›</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="reserve-modal-body">
        <!-- ä¸Šéƒ¨ã«æ³¨æ„æ–‡è¨€ã‚¨ãƒªã‚¢ã‚’è¿½åŠ  -->
        <div id="reserve-warning" class="alert alert-warning p-2 small mb-2 d-none"></div>
        <!-- JSã§ãƒ•ã‚©ãƒ¼ãƒ ãŒåŸ‹ã¾ã‚‹ -->
      </div>
      <div class="modal-footer justify-content-between flex-wrap gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <div class="ms-auto d-flex flex-wrap gap-2">
          <button type="button" class="btn btn-primary" id="view-reserve-btn">
            æ¬¡ã¸
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- äºˆç´„ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="reserveConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ã“ã®å†…å®¹ã§äºˆç´„ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="reserve-confirm-body">
        <!-- ä¸Šéƒ¨ã«æ³¨æ„æ–‡è¨€ã‚¨ãƒªã‚¢ã‚’è¿½åŠ  -->
        <div id="reserve-confirm-warning" class="text-danger mb-2 d-none"></div>
        <!-- JSã§è©³ç´°ãŒå…¥ã‚‹ -->
        <div id="reserve-confirm-content"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="back-to-form-btn">æˆ»ã‚‹</button>
        <button type="button" class="btn btn-primary" id="confirm-reserve-btn">äºˆç´„</button>
        <button type="button" class="btn btn-success d-none" id="confirm-reserve-register-btn">é¡§å®¢ç™»éŒ²ï¼†äºˆç´„</button>
      </div>
    </div>
  </div>
</div>


<!-- âš ï¸ å…¥åŠ›ä¸è¶³ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="inputCheckModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æœªå…¥åŠ›é …ç›®ãŒã‚ã‚Šã¾ã™</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        å§“ãƒ»åãƒ»é›»è©±ç•ªå·ã®ã„ãšã‚Œã‹ãŒæœªå…¥åŠ›ã§ã™ã€‚<br>ã“ã®ã¾ã¾äºˆç´„ã‚’ç¶šã‘ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-primary" id="input-check-ok-btn">OK</button>
      </div>
    </div>
  </div>
</div>

<!--  é¡§å®¢ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="customerRegisterModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ“‡ é¡§å®¢ç™»éŒ²</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
      </div>
      <div class="modal-body">
         <!-- ğŸ”” æ³¨æ„æ–‡è¨€ -->
        <div class="alert alert-warning p-2 small text-center mb-3">
          â€» ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã äºˆç´„ã¯ç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚
        </div>
        <form id="customerRegisterForm">
          <div class="row">
            <div class="col-md-6 mb-2">
              <label>å§“</label>
              <input type="text" id="regLastName" class="form-control" required>
            </div>
            <div class="col-md-6 mb-2">
              <label>å</label>
              <input type="text" id="regFirstName" class="form-control" required>
            </div>
            <div class="col-md-6 mb-2">
              <label>ãƒ•ãƒªã‚¬ãƒŠï¼ˆå§“ï¼‰</label>
              <input type="text" id="regLastKana" class="form-control">
            </div>
            <div class="col-md-6 mb-2">
              <label>ãƒ•ãƒªã‚¬ãƒŠï¼ˆåï¼‰</label>
              <input type="text" id="regFirstKana" class="form-control">
            </div>
            <div class="col-md-6 mb-2">
              <label>é›»è©±ç•ªå·</label>
              <input type="text" id="regPhone" class="form-control" required>
            </div>
            <div class="col-md-6 mb-2">
              <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
              <input type="email" id="regEmail" class="form-control">
            </div>
            <div class="col-12 mb-2">
              <label>ã‚«ãƒƒãƒˆã‚¹ã‚¿ã‚¤ãƒ«</label>
              <textarea id="regCutStyle" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-12 mb-2">
              <label>å‚™è€ƒ</label>
              <textarea id="regNote" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button class="btn btn-secondary" id="backToConfirmReserve">æˆ»ã‚‹</button>
        <button class="btn btn-primary" id="skipCustomerRegister">ã‚¹ã‚­ãƒƒãƒ—ã—ã¦äºˆç´„</button>
        <button class="btn btn-primary" id="submitCustomerRegister">äºˆç´„</button>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ•’ ã‚¢ã‚¤ãƒ‰ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="idleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">â³ ç„¡æ“ä½œãŒç¶šã„ã¦ã„ã¾ã™</h5>
      </div>
      <div class="modal-body">
        15åˆ†é–“æ“ä½œãŒãªã‹ã£ãŸãŸã‚ã€<br>10ç§’å¾Œã«ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚Šã¾ã™ã€‚
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="idleCancelBtn">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã“ã®ã¾ã¾ç¶šã‘ã‚‹
        </button>
      </div>
    </div>
  </div>
</div>

<!-- äºˆç´„è¢«ã‚Šç¦æ­¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="conflictModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">âš ï¸ äºˆç´„ãŒé‡è¤‡ã—ã¦ã„ã¾ã™</h5>
      </div>
      <div class="modal-body">
        ã“ã®æ™‚é–“å¸¯ã¯ã™ã§ã«äºˆç´„ãŒå…¥ã£ã¦ã„ã‚‹ãŸã‚ã€ç™»éŒ²ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
        ä»–ã®æ™‚é–“ã‚’ãŠé¸ã³ãã ã•ã„ã€‚
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="goTo('10_availability')">ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿</button>
      </div>
    </div>
  </div>
</div>


<div id="page-end" style="height: 10px;"></div>

<!-- ğŸŒ€äºˆç´„ä¸­ã®ã‚¹ãƒ”ãƒŠãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="reservation-overlay" class="position-fixed top-0 start-0 w-100 h-100 justify-content-center align-items-center bg-dark bg-opacity-50" style="z-index: 1055; display: none;">
  <div class="text-center text-white">
    <div class="spinner-border" role="status"></div>
    <div class="mt-2 fs-5 overlay-message">äºˆç´„å‡¦ç†ä¸­...</div>
  </div>
</div>

<script>


const prefillDate = '<?= date ?>';
const prefillTime = '<?= time ?>';
let weeklyCache = {}; //å…¨é€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
let weeklyDataCache = {}; //	ç¾åœ¨è¡¨ç¤ºä¸­ã®é€±ã®ãƒ‡ãƒ¼ã‚¿
let isLoading = false;
let lastTableData = {};
let lastSelectedDate = "";
let isFirstOpen = true;
let hasHighlightedPrefill = false;
let reservationUnit = 60;
let currentMode = "service";
let isSingleStaffMode = false;
let cachedCustomerList = null;
let isCustomerListReady = false;
let lastReserved = null;
let modalToRestore = null;
let scrollMemory = {};
let lastMatchedCustomer = null;


/*ã€€=============================================================================================== */
/*ã€€                                        æ—¥ä»˜å‡¦ç†ï¼ˆå½“æ—¥ï¼‰                                      */
/*ã€€=============================================================================================== */
let currentStartDate = toStartOfDayJST(new Date()); 

// "YYYY-MM-DD" æ–‡å­—åˆ— or Date ã‚’ JST 0:00 ã«æƒãˆã‚‹
function toStartOfDayJST(input) {
  const d = (input instanceof Date) ? input : new Date(input);
  if (isNaN(d)) return null;
  // JSTã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§ãã®æ—¥ã®0æ™‚ã‚’è¿”ã™
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

/*ã€€=============================================================================================== */
/*ã€€                                        ãƒšãƒ¼ã‚¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†                                      */
/*ã€€=============================================================================================== */
const idle = {
  timer: null,       // ãƒ¡ã‚¤ãƒ³ã®15åˆ†ã‚¿ã‚¤ãƒãƒ¼
  modalTimer: null,  // ãƒ¢ãƒ¼ãƒ€ãƒ«å‡ºã—ãŸå¾Œã®è‡ªå‹•é·ç§»ã‚¿ã‚¤ãƒãƒ¼ï¼ˆã‚‚ã—ä½¿ã†ãªã‚‰ï¼‰
  gen: 0,            // ä¸–ä»£ã€‚ã“ã‚ŒãŒå¤‰ã‚ã£ãŸã‚‰å¤ã„ã‚¿ã‚¤ãƒãƒ¼ã¯ç„¡åŠ¹
  deadline: 0,       // æ¬¡ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆäºˆå®šæ™‚åˆ»ï¼ˆDate.now() ã§æ¯”è¼ƒï¼‰
};

function clearIdleTimers() {
  if (idle.timer) { clearTimeout(idle.timer); idle.timer = null; }
  if (idle.modalTimer) { clearTimeout(idle.modalTimer); idle.modalTimer = null; }
}

function armIdle(limitMs) {
  clearIdleTimers();
  idle.gen++;
  const myGen = idle.gen;
  idle.deadline = Date.now() + limitMs;
  idle.timer = setTimeout(() => {
    if (idle.gen !== myGen) return;  // å¤ã„ã‚¿ã‚¤ãƒãƒ¼ãªã‚‰ç„¡è¦–
    showIdleConfirmModal();
  }, limitMs);
}

const IDLE_LIMIT = 120 * 60 * 1000; // 15åˆ†ã€€â†’ã€€120åˆ†ã¸

function resetIdleTimer() {
  armIdle(IDLE_LIMIT);
}

function showIdleConfirmModal() {
  // ã“ã“ã§æ–°ã—ã„ä¸–ä»£ã«ã—ã¦ãŠãã¨ã€è¡¨ç¤ºç›´å‰ã«ä»•è¾¼ã¾ã‚Œã¦ãŸå¤ã„ã‚¿ã‚¤ãƒãƒ¼ã‚’ç„¡åŠ¹åŒ–ã§ãã‚‹
  idle.gen++;

  // æ—¢å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  const modalEl = document.getElementById("idleModal");
  const modal = new bootstrap.Modal(modalEl, {
    backdrop: 'static',
    keyboard: false
  });

  // ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã¤ã‘ç›´ã—ï¼ˆå¤šé‡ç™»éŒ²é˜²æ­¢ï¼‰
  const cancelBtn = document.getElementById("idleCancelBtn");
  const gotoBtn = document.getElementById("idleGotoBtn"); // ã€ŒTOPã¸ã€ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ãªã‚‰

  cancelBtn.onclick = () => {
    // ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ç„¡åŠ¹åŒ–ï¼†ä¸–ä»£é€²ã‚ã‚‹
    clearIdleTimers();
    idle.gen++;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
    modal.hide();

    // ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ—ãŒæ®‹ã‚‹äº‹æ•…å¯¾ç­–
    document.querySelectorAll('.modal-backdrop').forEach(n => n.remove());
    document.body.classList.remove('modal-open');

    // ç›´ã¡ã«æ–°ã—ã„ç· åˆ‡ã§å†ã‚¢ãƒ¼ãƒ ï¼ˆä»Šã“ã“ã‹ã‚‰15åˆ†ï¼‰
    armIdle(IDLE_LIMIT);
  };

  if (gotoBtn) {
    gotoBtn.onclick = () => {
      clearIdleTimers();
      idle.gen++;
      // closeToAdmin() ãŒã‚ã‚‹ãªã‚‰ãã£ã¡æ¨å¥¨
      if (typeof closeToAdmin === 'function') closeToAdmin();
      else window.location.href = `${baseUrl}?page=06_index`;
    };
  }

  modal.show();

  // ï¼ˆä»»æ„ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã—ã¦ã‹ã‚‰Xç§’ã§è‡ªå‹•ã§TOPã«æˆ»ã—ãŸã„ãªã‚‰
  // å¤ã„ modalTimer ãŒæ®‹ã‚‰ãªã„ã‚ˆã†ä¸–ä»£ãƒã‚¤ãƒ³ãƒ‰
  const myGen = idle.gen;
  idle.modalTimer = setTimeout(() => {
    if (idle.gen !== myGen) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ä¸–ä»£ãŒé€²ã‚“ã ã‚‰ç„¡è¦–
    if (typeof closeToAdmin === 'function') closeToAdmin();
    else window.location.href = `${baseUrl}?page=06_index`;
  }, 10 * 1000); // ä¾‹: 60ç§’
}

/*ã€€=============================================================================================== */
/*ã€€                                        ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç³»                                       */
/*ã€€=============================================================================================== */
// â° æ–‡å­—åˆ— "HH:mm" â†’ åˆ†ã«å¤‰æ›
function timeToMinutes(str) {
  const [h, m] = str.split(":").map(Number);
  return h * 60 + m;
}

// â° åˆ† â†’ "HH:mm" ã«å¤‰æ›
function minutesToTime(mins) {
  const h = Math.floor(mins / 60).toString().padStart(2, "0");
  const m = (mins % 60).toString().padStart(2, "0");
  return `${h}:${m}`;
}

function formatDateWithWeekday(ymdStr) {
  if (!ymdStr || isNaN(new Date(ymdStr))) {
    return "ï¼ˆæ—¥ä»˜ä¸æ˜ï¼‰";
  }

  const d = new Date(ymdStr);
  const day = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][d.getDay()];
  return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥(${day})`;
}

//ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹åˆ‡ã‚Šæ›¿ãˆç”¨

// âœ… UIã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
document.getElementById("mode-staff").addEventListener("click", () => {
  if (currentMode !== "staff") {
    resetScrollMemory();
    currentMode = "staff";
    setToggleUI("staff");
    localStorage.setItem("calendarMode", "staff");
    initTabs("staff");
  }
});

document.getElementById("mode-service").addEventListener("click", () => {
  if (currentMode !== "service") {
    resetScrollMemory();
    currentMode = "service";
    setToggleUI("service");
    localStorage.setItem("calendarMode", "service");
    initTabs("service");
  }
});

function updateSingleStaffMode(data) {
  isSingleStaffMode = data?.meta?.staffList?.length === 1;
}

// âœ… ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã ã‘åˆ‡ã‚Šæ›¿ãˆ
function setToggleUI(mode) {
  document.getElementById("mode-staff").classList.toggle("active", mode === "staff");
  document.getElementById("mode-service").classList.toggle("active", mode === "service");
}

/*ã€€=============================================================================================== */
/*ã€€                                        ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç³»                                            */
/*ã€€=============================================================================================== */
let pendingHref = "";
let pendingReserveInfo = {}; // æ—¥ä»˜ãƒ»æ™‚é–“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ãªã©

function convertReasonToLabel(reasonText) {
  if (reasonText.includes("å–¶æ¥­æ™‚é–“å¤–") || reasonText.includes("æ‹…å½“è€…ãŒä¸åœ¨")) {
    return "æ™‚é–“å¤–";
  }
  if (reasonText.includes("ä»–ã‚µãƒ¼ãƒ“ã‚¹ã®äºˆç´„")) {
    return "ä»–äºˆç´„"; // â† è¿½åŠ ï¼
  }
  if (reasonText.includes("ã“ã®æ™‚é–“å¸¯ã«ã¯ã™ã§ã«äºˆç´„ãŒ")) {
    return "äºˆç´„æ¸ˆ";
  }
  return "äºˆç´„ä¸å¯"; // ãã‚Œä»¥å¤–
}

// é–‹å§‹å€™è£œ
function getStartTimeCandidates(dateStr, staffId, serviceId) {
  const unit = weeklyDataCache?.meta?.unitMin || 15;

  // ã¾ãšç¥æ—¥åæ˜ ç‰ˆ
  const bizA = weeklyDataCache?.meta?.rawBusinessHoursMap || {};
  let hoursList = bizA[dateStr] || [];

  // ç©ºï¼ˆ=ç¥æ—¥ä¼‘æ¥­ãªã©ï¼‰ãªã‚‰ç¥æ—¥ç„¡è¦–ç‰ˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (!Array.isArray(hoursList) || hoursList.length === 0) {
    const bizBase = weeklyDataCache?.meta?.rawBusinessHoursMapBase || {};
    hoursList = bizBase[dateStr] || [];
  }

  const allSlots = new Set();
  for (const hours of hoursList) {
    const startMin = timeToMinutes(hours.start);
    const endMin   = timeToMinutes(hours.end);
    for (let t = startMin; t < endMin; t += unit) {
      allSlots.add(minutesToTime(t));
    }
  }
  return Array.from(allSlots).sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
}


function generateStartTimeOptionsHTML(dateStr, selectedTime, staffId, serviceId, excludeReservation = null) {
  const times = getStartTimeCandidates(dateStr, staffId, serviceId);
  const unit = weeklyDataCache?.meta?.unitMin || 15;

  const excludeDuration = (excludeReservation?.endTime && excludeReservation?.time)
    ? timeToMinutes(excludeReservation.endTime) - timeToMinutes(excludeReservation.time)
    : unit;

  return times.map(t => {
    const tMin = timeToMinutes(t);
    const tEndMin = tMin + excludeDuration;
    const tEnd = minutesToTime(tEndMin);

    const reasons = checkReservationAvailabilityReasons(
      dateStr,
      t,
      tEnd,
      staffId,
      serviceId,
      excludeReservation
    );

    // ğŸ” ã“ã® t ã«å¯¾å¿œã™ã‚‹ç†ç”±ã ã‘ã‚’è¦‹ã‚‹
    const thisReason = reasons.find(r => r.time === t);
    const shortLabel = thisReason ? convertReasonToLabel(thisReason.reason) : "";

    const isDisabled = ["äºˆç´„æ¸ˆ", "äºˆç´„ä¸å¯"].includes(shortLabel);
    const label = shortLabel ? `${t}ï¼ˆ${shortLabel}ï¼‰` : t;

    return `<option value="${t}" ${t === selectedTime ? "selected" : ""} ${isDisabled ? "disabled" : ""}>${label}</option>`;
  }).join("");
}

// çµ‚äº†å€™è£œ
function getEndTimeCandidates(startTime, dateStr, staffId, serviceId) {
  const unit = weeklyDataCache?.meta?.unitMin || 15;

  // ã¾ãšç¥æ—¥åæ˜ ç‰ˆ
  const bizA = weeklyDataCache?.meta?.rawBusinessHoursMap || {};
  let hoursList = bizA[dateStr];

  // ç©ºãªã‚‰ç¥æ—¥ç„¡è¦–ç‰ˆ
  if (!Array.isArray(hoursList) || hoursList.length === 0) {
    const bizBase = weeklyDataCache?.meta?.rawBusinessHoursMapBase || {};
    hoursList = bizBase[dateStr];
  }

  const startMin = timeToMinutes(startTime);
  const list = [];
  if (Array.isArray(hoursList) && hoursList.length > 0) {
    for (const hours of hoursList) {
      const endMin = timeToMinutes(hours.end);
      for (let t = startMin + unit; t <= endMin; t += unit) {
        list.push(minutesToTime(t));
      }
    }
  }
  return [...new Set(list)];
}


function generateEndTimeOptionsHTML(startTime, dateStr, selectedEndTime, staffId, serviceId, excludeReservation = null) {
  const times = getEndTimeCandidates(startTime, dateStr, staffId, serviceId);
  const unit = weeklyDataCache?.meta?.unitMin || 15;

  let disableFromHere = false;

  return times.map(t => {
    const endMin = timeToMinutes(t);
    const startMin = endMin - unit;
    const startStr = minutesToTime(startMin);

    const reasons = checkReservationAvailabilityReasons(dateStr, startStr, t, staffId, serviceId, excludeReservation);
    const firstReason = reasons.length > 0 ? reasons[0]?.reason || "" : "";
    const shortLabel = firstReason ? convertReasonToLabel(firstReason) : "";

    if (["äºˆç´„æ¸ˆ", "äºˆç´„ä¸å¯"].includes(shortLabel)) {
      disableFromHere = true;
    }

    const label = shortLabel ? `${t}ï¼ˆ${shortLabel}ï¼‰` : t;
    const isDisabled = disableFromHere;

    return `<option value="${t}" ${t === selectedEndTime ? "selected" : ""} ${isDisabled ? "disabled" : ""}>${label}</option>`;
  }).join("");
}

function getAdjustedEndTimeForEditMode(startTime, originalEndTime, date, staffId, serviceId, excludeReservation) {
  const unit = weeklyDataCache?.meta?.unitMin || 15;
  const startMin = timeToMinutes(startTime);
  const origEndMin = timeToMinutes(originalEndTime);

  // ç·¨é›†å‰ã‚ˆã‚Šå‰å€’ã—ã•ã‚ŒãŸã‹ï¼Ÿ
  if (startMin < timeToMinutes(excludeReservation.time)) {
    // æ–°ãŸãªç¯„å›²ã«äºˆç´„æ¸ˆãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰å†èª¿æ•´
    for (let t = startMin; t < origEndMin; t += unit) {
      const tStr = minutesToTime(t);
      const reasons = checkReservationAvailabilityReasons(
        date,
        tStr,
        minutesToTime(t + unit),
        staffId,
        serviceId,
        excludeReservation
      );

      const label = reasons.length > 0 ? convertReasonToLabel(reasons[0].reason || "") : "";
      if (["äºˆç´„æ¸ˆ", "äºˆç´„ä¸å¯"].includes(label)) {
        return findMaxAvailableEndTime(startTime, date, staffId, serviceId, excludeReservation);
      }
    }
    return originalEndTime;
  }

  return originalEndTime;
}

function getAdjustedEndTimeIfInvalid(startTime, endTime, date, staffId, serviceId, excludeReservation) {
  if (timeToMinutes(startTime) >= timeToMinutes(endTime)) {
    const desired = calculateDefaultEndTime(startTime, serviceId);
    const maxAvailable = findMaxAvailableEndTime(startTime, date, staffId, serviceId, excludeReservation);
    if (!maxAvailable || timeToMinutes(desired) <= timeToMinutes(maxAvailable)) {
      return desired;
    }
    return maxAvailable;
  }
  return endTime;
}

//é–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateTimeOptions(excludeReservation = null) {
  const dateStr = document.getElementById("reserve-date").value;
  const staffId = document.getElementById("reserve-staff").value;
  const serviceId = document.getElementById("reserve-service").value;
  const startSelect = document.getElementById("start-time-select");
  const endSelect = document.getElementById("end-time-select");

  if (!dateStr || !staffId || !serviceId) return;

  // 1. ç¾åœ¨ã®é¸æŠçŠ¶æ…‹
  const selectedStartTime = startSelect.value;
  const currentEndTime = endSelect.value;

  // 2. é–‹å§‹æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿæˆ
  startSelect.innerHTML = generateStartTimeOptionsHTML(dateStr, selectedStartTime, staffId, serviceId, excludeReservation);

  // 3. å†å–å¾—ã•ã‚ŒãŸé–‹å§‹æ™‚é–“ã«åˆã‚ã›ã¦çµ‚äº†æ™‚é–“å€™è£œç”Ÿæˆ
  const updatedStartTime = startSelect.value;
  let adjustedEndTime = currentEndTime;

  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ï¼Ÿ
  const isEdit = excludeReservation && excludeReservation.mode === "edit";

  if (isEdit) {
    adjustedEndTime = getAdjustedEndTimeForEditMode(
      updatedStartTime,
      currentEndTime,
      dateStr,
      staffId,
      serviceId,
      excludeReservation
    );
  }

  // çµ‚äº†æ™‚é–“ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆâ‘£ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  adjustedEndTime = getAdjustedEndTimeIfInvalid(
    updatedStartTime,
    adjustedEndTime,
    dateStr,
    staffId,
    serviceId,
    excludeReservation
  );

  // 4. çµ‚äº†æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
  endSelect.innerHTML = generateEndTimeOptionsHTML(updatedStartTime, dateStr, adjustedEndTime, staffId, serviceId, excludeReservation);

  // 5. valueè¨­å®šï¼ˆå«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°æœ€åˆã®optionï¼‰
  const endValues = [...endSelect.options].map(opt => opt.value);
  endSelect.value = endValues.includes(adjustedEndTime) ? adjustedEndTime : endValues[0] || "";
}


//æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸæ™‚ã«å‘¼ã³å‡ºã™é–¢æ•°
function updateTimeSelectOptions(date, staffId, serviceId, selectedTime = "") {
  const startSelect = document.getElementById("start-time-select");
  const endSelect = document.getElementById("end-time-select");

  const newStartOptions = generateStartTimeOptions(date, staffId, serviceId);
  startSelect.innerHTML = newStartOptions;
  if (selectedTime) startSelect.value = selectedTime;

  const newEndOptions = getEndTimeCandidates(startSelect.value, date, staffId, serviceId)
    .map(t => `<option value="${t}">${t}</option>`)
    .join("");
  endSelect.innerHTML = newEndOptions;
}

function generateServiceOptionsHTML(selectedId) {
  const allServices = weeklyDataCache?.meta?.serviceList || [];
  const services = filterServicesByActiveCategory(allServices); // â† è¿½åŠ 
  return services.map(s =>
    `<option value="${s.id}" ${s.id === selectedId ? "selected" : ""}>
       ${s.categorySub || s.name}
     </option>`
  ).join("");
}

function generateStaffOptionsHTML(selectedId, serviceId) {
  const staffList = weeklyDataCache?.meta?.staffList || [];
  const serviceStaffMap = weeklyDataCache?.meta?.serviceStaffMap || {};

  const allowedStaffIds = serviceStaffMap[serviceId] || [];

  return staffList
    .filter(s => allowedStaffIds.includes(s.id))
    .map(s => `<option value="${s.id}" ${s.id === selectedId ? "selected" : ""}>${s.name}</option>`)
    .join("");
}

function getServiceNameById(serviceId) {
  const services = weeklyDataCache?.meta?.serviceList || [];
  const service = services.find(s => s.id === serviceId);
  return service ? service.name : "-";
}

function getStaffNameById(staffId) {
  const staff = weeklyDataCache?.meta?.staffList || [];
  const s = staff.find(s => s.id === staffId);
  return s ? s.name : "-";
}

function getCurrentWeekRange() {
  const start = toStartOfDayJST(currentStartDate); // å½“æ—¥0:00
  const end = new Date(start);
  end.setDate(start.getDate() + 6);             // 7æ—¥é–“ã®æœ€çµ‚æ—¥
  return { start: formatDate(start), end: formatDate(end) };
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šæ™‚åˆ»é…åˆ—ã‚’é€£ç¶šç¯„å›²ã«ã¾ã¨ã‚ã‚‹
function groupTimeRanges(timeList, unitMin) {
  
  if (timeList.length === 0) return [];

  const timesMin = timeList
    .map(t => ({ str: t, min: timeToMinutes(t) }))
    .filter(t => !isNaN(t.min))  // â† å¿µã®ãŸã‚ä¸æ­£å€¤ã‚’é™¤å¤–
    .sort((a, b) => a.min - b.min);

  if (timesMin.length === 0) return [];

  const ranges = [];
  let start = timesMin[0].str;
  let prev = timesMin[0].min;

  for (let i = 1; i < timesMin.length; i++) {
    const curr = timesMin[i];
    if (curr.min !== prev + unitMin) {
      ranges.push({ start, end: minutesToTime(prev + unitMin) });
      start = curr.str;
    }
    prev = curr.min;
  }
  ranges.push({ start, end: minutesToTime(prev + unitMin) });

  const result = ranges.map(r => `${r.start}ï½${r.end}`);
  return result;
}

function groupReasons(reasonList, unitMin) {
  const grouped = {};

  for (const r of reasonList) {
    if (!r.reason || !r.time) {
      console.warn("âš ï¸ ä¸æ­£ãªreasoné …ç›®:", r);
      continue;
    }

    if (!grouped[r.reason]) grouped[r.reason] = [];
    grouped[r.reason].push(r.time);
  }

  const lines = [];

  for (const reason in grouped) {
    const ranges = groupTimeRanges(grouped[reason], unitMin);
    if (ranges.length === 0) continue;
    lines.push(`${ranges.join("ã€")}ï¼š${reason}`);
  }
  return lines;
}

function checkReservationAvailabilityReasons(dateStr, startTime, endTime, staffId, serviceId, excludeReservation = null) {
  if (!weeklyDataCache || !weeklyDataCache.staffView) return [{ time: "å…¨ä½“", reason: "ãƒ‡ãƒ¼ã‚¿æœªå–å¾—" }];

  const staffView = weeklyDataCache.staffView[staffId];
  const meta = weeklyDataCache.meta;
  const unit = meta?.unitMin || 15;
  if (!staffView || !staffView[dateStr]) return [{ time: "å…¨ä½“", reason: "è©²å½“æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“" }];

  const slots = staffView[dateStr];

  // 1) ãã®ã¾ã¾ã®äºˆç´„ä»¶æ•°ï¼ˆè‡ªåˆ†é™¤å¤–ã—ãªã„ï¼‰
  const reservedCountMap = new Map();
  for (const tStr in slots) {
    const cells = slots[tStr]?.[serviceId];
    if (!Array.isArray(cells)) continue;
    for (const cell of cells) {
      const status = cell?.status ?? "";
      const sTime = cell?.startTime;
      const eTime = cell?.endTime;
      if (!sTime || !eTime) continue; // å…ˆé ­ã‚»ãƒ«ã ã‘æŒã¤å‰æ
      if (["ğŸŸ¢", "âˆ’", "Ã—"].includes(status)) continue; // è‡ªã‚µãƒ¼ãƒ“ã‚¹äºˆç´„ã ã‘æ•°ãˆã‚‹
      const s = timeToMinutes(sTime);
      const e = timeToMinutes(eTime);
      for (let m = s; m < e; m += unit) {
        const key = minutesToTime(m);
        reservedCountMap.set(key, (reservedCountMap.get(key) || 0) + 1);
      }
    }
  }

  // 2) ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚­ãƒ£ãƒ‘
  const serviceMeta = meta?.serviceList?.find(s => s.id === serviceId);
  const capacity = Number(serviceMeta?.capacity) || 1;

  // 3) ç·¨é›†ä¸­ã®è‡ªåˆ†ã®åŒºé–“
  const isEdit = !!excludeReservation && dateStr === excludeReservation.date;
  const sameStaffAsEdit = isEdit && String(staffId || "") === String(excludeReservation.staffId || "");
  const editStart = isEdit ? timeToMinutes(excludeReservation.time) : null;
  const editEnd = isEdit
    ? timeToMinutes(excludeReservation.endTime || calculateDefaultEndTime(excludeReservation.time, excludeReservation.service))
    : null;

  // 4) åˆ¤å®š
  const tStart = timeToMinutes(startTime);
  const tEnd   = timeToMinutes(endTime);
  const reasons = [];

  for (let t = tStart; t < tEnd; t += unit) {
    const tStr = minutesToTime(t);
    const row = slots[tStr];

    if (!row || !row[serviceId]) {
      reasons.push({ time: tStr, reason: "â€»ã“ã®æ™‚é–“å¸¯ã®äºˆç´„ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“" });
      continue;
    }

    const cells = row[serviceId];

    // 4-1) æº€æ ï¼ˆç·¨é›†æ™‚ã¯è‡ªåˆ†ã®ã¶ã‚“ã ã‘1æ¸›ç®—ï¼‰
    let reservedCount = reservedCountMap.get(tStr) || 0;
    if (sameStaffAsEdit && t >= editStart && t < editEnd) {
      reservedCount = Math.max(0, reservedCount - 1);
    }
    if (reservedCount >= capacity) {
      reasons.push({ time: tStr, reason: `ã“ã®æ™‚é–“å¸¯ã«ã¯ã™ã§ã«äºˆç´„ãŒ${reservedCount}ä»¶å…¥ã£ã¦ã„ã¾ã™ï¼ˆä¸Šé™${capacity}ï¼‰` });
      continue;
    }

    // 4-2) ç©ºãã‚»ãƒ«åˆ¤å®š & ä»–ã‚µãƒ¼ãƒ“ã‚¹ãƒ–ãƒ­ãƒƒã‚¯æ¤œå‡º
    let hasGreen = false;                 // ãã®åˆ†ã«â€œå®Ÿã‚»ãƒ«ç©ºãâ€ãŒã‚ã‚‹ã‹
    let hasOtherServiceBlock = false;     // ãã®åˆ†ã«â€œä»–ã‚µãƒ¼ãƒ“ã‚¹ã§Ã—â€ãŒã‚ã‚‹ã‹

    for (const cell of cells) {
      const status = cell?.status ?? "";
      const blockedBy = cell?.blockedBy ?? "";
      const name = cell?.name ?? "";

      if (status === "Ã—" && blockedBy === "other-service") {
        hasOtherServiceBlock = true;
      }
      if (status === "ğŸŸ¢" || name === "ğŸŸ¢") {
        hasGreen = true;
      }
    }

    // ç·¨é›†ä¸­ã®è‡ªåˆ†ã®åˆ†ã¯â€œç†è«–ä¸Šã®ç©ºãâ€ã¨ã—ã¦æ‰±ã†ï¼ˆã‚»ãƒ«è¡¨ç¤ºä¸Šã¯åŸ‹ã¾ã£ã¦ã¦ã‚‚é¸ã¹ã‚‹ã¹ãï¼‰
    if (!hasGreen && sameStaffAsEdit && t >= editStart && t < editEnd) {
      hasGreen = true;
    }

    // 4-3) ç©ºããŒç„¡ã‘ã‚Œã°ç†ç”±å‡ºã—ï¼ˆç©ºããŒã‚ã‚‹ãªã‚‰æ³¨æ„ã¯å‡ºã•ãªã„ï¼‰
    if (!hasGreen) {
      if (hasOtherServiceBlock) {
        reasons.push({ time: tStr, reason: "ã“ã®æ™‚é–“å¸¯ã«ã¯ä»–ã‚µãƒ¼ãƒ“ã‚¹ã®äºˆç´„ãŒå…¥ã£ã¦ã„ã¾ã™" });
      } else {
        reasons.push({ time: tStr, reason: "å–¶æ¥­æ™‚é–“å¤–ã¾ãŸã¯æ‹…å½“è€…ãŒä¸åœ¨ã§ã™" });
      }
    }
  }

  return reasons.length > 0 ? reasons : [];
}

// ======== è¿½åŠ ï¼šæ°¸ç¶šåŒ–ã‚­ãƒ¼ & ãƒ˜ãƒ«ãƒ‘ãƒ¼ ========
const LS_KEYS = {
  pending: "pendingReserveInfo",
  scroll: "scrollMemory",
  scrollPos: "scrollMemoryPosition",
};

function setLastAction(action) {
  try { localStorage.setItem("lastAction", action); } catch (e) {}
}
function consumeLastAction() {
  try {
    const a = localStorage.getItem("lastAction");
    localStorage.removeItem("lastAction");
    return a;
  } catch (e) { return null; }
}

function persistScrollPosToLS() {
  try {
    const wrap = document.querySelector('.table-wrap');
    if (!wrap) return;
    localStorage.setItem(LS_KEYS.scrollPos, JSON.stringify({
      top: wrap.scrollTop,
      left: wrap.scrollLeft
    }));
  } catch (e) {}
}

function restoreScrollPosFromLS() {
  try {
    const wrap = document.querySelector('.table-wrap');
    if (!wrap) return;
    const pos = JSON.parse(localStorage.getItem(LS_KEYS.scrollPos) || "null");
    if (pos && Number.isFinite(pos.top) && Number.isFinite(pos.left)) {
      wrap.scrollTo({ top: pos.top, left: pos.left, behavior: "instant" });
    }
  } catch (e) {}
}

// pendingReserveInfo ã‚’ LS ã«ä¿å­˜
function persistPendingInfo() {
  try {
    if (pendingReserveInfo && pendingReserveInfo.date && pendingReserveInfo.time) {
      localStorage.setItem(LS_KEYS.pending, JSON.stringify(pendingReserveInfo));
    }
  } catch (e) {}
}

// pendingReserveInfo ã‚’ LS ã‹ã‚‰å¾©å…ƒ
function restorePendingInfo() {
  try {
    const obj = JSON.parse(localStorage.getItem(LS_KEYS.pending) || "null");
    if (obj && obj.date && obj.time) {
      pendingReserveInfo = { ...pendingReserveInfo, ...obj };
      return true;
    }
  } catch (e) {}
  return false;
}

// pending ã‚’ã‚¯ãƒªã‚¢
function clearPendingInfo() {
  try { localStorage.removeItem(LS_KEYS.pending); } catch (e) {}
}
// è¿½åŠ ï¼šæç”»å®Œäº†å¾…ã¡ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function waitFor(cond, timeout = 1000, interval = 50) {
  return new Promise((resolve, reject) => {
    const t0 = performance.now();
    (function tick() {
      if (cond()) return resolve();
      if (performance.now() - t0 > timeout) return reject(new Error('waitFor timeout'));
      setTimeout(tick, interval);
    })();
  });
}

window.addEventListener("pageshow", async () => {
  try {
    // 1) äºˆç´„ã‚¢ãƒ³ã‚«ãƒ¼ç­‰ã‚’å…ˆã«å¾©å…ƒï¼ˆãƒ¡ãƒ¢ãƒªã¸ï¼‰
    restorePendingInfo();

    // 2) ãƒ¢ãƒ¼ãƒ‰å¾©å…ƒï¼ˆä¿å­˜ãŒã‚ã‚Œã°å¿…ãšåˆã‚ã›ã‚‹ï¼‰
    const savedMode = localStorage.getItem("calendarMode");
    if (savedMode === "staff" || savedMode === "service") {
      if (getCurrentMode?.() !== savedMode) {
        currentMode = savedMode;
        setToggleUI(savedMode);
        setupCategorySelect(); 
        initTabs(savedMode);
      } else {
        // åŒãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ initTabs ã§å†æç”»ã—ã¦ãŠãã¨å®‰å…¨
        initTabs(savedMode);
      }
    } else {
      initTabs(currentMode);
    }

    // 3) é€±ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç”Ÿãã¦ã‚‹ãªã‚‰å³æ™‚ãƒ‡ãƒ¼ã‚¿åæ˜ 
    const startStr = formatDate(currentStartDate);
    const allData = weeklyCache[startStr];
    if (allData) {
      weeklyDataCache = allData;
      setupCategorySelect();
    }

    // 4) è¡¨ã®DOMãŒç”ŸãˆãŸã®ã‚’å¾…ã£ã¦ã‹ã‚‰å¾©å…ƒå®Ÿè¡Œ
    await waitFor(() => document.querySelector('.table-wrap'), 1000);

    // 5) ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ï¼†ãƒã‚¤ãƒ©ã‚¤ãƒˆå¾©å…ƒ
    restoreScrollPosFromLS();   // ä½ç½®
    highlightSavedSlotOnly();   // ç›´è¿‘ã‚»ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼†ä¸­å¤®å¯„ã›
  } catch (e) {
    console.debug("pageshow restore skipped:", e);
  }
});

// ã‚¹ãƒªãƒ¼ãƒ—å¾©å¸°ã‚„bfcacheå¾©å¸°ã§ã‚‚ç¢ºå®Ÿã«å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«
window.addEventListener('pageshow', () => {
  // å¤ã„ã‚¿ã‚¤ãƒãƒ¼ã‚’å…¨ã¦æ®ºã—ã€ä¸–ä»£ã‚‚é€²ã‚ã‚‹
  clearIdleTimers();
  idle.gen++;

  // æœ¬å½“ã«15åˆ†çµŒã£ã¦ã„ã‚‹ã‹ã‚’æ™‚åˆ»ã§åˆ¤å®š
  if (idle.deadline && Date.now() >= idle.deadline) {
    // æœŸé™è¶…éãªã‚‰å³ãƒ¢ãƒ¼ãƒ€ãƒ«
    showIdleConfirmModal();
  } else {
    // ã¾ã æ®‹ã‚ŠãŒã‚ã‚‹ãªã‚‰æ®‹ã‚Šæ™‚é–“ã§å†ã‚¢ãƒ¼ãƒ 
    const remaining = idle.deadline ? Math.max(0, idle.deadline - Date.now()) : IDLE_LIMIT;
    armIdle(remaining);
  }
});


function attachModalInputListeners() {
  const modalEl = document.getElementById("viewReserveModal");
  let excludeReservation = null;
  try {
    excludeReservation = JSON.parse(modalEl?.dataset?.original || "null");
  } catch (_) {
    excludeReservation = null;
  }

  const ids = ["reserve-date","start-time-select","end-time-select","reserve-staff","reserve-service","reserve-designated"];

  const syncPending = () => {
    // ç¾çŠ¶å€¤ã‚’ pendingReserveInfo ã«åæ˜ 
    const chk = document.getElementById("reserve-designated");
    if (chk) {
      pendingReserveInfo = {
        ...pendingReserveInfo,
        date: document.getElementById("reserve-date")?.value || pendingReserveInfo.date,
        time: document.getElementById("start-time-select")?.value || pendingReserveInfo.time,
        serviceId: document.getElementById("reserve-service")?.value || pendingReserveInfo.serviceId,
        staffId: document.getElementById("reserve-staff")?.value || pendingReserveInfo.staffId,
        mode: modalEl?.dataset?.mode || pendingReserveInfo.mode,
        original: (() => {
          try { return JSON.parse(modalEl?.dataset?.original || "null") } catch { return pendingReserveInfo.original || null; }
        })(),
      };
    }
    persistPendingInfo();
  };

  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", () => {
      updateReserveWarning(excludeReservation);
      syncPending();
    });
  });

  // åˆå›ã‚‚åŒæœŸã—ã¦ãŠã
  syncPending();
}

function updateReserveWarning(excludeReservation = null) {
  const date = document.getElementById("reserve-date")?.value;
  const startTime = document.getElementById("start-time-select")?.value;
  const endTime = document.getElementById("end-time-select")?.value;
  const serviceId = document.getElementById("reserve-service")?.value;
  const staffId = document.getElementById("reserve-staff")?.value;

  if (!date || !startTime || !endTime || !serviceId || !staffId) return;

  const reasons = checkReservationAvailabilityReasons(
    date,
    startTime,
    endTime,
    staffId,
    serviceId,
    excludeReservation
  );

  const warningDiv = document.getElementById("reserve-warning");
  const reserveBtn = document.getElementById("view-reserve-btn");

  // ğŸ” äºˆç´„æ¸ˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ©ãƒ™ãƒ«ã§åˆ¤å®šï¼‰
  const hasReserved = reasons.some(r => {
    const label = convertReasonToLabel(r.reason || "");
    return label === "äºˆç´„æ¸ˆ";
  });

  // âš ï¸ æ–‡è¨€è¡¨ç¤º
  if (reasons.length > 0) {
    const unit = weeklyDataCache?.meta?.unitMin || 15;
    warningDiv.classList.remove("d-none");
    warningDiv.innerText = groupReasons(reasons, unit).join("\n");
  } else {
    warningDiv.classList.add("d-none");
    warningDiv.innerText = "";
  }

  // ğŸš« ãƒœã‚¿ãƒ³ã®æ´»æ€§/éæ´»æ€§
  if (reserveBtn) {
    reserveBtn.disabled = hasReserved;
  }
}


function showWarningMessage(msg) {
  const div = document.getElementById("reserve-warning");
  if (!div) return;
  div.classList.remove("d-none");
  div.innerText = msg;
}

function hideWarningMessage() {
  const div = document.getElementById("reserve-warning");
  if (!div) return;
  div.classList.add("d-none");
  div.innerText = "";
}

function formatPhoneNumber(raw) {
  const cleaned = raw.replace(/[^\d]/g, "");
  if (cleaned.length === 11) {
    return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
  } else if (cleaned.length === 10) {
    return cleaned.replace(/(\d{2,3})(\d{3,4})(\d{4})/, "$1-$2-$3");
  }
  return raw; // æ•´å½¢ä¸å¯ãªã‚‰ãã®ã¾ã¾
}

function cleanPhone(str) {
  return (str || "").replace(/[^\d]/g, ""); // æ•°å­—ã ã‘æ®‹ã™
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§è¡¨ç¤ºé€±å¤–ã®æ—¥ä»˜ã‚’é¸æŠã—ãŸå ´åˆã®ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
async function showReserveModalWithDataCheck(info) {
  const { date } = info;                       // "YYYY-MM-DD"
  const anchorStr = formatDate(toStartOfDayJST(date));

  // â¶ ã¾ãšç›´è¿‘ãƒ•ã‚§ãƒƒãƒæ¸ˆã¿ã®7æ—¥çª“ã«å…¥ã£ã¦ã„ã‚Œã°å³åˆ©ç”¨
  const rng = weeklyDataCache?.meta?.range; // { start, end } ã‚’GASãŒè¿”ã™
  if (rng && anchorStr >= rng.start && anchorStr <= rng.end) {
    showReserveModal(info);
    return;
  }

  // â· åŒä¸€ã‚­ãƒ¼ã§æ—¢ã«é€±ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°åˆ©ç”¨
  if (weeklyCache[anchorStr]) {
    weeklyDataCache = weeklyCache[anchorStr];
    showReserveModal(info);
    return;
  }

  // â¸ ç„¡ã‘ã‚Œã°å–å¾—
  showReservationOverlay("äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦");
  google.script.run
    .withSuccessHandler(data => {
      hideReservationOverlay();
      weeklyCache[anchorStr] = data;
      weeklyDataCache = data;
      setupCategorySelect(); 
      showReserveModal(info);
    })
    .withFailureHandler(err => {
      hideReservationOverlay();
      alert("âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç”¨ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + err.message);
    })
    .getWeeklyMatrixUnified(anchorStr);
}


document.getElementById("view-reserve-btn").addEventListener("click", () => {
  const modalEl = document.getElementById("viewReserveModal");
  const mode = modalEl.dataset.mode || "new";
  const original = JSON.parse(modalEl.dataset.original || "{}");

  const selectedPhone = document.getElementById("customer-select")?.value || "";
  const manualLast = document.getElementById("lastNameInput").value.trim();
  const manualFirst = document.getElementById("firstNameInput").value.trim();
  const manualPhone = document.getElementById("phoneInput").value.trim();
  const emailInputVal = document.getElementById("emailInput")?.value.trim() || "";

  const date = document.getElementById("reserve-date").value;
  const time = document.getElementById("start-time-select").value;
  const endTime = document.getElementById("end-time-select").value;
  const serviceId = document.getElementById("reserve-service").value;
  const staffId = document.getElementById("reserve-staff").value;
  const matchedCustomer = cachedCustomerList?.find(c => cleanPhone(c.phone) === cleanPhone(selectedPhone));
  const isExisting = !!matchedCustomer;

  //ã‚¹ã‚¿ãƒƒãƒ•ãƒ©ãƒ™ãƒ«
  let designated;
  const chk = document.getElementById("reserve-designated");
  if (chk) {
      designated = chk.checked;              // â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ã®é¸æŠã‚’æœ€å„ªå…ˆ
  } else if (mode === "edit" && typeof original.designated !== "undefined") {
    designated = !!original.designated;
  } else {
    const selCell = document.querySelector('#table-area td.selected-cell');
    if (selCell && selCell.dataset && selCell.dataset.designated != null) {
      designated = (selCell.dataset.designated === "true");
    } else {
      designated = false;                  // æ˜ç¤ºãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    }
  }

  const staffLabel = designated ? "ï¼ˆæŒ‡åï¼‰" : "";

  lastMatchedCustomer = matchedCustomer;

  const lastName = matchedCustomer?.lastName || manualLast;
  const firstName = matchedCustomer?.firstName || manualFirst;
  const phone = selectedPhone || manualPhone;
  const email = emailInputVal || matchedCustomer?.email || "";
  const cutStyle = matchedCustomer?.cutStyle || "";
  const note = matchedCustomer?.note || "";

  const reservationData = {
    lastName,
    firstName,
    phone,
    email,
    date,
    time,
    endTime,
    service: serviceId,
    staffId
  };

  // âœ… ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯
  if (!validateSafeInputs(reservationData)) {
    alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
    return;
  }

  if (!date || isNaN(new Date(date))) {
    alert("âŒ æ—¥ä»˜ãŒæ­£ã—ãé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  const confirmBody = document.getElementById("reserve-confirm-body");
  const confirmWarning = document.getElementById("reserve-confirm-warning");
  const confirmContent = document.getElementById("reserve-confirm-content");

  if (mode === "edit") {
    const confirmWarning = document.getElementById("reserve-confirm-warning");
    confirmWarning.classList.remove("d-none");

    if (window.__hasReserveDiff === false) {
      confirmWarning.innerText = "å¤‰æ›´ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“ãŒã€ã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ";
    } else {
      confirmWarning.innerText = "";
      confirmWarning.classList.add("d-none");
    }

    confirmContent.innerHTML = generateConfirmDiffHTML(original, reservationData);
    document.getElementById("confirm-reserve-btn").textContent = "å¤‰æ›´";
  }else {
    const service = getServiceNameById(serviceId);
    const staffName = getStaffNameById(staffId) || "ï¼";

    // GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã« designated ãŒå«ã¾ã‚Œã¦ã„ã‚‹å‰æ
    const staffLabel = designated ? "ï¼ˆæŒ‡åï¼‰" : "";

    const warnings = [];
    if (!lastName) warnings.push("å§“ãŒæœªå…¥åŠ›ã§ã™ã€‚");
    if (!firstName) warnings.push("åãŒæœªå…¥åŠ›ã§ã™ã€‚");
    if (!phone) warnings.push("é›»è©±ç•ªå·ãŒæœªå…¥åŠ›ã§ã™ã€‚");

    if (warnings.length > 0) {
      confirmWarning.className = "text-danger mb-2";
      confirmWarning.innerHTML = `${warnings.join("<br>")}`;
      confirmWarning.classList.remove("d-none");
    } else {
      confirmWarning.classList.add("d-none");
      confirmWarning.innerHTML = "";
    }

    confirmContent.innerHTML = `
      <div><strong>æ—¥ä»˜ï¼š</strong>${formatDateWithWeekday(date)}</div>
      <div><strong>æ™‚é–“ï¼š</strong>${time}ï½${endTime}</div>
      <div><strong>ã‚µãƒ¼ãƒ“ã‚¹ï¼š</strong>${service}</div>
      <div><strong>æ‹…å½“è€…ï¼š</strong>${staffName}${staffLabel}</div>
      <div><strong>äºˆç´„è€…åï¼š</strong>${lastName} ${firstName}</div>
      <div><strong>é›»è©±ç•ªå·ï¼š</strong>${formatPhoneNumber(phone)}</div>
      <div><strong>ãƒ¡ãƒ¼ãƒ«ï¼š</strong>${email || "ï¼"}</div>
      ${cutStyle ? `<div><strong>ã‚«ãƒƒãƒˆã‚¹ã‚¿ã‚¤ãƒ«ï¼š</strong>${cutStyle}</div>` : ""}
      ${note ? `<div><strong>å‚™è€ƒï¼š</strong>${note}</div>` : ""}
    `;

    document.getElementById("confirm-reserve-btn").textContent = "äºˆç´„";
  }

  const regBtn = document.getElementById("confirm-reserve-register-btn");
  regBtn.classList.remove("d-none");

  const confirmTitleEl = document.querySelector("#reserveConfirmModal .modal-title");
  if (confirmTitleEl) {
    confirmTitleEl.textContent = mode === "edit"
      ? "ã“ã®å†…å®¹ã§å¤‰æ›´ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
      : "ã“ã®å†…å®¹ã§äºˆç´„ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
  }

  if (mode === "edit") {
    regBtn.textContent = isExisting
      ? "ç™»éŒ²æƒ…å ±ã‚’æ›´æ–°ã—ã¦å¤‰æ›´"
      : "é¡§å®¢æƒ…å ±ã‚’ç™»éŒ²ã—ã¦å¤‰æ›´";
  } else {
    regBtn.textContent = isExisting
      ? "ç™»éŒ²æƒ…å ±ã‚’æ›´æ–°ã—ã¦äºˆç´„"
      : "é¡§å®¢æƒ…å ±ã‚’ç™»éŒ²ã—ã¦äºˆç´„";
  }

  bootstrap.Modal.getInstance(modalEl).hide();
  setTimeout(() => {
    const confirmModal = new bootstrap.Modal(document.getElementById("reserveConfirmModal"));
    confirmModal.show();
  }, 300);
});


document.getElementById("back-to-form-btn").addEventListener("click", () => {
  const confirmModalEl = document.getElementById("reserveConfirmModal");
  const confirmModalInstance = bootstrap.Modal.getInstance(confirmModalEl);
  confirmModalInstance.hide();

  confirmModalEl.addEventListener("hidden.bs.modal", function handler() {
    confirmModalEl.removeEventListener("hidden.bs.modal", handler);
    const reserveModal = new bootstrap.Modal(document.getElementById("viewReserveModal"));
    reserveModal.show();
  });
});

//äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«
document.getElementById("confirm-reserve-btn").addEventListener("click", () => {
  setLastAction("reserve");
  // âœ… pendingReserveInfoã‚’æ›´æ–°ï¼ˆmodeã¨originalã¯ç¶­æŒã•ã‚Œã‚‹ï¼‰
  pendingReserveInfo = {
    ...pendingReserveInfo,
    date: document.getElementById("reserve-date")?.value || pendingReserveInfo.date,
    time: document.getElementById("start-time-select")?.value || pendingReserveInfo.time,
    serviceId: document.getElementById("reserve-service")?.value || pendingReserveInfo.serviceId,
    staffId: document.getElementById("reserve-staff")?.value || pendingReserveInfo.staffId
  };

  const reservationData = {
    lastName: document.getElementById("lastNameInput")?.value || "",
    firstName: document.getElementById("firstNameInput")?.value || "",
    phone: document.getElementById("phoneInput")?.value || "",
    email: document.getElementById("emailInput")?.value || "",
    date: pendingReserveInfo.date,
    time: pendingReserveInfo.time,
    endTime: document.getElementById("end-time-select")?.value || "",
    service: pendingReserveInfo.serviceId,
    staffId: pendingReserveInfo.staffId
  };

  // âœ… ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯ã®ã¿
  if (!validateSafeInputs(reservationData)) {
    alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
    return;
  }

  // âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦å‡¦ç†ã¸é€²ã‚€
  const confirmModal = bootstrap.Modal.getInstance(document.getElementById("reserveConfirmModal"));
  confirmModal?.hide();

  // äºˆç´„ç¢ºå®šç›´å‰ã«ã‚‚ scrollMemory ã‚’ç¢ºå®šä¿å­˜ï¼ˆå¾©å¸°ä¸­æ–­ã«å¼·ãã™ã‚‹ï¼‰
  try {
    const selector = `[data-date="${pendingReserveInfo.date}"][data-time="${pendingReserveInfo.time}"][data-staff-id="${pendingReserveInfo.staffId}"][data-service-id="${pendingReserveInfo.serviceId}"]`;
    const endTimeNow = document.getElementById("end-time-select")?.value || "";
    const lastName = document.getElementById("lastNameInput")?.value?.trim() || "";
    const firstName = document.getElementById("firstNameInput")?.value?.trim() || "";
    const phone = document.getElementById("phoneInput")?.value?.trim() || "";

    localStorage.setItem(LS_KEYS.scroll, JSON.stringify({
      selector,
      meta: {
        date: pendingReserveInfo.date,
        time: pendingReserveInfo.time,
        end: endTimeNow,
        staffId: pendingReserveInfo.staffId,
        serviceId: pendingReserveInfo.serviceId,
        name: `${lastName} ${firstName}`.trim(),
        phone: phone
      }
    }));

    const wrap = document.querySelector('.table-wrap');
    if (wrap) {
      localStorage.setItem(LS_KEYS.scrollPos, JSON.stringify({ top: wrap.scrollTop, left: wrap.scrollLeft }));
    }
  } catch(e) {}


  setTimeout(() => {
    saveReservationFromPending();
  }, 100);
});


// äºˆç´„å†…å®¹ç¢ºèª â†’ é¡§å®¢æƒ…å ±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸
document.getElementById("confirm-reserve-register-btn").addEventListener("click", () => {
  setLastAction("reserve");
  const viewModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("viewReserveModal"));
  const confirmModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("reserveConfirmModal"));
  viewModal.hide();
  confirmModal.hide();

  const last = document.getElementById("lastNameInput")?.value.trim() || "";
  const first = document.getElementById("firstNameInput")?.value.trim() || "";
  const phone = document.getElementById("phoneInput")?.value.trim() || "";

  // å…¥åŠ›ã‚’ã‚»ãƒƒãƒˆ
  document.getElementById("regLastName").value = last;
  document.getElementById("regFirstName").value = first;
  document.getElementById("regPhone").value = phone;
  document.getElementById("regLastKana").value = lastMatchedCustomer?.lastKana || "";
  document.getElementById("regFirstKana").value = lastMatchedCustomer?.firstKana || "";
  document.getElementById("regEmail").value =  (document.getElementById("emailInput")?.value.trim() || lastMatchedCustomer?.email || "");
  document.getElementById("regCutStyle").value = lastMatchedCustomer?.cutStyle || "";
  document.getElementById("regNote").value = lastMatchedCustomer?.note || "";

  setTimeout(() => {
    bootstrap.Modal.getOrCreateInstance(document.getElementById("customerRegisterModal")).show();
  }, 300);
});

document.getElementById("skipCustomerRegister").addEventListener("click", () => {
  bootstrap.Modal.getInstance(document.getElementById("customerRegisterModal")).hide();

  setTimeout(() => {
    saveReservationFromPending(); // â† é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãªã—ã§äºˆç´„
  }, 300);
});

document.getElementById("backToConfirmReserve").addEventListener("click", () => {
  bootstrap.Modal.getInstance(document.getElementById("customerRegisterModal")).hide();

  setTimeout(() => {
    bootstrap.Modal.getOrCreateInstance(document.getElementById("viewReserveModal")).show();
  }, 300);
});

function showConflictModal() {
  const modalEl = document.getElementById("conflictModal");
  const modal = new bootstrap.Modal(modalEl, {
    backdrop: 'static', // â† èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹
    keyboard: false     // â† Escã‚­ãƒ¼ç„¡åŠ¹
  });

  // ä¸€åº¦ã ã‘ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ï¼ˆè¤‡æ•°å›è¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚‹ã®ã§ remove â†’ addï¼‰
  modalEl.removeEventListener("hidden.bs.modal", handleConflictClose);
  modalEl.addEventListener("hidden.bs.modal", handleConflictClose);

  modal.show();
}

function handleConflictClose() {
  /*setTimeout(() => {
    goTo("10_availability"); // ğŸ”„ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
  }, 300);*/
}
// è¨ˆæ¸¬ã®ON/OFFï¼ˆå¿…è¦ãªã‚‰ false ã«ï¼‰
window.__PERF_SAVE = true;
function tStart(label){ if (window.__PERF_SAVE) console.time(label); }
function tEnd(label){ if (window.__PERF_SAVE) console.timeEnd(label); }
function tLog(label, ...args){ if (window.__PERF_SAVE && console.timeLog) console.timeLog(label, ...args); else if (window.__PERF_SAVE) console.log(label, ...args); }

// è¨ˆæ¸¬ãƒˆã‚°ãƒ«ã¯æ—¢å­˜ã®ã¾ã¾åˆ©ç”¨
function saveReservationFromPending(optionalCustomerData = null) {
  tStart("[save] TOTAL");

  tStart("[save] DOM-read");
  restorePendingInfo();
  const ctx = JSON.parse(JSON.stringify(pendingReserveInfo || {}));
  const isStaffMode = document.getElementById("mode-staff")?.classList.contains("active");

  const lastName  = document.getElementById("lastNameInput")?.value?.trim() || "";
  const firstName = document.getElementById("firstNameInput")?.value?.trim() || "";
  const phoneRaw  = document.getElementById("phoneInput")?.value?.trim() || "";
  const endTime   = document.getElementById("end-time-select")?.value || "";
  const emailInputVal = document.getElementById("emailInput")?.value?.trim() || "";
  const emailFallback  = lastMatchedCustomer?.email || "";

  const cleanPhone = phoneRaw.replace(/[^\d]/g, "");
  const displayName = `${lastName} ${firstName}`.trim();

  // å¤‰æ›´æ¤œçŸ¥ï¼ˆç·¨é›†æ™‚ã¯ ctx.original ã¨æ¯”è¼ƒï¼æ–°è¦ã§ optionalCustomerData ãŒã‚ã‚Œã°å¤‰æ›´æ‰±ã„ï¼‰
  const norm = s => String(s || "").replace(/[^\d]/g, "");
  const changedByEdit =
    ctx?.mode === "edit" && ctx?.original ? (
      (ctx.original.lastName || "").trim()   !== lastName ||
      (ctx.original.firstName || "").trim()  !== firstName ||
      norm(ctx.original.phone)               !== cleanPhone
    ) : false;
  const changedByNewData = !!optionalCustomerData; // æ–°è¦ã‚„é¡§å®¢æ›´æ–°ã‚’ä¼´ã†ä¿å­˜æ™‚ã®ãƒ•ãƒ©ã‚°
  const customerChanged = changedByEdit || changedByNewData;

  const selectorBase =
    `[data-date="${ctx.date}"]` +
    `[data-time="${ctx.time}"]` +
    `[data-service-id="${ctx.serviceId}"]` +
    `[data-staff-id="${ctx.staffId}"]`;
  const selector = `${selectorBase}[data-end="${endTime}"][data-name="${displayName}"][data-phone="${cleanPhone}"]`;
  tEnd("[save] DOM-read");

  tStart("[save] LS/save-scroll");
  localStorage.setItem(LS_KEYS.scroll, JSON.stringify({
    selector,
    meta: { date: ctx.date, time: ctx.time, end: endTime, staffId: ctx.staffId, serviceId: ctx.serviceId, name: displayName, phone: cleanPhone }
  }));
  const wrap = document.querySelector('.table-wrap');
  if (wrap) {
    localStorage.setItem("scrollMemoryPosition", JSON.stringify({ top: wrap.scrollTop, left: wrap.scrollLeft }));
  }
  tEnd("[save] LS/save-scroll");

  tStart("[save] overlay-show");
  showReservationOverlay();
  tEnd("[save] overlay-show");

  const reservationData = {
    lastName, firstName, phone: cleanPhone,email: emailInputVal || emailFallback,
    date: ctx.date, time: ctx.time, endTime,
    service: ctx.serviceId, staffId: ctx.staffId || "",
    designated: document.getElementById("reserve-designated")?.checked || false,
    request: ctx.original?.request || "" 
  };

  // â˜… é¡§å®¢ãŒå¤‰ã‚ã£ãŸã¨ãã ã‘ã€å…ˆã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ï¼ˆéåŒæœŸãƒ»å¾…ãŸãªã„ï¼‰
  if (customerChanged) {
    tStart("[save] RPC invalidateCustomerCache");
    google.script.run
      .withSuccessHandler(() => tEnd("[save] RPC invalidateCustomerCache"))
      .withFailureHandler(() => tEnd("[save] RPC invalidateCustomerCache"))
      .invalidateCustomerCache();
  }

  const save = () => {
    // ===== RPC: saveReservationAdmin =====
    tStart("[save] RPC saveReservationAdmin");
    google.script.run
      .withSuccessHandler(result => {
        tEnd("[save] RPC saveReservationAdmin");

        if (result === "CONFLICT") {
          tLog("[save] RESULT", "CONFLICT");
          hideReservationOverlay();
          tEnd("[save] TOTAL");
          showConflictModal();
          return;
        }

        // é¡§å®¢ãŒå¤‰ã‚ã£ãŸã¨ãã ã‘å†å–å¾—ï¼ˆå¤‰æ›´ãªã‘ã‚Œã°å‘¼ã°ãªã„ï¼‰
        if (customerChanged) {
          tStart("[save] RPC getCustomerList");
          google.script.run
            .withSuccessHandler(data => {
              tEnd("[save] RPC getCustomerList");
              cachedCustomerList = data || [];
              isCustomerListReady = true;
            })
            .withFailureHandler(err => {
              tEnd("[save] RPC getCustomerList");
              console.warn("[save] getCustomerList failed:", err?.message || err);
            })
            .getCustomerList();
        }

        // ===== RPC: getWeeklyMatrixUnified =====
        const startStr = formatDate(currentStartDate);
        tStart("[save] RPC getWeeklyMatrixUnified");
        google.script.run
          .withSuccessHandler(allData => {
            tEnd("[save] RPC getWeeklyMatrixUnified");

            // ===== ãƒ•ãƒ­ãƒ³ãƒˆåæ˜  =====
            tStart("[save] apply-cache");
            weeklyDataCache = allData;
            weeklyCache[startStr] = allData;
            updateSingleStaffMode(allData);
            tEnd("[save] apply-cache");

            if (isSingleStaffMode) {
              tStart("[save] render:single-staff");
              updateLabel();
              const staff = allData.meta.staffList[0];
              drawTableByStaff(allData.staffView[staff.id], staff.id);
              tEnd("[save] render:single-staff");

              tStart("[save] highlight");
              highlightSavedSlotOnly();
              tEnd("[save] highlight");

              tStart("[save] adjust-width");
              adjustTableMinWidth();
              tEnd("[save] adjust-width");
            } else {
              tStart("[save] tabs/init");
              const targetMode = ctx.viewMode || localStorage.getItem("calendarMode") || currentMode || "service";
              currentMode = targetMode;
              localStorage.setItem("calendarMode", targetMode);
              setToggleUI(targetMode);
              initTabs(targetMode);
              tEnd("[save] tabs/init");

              tStart("[save] tabs/activate");
              const tabsContainer = (targetMode === "staff") ? "#staff-tabs" : "#service-tabs";
              const tabKey = (targetMode === "staff") ? ctx.staffId : ctx.serviceId;
              try { activateTabByDataId(tabsContainer, targetMode, tabKey); } catch (e) { console.warn("activateTabByDataId å¤±æ•—:", e); }
              tEnd("[save] tabs/activate");

              tStart("[save] highlight");
              highlightSavedSlotOnly();
              tEnd("[save] highlight");
            }

            tStart("[save] overlay-hide");
            hideReservationOverlay();
            tEnd("[save] overlay-hide");

            clearPendingInfo();
            isLoading = false;

            tEnd("[save] TOTAL");
          })
          .withFailureHandler(err => {
            tEnd("[save] RPC getWeeklyMatrixUnified");
            hideReservationOverlay();
            document.getElementById("table-area").innerHTML =
              `<div class='text-danger'>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
            isLoading = false;
            tEnd("[save] TOTAL");
          })
          .getWeeklyMatrixUnified(startStr);
      })
      .withFailureHandler(err => {
        tEnd("[save] RPC saveReservationAdmin");
        hideReservationOverlay();
        alert("âŒ äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        tEnd("[save] TOTAL");
      })
      .saveReservationAdmin(reservationData);
  };

  if (ctx.mode === "edit" && ctx.original) {
    const editToken =
      (window.crypto && crypto.randomUUID) ? crypto.randomUUID()
        : (Date.now().toString(36) + Math.random().toString(36).slice(2));

    tStart("[save] RPC deleteReservation");
    google.script.run
      .withSuccessHandler(() => {
        tEnd("[save] RPC deleteReservation");
        // â† ã“ã“ã§ãƒ•ãƒ©ã‚°ã‚’ä»˜ä¸ã—ã¦æ—¢å­˜ save() ã‚’å†åˆ©ç”¨
        reservationData._forUpdate = true;
        reservationData._editToken = editToken;
        save(); // æ—¢å­˜ã®æˆåŠŸ/å¤±æ•—ãƒãƒ³ãƒ‰ãƒ©ãƒ»å†æç”»ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è§£é™¤ã‚’ãã®ã¾ã¾ä½¿ã†
      })
      .withFailureHandler(err => {
        tEnd("[save] RPC deleteReservation");
        hideReservationOverlay();
        alert("âŒ å¤‰æ›´å‰ã®äºˆç´„å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        tEnd("[save] TOTAL");
      })
      .deleteReservation({ ...ctx.original, _forUpdate: true, _editToken: editToken });  // â† ... ã«ä¿®æ­£
  } else {
    save();
  }
}


document.getElementById("submitCustomerRegister").addEventListener("click", () => {
  const data = {
    id: lastMatchedCustomer?.id || null,
    lastName: document.getElementById("regLastName").value.trim(),
    firstName: document.getElementById("regFirstName").value.trim(),
    lastKana: document.getElementById("regLastKana").value.trim(),
    firstKana: document.getElementById("regFirstKana").value.trim(),
    phone: document.getElementById("regPhone").value.trim(),
    email: document.getElementById("regEmail").value.trim(),
    cutStyle: document.getElementById("regCutStyle").value.trim(),
    note: document.getElementById("regNote").value.trim()
  };

  if (!validateSafeInputs(data)) {
    alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
    return;
  }

  if (!data.lastName || !data.firstName || !data.phone) {
    alert("å§“ãƒ»åãƒ»é›»è©±ç•ªå·ã¯å¿…é ˆã§ã™ï¼");
    return;
  }

  //document.getElementById("submitCustomerRegister").disabled = true;

  // âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã¦ã€ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºï¼ˆé¡§å®¢ç™»éŒ²ä¸­ï¼‰
  bootstrap.Modal.getInstance(document.getElementById("customerRegisterModal")).hide();
  showReservationOverlay("é¡§å®¢ç™»éŒ²ä¸­...");

  // âœ… é¡§å®¢ç™»éŒ² â†’ ç™»éŒ²å¾Œã«äºˆç´„å‡¦ç†
  google.script.run.withSuccessHandler(() => {
    // âœ… é¡§å®¢ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¦ã‹ã‚‰äºˆç´„å‡¦ç†ã¸
    google.script.run.withSuccessHandler(data => {
      cachedCustomerList = data || [];
      isCustomerListReady = true;

      const phone = document.getElementById("regPhone").value.trim();
      lastMatchedCustomer = cachedCustomerList.find(c => cleanPhone(c.phone) === cleanPhone(phone));

      populateCustomerSelect();

      if (lastMatchedCustomer) {
        const select = document.getElementById("customer-select");
        const phone = cleanPhone(lastMatchedCustomer.phone);
        select.value = phone;
        select.dispatchEvent(new Event("change"));
      }

      showReservationOverlay("äºˆç´„å‡¦ç†ä¸­...");
      saveReservationFromPending(data);

    }).getCustomerList();

  }).withFailureHandler(err => {
    hideReservationOverlay();
    alert("âŒ é¡§å®¢ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
  }).saveCustomer(data);

});

//å¤‰æ›´ãƒœã‚¿ãƒ³ãŒãŠã•ã‚ŒãŸã‚‰ã€äºˆç´„å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
document.getElementById("edit-reserve-btn").addEventListener("click", () => {
  const modal = bootstrap.Modal.getInstance(document.getElementById("viewConfirmModal"));
  modal.hide();

  // å…ƒäºˆç´„ãƒ‡ãƒ¼ã‚¿ï¼ˆpendingReserveInfoï¼‰ã‚’ä½¿ã£ã¦ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¢ãƒ¼ãƒ€ãƒ«å†è¡¨ç¤º
  setTimeout(() => {
    showReserveModal({
      date: pendingReserveInfo.date,
      time: pendingReserveInfo.time,
      service: getServiceNameById(pendingReserveInfo.service),
      staff: getStaffNameById(pendingReserveInfo.staffId),
      serviceId: pendingReserveInfo.service,
      staffId: pendingReserveInfo.staffId,
      mode: "edit",
      original: {
        ...pendingReserveInfo,
        designated: pendingReserveInfo.designated
      }
    });
  }, 300);
});


// ğŸŸ¥ å‰Šé™¤ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  document.getElementById("delete-btn")?.addEventListener("click", () => {
    const modal = bootstrap.Modal.getInstance(document.getElementById("viewConfirmModal"));
    modal?.hide();

    const confirmModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
    confirmModal.show();
  });

  // âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ« â†’ å…ƒã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã«æˆ»ã™
  document.getElementById("cancel-delete-btn")?.addEventListener("click", () => {
    const deleteModal = bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal"));
    deleteModal?.hide();

    const confirmModal = new bootstrap.Modal(document.getElementById("viewConfirmModal"));
    confirmModal.show();
  });

  // âœ… æœ¬å½“ã«å‰Šé™¤ â†’ GASå‘¼ã³å‡ºã—
  document.getElementById("confirm-delete-btn")?.addEventListener("click", () => {
    const deleteModal = bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal"));
    deleteModal?.hide();

    // å…ˆé ­ã‚¹ãƒ­ãƒƒãƒˆã ã‘ã‚’ç‹™ã†æœ€å°ã‚»ãƒ¬ã‚¯ã‚¿ï¼ˆå‰Šé™¤å¾Œã‚‚ä¸€è‡´ã™ã‚‹ï¼‰
    const svcId =
      pendingReserveInfo.serviceId
      || pendingReserveInfo.service
      || document.querySelector(
          `[data-date="${pendingReserveInfo.date}"][data-time="${pendingReserveInfo.time}"][data-staff-id="${pendingReserveInfo.staffId}"][data-service-id]`
        )?.dataset?.serviceId
      || ""; // å–ã‚Œãªã‘ã‚Œã°ç©ºï¼ˆå±æ€§ã‚’ä»˜ã‘ãªã„ï¼‰

    let selector =
      `[data-date="${pendingReserveInfo.date}"]` +
      `[data-time="${pendingReserveInfo.time}"]` +
      `[data-staff-id="${pendingReserveInfo.staffId}"]`;
    if (svcId) selector += `[data-service-id="${svcId}"]`;

    const lastName = document.getElementById("lastNameInput")?.value?.trim() || "";
    const firstName = document.getElementById("firstNameInput")?.value?.trim() || "";
    const phone = document.getElementById("phoneInput")?.value?.trim() || "";
    const endTime = document.getElementById("end-time-select")?.value || "";

    localStorage.setItem(LS_KEYS.scroll, JSON.stringify({
      selector,
      meta: {
        date: pendingReserveInfo.date,
        time: pendingReserveInfo.time,
        end: endTime,                 // â† data-end ã¨ã®çªãåˆã‚ã›ã«ä½¿ã†
        staffId: pendingReserveInfo.staffId,
        serviceId: svcId,
        name: `${lastName} ${firstName}`.trim(), // â† data-name ã¨æ¯”è¼ƒ
        phone: phone                               // â† data-phone ã¨æ¯”è¼ƒï¼ˆã©ã¡ã‚‰ã‹ä¸€è‡´ã§OKï¼‰
      }
    }));


    const wrap = document.querySelector('.table-wrap');
    if (wrap) {
      localStorage.setItem(LS_KEYS.scrollPos, JSON.stringify({
        top: wrap.scrollTop,
        left: wrap.scrollLeft
      }));
    }
    
    try {
      if (typeof setLastAction === "function") setLastAction("delete");
      else localStorage.setItem(LS_KEYS.lastAction, "delete");
    } catch {}


    showReservationOverlay("å‰Šé™¤ä¸­â€¦");

    google.script.run
      .withSuccessHandler(() => {
        const startStr = formatDate(currentStartDate);
        google.script.run
          .withSuccessHandler(allData => {
            weeklyDataCache = allData;
            weeklyCache[startStr] = allData;
            initTabs(currentMode);
            hideReservationOverlay();
            highlightSavedSlotOnly();
          })
          .withFailureHandler(err => {
            hideReservationOverlay();
            alert("âŒ è¡¨å†å–å¾—å¤±æ•—ï¼š" + err.message);
          })
          .getWeeklyMatrixUnified(startStr);
      })
      .withFailureHandler(err => {
        hideReservationOverlay();
        alert("âŒ å‰Šé™¤å¤±æ•—ï¼š" + err.message);
      })
      .deleteReservation(pendingReserveInfo);
  });

// OK â†’ å‡¦ç†ã¸é€²ã‚€
document.getElementById("input-check-ok-btn").addEventListener("click", () => {
  const confirmModal = bootstrap.Modal.getInstance(document.getElementById("inputCheckModal"));
  if (confirmModal) confirmModal.hide();

  if (typeof window._onMissingConfirmOk === "function") {
    window._onMissingConfirmOk();
  }
});

// ã‚­ãƒ£ãƒ³ã‚»ãƒ« â†’ å…ƒã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æˆ»ã™
document.querySelector("#inputCheckModal .btn-secondary").addEventListener("click", () => {
  if (modalToRestore) {
    setTimeout(() => {
      const restoreModal = new bootstrap.Modal(document.getElementById(modalToRestore));
      restoreModal.show();
      modalToRestore = null;
    }, 300);
  }
});

function generateConfirmDiffHTML(original, updated) {
  const fields = [
    { key: "date", label: "æ—¥ä»˜", format: val => formatDateWithWeekday(val) },
    { key: "time", label: "é–‹å§‹æ™‚é–“" },
    { key: "endTime", label: "çµ‚äº†æ™‚é–“" },
    { key: "service", label: "ã‚µãƒ¼ãƒ“ã‚¹", format: getServiceNameById },
    { key: "staffId", label: "æ‹…å½“è€…", format: getStaffNameById },
    { key: "lastName", label: "å§“" },
    { key: "firstName", label: "å" },
    {
      key: "phone",
      label: "é›»è©±ç•ªå·",
      format: formatPhoneNumber,
      normalize: val => val.replace(/[^\d]/g, "")  // â† æ¯”è¼ƒç”¨ã«æ•´å½¢
    },
    { key: "email",   label: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
      normalize: v => String(v||"").trim().toLowerCase() }
  ];

  const lines = fields.map(({ key, label, format, normalize }) => {
    const rawOld = original?.[key] ?? "";
    const rawNew = updated?.[key] ?? "";

    const oldVal = normalize ? normalize(rawOld) : rawOld;
    const newVal = normalize ? normalize(rawNew) : rawNew;

    const formatVal = format || (v => v || "ï¼");

    if (oldVal !== newVal) {
      return `<div><strong>${label}ï¼š</strong><span class="text-danger fw-bold">${formatVal(rawOld)} â†’ ${formatVal(rawNew)}</span></div>`;
    } else {
      return `<div><strong>${label}ï¼š</strong>${formatVal(rawNew)}</div>`;
    }
  });

  return lines.join("");
}

function findMaxAvailableEndTime(startTime, date, staffId, serviceId, excludeReservation) {
  const unit = weeklyDataCache?.meta?.unitMin || 15;
  const candidates = getEndTimeCandidates(startTime, date, staffId, serviceId);
  const startMin = timeToMinutes(startTime);

  let lastValid = null;

  for (const endTime of candidates) {
    const endMin = timeToMinutes(endTime);
    let hasConflict = false;

    for (let t = startMin; t < endMin; t += unit) {
      const tStr = minutesToTime(t);
      const reasons = checkReservationAvailabilityReasons(
        date,
        tStr,
        minutesToTime(t + unit),
        staffId,
        serviceId,
        excludeReservation
      );

      const label = reasons.length > 0 ? convertReasonToLabel(reasons[0].reason || "") : "";
      
      if (["äºˆç´„æ¸ˆ", "äºˆç´„ä¸å¯"].includes(label)) {
        hasConflict = true;
        break;
      }
    }

    if (hasConflict) break;
    lastValid = endTime;
  }
  return lastValid;
}

function enableSaveIfChanged() {
  const modal = document.getElementById("viewReserveModal");
  const original = JSON.parse(modal.dataset.original || "{}");

  const date = document.getElementById("reserve-date").value;
  const time = document.getElementById("start-time-select").value;
  const endTime = document.getElementById("end-time-select").value;
  const service = document.getElementById("reserve-service").value;
  const staff = document.getElementById("reserve-staff").value;
  const last = document.getElementById("lastNameInput").value;
  const first = document.getElementById("firstNameInput").value;
  const phone = document.getElementById("phoneInput").value;
  const email = document.getElementById("emailInput").value;

  const current = {
    date,
    time,
    endTime,
    service,
    staffId: staff,
    lastName: last,
    firstName: first,
    phone,
    email,
  };

  const normalize = val => val?.toString().trim().replace(/[^\d]/g, "");
  const hasDiff = Object.keys(current).some(k => {
    const oldVal = normalize(original?.[k] || "");
    const newVal = normalize(current[k] || "");
    return oldVal !== newVal;
  });

  window.__hasReserveDiff = hasDiff;

  //å¤‰æ›´ãªã„å ´åˆã®ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³éæ´»æ€§å‡¦ç†
  //const btn = document.getElementById("view-reserve-btn");
  //if (btn) btn.disabled = !hasDiff;
}
 
function showModalInlineSpinner(on) {
  const head = document.querySelector('#viewReserveModal .modal-title');
  if (!head) return;
  if (on) {
    if (!head.querySelector('.mini-spinner')) {
      head.insertAdjacentHTML('beforeend', ' <span class="mini-spinner spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
    }
  } else {
    head.querySelector('.mini-spinner')?.remove();
  }
}

function getActiveMode() {
  if (document.querySelector('#mode-staff.active'))   return 'staff';
  if (document.querySelector('#mode-service.active')) return 'service';
  return window.currentMode || 'service';
}

// âœ… é€±ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆï¼‰ï¼‹ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚’ãã®é€±ã¸
async function ensureWeekAndApply(dateStr) {
  const weekStartStr = formatDate(toStartOfDayJST(new Date(dateStr)));

  if (!weeklyCache[weekStartStr]) {
    showModalInlineSpinner(true);
    try {
      const data = await new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getWeeklyMatrixUnified(weekStartStr);
      });
      weeklyCache[weekStartStr] = data;
    } finally {
      showModalInlineSpinner(false);
    }
  }
  weeklyDataCache = weeklyCache[weekStartStr];

  //ä»Šã®ãƒ¢ãƒ¼ãƒ‰ã‚’å›ºå®šã—ã¦ä½¿ã†
  const mode = getActiveMode();
  window.currentMode = mode; // ä¸€å¿œã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚‚åˆã‚ã›ã‚‹

  try {
    if (typeof currentStartDate !== "undefined") {
      currentStartDate = toStartOfDayJST(new Date(dateStr));
    }
    if (typeof initTabs === "function")  initTabs(mode);
    if (typeof updateLabel === "function") updateLabel();

    // ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦æç”»
    if (mode === "staff" && typeof drawTableByStaff === "function") {
      const staffId = localStorage.getItem("defaultStaffId")|| weeklyDataCache.meta.staffList[0]?.id;
      drawTableByStaff(weeklyDataCache.staffView[staffId], staffId);
    } else if (typeof drawTable === "function") {
      drawTable(weeklyDataCache, "");
    }
  } catch (_) {}
}

function focusSelectedCell({ date, time, serviceId, staffId }) {
  if (!date || !time) return;
  document.querySelectorAll('.selected-cell').forEach(el => el.classList.remove('selected-cell'));

  const candidates = [
    // âœ… è¿½åŠ ï¼šã‚µãƒ¼ãƒ“ã‚¹Ã—ã‚¹ã‚¿ãƒƒãƒ•ã§åˆ—ã‚’ç‰¹å®šï¼ˆæœ€å„ªå…ˆï¼‰
    `[data-date="${date}"][data-time="${time}"][data-service-id="${serviceId}"][data-staff-id="${staffId}"].selectable-cell`,
    // æ¬¡ç‚¹ï¼šã‚¹ã‚¿ãƒƒãƒ•ã ã‘
    `[data-date="${date}"][data-time="${time}"][data-staff-id="${staffId}"].selectable-cell`,
    // æ¬¡ç‚¹ï¼šã‚µãƒ¼ãƒ“ã‚¹ã ã‘
    `[data-date="${date}"][data-time="${time}"][data-service-id="${serviceId}"].selectable-cell`,
    // æœ€å¾Œï¼šæ™‚é–“ã ã‘
    `[data-date="${date}"][data-time="${time}"].selectable-cell`
  ];

  let target = null;
  for (const sel of candidates) {
    const list = [...document.querySelectorAll(sel)];
    if (list.length === 0) continue;
    target = list.find(el =>
      el.dataset.status === 'available' ||
      el.textContent.trim() === 'ğŸŸ¢' ||
      el.classList.contains('available')
    ) || list[0];
    if (target) break;
  }

  if (!target) return;
  target.classList.add('selected-cell');
  target.scrollIntoView({ block: "center", inline: "center", behavior: "smooth" });
}

// æº€æ ã ã‘ã‚’åˆ¤å®š
// âœ… ä»Šã®ãƒ¢ãƒ¼ãƒ€ãƒ«é¸æŠãŒã€Œäºˆç´„æ¸ˆã¿ï¼ˆè‡ªåˆ†å«ã‚€ï¼‰ã€ã‹ã‚’åˆ¤å®šï¼ˆï¼è£UIã‚’æ­¢ã‚ã‚‹æ¡ä»¶ã ã‘æ‹¾ã†ï¼‰
function isReservedSelectionNow() {
  const d  = document.getElementById("reserve-date")?.value || "";
  const st = document.getElementById("start-time-select")?.value || "";
  const sv = document.getElementById("reserve-service")?.value || "";
  const sf = document.getElementById("reserve-staff")?.value || "";
  if (!d || !st || !sv || !sf) return false;

  const endSel = document.getElementById("end-time-select")?.value || "";
  const et = endSel || calculateDefaultEndTime(st, sv);

  // è‡ªåˆ†ã‚‚ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ãŸã‚ excludeReservation ã¯æ¸¡ã•ãªã„
  const reasons = checkReservationAvailabilityReasons(d, st, et, sf, sv, /*excludeReservation=*/null) || [];

  // â›” è£UIã‚’æ­¢ã‚ã‚‹ã®ã¯ã€Œæº€æ ç³»ã€ã ã‘ã€‚
  //    ä¸‹2ã¤ã¯å¯¾è±¡å¤–ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆOKï¼‰ãªã®ã§é™¤å¤–:
  //      ãƒ»ã“ã®æ™‚é–“å¸¯ã«ã¯ä»–ã‚µãƒ¼ãƒ“ã‚¹ã®äºˆç´„ãŒå…¥ã£ã¦ã„ã¾ã™
  //      ãƒ»å–¶æ¥­æ™‚é–“å¤–ã¾ãŸã¯æ‹…å½“è€…ãŒä¸åœ¨ã§ã™
  const isFullReason = (txt) =>
    typeof txt === "string" &&
    /äºˆç´„ãŒ\d+ä»¶.*ä¸Šé™\d+/.test(txt);                  // æ­£è¦è¡¨ç¾ï¼ˆä¾‹: äºˆç´„ãŒ3ä»¶â€¦ä¸Šé™2ï¼‰

  // äº’æ›: æ–‡è¨€ãŒå¾®å¦™ã«å¤‰ã‚ã£ã¦ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ä¿é™º
  const isFullReasonFallback = (txt) =>
    typeof txt === "string" &&
    txt.includes("ã™ã§ã«äºˆç´„ãŒ") && txt.includes("ä¸Šé™");

  const isOtherService = (txt) => typeof txt === "string" && txt.includes("ä»–ã‚µãƒ¼ãƒ“ã‚¹ã®äºˆç´„");
  const isClosedOrAbsent = (txt) => typeof txt === "string" && txt.includes("å–¶æ¥­æ™‚é–“å¤–ã¾ãŸã¯æ‹…å½“è€…ãŒä¸åœ¨");

  // 1ã¤ã§ã‚‚ã€Œæº€æ ç³»ã€ç†ç”±ãŒã‚ã‚Œã°ã€è£UIæ“ä½œã¯æŠ‘æ­¢
  return reasons.some(r => {
    const t = r?.reason;
    if (isOtherService(t) || isClosedOrAbsent(t)) return false; // â† é™¤å¤–
    return isFullReason(t) || isFullReasonFallback(t);          // â† æº€æ ã ã‘ true
  });
}



function showReserveConfirmModal() {
  const modal = new bootstrap.Modal(document.getElementById("reserveConfirmModal"));
  modal.show();
}

function showReserveModal({ date, time, service, staff, serviceId, staffId, warning = "", mode = "new", original = null }) {
  const { start: minDate, end: maxDate } = getCurrentWeekRange();
  const excludeReservation = (mode === "edit" ? original : null); 

  // ğŸ”½ ã‚¿ã‚¤ãƒˆãƒ«åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
  const modalTitle = document.querySelector("#viewReserveModal .modal-title");
  if (modalTitle) {
    modalTitle.textContent = (mode === "edit") ? "äºˆç´„å¤‰æ›´" : "äºˆç´„å…¥åŠ›";
  }

  if (!warning) {
    const unit = weeklyDataCache?.meta?.unitMin || 15;
    const reasons = checkReservationAvailabilityReasons(
      date,
      time,
      calculateDefaultEndTime(time, serviceId),
      staffId,
      serviceId,
      excludeReservation
    );
    if (reasons.length > 0) {
      warning = groupReasons(reasons, unit).join("\n");
    }
  }

  const desiredEndTime = calculateDefaultEndTime(time, serviceId);
  const maxEndTime = findMaxAvailableEndTime(time, date, staffId, serviceId, excludeReservation);

  // ğŸ” desiredEndTime ãŒ maxEndTime ã‚ˆã‚Šã‚‚å¾Œã‚ãªã‚‰ã€ãã“ã¾ã§ã¯å–ã‚Œãªã„ã¨ã„ã†ã“ã¨
  let selectedEndTime = (!maxEndTime || timeToMinutes(desiredEndTime) <= timeToMinutes(maxEndTime))
    ? desiredEndTime
    : maxEndTime;

  const body = document.getElementById("reserve-modal-body");

  body.innerHTML = `
    <div id="reserve-warning" class="text-danger mb-2 ${warning ? "" : "d-none"}">
      ${warning ? `${warning.replace(/\n/g, "<br>")}` : ""}
    </div>
    <div class="mb-1">
      <label class="form-label fw-bold">æ—¥ä»˜</label>
      <input type="date" class="form-control form-control-sm"
            id="reserve-date"
            value="${date}"
      </div>
    <div class="mb-1">
      <label class="form-label fw-bold d-block">æ™‚é–“</label>
      <div class="d-flex align-items-center">
        <select class="form-select form-select-sm me-1" id="start-time-select" style="width:auto;">
          ${generateStartTimeOptionsHTML(date, time, staffId, serviceId, excludeReservation)} 
        </select>
        <span class="me-1">ï½</span>
        <select class="form-select form-select-sm" id="end-time-select" style="width:auto;">
          ${generateEndTimeOptionsHTML(time, date, selectedEndTime, staffId, serviceId, excludeReservation)} 
        </select>
      </div>
    </div>
    <div class="mb-1">
      <label class="form-label fw-bold">ã‚µãƒ¼ãƒ“ã‚¹</label>
      <select class="form-select form-select-sm" id="reserve-service">
        ${generateServiceOptionsHTML(serviceId)}
      </select>
    </div>
    <div class="mb-1">
      <label class="form-label fw-bold">æ‹…å½“è€…</label>
      <select class="form-select form-select-sm" id="reserve-staff">
        ${generateStaffOptionsHTML(staffId, serviceId)}
      </select>
    </div>
    <div class="form-check mb-1">
      <input class="form-check-input" type="checkbox" id="reserve-designated">
      <label class="form-check-label" for="reserve-designated">æ‹…å½“è€…æŒ‡åã®å ´åˆã¯ãƒã‚§ãƒƒã‚¯</label>
    </div>
    <div class="mb-1">
      <label for="customer-select" class="form-label fw-bold">ç™»éŒ²æ¸ˆã¿é¡§å®¢</label>
      <select id="customer-select" class="form-select form-select-sm"></select>
    </div>
    <div class="row mb-1">
      <div class="col-6">
        <label class="form-label fw-bold">å§“</label>
        <input type="text" class="form-control form-control-sm" id="lastNameInput" />
      </div>
      <div class="col-6">
        <label class="form-label fw-bold">å</label>
        <input type="text" class="form-control form-control-sm" id="firstNameInput" />
      </div>
    </div>
    <div class="mb-1">
      <label class="form-label fw-bold">é›»è©±ç•ªå·</label>
      <input type="tel" class="form-control form-control-sm" id="phoneInput" />
    </div>
    <div class="mb-1">
      <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
      <input type="email" id="emailInput" class="form-control" placeholder="example@mail.com" autocomplete="email">
    </div>
  `;

  {
    const chk = document.getElementById("reserve-designated");
    if (mode === "edit" && original && typeof original.designated !== "undefined") {
      chk.checked = !!original.designated;
    } else {
      // æ–°è¦ã®å ´åˆã‚„ original ã«æƒ…å ±ãŒãªã„å ´åˆ â†’ é¸æŠã‚»ãƒ«ã® dataset ã‹ã‚‰æ‹¾ã†
      const selCell = document.querySelector('#table-area td.selected-cell');
      if (selCell && selCell.dataset.designated) {
        chk.checked = (selCell.dataset.designated === "true");
      }
    }
  }

  // é¡§å®¢ãƒªã‚¹ãƒˆè¡¨ç¤º
  populateCustomerSelect();

  // 2. é¸æŠã‚’åæ˜ ï¼ˆé…å»¶ã¾ãŸã¯ render ã‚’ Promise åŒ–ã™ã‚‹ï¼‰
  setTimeout(() => {
    const custSelect = document.getElementById("customer-select");

    if (mode === "edit" && original?.phone) {
      const phoneRaw = original.phone;
      const phone = phoneRaw.replace(/-/g, "");

      const found = Array.from(custSelect.options).some(opt => opt.value === phone);

      if (custSelect && found) {
        custSelect.value = phone;
        custSelect.dispatchEvent(new Event("change"));
      } else {
        document.getElementById("lastNameInput").value = original.lastName || "";
        document.getElementById("firstNameInput").value = original.firstName || "";
        document.getElementById("phoneInput").value = original.phone || "";
        document.getElementById("emailInput").value = original.email || "";
        document.getElementById("reserve-designated").checked = !!original.designated;
      }
    }
  }, 50);

  // âœ… ç·¨é›†æƒ…å ±ã‚’ä¿æŒ
  const modalEl = document.getElementById("viewReserveModal");
  modalEl.dataset.mode = mode;
  modalEl.dataset.original = original ? JSON.stringify(original) : "";

  pendingReserveInfo = {
    date,
    time,
    serviceId,
    staffId,
    mode,
    original,
  };

  persistPendingInfo();

  // âœ… ãƒœã‚¿ãƒ³æ–‡è¨€å¤‰æ›´
  const saveBtn = document.getElementById("view-reserve-btn");
  if (saveBtn) {
    saveBtn.textContent = (mode === "edit") ? "æ¬¡ã¸" : "æ¬¡ã¸";
    saveBtn.disabled = (mode === "edit");
  }

  if (mode === "edit") {
    saveBtn.disabled = true;  // â† åˆæœŸã¯éæ´»æ€§
  }

  // âœ… ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®è£œå®Œå‡¦ç†
  if (mode === "edit" && original) {
    document.getElementById("reserve-date").value = original.date || date;
    document.getElementById("start-time-select").value = original.time || time;
    document.getElementById("end-time-select").value = original.endTime || desiredEndTime;
    document.getElementById("reserve-service").value = original.service || serviceId;
    document.getElementById("reserve-staff").value = original.staffId || staffId;
    document.getElementById("lastNameInput").value = original.lastName || "";
    document.getElementById("firstNameInput").value = original.firstName || "";
    document.getElementById("phoneInput").value = original.phone || "";
    document.getElementById("emailInput").value = original.email || "";
  }

  // æ—¥ä»˜å¤‰æ›´æ™‚ã®é€±ã¾ãŸããƒã‚§ãƒƒã‚¯
  document.getElementById("reserve-date")?.addEventListener("change", async (e) => {
    const newDate = e.target.value;

    await ensureWeekAndApply(newDate); // è£ã ã‘æ›´æ–°ï¼ˆãƒ¢ãƒ¼ãƒ‰ç¶­æŒï¼‰

    updateTimeOptions((mode === "edit" ? original : null));
    updateReserveWarning((mode === "edit" ? original : null));
    
    if (isReservedSelectionNow()) return;

    // æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§ä¸­å¤®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼†ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    requestAnimationFrame(() => {
      focusSelectedCell({
        date: newDate,
        time: document.getElementById("start-time-select")?.value || "",
        serviceId: document.getElementById("reserve-service")?.value || "",
        staffId: document.getElementById("reserve-staff")?.value || ""
      });
    });
  });

  // çµ‚äº†æ™‚é–“ã®å€™è£œæ›´æ–°
  document.getElementById("start-time-select")?.addEventListener("change", () => {
    const startTime = document.getElementById("start-time-select").value;
    const date = document.getElementById("reserve-date").value;
    const staffId = document.getElementById("reserve-staff").value;
    const serviceId = document.getElementById("reserve-service").value;
    const endSelect = document.getElementById("end-time-select");

    const modalEl = document.getElementById("viewReserveModal");
    let excludeReservation = null;
    let mode = "new";
    try {
      excludeReservation = JSON.parse(modalEl?.dataset?.original || "null");
      mode = modalEl?.dataset?.mode || "new";
    } catch (_) {}

    let currentEndTime = endSelect.value || "";
    let selectedEndTime = "";

    if (mode === "edit" && excludeReservation) {
      const adjustedEnd = getAdjustedEndTimeForEditMode(
        startTime,
        currentEndTime,
        date,
        staffId,
        serviceId,
        excludeReservation
      );
      selectedEndTime = getAdjustedEndTimeIfInvalid(
        startTime,
        adjustedEnd,
        date,
        staffId,
        serviceId,
        excludeReservation
      );
    } else {
      const desiredEndTime = calculateDefaultEndTime(startTime, serviceId);
      const maxEndTime = findMaxAvailableEndTime(
        startTime,
        date,
        staffId,
        serviceId,
        excludeReservation
      );
      selectedEndTime = (!maxEndTime || timeToMinutes(desiredEndTime) <= timeToMinutes(maxEndTime))
        ? desiredEndTime
        : maxEndTime;
    }

    // âœ… å¸¸ã«çµ‚äº†æ™‚é–“ã®å€™è£œã‚’æ›´æ–°ã™ã‚‹ â† ã“ã“ãŒå¤§äº‹ï¼
    endSelect.innerHTML = generateEndTimeOptionsHTML(
      startTime,
      date,
      selectedEndTime,
      staffId,
      serviceId,
      excludeReservation
    );

    // âœ… value ã‚’è¨­å®šï¼ˆãªã‘ã‚Œã°å…ˆé ­ï¼‰
    const endValues = [...endSelect.options].map(opt => opt.value);
    endSelect.value = endValues.includes(selectedEndTime) ? selectedEndTime : endValues[0] || "";
    requestAnimationFrame(() => {
      focusSelectedCell({
        date,
        time: startTime,
        serviceId,
        staffId
      });
    });
  });

  // ã‚µãƒ¼ãƒ“ã‚¹å¤‰æ›´æ™‚ï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚‚å«ã‚€ï¼‰
  document.getElementById("reserve-service")?.addEventListener("change", () => {
    const newServiceId = document.getElementById("reserve-service").value;
    const staffSelect = document.getElementById("reserve-staff");

    staffSelect.innerHTML = generateStaffOptionsHTML(null, newServiceId);
    staffSelect.selectedIndex = 0;
    const newStaffId = staffSelect.options[0]?.value || "";

    updateTimeOptions(original);
    updateReserveWarning((mode === "edit" ? original : null));

    if (isReservedSelectionNow()) return;

    const inServiceMode = document.querySelector("#mode-service.active");
    if (inServiceMode) {
      activateTabByDataId("#service-tabs", "service", newServiceId);
    }
    const inStaffMode = document.querySelector("#mode-staff.active");
    if (inStaffMode && newStaffId) {
      activateTabByDataId("#service-tabs", "staff", newStaffId);
    }

    focusSelectedCell({
      date: document.getElementById("reserve-date")?.value || "",
      time: document.getElementById("start-time-select")?.value || "",
      serviceId: newServiceId,
      staffId: newStaffId
    });
  });

  // ã‚¹ã‚¿ãƒƒãƒ•å¤‰æ›´æ™‚
  document.getElementById("reserve-staff")?.addEventListener("change", () => {
    const newStaffId = document.getElementById("reserve-staff").value;

    updateTimeOptions(original);
    updateReserveWarning((mode === "edit" ? original : null));

    if (isReservedSelectionNow()) return;

    const inServiceMode = document.querySelector("#mode-service.active");
    if (inServiceMode && newStaffId) {
      // ã‚µãƒ¼ãƒ“ã‚¹è¡¨ç¤ºä¸­ã§ã‚‚ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¿ãƒ–å†…ã®ã€Œã‚¹ã‚¿ãƒƒãƒ•åˆ—ã€ã‚’åˆ‡æ›¿
      activateTabByDataId("#service-tabs", "staff", newStaffId);
    }

    const inStaffMode = document.querySelector("#mode-staff.active");
    if (inStaffMode && newStaffId) {
      activateTabByDataId("#service-tabs", "staff", newStaffId);
    }

    // ã‚¿ãƒ–åˆ‡æ›¿ç›´å¾Œã¯æç”»å®Œäº†ã‚’1ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    requestAnimationFrame(() => {
      focusSelectedCell({
        date: document.getElementById("reserve-date")?.value || "",
        time: document.getElementById("start-time-select")?.value || "",
        serviceId: document.getElementById("reserve-service")?.value || "",
        staffId: newStaffId
      });
    });
  });


  const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
  modalInstance.show();
  attachModalInputListeners();
  updateReserveWarning((mode === "edit" ? original : null));

  if (mode === "edit") {
    const ids = [
      "reserve-date", "start-time-select", "end-time-select",
      "reserve-service", "reserve-staff",
      "lastNameInput", "firstNameInput", "phoneInput","emailInput",
      "customer-select"
    ];
    for (const id of ids) {
      document.getElementById(id)?.addEventListener("input", enableSaveIfChanged);
      document.getElementById(id)?.addEventListener("change", enableSaveIfChanged);
    }
  }

  setTimeout(() => {
    setupModalScrollListeners();
    scrollToSelectedSlotInModal();  // æœ€åˆã«ä¸€å›ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  }, 300);
}


// â± é–‹å§‹æ™‚é–“ + æ‰€è¦æ™‚é–“ â†’ åˆæœŸã®çµ‚äº†æ™‚é–“ã‚’è¿”ã™
function calculateDefaultEndTime(startTime, serviceId) {
  const serviceList = weeklyDataCache?.meta?.serviceList || [];
  const svc = serviceList.find(s => s.id === serviceId);
  if (!svc) return "";

  const duration = Number(svc.duration) || 0; // å˜ä½ã¯ã€Œåˆ†ã€
  const startMin = timeToMinutes(startTime);
  const endMin = startMin + duration;

  return minutesToTime(endMin);
}

if (prefillDate) {
  const targetDate = new Date(prefillDate);
  currentStartDate = toStartOfDayJST(targetDate);
}

//ã‚µãƒ‹ã‚¿ã‚¤ã‚º
function escapeHtml(str) {
  if (str == null) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}


window.addEventListener("DOMContentLoaded", () => {
  console.log("[CHILD] DOMContentLoaded â†’ child-ready ã‚’è¦ªã¸é€ä¿¡");
  try {
    window.top.postMessage(
      { type: "misemaru:child-ready", origin: location.origin },
      "*" // è¦ªå´ã§å¿…ãš event.origin ã‚’æ¤œè¨¼ã™ã‚‹ã®ã§å®‰å…¨
    );
  } catch (err) {
    console.error("[CHILD] child-ready é€ä¿¡å¤±æ•—:", err);
  }

  const staffBtn = document.getElementById("mode-staff");
  const serviceBtn = document.getElementById("mode-service");

  const savedMode = localStorage.getItem("calendarMode");
  if (savedMode === "staff" || savedMode === "service") {
    currentMode = savedMode;
  } else if (staffBtn?.classList.contains("active")) {
    currentMode = "staff";
  } else {
    currentMode = "service";
  }

  setToggleUI(currentMode);
  initTabs(currentMode);

  // âœ… idle ã‚¿ã‚¤ãƒãƒ¼åˆæœŸåŒ–
  resetIdleTimer();

  // âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
  ['click','keydown','touchstart','scroll','mousemove'].forEach(ev => {
  window.addEventListener(ev, () => {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼ˆèª¤ã‚¿ãƒƒãƒ—ã§é–‰ã˜ãªã„ã‚ˆã†ã«ï¼‰
    const modalShown = document.getElementById('idleModal')?.classList.contains('show');
    if (!modalShown) resetIdleTimer();
  }, { passive: true });
});

  // âœ… ã‚¹ãƒãƒ›å¯¾å¿œï¼šå¾©å¸°æ™‚ã« idle ãƒã‚§ãƒƒã‚¯
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      // å¾©å¸°æ™‚ã¯ pageshow ã¨åŒã˜åˆ¤å®šã§OKï¼ˆä¿é™ºï¼‰
      if (idle.deadline && Date.now() >= idle.deadline) {
        clearIdleTimers();
        idle.gen++;
        showIdleConfirmModal();
      } else {
        const remaining = idle.deadline ? Math.max(0, idle.deadline - Date.now()) : IDLE_LIMIT;
        armIdle(remaining);
      }
    } else {
      // éè¡¨ç¤ºã«ãªã‚‹ç¬é–“ã§ã¯ç‰¹åˆ¥ãªã“ã¨ã¯ä¸è¦ï¼ˆç· åˆ‡ã¯ deadline ã§ä¿æŒï¼‰
      // ã‚¿ã‚¤ãƒãƒ¼ã¯OSå´ã§æ­¢ã¾ã£ã¦ã‚‚ã€å¾©å¸°æ™‚ã«deadlineåŸºæº–ã§å†è©•ä¾¡ã™ã‚‹
    }
  });

  const startStr = formatDate(currentStartDate);
  showLoadingSpinner();

  google.script.run.withSuccessHandler(data => {
    cachedCustomerList = data || [];
    isCustomerListReady = true;
  }).getCustomerList();

  // âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯ DOM èª­ã¿è¾¼ã¿å¾Œã«å®‰å…¨ã«ç™»éŒ²
  const tableArea = document.getElementById("table-area");
  if (tableArea) {
    tableArea.addEventListener("click", function (e) {
    const cell = e.target.closest("td");
    if (!cell || !cell.classList.contains("selectable-cell")) return;

    document.getElementById("page-end")?.scrollIntoView({ behavior: "smooth" });

    const content = cell.textContent.trim();

    const date = cell.dataset.date;
    const time = cell.dataset.time;
    let staffId = cell.dataset.staffId || "";
    let serviceId = cell.dataset.serviceId || "";

    const siblings = [...tableArea.querySelectorAll(`td[data-date="${date}"][data-time="${time}"][data-staff-id="${staffId}"][data-service-id="${serviceId}"]`)];
    const colIndex = siblings.indexOf(cell);  // â† ç¾åœ¨ã®åˆ—ã‚’ç‰¹å®š

    pendingReserveInfo = { date, time, staffId, serviceId, colIndex, mode: currentMode };
    persistPendingInfo?.(); 

    if (currentMode === "service") {
      const activeTab = document.querySelector("#service-tabs .active");
      serviceId = activeTab?.dataset.serviceId || serviceId;
    }
    if (currentMode === "staff") {
      const activeTab = document.querySelector("#service-tabs .active");
      staffId = activeTab?.dataset.staffId || staffId;
    }

    pendingReserveInfo = { date, time, staffId, serviceId };

    const name = cell.dataset.name || "";
    const start = cell.dataset.start || time;
    const end = cell.dataset.end || "";
    const phone = cell.dataset.phone || "";
    const email = cell.dataset.email || "";
    const cutStyle = cell.dataset.cutstyle || "";
    const note = cell.dataset.note || "";
    const request = cell.dataset.request || "";


    const staff = getStaffNameById(staffId);
    const service = getServiceNameById(serviceId);
    if (["ã€‡", "ï¼", "Ã—"].includes(content)) {
      if (!isCustomerListReady) {
        alert("âš ï¸ é¡§å®¢æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        return;
      }

      showReserveModalWithDataCheck({
        date,
        time,
        staff,
        service,
        serviceId,
        staffId
      });
    }else {
      const body = document.getElementById("confirm-modal-body");

      const [lastName, firstName] = name.split(" ");
      const designatedAttr = cell.dataset.designated;
      const isDesignated = (designatedAttr === "true");
      pendingReserveInfo = {
        date,
        time: start,
        endTime: end,
        service: serviceId,
        staffId,
        lastName: lastName || "",
        firstName: firstName || "",
        phone: phone || "",
        email,
        cutStyle,
        note,
        request,
        designated: isDesignated
      };
      
      const staffLabel = (designatedAttr === "true") ? "ï¼ˆæŒ‡åï¼‰"
                        : (designatedAttr === "false") ? "" : "";
      const staffForModal = `${staff}${staffLabel}`;

      body.innerHTML = `
        <div><span class="fw-bold mb-1">æ—¥ä»˜ï¼š</span> ${formatDateWithWeekday(date)}</div>
        <div><span class="fw-bold mb-1">é–‹å§‹æ™‚é–“ï¼š</span> ${start}</div>
        <div><span class="fw-bold mb-1">çµ‚äº†æ™‚é–“ï¼š</span> ${end}</div>
        <div><span class="fw-bold mb-1">ã‚µãƒ¼ãƒ“ã‚¹ï¼š</span> ${service}</div>
        <div><span class="fw-bold mb-1">æ‹…å½“è€…ï¼š</span> ${staffForModal}</div>
        <div><span class="fw-bold mb-1">äºˆç´„è€…åï¼š</span> ${name}</div>
        <div><span class="fw-bold mb-1">é›»è©±ç•ªå·ï¼š</span> ${phone || "ï¼"}</div>
        <div><span class="fw-bold mb-1">ãƒ¡ãƒ¼ãƒ«ï¼š</span> ${email || "ï¼"}</div>
        <div><span class="fw-bold mb-1">ã‚«ãƒƒãƒˆã‚¹ã‚¿ã‚¤ãƒ«ï¼š</span> ${cutStyle || "ï¼"}</div>
        <div><span class="fw-bold mb-1">ãŠå®¢æ§˜ã‹ã‚‰ã®è¦æœ›ï¼š</span> ${ request ? escapeHtml(request) : "ï¼" }</div>
        <div><span class="fw-bold">å‚™è€ƒï¼š</span> ${note || "ï¼"}</div>
      `;


      new bootstrap.Modal(document.getElementById("viewConfirmModal")).show();
    }

      e.preventDefault(); // ãƒšãƒ¼ã‚¸é·ç§»é˜²æ­¢
    });
  }

  google.script.run.withSuccessHandler(data => {
    const select = document.getElementById("customer-select");
    if (!select) return;

    data.forEach(cust => {
      const option = document.createElement("option");
      option.value = `${cust.lastName}|${cust.firstName}|${cust.tel}|${cust.email}`;
      option.textContent = `${cust.lastName} ${cust.firstName}`;
      select.appendChild(option);
    });

    select.addEventListener("change", e => {
      const [last, first, tel, email] = e.target.value.split("|");
      document.getElementById("lastNameInput").value = last || "";
      document.getElementById("firstNameInput").value = first || "";
      document.getElementById("phoneInput").value = tel || "";
      document.getElementById("emailInput").value = email || "";
    });
  }).getCustomerList();

  google.script.run
    .withSuccessHandler(allData => {
      weeklyDataCache = allData;
      weeklyCache[startStr] = allData;

      isSingleStaffMode = allData?.meta?.staffList?.length === 1;

      if (isSingleStaffMode) {
        document.getElementById("display-mode-toggle").style.display = "none";
        document.getElementById("service-tabs").style.display = "none";

        setupCategorySelect();
        updateLabel();
        const staff = allData.meta.staffList[0];
        drawTableByStaff(allData.staffView[staff.id], staff.id);
        adjustTableMinWidth();
      } else {
        document.getElementById("display-mode-toggle").style.display = "block";
        document.getElementById("service-tabs").style.display = "flex";

        const savedMode = localStorage.getItem("calendarMode") || "staff";
        currentMode = savedMode;
        setToggleUI(savedMode);
        setupCategorySelect(); 
        initTabs(savedMode);
      }
      hideReservationOverlay();
    })

    .withFailureHandler(err => {
      document.getElementById("table-area").innerHTML = `<div class='text-danger'>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
    })
    .getWeeklyMatrixUnified(startStr);
});



let resizeTimer;
window.addEventListener("resize", () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    const startStr = formatDate(currentStartDate);
    const allData = weeklyCache[startStr];
    if (!allData) return;

    if (isSingleStaffMode) {
      const staff = allData.meta.staffList[0];
      drawTableByStaff(allData.staffView[staff.id], staff.id);
    } else {
      const mode = currentMode;
      const activeTab = document.querySelector("#service-tabs .active");

      if (mode === "service" && activeTab) {
        const serviceId = activeTab.dataset.serviceId;
        drawTable(allData.services[serviceId], serviceId);
      }

      if (mode === "staff" && activeTab) {
        const staffId = activeTab.dataset.staffId;
        drawTableByStaff(allData.staffView[staffId], staffId);
      }
    }

    // âœ… å†æç”»ã®ã‚ã¨ã« width èª¿æ•´ã‚’ã‹ã‘ã‚‹
    setTimeout(() => {
      adjustTableMinWidth();
    }, 50); // å°‘ã—é…ã‚‰ã›ã¦åæ˜ ã•ã›ã‚‹
  }, 150);
});

function populateCustomerSelect() {
  if (!cachedCustomerList || cachedCustomerList.length === 0) return;
  renderCustomerSelect(cachedCustomerList, "customer-select");
}


function renderCustomerSelect(customers, selectId = "customer-select", prefix = "") {
  const select = document.getElementById(selectId);
  if (!select) return;

  select.innerHTML = '<option value="">-- æ–°è¦é¡§å®¢ --</option>';

  const gojuonMap = {
    ã‚¢: "ã‚¢è¡Œ", ã‚¤: "ã‚¢è¡Œ", ã‚¦: "ã‚¢è¡Œ", ã‚¨: "ã‚¢è¡Œ", ã‚ª: "ã‚¢è¡Œ",
    ã‚«: "ã‚«è¡Œ", ã‚­: "ã‚«è¡Œ", ã‚¯: "ã‚«è¡Œ", ã‚±: "ã‚«è¡Œ", ã‚³: "ã‚«è¡Œ",
    ã‚µ: "ã‚µè¡Œ", ã‚·: "ã‚µè¡Œ", ã‚¹: "ã‚µè¡Œ", ã‚»: "ã‚µè¡Œ", ã‚½: "ã‚µè¡Œ",
    ã‚¿: "ã‚¿è¡Œ", ãƒ: "ã‚¿è¡Œ", ãƒ„: "ã‚¿è¡Œ", ãƒ†: "ã‚¿è¡Œ", ãƒˆ: "ã‚¿è¡Œ",
    ãƒŠ: "ãƒŠè¡Œ", ãƒ‹: "ãƒŠè¡Œ", ãƒŒ: "ãƒŠè¡Œ", ãƒ: "ãƒŠè¡Œ", ãƒ: "ãƒŠè¡Œ",
    ãƒ: "ãƒè¡Œ", ãƒ’: "ãƒè¡Œ", ãƒ•: "ãƒè¡Œ", ãƒ˜: "ãƒè¡Œ", ãƒ›: "ãƒè¡Œ",
    ãƒ: "ãƒè¡Œ", ãƒŸ: "ãƒè¡Œ", ãƒ : "ãƒè¡Œ", ãƒ¡: "ãƒè¡Œ", ãƒ¢: "ãƒè¡Œ",
    ãƒ¤: "ãƒ¤è¡Œ", ãƒ¦: "ãƒ¤è¡Œ", ãƒ¨: "ãƒ¤è¡Œ",
    ãƒ©: "ãƒ©è¡Œ", ãƒª: "ãƒ©è¡Œ", ãƒ«: "ãƒ©è¡Œ", ãƒ¬: "ãƒ©è¡Œ", ãƒ­: "ãƒ©è¡Œ",
    ãƒ¯: "ãƒ¯è¡Œ", ãƒ²: "ãƒ¯è¡Œ", ãƒ³: "ãƒ¯è¡Œ"
  };

  const grouped = {};
  customers.forEach(c => {
    const kana = (c.lastKana || "").normalize("NFKC").replace(/[^ã‚¡-ãƒ³]/g, "");
    const firstChar = kana.charAt(0);
    const baseChar = firstChar.replace(/[ã‚¬ã‚®ã‚°ã‚²ã‚´]/, "ã‚«")
                              .replace(/[ã‚¶ã‚¸ã‚ºã‚¼ã‚¾]/, "ã‚µ")
                              .replace(/[ãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰]/, "ã‚¿")
                              .replace(/[ãƒãƒ“ãƒ–ãƒ™ãƒœ]/, "ãƒ")
                              .replace(/[ãƒ‘ãƒ”ãƒ—ãƒšãƒ]/, "ãƒ");
    const group = gojuonMap[baseChar] || "ãã®ä»–";
    if (!grouped[group]) grouped[group] = [];
    grouped[group].push(c);
  });

  const gojuonOrder = ["ã‚¢è¡Œ", "ã‚«è¡Œ", "ã‚µè¡Œ", "ã‚¿è¡Œ", "ãƒŠè¡Œ", "ãƒè¡Œ", "ãƒè¡Œ", "ãƒ¤è¡Œ", "ãƒ©è¡Œ", "ãƒ¯è¡Œ", "ãã®ä»–"];
  gojuonOrder.forEach(group => {
    if (!grouped[group]) return;
    const optGroup = document.createElement("optgroup");
    optGroup.label = group;
    grouped[group].forEach(c => {
      const option = document.createElement("option");
      option.value = (c.phone || "").replace(/-/g, "");
      option.textContent = `${c.lastName} ${c.firstName}`;
      optGroup.appendChild(option);
    });
    select.appendChild(optGroup);
  });

  select.addEventListener("change", function () {
    const selected = cachedCustomerList.find(c => (c.phone || "").replace(/-/g, "") === this.value);

    document.getElementById(`${prefix}lastNameInput`).value = selected ? selected.lastName : "";
    document.getElementById(`${prefix}firstNameInput`).value = selected ? selected.firstName : "";
    document.getElementById(`${prefix}phoneInput`).value = selected ? selected.phone : "";
    document.getElementById(`${prefix}emailInput`).value = selected ? selected.email : "";
  });
}

/*ã€€=============================================================================================== */
/*ã€€                                        ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºç³»ã€€ã€€                                         */
/*ã€€=============================================================================================== */

function saveScrollPosition(mode, id) {
  const el = document.querySelector('.table-wrap');
  if (!el || !mode || !id) return;
  const key = `${mode}_${id}`;
  scrollMemory[key] = {
    left: el.scrollLeft,
    top: el.scrollTop
  };
}

function restoreScrollPosition(mode, id) {
  const el = document.querySelector('.table-wrap');
  if (!el || !mode || !id) return;
  const key = `${mode}_${id}`;
  const pos = scrollMemory[key];
  if (pos) {
    el.scrollTo(pos.left, pos.top);
  }
}

function resetScrollMemory() {
  scrollMemory = { service: {}, staff: {} };
}

function scrollToAndHighlight(date, time, staffId, serviceId) {
  const selector = `[data-date="${date}"][data-time="${time}"][data-staff-id="${staffId}"][data-service-id="${serviceId}"]`;
  const target = document.querySelector(selector);
  if (!target) return;

  target.classList.add("highlighted");
  //target.scrollIntoView({ behavior: "smooth", block: "center" });

  setTimeout(() => {
    target.classList.remove("highlighted");
  }, 3000);
}

// ã‚«ãƒ†ã‚´ãƒªçŠ¶æ…‹ï¼ˆç®¡ç†ç”»é¢ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆâ€œã™ã¹ã¦â€ï¼‰
let activeCategoryMain = localStorage.getItem("activeCategoryMain") || "__ALL__";

// ã‚«ãƒ†ã‚´ãƒªã‚»ãƒ¬ã‚¯ãƒˆã®æ§‹ç¯‰ãƒ»è¡¨ç¤ºåˆ¶å¾¡
function setupCategorySelect() {
  const wrap = document.getElementById("category-main-wrap");
  const sel  = document.getElementById("category-main-select");

  wrap.style.display = "none";
  sel.innerHTML = "";

  const cats = (weeklyDataCache?.meta?.categories || []).filter(v => String(v).trim() !== "");
  if (cats.length === 0) {
    activeCategoryMain = "__ALL__";
    return;
  }

  sel.innerHTML = [
    `<option value="__ALL__">ã™ã¹ã¦</option>`,
    ...cats.map(c => `<option value="${c}">${c}</option>`)
  ].join("");

  if (![ "__ALL__", ...cats ].includes(activeCategoryMain)) {
    activeCategoryMain = "__ALL__";
  }
  sel.value = activeCategoryMain;
  wrap.style.display = "block";

  sel.onchange = () => {
    activeCategoryMain = sel.value || "__ALL__";
    localStorage.setItem("activeCategoryMain", activeCategoryMain);

    // â˜… SingleStaffMode ã§ã¯ã‚¹ã‚¿ãƒƒãƒ•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å›ºå®š
    if (isSingleStaffMode) {
      if (currentMode !== "staff") {
        currentMode = "staff";
        setToggleUI("staff");
        localStorage.setItem("calendarMode", "staff");
      }
      initTabs("staff");
    } else {
      initTabs(currentMode);
    }
  };
}


// ã‚«ãƒ†ã‚´ãƒªã§ã‚µãƒ¼ãƒ“ã‚¹é…åˆ—ã‚’çµã‚Šè¾¼ã‚€
function filterServicesByActiveCategory(services) {
  if (!Array.isArray(services)) return [];
  if (activeCategoryMain === "__ALL__") return services;
  const metaList = (weeklyDataCache?.meta?.serviceList) || [];
  const catMap = Object.fromEntries(metaList.map(s => [s.id, s.categoryMain || ""]));
  return services.filter(s => {
    const cat = (s.categoryMain ?? catMap[s.id] ?? "");
    return cat === activeCategoryMain;
  });
}

function initTabs(mode) {
  const startStr = formatDate(currentStartDate);
  const allData = weeklyCache[startStr];
  if (!allData) {
    console.warn("ğŸš« ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒãªã„", startStr);
    return;
  }

  weeklyDataCache = allData;
  const tabsContainer = document.getElementById("service-tabs");
  tabsContainer.innerHTML = "";
  updateLabel();
  showLoadingSpinner();

  if (mode === "service") {
    const serviceList = filterServicesByActiveCategory(
      [...allData.meta.serviceList].sort((a, b) => (a.order || 0) - (b.order || 0))
    );

    const savedServiceId = localStorage.getItem("defaultServiceId") || serviceList[0]?.id;
    let found = false;

    serviceList.forEach(service => {
      const btn = document.createElement("button");
      btn.className = "btn btn-outline-primary";
      btn.dataset.serviceId = service.id;
      // name ã¯å°ã‚«ãƒ†ã‚´ãƒª (categorySub) ãŒå…¥ã£ã¦ã‚‹æƒ³å®š
      btn.textContent = service.categorySub || service.name || service.id;

      if (service.id === savedServiceId) {
        btn.classList.add("active");
        found = true;
      }

      btn.addEventListener("click", () => {
        saveScrollPosition("service", localStorage.getItem("defaultServiceId"));

        document.querySelectorAll('#service-tabs button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        drawTable(allData.services[service.id], service.id);
        adjustTableMinWidth();
        localStorage.setItem("defaultServiceId", service.id);

        restoreScrollPosition("service", service.id);
      });

      tabsContainer.appendChild(btn);
    });

    const targetId = found ? savedServiceId : serviceList[0].id;
    drawTable(allData.services[targetId], targetId);
    adjustTableMinWidth();
    const targetBtn = document.querySelector(`#service-tabs button[data-service-id="${targetId}"]`);
    if (targetBtn) targetBtn.classList.add("active");
    restoreScrollPosition("service", targetId);
    highlightSavedSlotOnly();
  }

  if (mode === "staff") {
  const staffList = allData.meta.staffList;
  let savedStaffId = localStorage.getItem("defaultStaffId");

  const isValidStaffId = staffList.some(s => s.id === savedStaffId);
  if (!isValidStaffId) {
    savedStaffId = staffList[0]?.id;
    localStorage.setItem("defaultStaffId", savedStaffId);
  }

  staffList.forEach(staff => {
    const btn = document.createElement("button");
    btn.className = "btn btn-outline-primary";
    btn.dataset.staffId = staff.id;
    btn.textContent = staff.name || staff.id;

    if (staff.id === savedStaffId) {
      btn.classList.add("active");
    }

    btn.addEventListener("click", () => {
      saveScrollPosition("staff", localStorage.getItem("defaultStaffId"));

      document.querySelectorAll('#service-tabs button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      drawTableByStaff(allData.staffView[staff.id], staff.id);
      adjustTableMinWidth();
      localStorage.setItem("defaultStaffId", staff.id);

      restoreScrollPosition("staff", staff.id);
      highlightSavedSlotOnly();
    });

    tabsContainer.appendChild(btn);
  });

  drawTableByStaff(allData.staffView[savedStaffId], savedStaffId);
  adjustTableMinWidth();
  const firstBtn = document.querySelector(`#service-tabs button[data-staff-id="${savedStaffId}"]`);
  if (firstBtn) firstBtn.classList.add("active");
}



  isLoading = false;
}

function formatDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function updateLabel() {
  const end = new Date(currentStartDate);
  end.setDate(currentStartDate.getDate() + 6);

  const options = { month: 'numeric', day: 'numeric', weekday: 'short' };
  const startStr = currentStartDate.toLocaleDateString('ja-JP', options);
  const endStr = end.toLocaleDateString('ja-JP', options);

  const yearStr = `${currentStartDate.getFullYear()}å¹´`;

  document.getElementById("week-label").textContent = `${yearStr} ${startStr}ã€œ${endStr}`;
}

function changeWeek(deltaDays) {      // deltaDays ã¯ -7 / +7 ã‚’æƒ³å®š
  if (isLoading) return;
  currentStartDate = toStartOfDayJST(new Date(currentStartDate.getTime() + deltaDays * 86400000));

  const key = formatDate(toStartOfDayJST(currentStartDate));
  if (weeklyCache[key]) {
    weeklyDataCache = weeklyCache[key];
    initTabs(currentMode);            // â† æ—¢å­˜ã®å†æç”»å…¥å£
  } else {
    isLoading = true;
    showReservationOverlay("äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦");
    google.script.run
      .withSuccessHandler(data => {
        hideReservationOverlay();
        isLoading = false;
        weeklyCache[key] = data;
        weeklyDataCache = data;
        setupCategorySelect(); 
        initTabs(currentMode);
      })
      .withFailureHandler(err => {
        hideReservationOverlay();
        isLoading = false;
        alert("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + err.message);
      })
      .getWeeklyMatrixUnified(key);   // â† ã™ã§ã«å½“æ—¥èµ·ç‚¹å¯¾å¿œæ¸ˆã¿ï¼ˆã‚µãƒ¼ãƒï¼‰
  }
}

function handleDateSelect() {
  const v = document.getElementById("date-picker").value;
  if (!v) return;
  currentStartDate = toStartOfDayJST(v);
  const key = formatDate(toStartOfDayJST(currentStartDate));
  if (weeklyCache[key]) {
    weeklyDataCache = weeklyCache[key];
    initTabs(currentMode);
  } else {
    // ä¸Šã¨åŒæ§˜ã«å–å¾—
    isLoading = true;
    showReservationOverlay("äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦");
    google.script.run
      .withSuccessHandler(data => {
        hideReservationOverlay();
        isLoading = false;
        weeklyCache[key] = data;
        weeklyDataCache = data;
        setupCategorySelect(); 
        initTabs(currentMode);
      })
      .withFailureHandler(err => {
        hideReservationOverlay();
        isLoading = false;
        alert("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + err.message);
      })
      .getWeeklyMatrixUnified(key);
  }
}

function showLoadingSpinner() {
  document.getElementById("table-area").innerHTML = `
    <div class="text-center my-3">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
      </div>
      <p class="mt-3">ç©ºãçŠ¶æ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆä¸­â€¦</p>
    </div>`;
}


function toMinutes(timeStr) {
  const [h, m] = timeStr.split(":").map(Number);
  return h * 60 + m;
}

// âœ… ã‚¹ãƒãƒ›åˆ¤å®šé–¢æ•°
function isMobile() {
  return window.matchMedia("(max-width: 576px)").matches;
}

// âœ… ã‚¹ãƒãƒ›ã ã‘ç¸¦è¡¨ç¤ºã«å¤‰æ›
function verticalName(name) {
  if (!name) return "";
  return String(name).split("").join("<br>");
}

// âœ… ãƒ¢ãƒã‚¤ãƒ«ãªã‚‰ç¸¦ã€PCã¯ãã®ã¾ã¾
function getDisplayName(name) {
  return name || "";
}

function adjustTableMinWidth() {
  const table = document.querySelector('.table');
  if (!table) return;

  if (window.innerWidth <= 576) {
    const colCount = table.querySelectorAll('thead tr:nth-child(2) th').length;
    const widthPerCol = 40;
    const totalWidth = colCount * widthPerCol;
    table.style.minWidth = `${totalWidth}px`;
    table.style.width = "unset"; // â† ğŸ’¡å¼·åˆ¶ä¸Šæ›¸ãã•ã‚ŒãŸ100%ã‚’ç„¡åŠ¹åŒ–
  } else {
    table.style.minWidth = "";
    table.style.width = "";
  }
}

function generateSlotTimesFromHours(businessHourMap, unitMinutes) {
  let minMinutes = 1440;
  let maxMinutes = 0;

  for (const date in businessHourMap) {
    const ranges = businessHourMap[date] || [];
    for (const r of ranges) {
      if (!r.start || !r.end) continue;
      const [sh, sm] = r.start.split(":").map(Number);
      const [eh, em] = r.end.split(":").map(Number);
      const startMin = sh * 60 + sm;
      const endMin = eh * 60 + em;

      if (!isNaN(startMin) && startMin < minMinutes) minMinutes = startMin;
      if (!isNaN(endMin) && endMin > maxMinutes) maxMinutes = endMin;
    }
  }

  const slots = [];
  for (let m = minMinutes; m < maxMinutes; m += unitMinutes) {
    const h = Math.floor(m / 60).toString().padStart(2, "0");
    const min = (m % 60).toString().padStart(2, "0");
    slots.push(`${h}:${min}`);
  }

  return slots;
}

function getSlotHeight(unitMin) {
  if (unitMin <= 10) return 28;
  if (unitMin <= 15) return 36;
  if (unitMin <= 30) return 48;
  if (unitMin <= 60) return 60;
  return 72; // 90åˆ†ä»¥ä¸Š
}

function generateEndTime(startTime, rowspan, unitMin, timeSlots) {
  const startIndex = timeSlots.indexOf(startTime);
  const endIndex = startIndex + rowspan;
  if (endIndex >= timeSlots.length) {
    // æœ€å¾Œã®ã‚¹ãƒ­ãƒƒãƒˆè¶…ãˆã‚‹ â†’ è‡ªåŠ›ã§è¨ˆç®—
    const [h, m] = startTime.split(":").map(Number);
    const totalMinutes = h * 60 + m + rowspan * unitMin;
    const hh = Math.floor(totalMinutes / 60).toString().padStart(2, "0");
    const mm = (totalMinutes % 60).toString().padStart(2, "0");
    return `${hh}:${mm}`;
  }
  return timeSlots[endIndex];
}

// å–¶æ¥­/ä¼‘æ†©ã‚’è€ƒæ…®ã—ã¦ã€ã“ã®æ—¥æ™‚ãŒâ€œé–‹ã„ã¦ã„ã‚‹ã‹â€åˆ¤å®š
// businessHourMap ä¾‹ï¼š
//  - æ›œæ—¥ã‚­ãƒ¼: { "0":[{start:"10:00",end:"20:00",type:"å–¶æ¥­"},{start:"13:00",end:"14:00",type:"ä¼‘æ†©"}], ... }
//  - æ—¥ä»˜ã‚­ãƒ¼: { "2025-08-09":[{start:"10:00",end:"19:00",type:"å–¶æ¥­"}], ... }
// ã©ã¡ã‚‰ã‚‚ã‚ã‚Œã°ä¸¡æ–¹ã‚’åˆç®—ï¼ˆå–¶æ¥­ã¯è¿½åŠ ã€ä¼‘æ†©/ä¼‘æ¥­ã¯ä¸Šæ›¸ãã§é–‰ã˜ã‚‹ï¼‰
function isOpenAt(dateStr, t, businessHourMap) {
  if (!businessHourMap) return true; // ä¸æ˜ãªã‚‰å£Šã•ãªã„ï¼ˆå¾“æ¥äº’æ›ï¼‰

  const toMin = (hhmm) => {
    if (!hhmm) return null;
    const [h, m] = hhmm.split(":").map(Number);
    return (h ?? 0) * 60 + (m ?? 0);
  };
  const covers = (rule, tMin) => {
    // start/end æœªæŒ‡å®šã¯ã€Œçµ‚æ—¥ã€æ‰±ã„
    const s = toMin(rule.start) ?? 0;
    const e = toMin(rule.end) ?? 24 * 60;
    return tMin >= s && tMin < e;
  };

  const d = new Date(dateStr);
  const dow = d.getDay();
  const tMin = toMin(t);

  // ä½¿ã†ãƒ«ãƒ¼ãƒ«ã‚’é›†ã‚ã‚‹ï¼ˆæ›œæ—¥ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‹æ—¥ä»˜å€‹åˆ¥ï¼‰
  const flat = [];
  const pushArr = (arr) => { if (Array.isArray(arr)) for (const r of arr) if (r) flat.push(r); };
  pushArr(businessHourMap[dow] || businessHourMap[String(dow)]);
  pushArr(businessHourMap[dateStr]);

  // ãƒ«ãƒ¼ãƒ«ãŒå…¨ãç„¡ã‘ã‚Œã° â€œé–‹åº—ä¸­â€ ã¨ã¿ãªã™ï¼ˆå¾“æ¥äº’æ›ï¼‰
  if (flat.length === 0) return true;

  // ã‚¿ã‚¤ãƒ—åˆ¤å®š
  const isOnType = (type) => {
    const s = String(type ?? "").trim();
    // ã€Œå–¶æ¥­ã€ã‚’å«ã‚€ã‚‚ã®ã‚’ ON ã¨è§£é‡ˆ
    return s.includes("å–¶");
  };
  const isOffType = (type) => {
    const s = String(type ?? "").trim();
    // ã€Œä¼‘ã€ã€Œä¼‘æ†©ã€ã€Œé–‰ã€ç­‰ã‚’ OFF ã¨è§£é‡ˆï¼ˆä¾‹ï¼šä¼‘æ†©/ä¼‘æ¥­/ä¼‘åº—/é–‰åº—/åº—ä¼‘ ãªã©ï¼‰
    return s.includes("ä¼‘") || s.includes("é–‰");
  };

  // t ã‚’ã‚«ãƒãƒ¼ã™ã‚‹ ON ã¨ OFF ã‚’åˆ¤å®š
  let on = false;
  let off = false;
  for (const r of flat) {
    if (!covers(r, tMin)) continue;
    if (isOnType(r.type ?? r.ç”¨é€”)) on = true;
    if (isOffType(r.type ?? r.ç”¨é€”)) off = true;
  }

  // ãƒ«ãƒ¼ãƒ«ã«ä¸€åˆ‡è©²å½“ã—ãªã‘ã‚Œã°é–‰ã˜ã¦ã„ã‚‹ã¨ã¯è¨€ã„åˆ‡ã‚Œãªã„ã®ã§ã€å¾“æ¥äº’æ›ã§ true
  // ã©ã‚Œã‹ã«è©²å½“ã—ãŸå ´åˆã¯ã€ŒON ã‹ã¤ OFF ã§ãªã„ã€æ™‚ã ã‘é–‹åº—ä¸­
  return (on || (!on && !off && flat.length === 0)) ? (!off && on) : (!off && on);
}

function drawTable(data, serviceId = "") {
  const t0 = performance.now();

  const businessHourMap = data["_meta"].businessHours || {};
  const unitMin = data["_meta"].unitMin || 60;
  const slotHeight = getSlotHeight(unitMin); //ã‚¹ãƒ­ãƒƒãƒˆã®é«˜ã•èª¿æ•´ç”¨

  document.documentElement.style.setProperty('--slot-height', `${slotHeight}px`);

  const timeSlots = generateSlotTimesFromHours(data["_meta"].businessHours || {}, unitMin);
  const staffColumnMap = data["_meta"].staffColumnMap || {};
  const dates = Object.keys(data).filter(k => k !== "_meta").sort((a, b) => new Date(a) - new Date(b));
  const skipMap = {};

  // âœ… ãƒ¡ã‚¿ã‹ã‚‰åå‰â†’IDã‚’ç¢ºå®š
  const metaStaff = (data["_meta"]?.staff || []).reduce((m, s) => {
    if (s?.name) m[s.name] = s.id;
    return m;
  }, {});

  for (let dateStr of dates) {
    const serviceMeta = data["_meta"]?.services?.find(s => s.id === serviceId);
    const capacity = serviceMeta?.capacity || 1;
    const staffList = staffColumnMap[dateStr] || [];
    const staffCount = staffList.length;

    for (let t of timeSlots) {
      if (!data[dateStr]) data[dateStr] = {};
      if (!data[dateStr][t]) data[dateStr][t] = [];

      const slotArray = data[dateStr][t];
      skipMap[dateStr] = skipMap[dateStr] || {};

      for (let s = 0; s < staffCount; s++) {
        const staffName = staffList[s];
        const staffId = metaStaff[staffName] || "";
        const baseIndex = s * capacity;

        // ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã ã‘åˆ‡ã‚Šå‡ºã—
        const segStart = baseIndex;
        const segEnd = baseIndex + capacity; // éåŒ…å«
        const segCells = slotArray.slice(segStart, segEnd);

        const isDash = (v) => v === "ï¼" || v === "âˆ’" || v === "-";
        const isBookedCell = (c) => {
          if (!c) return false;
          const name = c?.name ?? "";
          const status = c?.status ?? "";
          // ã€ŒğŸŸ¢/ï¼/Ã—/ç©ºã€ä»¥å¤–ã®è¡¨ç¤ºï¼ˆäºˆç´„è€…åç­‰ï¼‰ã¯äºˆç´„æ‰±ã„
          const byName = name && !["ğŸŸ¢", "Ã—"].includes(name) && !isDash(name);
          const byStatus = status && !["ğŸŸ¢", "Ã—"].includes(status) && !isDash(status);
          return byName || byStatus;
        };

        // è¡Œï¼ˆæ™‚åˆ»ï¼‰å…¨ä½“ã®å–¶æ¥­åˆ¤å®šï¼ˆä¼‘æ†©ã‚‚é–‰æ‰±ã„ï¼‰
        const openNow = isOpenAt(dateStr, t, businessHourMap);

        // ç¾åœ¨æ™‚åˆ»ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆçŠ¶æ…‹
        const segDefined = segCells.filter(c => c != null);
        const segHasGreen = segDefined.some(c => (c?.name === "ğŸŸ¢") || (c?.status === "ğŸŸ¢"));
        const segHasBooked = segDefined.some(isBookedCell);
        const segAllDashNow = segDefined.length > 0 && segDefined.every(c => isDash(c?.name) || isDash(c?.status));

        // ç›´å‰/ç›´å¾Œã‚¹ãƒ­ãƒƒãƒˆã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚‚å‚ç…§ï¼ˆâ€œä¸åœ¨ã®å¸¯â€ ã®åˆ¤å®šã«ä½¿ã†ï¼‰
        const timeIndex = timeSlots.indexOf(t);
        const prevTime = timeSlots[timeIndex - 1];
        const nextTime = timeSlots[timeIndex + 1];
        const segAllDashFor = (row) => {
          if (!Array.isArray(row)) return false;
          const cells = row.slice(segStart, segEnd).filter(c => c != null);
          return cells.length > 0 && cells.every(c => isDash(c?.name) || isDash(c?.status));
        };
        const prevSegAllDash = prevTime ? segAllDashFor(data[dateStr]?.[prevTime] || []) : false;
        const nextSegAllDash = nextTime ? segAllDashFor(data[dateStr]?.[nextTime] || []) : false;

        // è£œå®Œãƒãƒ¼ã‚¯æ±ºå®šï¼š
        // 1) å–¶æ¥­æ™‚é–“å¤– â†’ å¸¸ã« "ï¼"
        // 2) å–¶æ¥­æ™‚é–“å†…ã‹ã¤ â€œä»Šã€œæ¬¡ã‚‚ä¸åœ¨å¸¯ï¼ˆå…¨ãƒã‚¤ãƒ•ãƒ³ï¼‰â€ ã§ã€ä»Šã¯äºˆç´„ã ã‘å…¥ã£ã¦ã„ã‚‹ â†’ ä¸åœ¨ä¸­ã®ã‚¤ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼äºˆç´„ â†’ "ï¼"
        // 3) å–¶æ¥­æ™‚é–“å†…ã‹ã¤ äºˆç´„ã‚ã‚Š â†’ ç¨¼åƒä¸­ â†’ "ğŸŸ¢"
        // 4) å–¶æ¥­æ™‚é–“å†…ã‹ã¤ æ˜ç¢ºã«å…¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ â†’ "ï¼"
        // 5) ãã‚Œä»¥å¤– â†’ "ğŸŸ¢"
        let fillMark;
        if (!openNow) {
          fillMark = "ï¼";
        } else if (segHasBooked && !segHasGreen && (segAllDashNow || nextSegAllDash)) {
          // ä¾‹: 18:00 ãŒä¸åœ¨å¸¯ã§äºˆç´„å…¥ã‚Šã€18:15 ã‚‚ä¸åœ¨å¸¯ â†’ æ®‹ã‚Šã¯ ï¼
          fillMark = "ï¼";
        } else if (segHasBooked) {
          // ä¾‹: 19:00 ã§å‡ºå‹¤é–‹å§‹ï¼†äºˆç´„ã‚ã‚Š â†’ æ®‹ã‚Šã¯ ğŸŸ¢
          fillMark = "ğŸŸ¢";
        } else if (!segHasGreen && segAllDashNow) {
          fillMark = "ï¼";
        } else {
          fillMark = "ğŸŸ¢";
        }

        for (let c = 0; c < capacity; c++) {
          const i = baseIndex + c;
          if (!slotArray[i]) {
            slotArray[i] = { staffId, name: fillMark, duration: unitMin };
          }
        }
      }

      // â˜… ç¶™ç¶šåˆ—ã‚’é¿ã‘ã¦æ–°è¦é–‹å§‹ã‚’æ¨ªç§»å‹•ï¼ˆrowspanç›´å‰ï¼‰
      {
        const timeIndex = timeSlots.indexOf(t);
        const prevTime = timeSlots[timeIndex - 1];

        const isDash = v => v === "ï¼" || v === "âˆ’" || v === "-";
        const isBooked = c => {
          if (!c) return false;
          const n = (c.name || "").trim();
          const st = (c.status || "").trim();
          return (n && !["ğŸŸ¢","Ã—"].includes(n) && !isDash(n)) ||
                (st && !["ğŸŸ¢","Ã—"].includes(st) && !isDash(st));
        };

        for (let s = 0; s < staffCount; s++) {
          const segStart = s * capacity;
          const segEnd   = segStart + capacity;

          for (let i = segStart; i < segEnd; i++) {
            const cell = slotArray[i];
            if (!isBooked(cell)) continue;

            // å‰è¡Œã¨åŒã˜äºˆç´„ãªã‚‰ç¶™ç¶šï¼ãã®ã¾ã¾
            const prevCell = prevTime ? (data[dateStr]?.[prevTime]?.[i]) : null;
            const continuing = prevCell && isBooked(prevCell) &&
                              (prevCell.name === cell.name) &&
                              ((prevCell.phone || "") === (cell.phone || ""));
            if (continuing) continue;

            // ã“ã®åˆ—ã¯ä¸Šã‹ã‚‰ã®rowspanã§å¡ãŒã‚Œã¦ã‚‹ï¼Ÿ
            const blockedHere = !!(skipMap[dateStr]?.[`${t}-${i}`]);
            if (!blockedHere) continue;

            // åŒã‚¹ã‚¿ãƒƒãƒ•ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†…ã§ã€å¡ãŒã‚Œã¦ãªãã¦â€œäºˆç´„ãŒç½®ã‹ã‚Œã¦ã„ãªã„â€åˆ—ã¸ã‚¹ãƒ©ã‚¤ãƒ‰
            for (let j = segStart; j < segEnd; j++) {
              if (j === i) continue;
              if (skipMap[dateStr]?.[`${t}-${j}`]) continue;      // ã“ã“ã‚‚ç¶™ç¶šã§å¡ãŒã‚Šãªã‚‰NG
              const dst = slotArray[j];
              if (!isBooked(dst)) {                                // ğŸŸ¢/ï¼/ç©º ãªã‚‰å—ã‘çš¿OK
                slotArray[j] = cell;
                slotArray[i] = { staffId: cell.staffId || "", name: "ğŸŸ¢", duration: unitMin };
                break;
              }
            }
          }
        }
      }

      // ğŸ” rowspan å‡¦ç†
        for (let i = 0; i < slotArray.length; i++) {
          const cell = slotArray[i];
          // äºˆç´„ã‚»ãƒ«ã ã‘ç¸¦ã«ã‚¹ã‚­ãƒƒãƒ—ä»˜ä¸ï¼ˆğŸŸ¢/ï¼/ç©º ä»¥å¤–ï¼‰
          if (cell && cell.name && !["ğŸŸ¢", "ğŸ”˜", "ï¼", ""].includes(cell.name)) {
            const timeIndex = timeSlots.indexOf(t);
            const rowspan = (cell.duration || 0) / unitMin;

            for (let j = 1; j < rowspan; j++) {
              const nextTime = timeSlots[timeIndex + j];
              if (!nextTime) continue;

              skipMap[dateStr][`${nextTime}-${i}`] = true;

              if (!data[dateStr][nextTime]) data[dateStr][nextTime] = [];
              const nextSlotArray = data[dateStr][nextTime];

              while (nextSlotArray.length <= i) {
                // åˆ— i â†’ ã‚¹ã‚¿ãƒƒãƒ•ã‚’é€†ç®—ã—ã¦ staffId ã‚’å®‰å®šä»˜ä¸
                const staffIdx = Math.floor(i / capacity);
                const staffName2 = (staffColumnMap[dateStr] || [])[staffIdx] || "";
                const staffId2 = metaStaff[staffName2] || "";
                nextSlotArray.push({ staffId: staffId2, name: "ï¼", duration: unitMin });
              }
            }
          }
        }
      }
  }
  

  const htmlParts = [];
  htmlParts.push('<div class="table-wrap"><table class="table table-bordered table-fixed text-center">');
  htmlParts.push('<thead class="table-light"><tr><th rowspan="2">æ™‚é–“</th>');

  const holidaySet = new Set(weeklyDataCache?.meta?.holidays || []);

  for (let dateStr of dates) {
    const d = new Date(dateStr);
    const dow = d.getDay();

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæ—¥æ›œèµ¤ã€åœŸæ›œé’ï¼‰
    let dayColor = "";
    if (dow === 0) dayColor = "text-danger";
    else if (dow === 6) dayColor = "text-primary";

    // ğŸ‘‡ ç¥æ—¥ã ã£ãŸã‚‰æ—¥æ›œã¨åŒã˜èµ¤ã«ä¸Šæ›¸ã
    if (holidaySet.has(dateStr)) {
      dayColor = "text-danger";
    }

    const sampleRow = data[dateStr]?.[timeSlots[0]] || [];
    const colSpan = sampleRow.length || 1;

    htmlParts.push(
      `<th colspan="${colSpan}">
        <span class="${dayColor}">
          ${d.getMonth() + 1}/${d.getDate()}
          <span class="day-split">(${["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][dow]})</span>
        </span>
      </th>`
    );
  }

  htmlParts.push('</tr><tr>');

  // ã‚¹ã‚¿ãƒƒãƒ•åè¡Œ
  for (let dateStr of dates) {
    const staffListRaw = staffColumnMap[dateStr] || [];
    const capacity = data["_meta"]?.services?.find(s => s.id === serviceId)?.capacity || 1;

    for (const name of staffListRaw) {
      htmlParts.push(`<th class="small text-secondary staff-name-cell" colspan="${capacity}">${name}</th>`);
    }
  }

  htmlParts.push('</tr></thead><tbody>');

  for (let t of timeSlots) {
    const borderClass = t.endsWith(":00") ? "border-solid" : "border-dotted";
    htmlParts.push(`<tr><th class="${borderClass}">${t}</th>`);

    for (let dateStr of dates) {
      skipMap[dateStr] = skipMap[dateStr] || {};
      const slotArray = data[dateStr]?.[t] || [];
      const fixedCols = ((staffColumnMap[dateStr] || []).length) * ((data["_meta"]?.services?.find(s => s.id === serviceId)?.capacity) || 1) || 1;

      for (let i = 0; i < fixedCols; i++) {
        const skipKey = `${t}-${i}`;
        if (skipMap[dateStr][skipKey]) continue;

        const cell = slotArray[i];
        const staffId = cell?.staffId || "";

        const timeIndex = timeSlots.indexOf(t);
        const rowspan = (cell?.duration || 0) / unitMin;

        if (cell && !["ğŸŸ¢", "ğŸ”˜", "ï¼", "", "ã€‡"].includes(cell.name)) {
          for (let j = 1; j < rowspan; j++) {
            const nextTime = timeSlots[timeIndex + j];
            if (nextTime) skipMap[dateStr][`${nextTime}-${i}`] = true;
          }
          const nameClass = isMobile() ? 'vertical-name' : '';
          htmlParts.push(`<td class="badge-booked ${borderClass} text-center bg-white selectable-cell" rowspan="${rowspan}"
            data-date="${dateStr}" data-time="${t}" data-service-id="${serviceId}"
            data-staff-id="${staffId}" data-name="${cell.name}"
            data-start="${t}" data-end="${generateEndTime(t, rowspan, unitMin, timeSlots)}"
            data-phone="${cell.phone || ''}" data-email="${cell.email || ''}"
            data-cutstyle="${cell.cutStyle || ''}" data-note="${cell.note || ''}"
            data-request="${(cell.request || '').replace(/"/g,'&quot;')}"
            data-designated="${cell.designated ? 'true' : 'false'}">
            <span class="text-body text-decoration-none ${nameClass}">${getDisplayName(cell.name)}</span></td>`);
        } else if (cell?.name === "ğŸŸ¢") {
          htmlParts.push(`<td class="${borderClass} text-center selectable-cell available-slot fw-bold text-success-light"
          data-date="${dateStr}" data-time="${t}"
          data-service-id="${serviceId}" data-staff-id="${staffId}">ã€‡</td>`);
        } else if (cell?.status === "other-service") {
          htmlParts.push(`<td class="${borderClass} text-center bg-body-secondary other-reserved-slot text-muted selectable-cell"
            data-date="${dateStr}" data-time="${t}"
            data-service-id="${serviceId}" data-staff-id="${staffId}">Ã—</td>`);
        } else {
          htmlParts.push(`<td class="${borderClass} bg-body-secondary text-muted text-center selectable-cell"
            data-date="${dateStr}" data-time="${t}"
            data-service-id="${serviceId}" data-staff-id="${staffId}">ï¼</td>`);
        }
      }
    }
    htmlParts.push('</tr>');
  }

  htmlParts.push('</tbody></table></div>');
  document.getElementById("table-area").innerHTML = htmlParts.join("");

  // âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰ï¼ˆ1å›ã ã‘ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  const tableArea = document.getElementById("table-area");
  tableArea.removeEventListener("click", handleCellClick); // äºŒé‡ç™»éŒ²é˜²æ­¢
  tableArea.addEventListener("click", handleCellClick);

  restoreScrollPosition("service", serviceId);

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¿å­˜ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  (function attachWrapScrollSaver(){
    const wrap = document.querySelector('.table-wrap');
    if (!wrap) return;
    let t;
    wrap.removeEventListener('scroll', wrap.__saveHandler || (()=>{}));
    wrap.__saveHandler = function() {
      clearTimeout(t);
      t = setTimeout(persistScrollPosToLS, 150);
    };
    wrap.addEventListener('scroll', wrap.__saveHandler, { passive: true });
  })();

}

function drawTableByStaff(data, staffId) {
  if (!data || !data["_meta"]) {
    console.warn("drawTableByStaff: invalid data", { staffId, data });
    const fallback = weeklyDataCache?.staffView?.[staffId];
    if (!fallback) return; // ã“ã‚Œä»¥ä¸Šã§ããªã„
    data = fallback;
  }
  const t0 = performance.now();

  const unitMin = data["_meta"].unitMin || 60;
  const slotHeight = getSlotHeight(unitMin); // ã‚¹ãƒ­ãƒƒãƒˆã®é«˜ã•èª¿æ•´ç”¨
  document.documentElement.style.setProperty('--slot-height', `${slotHeight}px`);

  const timeSlots = generateSlotTimesFromHours(data["_meta"].businessHours || {}, unitMin);
  const allServices = data["_meta"].services || [];
  const services = filterServicesByActiveCategory(allServices);
  const dates = Object.keys(data).filter(k => k !== "_meta").sort((a, b) => new Date(a) - new Date(b));
  const skipMap = {};

  // äºˆç´„/ç©ºãåˆ¤å®šï¼ˆvalue ã¯ {status,startTime,endTime,phone,...}ï¼‰
  const isDash = v => v === "ï¼" || v === "âˆ’" || v === "-";
  const isBooked = v => !!v && !!v.status && !["ğŸŸ¢", "Ã—"].includes(v.status) && !isDash(v.status);

  const htmlParts = [];
  htmlParts.push('<div class="table-wrap"><table class="table table-bordered table-fixed text-center">');
  htmlParts.push('<thead class="table-light"><tr><th rowspan="2">æ™‚é–“</th>');

  const holidaySet = new Set(weeklyDataCache?.meta?.holidays || []);

  for (let dateStr of dates) {
    const d = new Date(dateStr);
    const dow = d.getDay();

    let dayColor = "";
    if (dow === 0) dayColor = "text-danger";
    else if (dow === 6) dayColor = "text-primary";
    if (holidaySet.has(dateStr)) {
      dayColor = "text-danger";
    }
    let colSpan = 0;
    for (let s of services) {
      const val = data[dateStr]?.[timeSlots[0]]?.[s.id];
      if (Array.isArray(val)) colSpan += val.length; // capacity æœ¬
    }
    htmlParts.push(
      `<th colspan="${colSpan}"><span class="${dayColor}">${d.getMonth() + 1}/${d.getDate()}<span class="day-split">(${["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][dow]})</span></span></th>`
    );
  }

  // è¦‹å‡ºã—ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ Ã— capacityï¼‰
  htmlParts.push('</tr><tr>');
  for (let dateStr of dates) {
    for (let s of services) {
      const val = data[dateStr]?.[timeSlots[0]]?.[s.id];
      if (Array.isArray(val)) {
        for (let i = 0; i < val.length; i++) {
          htmlParts.push(
            `<th class="small text-secondary staff-name-cell">
              ${s.categorySub || s.name}${val.length > 1 ? " " + (i + 1) : ""}
            </th>`
          );
        }
      }
    }
  }
  htmlParts.push('</tr></thead><tbody>');

  // æœ¬ä½“
  for (let t of timeSlots) {
    const borderClass = t.endsWith(":00") ? "border-solid" : "border-dotted";
    htmlParts.push(`<tr><th class="${borderClass}">${t}</th>`);

    for (let dateStr of dates) {
      skipMap[dateStr] = skipMap[dateStr] || {};
      const serviceRow = data[dateStr]?.[t] || {};
      const timeIndex = timeSlots.indexOf(t);
      const prevTime = timeSlots[timeIndex - 1];

      for (let s of services) {
        const cells = serviceRow[s.id];
        if (!Array.isArray(cells)) continue;

        // â˜… rowspan ç›´å‰ã®â€œæ¨ªã‚¹ãƒ©ã‚¤ãƒ‰â€ï¼šã“ã®æ™‚åˆ» t ã§ç¶™ç¶šï¼ˆä¸Šã‹ã‚‰ã® rowspanï¼‰ã§å¡ãŒã£ãŸåˆ—ã«æ–°è¦é–‹å§‹ãŒä¹—ã£ã¦ãŸã‚‰ã€
        //    åŒã‚µãƒ¼ãƒ“ã‚¹é…åˆ—å†…ï¼ˆcapacity æœ¬ï¼‰ã§å¡ãŒã‚Œã¦ã„ãªã„ï¼†æœªäºˆç´„ã®åˆ—ã¸ç§»å‹•
        {
          // ã©ã® index ãŒä¸Šã‹ã‚‰å¡ãŒã£ã¦ã‚‹ã‹ï¼ˆskipMapï¼‰ã‚’æŠŠæ¡
          const blockedIdx = new Set();
          for (let i = 0; i < cells.length; i++) {
            const key = `${t}-${s.id}-${i}`;
            if (skipMap[dateStr][key]) blockedIdx.add(i);
          }

          if (blockedIdx.size) {
            // â€œå¡ãŒã£ã¦ã‚‹åˆ—ã«ç½®ã‹ã‚ŒãŸäºˆç´„â€ã® index ä¸€è¦§
            const moveTargets = [];
            for (let i = 0; i < cells.length; i++) {
              if (!blockedIdx.has(i)) continue;
              const v = cells[i];
              if (isBooked(v)) moveTargets.push(i);
            }

            if (moveTargets.length) {
              // å—ã‘çš¿ï¼ˆå¡ãŒã‚Œã¦ãŠã‚‰ãšã€æœªäºˆç´„ã®åˆ—ï¼‰ã‚’å·¦ã‹ã‚‰æ¢ã—ã¦é †ã«ç§»ã™
              for (const from of moveTargets) {
                const v = cells[from];
                let moved = false;
                for (let j = 0; j < cells.length; j++) {
                  if (j === from) continue;
                  if (blockedIdx.has(j)) continue;         // ã“ã“ã‚‚ç¶™ç¶šã§å¡ãŒã‚Šãªã‚‰NG
                  const dst = cells[j];
                  if (!isBooked(dst)) {                     // ğŸŸ¢/ï¼/ç©º ãªã‚‰OK
                    cells[j] = v;
                    cells[from] = { status: "ğŸŸ¢", startTime: t, endTime: t, phone: v?.phone || "" };
                    moved = true;
                    break;
                  }
                }
                // ç½®ãå ´ãŒç„¡ã„å ´åˆï¼ˆcapacityè¶…éï¼‰ã¯ãã®ã¾ã¾
              }
            }
          }
        }

        // â–¼ ã“ã“ã‹ã‚‰æç”»ï¼ˆrowspan ã‚’é…ã‚‹ï¼‰
        for (let i = 0; i < cells.length; i++) {
          const skipKey = `${t}-${s.id}-${i}`;
          if (skipMap[dateStr][skipKey]) continue;

          const value = cells[i];

          if (!value || value.status === "âˆ’") {
            htmlParts.push(
              `<td class="${borderClass} bg-body-secondary text-muted text-center selectable-cell"
                 data-date="${dateStr}" data-time="${t}"
                 data-service-id="${s.id}" data-staff-id="${staffId}">ï¼</td>`
            );
          } else if (value.status === "ğŸŸ¢") {
            htmlParts.push(
              `<td class="${borderClass} text-center selectable-cell available-slot fw-bold text-success-light"
                 data-date="${dateStr}" data-time="${t}"
                 data-service-id="${s.id}" data-staff-id="${staffId}">ã€‡</td>`
            );
          } else if (value.status === "Ã—") {
            htmlParts.push(
              `<td class="${borderClass} text-center bg-body-secondary other-reserved-slot text-muted selectable-cell"
                 data-date="${dateStr}" data-time="${t}"
                 data-service-id="${s.id}" data-staff-id="${staffId}">Ã—</td>`
            );
          } else {
            // äºˆç´„ã‚»ãƒ«
            const rowspan = (toMinutes(value.endTime) - toMinutes(value.startTime)) / unitMin;
            const idx = timeSlots.indexOf(t);

            // æœªæ¥è¡Œã« skip ã‚’é…ã‚‹
            for (let j = 1; j < rowspan; j++) {
              const nt = timeSlots[idx + j];
              if (nt) skipMap[dateStr][`${nt}-${s.id}-${i}`] = true;
            }

            const nameClass = isMobile() ? "vertical-name" : "";
            htmlParts.push(
              `<td class="badge-booked ${borderClass} text-center selectable-cell" rowspan="${rowspan}"
                 data-date="${dateStr}" data-time="${t}"
                 data-service-id="${s.id}" data-staff-id="${staffId}"
                 data-name="${value.status}" data-phone="${value.phone || ''}"
                 data-start="${value.startTime}" data-end="${value.endTime}"
                 data-email="${value.email || ''}"
                 data-cutstyle="${value.cutStyle || ''}"
                 data-note="${value.note || ''}"
                 data-request="${(value.request || '').replace(/"/g,'&quot;')}"
                 data-designated="${value.designated ? 'true' : 'false'}">
                 <span class="text-body text-decoration-none ${nameClass}">${getDisplayName(value.status)}</span></td>`
            );
          }
        }
      } // services
    }   // dates

    htmlParts.push('</tr>');
  }     // timeSlots

  htmlParts.push('</tbody></table></div>');
  document.getElementById("table-area").innerHTML = htmlParts.join("");

  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ1å›ã ã‘ï¼‰
  const tableArea = document.getElementById("table-area");
  tableArea.removeEventListener("click", handleCellClick);
  tableArea.addEventListener("click", handleCellClick);

  restoreScrollPosition("staff", staffId);

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¿å­˜ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  (function attachWrapScrollSaver(){
    const wrap = document.querySelector('.table-wrap');
    if (!wrap) return;
    let t;
    wrap.removeEventListener('scroll', wrap.__saveHandler || (()=>{}));
    wrap.__saveHandler = function() {
      clearTimeout(t);
      t = setTimeout(persistScrollPosToLS, 150);
    };
    wrap.addEventListener('scroll', wrap.__saveHandler, { passive: true });
  })();

}

function handleCellClick(e) {
  const cell = e.target.closest("td");
  if (!cell || !cell.classList.contains("selectable-cell")) return;

  document.querySelectorAll('#table-area td').forEach(c => c.classList.remove('selected-cell'));
  cell.classList.add('selected-cell');
  // showReservationModal(cell.dataset); // å¿…è¦ãªã‚‰æœ‰åŠ¹åŒ–
}

function showReservationOverlay(message = "äºˆç´„å‡¦ç†ä¸­...") {
  const overlay = document.getElementById("reservation-overlay");
  if (overlay) {
    overlay.style.display = "flex";
    const messageDiv = overlay.querySelector(".overlay-message");
    if (messageDiv) {
      messageDiv.textContent = message;
    }
  }
}

function setupModalScrollListeners() {
  const elms = [
    "reserve-date",
    "start-time-select",
    "reserve-service",
    "reserve-staff",
  ];

  elms.forEach((id) => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("change", scrollToSelectedSlotInModal);
    }
  });
}

function scrollToSelectedSlotInModal() {
  const { date, time, staffId, serviceId, colIndex } = pendingReserveInfo || {};
  if (!date || !time || !staffId || !serviceId || colIndex == null) return;

  const selector = `[data-date="${date}"][data-time="${time}"][data-staff-id="${staffId}"][data-service-id="${serviceId}"]`;

  setTimeout(() => {
    const allMatches = document.querySelectorAll(selector);
    const target = allMatches[colIndex];  // â† æ­£ã—ãã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸåˆ—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼
    const wrap = document.querySelector(".table-wrap");

    if (!target || !wrap) return;

    const targetRect = target.getBoundingClientRect();
    const wrapRect = wrap.getBoundingClientRect();

    wrap.scrollTo({
      top: wrap.scrollTop + (targetRect.top - wrapRect.top) - 100,
      left: wrap.scrollLeft + (targetRect.left - wrapRect.left) - 100,
      behavior: "smooth",
    });

    target.classList.add("highlighted");
    setTimeout(() => target.classList.remove("highlighted"), 3000);
  }, 200);
}


function activateTabByDataId(containerSelector, type, targetId) {

  const container = document.querySelector(containerSelector);
  if (!container) return;

  const tabs = container.querySelectorAll(`[data-${type}-id]`);

  let found = false;
  tabs.forEach(tab => {
    const id = tab.dataset[`${type}Id`];

    if (id === targetId) {
      tab.click();
      found = true;
    }
  });

  if (!found) {
    console.warn("âŒ ã‚¿ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼");
  }
}

function hideReservationOverlay() {
  const overlay = document.getElementById("reservation-overlay");
  if (overlay) overlay.style.display = "none";
}

function highlightSavedSlotOnly() {
  const action = (typeof consumeLastAction === "function"
    ? consumeLastAction()
    : (localStorage.getItem(LS_KEYS.lastAction) || ""));
  // äºˆç´„ or å‰Šé™¤ ã®ã¨ãã ã‘å®Ÿè¡Œ
  if (action !== "reserve" && action !== "delete") {
    try { localStorage.removeItem(LS_KEYS.scroll); } catch {}
      return;
  }
  console.log("ğŸ§­ lastAction:", action);

  let mem = null;
  try { mem = JSON.parse(localStorage.getItem(LS_KEYS.scroll) || "null"); } catch {}
  const wrap = document.querySelector(".table-wrap");

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒ
  try {
    const pos = JSON.parse(localStorage.getItem(LS_KEYS.scrollPos) || "null");
    if (wrap && pos && (pos.top != null || pos.left != null)) {
      wrap.scrollTo({ top: pos.top || 0, left: pos.left || 0, behavior: "instant" });
    }
  } catch {}

  if (!mem) return;
  console.log("ğŸ” scrollMemory:", mem);

  let target = null;

  // Step1: å®Œå…¨ä¸€è‡´ã‚»ãƒ¬ã‚¯ã‚¿
  if (mem.selector) {
    console.log("ğŸ¯ Step1: querySelector ->", mem.selector);
    target = document.querySelector(mem.selector);
    console.log("ğŸ¯ Step1 result:", target);
  }

  // Step1b: serviceId ãŒæ¬ è½/ç„¡åŠ¹ãªã¨ãã®æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (!target && mem.meta) {
    const { date, time } = mem.meta;
    const staffId   = mem.meta.staffId || "";
    const serviceId = mem.meta.serviceId || "";
    const parts = [
      `[data-date="${date}"]`,
      `[data-time="${time}"]`,
    ];
    const withStaff  = staffId   ? parts.concat(`[data-staff-id="${staffId}"]`)   : parts.slice();
    const withSvc    = serviceId ? parts.concat(`[data-service-id="${serviceId}"]`): parts.slice();
    const withBoth   = (staffId && serviceId) ? parts.concat(`[data-staff-id="${staffId}"]`,`[data-service-id="${serviceId}"]`) : null;

    const candidates = [];
    if (withBoth) candidates.push(withBoth.join(""));
    candidates.push(withStaff.join(""));
    candidates.push(withSvc.join(""));
    candidates.push(parts.join("")); // æœ€å¾Œã¯ date+time ã ã‘

    for (const sel of candidates) {
      console.log("ğŸ§ª Step1b try:", sel);
      const el = document.querySelector(sel);
      if (el) { console.log("âœ… Step1b hit:", sel, el); target = el; break; }
    }
  } 

  // Step2: å†æ¢ç´¢ï¼ˆname/phoneä¸€è‡´å„ªå…ˆ & staff-idå«ã‚ã¦çµã‚‹ï¼‰
  if (!target && mem.meta) {
    const { date, time, end, staffId, serviceId, name, phone } = mem.meta;
    const baseSel =
      `[data-date="${date}"][data-time="${time}"]` +
      (staffId   ? `[data-staff-id="${staffId}"]`   : "") +
      (serviceId ? `[data-service-id="${serviceId}"]` : "");
    const list = document.querySelectorAll(baseSel);
    console.log(`ğŸ“‹ Step2å€™è£œ: ${list.length} ä»¶`, list);

    const clean = s => (s || "").replace(/[^\d]/g, "");
    const wantPhone = clean(phone);
    const wantName  = (name || "").trim();

    target = Array.from(list).find(el => {
      const get = (e, key) => e?.dataset?.[key]
        ?? e?.querySelector(`[data-${key}]`)?.dataset?.[key]
        ?? "";
      const elName  = (get(el, "name") || "").trim();
      const elPhone = clean(get(el, "phone"));
      const okName  = !!wantName  && elName  === wantName;
      const okPhone = !!wantPhone && elPhone === wantPhone;
      const okTime  = !time || String(get(el, "time")) === String(time);

      const match = okTime && (okName || okPhone);
      console[match ? "log" : "log"](match ? "âœ… Step2ãƒãƒƒãƒ:" : "ğŸŸ¨ Step2ã‚¹ã‚­ãƒƒãƒ—:", { el, elName, elPhone, wantName, wantPhone });
      return match;
    }) || null;
  }

  if (!target) {
    console.warn("âš ï¸ ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸ");
    try { localStorage.removeItem(LS_KEYS.scroll); } catch {}
    return;
  }

  // âœ¨ ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ï¼ˆè¨ˆæ¸¬å¼·åŒ–ï¼‰
  const CLS = "selected-cell"; // â† CSSãŒã‚ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†
  console.log("âœ¨ will highlight:", target);

  // 1) ã‚¯ãƒ©ã‚¹ä»˜ä¸
  target.classList.add(CLS);
  console.log("ğŸ“¦ class after add:", target.className);

  // 2) æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¹ã‚¿ã‚¤ãƒ«åæ˜ ç¢ºèª
  requestAnimationFrame(() => {
    const bg = getComputedStyle(target).backgroundColor;
    console.log("ğŸ¨ computed bg after add:", bg);

    // 2-a) DOMãŒæ›¸ãæ›ãˆã‚‰ã‚Œã¦æ¶ˆãˆã¦ãªã„ã‹
    if (!document.contains(target)) {
      console.warn("ğŸ§¨ targetãŒDOMã‹ã‚‰æ¶ˆãˆãŸï¼ˆå†æç”»ã«è² ã‘ãŸå¯èƒ½æ€§ï¼‰ã€‚å†å¾…æ©Ÿâ†’å†å®Ÿè¡Œã—ã¾ã™ã€‚");
      // ç›´å‰ã§å‚ç…§ã§ãã‚‹ mem ã‚’ä½¿ã†ï¼ˆé–¢æ•°å…ˆé ­ã§å–å¾—æ¸ˆã¿ï¼‰
      const { date, time, staffId, serviceId, name, phone, end } = mem.meta;

      // å†æç”»ã‚’å¾…ã¡ãªãŒã‚‰ã€Œæœ¬äººã€ã‚’å†æ¢ç´¢
      waitFor(() => {
        const list = document.querySelectorAll(
          `[data-date="${date}"][data-time="${time}"][data-service-id="${serviceId}"][data-staff-id="${staffId}"]`
        );
        const clean = s => (s || "").replace(/[^\d]/g, "");
        const wantPhone = clean(phone);
        const wantName  = (name || "").trim();

        const found = Array.from(list).find(el => {
          const get = (e, key) => e?.dataset?.[key]
            ?? e?.querySelector(`[data-${key}]`)?.dataset?.[key]
            ?? "";
          const elName  = (get(el, "name") || "").trim();
          const elPhone = clean(get(el, "phone"));
          // åå‰ or é›»è©±ã®ã©ã¡ã‚‰ã‹ä¸€è‡´ã‚’å¿…é ˆã«
          return (!!wantName && elName === wantName) || (!!wantPhone && elPhone === wantPhone);
        });

        if (found) { window.__reFoundTarget = found; }
        return !!found;
      }, 1500, 50).then(() => {
        const t2 = window.__reFoundTarget;
        console.log("ğŸ” å†å–å¾— target(æœ¬äºº):", t2);
        if (t2) {
          t2.classList.add(CLS);
          setTimeout(() => t2.classList.remove(CLS), 3000);
        }
      }).catch(() => {
        console.warn("â± å†å–å¾—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ");
      });

      return;
    }

    // 2-b) èƒŒæ™¯ãŒç™½ã®ã¾ã¾ç­‰â†’CSSå„ªå…ˆåº¦è² ã‘ã®ç–‘ã„ â†’ ä¸€æ™‚çš„ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§å¡—ã‚‹
    const isNoColor = !bg || bg === "rgba(0, 0, 0, 0)" || bg === "transparent" || bg === "rgb(255, 255, 255)";
    if (isNoColor) {
      console.warn("ğŸ§ª èƒŒæ™¯ãŒåŠ¹ã„ã¦ãªã„â†’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§ä¸€æ™‚å¡—ã‚Š");
      target.style.backgroundColor = "#ffeeba";
      target.style.outline = "2px solid #ffa000";
      target.style.boxShadow = "0 0 0 2px #ffa000 inset";
    }

    // 3) è‡ªå‹•è§£é™¤
    setTimeout(() => {
      target.classList.remove(CLS);
      target.style.backgroundColor = "";
      target.style.outline = "";
      target.style.boxShadow = "";
    }, 3000);
  });

  try { localStorage.removeItem(LS_KEYS.scroll); } catch {}
}


// â± "HH:mm" â†’ åˆ†æ•°ã«å¤‰æ›
function toMinutes(str) {
  const [h, m] = str.split(":").map(Number);
  return h * 60 + m;
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>

