<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top" />
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>🏝️ スタッフ予定設定</title>
  <style>
    tr.schedule-working {
    background-color: #e0f7ff !important;
  }

  tr.schedule-off {
    background-color: #ffeaea !important;
  }
  </style>
</head>
<body class="container-fluid py-3 loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>認証チェック中...</p>
  </div>

  <div id="app" style="display:none;">

  <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('20_staff_main_staff')">← 戻る</button>
  <h4 class="text-center mb-3">🏝️ スタッフ予定設定</h4>

  <div id="success-message" class="alert alert-success text-center" style="display: none;"></div>

  <!-- 🔄 初期表示ぐるぐる -->
  <div id="global-spinner" class="text-center my-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">読み込み中...</span>
    </div>
    <p class="mt-3">スタッフ予定データを読み込んでいます…</p>
  </div>

  <!-- 🔄 保存中ぐるぐる -->
  <div id="saving-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">保存中...</span>
    </div>
    <p class="mt-2">保存しています…</p>
  </div>

  <!-- 🔄 削除中ぐるぐる -->
  <div id="delete-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-danger" role="status">
      <span class="visually-hidden">削除中...</span>
    </div>
    <p class="mt-2">削除しています…</p>
  </div>

  <div id="main-content">

    <h5>📋 登録済み予定履歴</h5>
    <div class="table-wrapper mb-0">
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>日付</th>
              <th>スタッフID</th>
              <th>スタッフ名</th>
              <th>状態</th>
              <th>時間</th>
              <th>備考</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- JSで埋め込み -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="form-wrapper mt-3 mb-3">
      <button id="toggleFormBtn" class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#leaveForm" aria-expanded="false" aria-controls="leaveForm">
        ＋ 新規作成
      </button>
    </div>

    <div class="collapse" id="leaveForm">
      <div class="form-wrapper">
        <h5>スタッフ予定登録</h5>
        <!-- ✅ メッセージ -->
        <div id="error-message" class="alert alert-danger text-center" style="display: none;"></div>
        <input type="hidden" id="formMode" value="new" />
        <div class="mb-3">
          <label for="staffId" class="form-label">👤 スタッフ選択</label>
          <select id="staffId" class="form-select">
            <option value="">スタッフを選択してください</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="startDate" class="form-label">📅 開始日</label>
          <input type="date" class="form-control" id="startDate" />
        </div>
        <div class="mb-3">
          <label for="endDate" class="form-label">📅 終了日</label>
          <input type="date" class="form-control" id="endDate" />
        </div>

        <div class="mb-3">
          <label class="form-label">🛌 状態</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="status" id="working" value="休出">
            <label class="form-check-label" for="working">休出</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="status" id="off" value="予定休">
            <label class="form-check-label" for="off">予定休</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="status" id="radio-time" value="時間休">
            <label class="form-check-label" for="radio-time">時間休</label>
          </div>
        </div>
        <!-- ✅ 時間入力欄：開始・終了 -->
        <div class="mb-3">
          <label class="form-label">⏰ 時間帯</label>
          <div class="row gx-2">
            <div class="col">
              <input type="time" class="form-control" id="startTime" disabled />
            </div>
            <div class="col-auto d-flex align-items-center">〜</div>
            <div class="col">
              <input type="time" class="form-control" id="endTime" disabled />
            </div>
          </div>
          <small class="form-text text-muted ms-1">
            ※「時間休」「休出」を選択すると時間帯を入力できます<br>
            ※休出の時間帯でも「営業設定の休憩時間」は予約不可になります
          </small>
        </div>
        <div class="mb-3">
          <label for="note" class="form-label">📝 備考</label>
          <textarea class="form-control" id="note" rows="2"></textarea>
        </div>
        <div class="d-grid gap-2">
          <button id="saveBtn" class="btn btn-primary mt-2" disabled>登録</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmSaveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">保存してもよろしいですか？</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">入力内容を保存します。よろしいですか？</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" id="confirm-save-btn">保存する</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">削除してもよろしいですか？</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">この休暇を削除します。よろしいですか？</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">削除する</button>
      </div>
    </div>
  </div>
</div>

  <script>
  const Utils = {
    sanitize(str) {
      return String(str || "").replace(/[<>"'&]/g, s => ({
        "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;", "&": "&amp;"
      }[s]));
    },
    validate({ staffId, startDate, endDate, status, startTime, endTime }) {
      if (!staffId) throw new Error("⚠ スタッフは必須です");
      if (!startDate) throw new Error("⚠ 開始日は必須です");
      if (!status) throw new Error("⚠ 状態は必須です");

      if (endDate && new Date(startDate) > new Date(endDate)) {
        throw new Error("⚠ 終了日は開始日以降にしてください");
      }
      if (status === "時間休") {
        if (!startTime || !endTime) throw new Error("⚠ 時間帯は必須です");
        if (startTime >= endTime) throw new Error("⚠ 開始時間は終了時間より前にしてください");
      }
    }
  };
    
  const prefillStaffId = '<?= staffId ?>';
  const prefillDate = '<?= date ?>';
  const prefillStatus = '<?= status ?>';
  const prefillNote = '<?= note ?>';
  const prefillStartDate = '<?= startDate ?>';
  const prefillEndDate = '<?= endDate ?>';
  const prefillStartTime = '<?= startTime ?>';
  const prefillEndTime = '<?= endTime ?>';

  let leaveData = [];
  let staffList = [];
  let collapseForm;
  let deleteTarget = {};
  let originalLeaveData = null;
  let isEditMode = false;

  window.onload = () => {
    document.getElementById("main-content").style.display = "none";
    document.getElementById("global-spinner").style.display = "block";

    google.script.run.withSuccessHandler(data => {
      renderStaffOptions(data);

      google.script.run.withSuccessHandler(history => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const filtered = history.filter(item => {
          const endDate = new Date(item.endDate || item.startDate);
          return endDate >= today;
        });

        renderHistory(filtered);

        setTimeout(() => {
          document.getElementById("global-spinner").style.display = "none";
          document.getElementById("main-content").style.display = "block";
          document.getElementById("main-content").classList.add("show");

          // ✅ パラメータがある場合：フォームにセット
          if (prefillStaffId && (prefillStartDate || prefillDate) && prefillStatus) {
            document.getElementById("staffId").value = prefillStaffId;

            // startDate / endDate があればそっちを優先
            document.getElementById("startDate").value = prefillStartDate || prefillDate;
            document.getElementById("endDate").value = prefillEndDate || prefillDate;

            const radio = document.querySelector(`input[name='status'][value='${prefillStatus}']`);
            if (radio) radio.checked = true;

            if (prefillNote) {
              document.getElementById("note").value = prefillNote.replace(/\\n/g, "\n");
            }

            if (prefillStartTime) document.getElementById("startTime").value = prefillStartTime;
            if (prefillEndTime) document.getElementById("endTime").value = prefillEndTime;

            originalLeaveData = {
              staffId: prefillStaffId,
              startDate: prefillStartDate || prefillDate,
              endDate: prefillEndDate || prefillDate,
              status: prefillStatus,
              startTime: prefillStartTime || "",
              endTime: prefillEndTime || "",
              note: prefillNote || ""
            };

            document.getElementById("saveBtn").textContent = "更新";
            isEditMode = true;
          } else {
            // 新規登録扱い
            if (prefillStaffId) document.getElementById("staffId").value = prefillStaffId;
            if (prefillStartDate || prefillDate) {
              document.getElementById("startDate").value = prefillStartDate || prefillDate;
              document.getElementById("endDate").value = prefillEndDate || prefillDate;
            }
          }


          updateTimeInputs();
          collapseForm.show();
          setTimeout(() => {
            document.getElementById("leaveForm").scrollIntoView({ behavior: "smooth", block: "start" });
          }, 300);
        }, 50);
      }).getScheduleHistory();
    }).getStaffList();

    setupInputChangeHandler();
  };

  document.getElementById("startDate").addEventListener("change", () => {
    const startDate = document.getElementById("startDate").value;
    const endDateEl = document.getElementById("endDate");

    if (!endDateEl.value) {
      endDateEl.value = startDate;
    }

    const status = document.querySelector("input[name='status']:checked")?.value;
    if (status === "休出" && startDate) {
      google.script.run.withSuccessHandler((map) => {
        const hours = map[startDate];
        if (!hours || hours.length === 0) return;

        const start = hours.map(h => h.start).sort()[0];
        const end = hours.map(h => h.end).sort().reverse()[0];

        const startTimeEl = document.getElementById("startTime");
        const endTimeEl = document.getElementById("endTime");
        startTimeEl.value = start;
        endTimeEl.value = end;
      }).getBusinessHourMap(startDate);
    }
  });



  // ✅ ラジオボタン変更時に時間入力制御
  function setupRadioControl() {
    const radios = document.querySelectorAll('input[name="status"]');
    radios.forEach(radio => {
      radio.addEventListener("change", () => {
        updateTimeInputs();
      });
    });

    // 初期状態にも反映
    updateTimeInputs();

    document.getElementById("startTime").addEventListener("change", () => {
      const start = document.getElementById("startTime");
      const end = document.getElementById("endTime");
      if (!end.value) {
        end.value = start.value;
      }
    });
  }

  document.querySelectorAll("input[name='status']").forEach(radio => {
    radio.addEventListener("change", () => {
      updateTimeInputs();

      const selected = document.querySelector("input[name='status']:checked")?.value;
      const startDate = document.getElementById("startDate").value;

      if (selected === "休出" && startDate) {
        google.script.run.withSuccessHandler((map) => {
          const hours = map[startDate];
          if (!hours || hours.length === 0) return;

          const start = hours.map(h => h.start).sort()[0];
          const end = hours.map(h => h.end).sort().reverse()[0];

          const startTimeEl = document.getElementById("startTime");
          const endTimeEl = document.getElementById("endTime");
          startTimeEl.value = start;
          endTimeEl.value = end;
        }).getBusinessHourMap(startDate);
      }
    });
  });


  function updateTimeInputs() {
    const selected = document.querySelector("input[name='status']:checked");
    const isTimeRequired = selected && (selected.value === "時間休" || selected.value === "休出");

    const start = document.getElementById("startTime");
    const end = document.getElementById("endTime");

    start.disabled = !isTimeRequired;
    end.disabled = !isTimeRequired;

    if (!isTimeRequired) {
      start.value = "";
      end.value = "";
    }
  }


  // ✅ 保存ボタン → モーダル表示
  function handleSaveClick() {
    try {
      const formData = {
        staffId: document.getElementById("staffId").value.trim(),
        startDate: document.getElementById("startDate").value.trim(),
        endDate: document.getElementById("endDate").value.trim(),
        status: document.querySelector("input[name='status']:checked")?.value,
        startTime: document.getElementById("startTime").value,
        endTime: document.getElementById("endTime").value,
        note: document.getElementById("note").value.trim()
      };

      Utils.validate(formData);

      // サニタイズ
      const sanitized = {
        staffId: Utils.sanitize(formData.staffId),
        startDate: formData.startDate,
        endDate: formData.endDate,
        status: formData.status,
        startTime: formData.startTime,
        endTime: formData.endTime,
        note: Utils.sanitize(formData.note)
      };

      isEditMode = !!originalLeaveData;

      showDiffModal(sanitized);

    } catch (err) {
      showMessage(err.message, true);
    }
  }

  function showDiffModal(newData) {
    const modalTitle = document.querySelector("#confirmSaveModal .modal-title");
    modalTitle.textContent = originalLeaveData ? "更新してもよろしいですか？" : "登録してもよろしいですか？";

    const labels = {
      staffId: "👤 スタッフ",
      startDate: "📅 開始日",
      endDate: "📅 終了日",
      status: "🛌 状態",
      startTime: "⏰ 開始時間",
      endTime: "⏰ 終了時間",
      note: "📝 備考"
    };

    const isNew = !originalLeaveData;

    let diffHtml = '<ul class="list-group list-group-flush">';

    for (const key of Object.keys(labels)) {
      const label = labels[key];
      const oldValRaw = originalLeaveData?.[key] ?? "";
      const newValRaw = newData[key] ?? "";

      let oldVal = oldValRaw;
      let newVal = newValRaw;

      // ✅ スタッフ名の表示変換
      if (key === "staffId") {
        oldVal = staffList.find(s => s.id === oldValRaw)?.name || oldValRaw;
        newVal = staffList.find(s => s.id === newValRaw)?.name || newValRaw;
      }

      if (isNew) {
        diffHtml += `<li class="list-group-item">${label}：${newVal || "-"}</li>`;
      } else {
        const changed = oldValRaw !== newValRaw;
        const klass = changed ? "text-danger fw-bold" : "";
        const arrow = changed ? ` → ${newVal || "-"}` : "";
        diffHtml += `<li class="list-group-item ${klass}">${label}：${oldVal || "-"}${arrow}</li>`;
      }
    }

    diffHtml += '</ul>';

    document.querySelector("#confirmSaveModal .modal-body").innerHTML = diffHtml;

    const confirmBtn = document.getElementById("confirm-save-btn");
    confirmBtn.textContent = originalLeaveData ? "更新" : "登録";

    new bootstrap.Modal(document.getElementById("confirmSaveModal")).show();
  }


  function setupSaveHandler() {
    document.getElementById("saveBtn").addEventListener("click", handleSaveClick);

    document.getElementById("confirm-save-btn")?.addEventListener("click", () => {
      // ✅ こっちで反映
      const savingText = isEditMode ? "更新しています…" : "登録しています…";
      document.getElementById("saving-spinner").querySelector("p").textContent = savingText;

      const staffId = document.getElementById("staffId").value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const status = document.querySelector("input[name='status']:checked").value;
      const note = document.getElementById("note").value;

      let startTime = "";
      let endTime = "";
      if (status === "時間休" || status === "休出")  {
        startTime = document.getElementById("startTime").value;
        endTime = document.getElementById("endTime").value;
      }

      const payload = {
        staffId: Utils.sanitize(staffId),
        status,
        startDate,
        endDate,
        startTime,
        endTime,
        note: Utils.sanitize(note),
        originalStaffId: originalLeaveData?.staffId || "",
        originalStartDate: originalLeaveData?.startDate || "",
        originalEndDate: originalLeaveData?.endDate || ""
      };

      // ✅ サニタイズチェック
      if (!validateSafeInputs(payload)) {
        alert("❌ 入力内容に不正なタグが含まれています。");
        return;
      }

      const modal = bootstrap.Modal.getInstance(document.getElementById("confirmSaveModal"));
      modal.hide();

      collapseForm.hide();

      document.getElementById("main-content").style.display = "none";
      document.getElementById("saving-spinner").style.display = "block";

      google.script.run.withSuccessHandler(() => {
        clearForm();
        google.script.run.withSuccessHandler(history => {
          renderHistory(history);
          setTimeout(() => {
            document.getElementById("saving-spinner").style.display = "none";
            document.getElementById("main-content").style.display = "block";
            showMessage("✅ 登録完了！");
            document.getElementById("saveBtn").disabled = true;
          }, 50);
        }).getScheduleHistory();
      }).withFailureHandler(e => {
        document.getElementById("saving-spinner").style.display = "none";
        document.getElementById("main-content").style.display = "block";
        showMessage("❌ 保存エラー：" + e.message, true);
      }).saveScheduleEntry(payload);
    });
  }

  function clearForm() {
    document.getElementById("staffId").value = "";
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("note").value = "";
    document.getElementById("startTime").value = "";
    document.getElementById("endTime").value = "";
    document.getElementById("startTime").disabled = true;
    document.getElementById("endTime").disabled = true;
    document.querySelectorAll("input[name='status']").forEach(r => r.checked = false);

    updateTimeInputs();

    // ⬇️ ボタン文言リセット
    document.getElementById("saveBtn").textContent = "登録";

    // ⬇️ 編集フラグクリア
    originalLeaveData = null;
  }



  function renderStaffOptions(data) {
    const select = document.getElementById("staffId");
    staffList = data;
    select.innerHTML = '<option value="">スタッフを選択してください</option>';

    data.forEach(staff => {
      const opt = document.createElement("option");
      opt.value = staff.id;
      opt.textContent = `${staff.id}：${staff.name}`;
      select.appendChild(opt);
    });

    // ← プリセットデータをここで反映する
    if (prefillStaffId) {
      select.value = prefillStaffId;
    }
  }

  function renderHistory(data) {
    leaveData = data;

    // ✅ 開始日でソート
    data.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

    const tbody = document.getElementById("historyTableBody");
    tbody.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">履歴がありません</td></tr>`;
    } else {
      data.forEach((item, index) => {
        const dateDisplay = item.startDate === item.endDate || !item.endDate
          ? item.startDate
          : `${item.startDate}〜${item.endDate}`;

        const timeDisplay = item.startTime && item.endTime
          ? `${item.startTime}〜${item.endTime}`
          : "";

        const tr = document.createElement("tr");
        tr.classList.add(item.status === "休出" ? "schedule-working" : "schedule-off");

        tr.innerHTML = `
          <td>${dateDisplay}</td>
          <td>${item.staffId}</td>
          <td>${item.staffName || ""}</td>
          <td>${item.status}</td>
          <td>${timeDisplay}</td>
          <td>${item.note || ""}</td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-warning me-1" onclick="loadToForm(${index})">編集</button>
            <button class="btn btn-sm btn-danger" onclick="deleteLeave('${item.staffId}', '${item.startDate}', '${item.endDate || ""}')">削除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  }

  function loadToForm(index) {
    const item = leaveData[index];
    const formEl = document.getElementById("leaveForm");
    collapseForm.show();
    setTimeout(() => {
      formEl.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 300);

    // 編集前データ保持
    originalLeaveData = { ...item };

    document.getElementById("staffId").value = item.staffId;
    document.getElementById("startDate").value = item.startDate || "";
    document.getElementById("endDate").value = item.endDate || "";
    document.getElementById("note").value = item.note || "";

    const radio = document.querySelector(`input[name='status'][value='${item.status}']`);
    if (radio) radio.checked = true;

    const isTimeOff = item.status === "時間休";
    document.getElementById("startTime").disabled = !isTimeOff;
    document.getElementById("endTime").disabled = !isTimeOff;
    document.getElementById("startTime").value = item.startTime || "";
    document.getElementById("endTime").value = item.endTime || "";

    updateTimeInputs();

    document.getElementById("saveBtn").textContent = "更新";
  }



  function deleteLeave(staffId, startDate, endDate) {
    deleteTarget = { staffId, startDate, endDate };
    const modal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
    modal.show();
  }

  function setupDeleteHandler() {
    document.getElementById("confirm-delete-btn")?.addEventListener("click", () => {
      const { staffId, startDate, endDate } = deleteTarget;
      const modal = bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal"));
      modal.hide();

      if (collapseForm) collapseForm.hide();
      clearForm();

      document.getElementById("main-content").style.display = "none";
      document.getElementById("delete-spinner").style.display = "block";

      google.script.run
        .withSuccessHandler(() => {
          google.script.run.withSuccessHandler(history => {
            renderHistory(history);
            setTimeout(() => {
              document.getElementById("delete-spinner").style.display = "none";
              document.getElementById("main-content").style.display = "block";
              showMessage("🗑 削除しました");
            }, 50);
          }).getScheduleHistory();
        })
        .withFailureHandler(e => {
          showMessage("❌ 削除失敗：" + e.message, true);
          document.getElementById("delete-spinner").style.display = "none";
          document.getElementById("main-content").style.display = "block";
        })
        .deleteScheduleEntry(staffId, startDate, endDate);
    });
  }

  function showMessage(msg, isError = false) {
    const success = document.getElementById("success-message");
    const error = document.getElementById("error-message");
    success.style.display = "none";
    error.style.display = "none";

    const target = isError ? error : success;
    target.textContent = msg;
    target.style.display = "block";
    setTimeout(() => (target.style.display = "none"), 4000);
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("[CHILD] DOMContentLoaded → child-ready を親へ送信");
    try {
      window.top.postMessage(
        { type: "misemaru:child-ready", origin: location.origin },
        "*" // 親側で必ず event.origin を検証するので安全
      );
    } catch (err) {
      console.error("[CHILD] child-ready 送信失敗:", err);
    }

    const toggleBtn = document.getElementById("toggleFormBtn");
    const formEl = document.getElementById("leaveForm");
    collapseForm = new bootstrap.Collapse(formEl, { toggle: false });

    toggleBtn.addEventListener("click", () => {
      const visible = formEl.classList.contains("show");
      if (visible) {
        collapseForm.hide();
      } else {
        collapseForm.show();
        setTimeout(() => {
          formEl.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      }
    });

    formEl.addEventListener("hide.bs.collapse", () => {
      toggleBtn.textContent = "＋ 新規作成";
      clearForm();
    });

    formEl.addEventListener("show.bs.collapse", () => {
      toggleBtn.textContent = "− 閉じる";
    });

    // ✅ ここに追加
    setupRadioControl();
    setupSaveHandler();
    setupDeleteHandler();
    setupTimeSync();
  });

  function setupTimeSync() {
    const startInput = document.getElementById("startTime");
    const endInput = document.getElementById("endTime");

    let autoSyncEnabled = true;

    if (startInput && endInput) {
      // ユーザーが endTime を手動で変更したら同期やめる
      endInput.addEventListener("input", () => {
        autoSyncEnabled = false;
      });

      // startTime を変更したら endTime に反映（同期中のみ）
      startInput.addEventListener("input", () => {
        if (autoSyncEnabled) {
          endInput.value = startInput.value;
        }
      });
    }
  }

  function setupInputChangeHandler() {
    const form = document.getElementById("leaveForm");
    const saveBtn = document.getElementById("saveBtn");

    form.addEventListener("input", () => {
      saveBtn.disabled = !hasFormChanged();
    });

    form.addEventListener("change", () => {
      saveBtn.disabled = !hasFormChanged();
    });
  }

  function hasFormChanged() {
    const staffId = document.getElementById("staffId").value;
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const status = document.querySelector("input[name='status']:checked")?.value;
    const startTime = document.getElementById("startTime").value;
    const endTime = document.getElementById("endTime").value;
    const note = document.getElementById("note").value;

    const newData = {
      staffId,
      startDate,
      endDate,
      status,
      startTime: status === "時間休" ? startTime : "",
      endTime: status === "時間休" ? endTime : "",
      note
    };

    if (!originalLeaveData) {
      // 新規 → すべて空なら false
      return !!(staffId && startDate && endDate && status);
    } else {
      // 更新 → 差分が1つでもあれば true
      return Object.keys(newData).some(k => newData[k] !== originalLeaveData[k]);
    }
  }



  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
