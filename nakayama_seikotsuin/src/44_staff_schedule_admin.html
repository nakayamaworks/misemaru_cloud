<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top" />
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>ğŸï¸ ã‚¹ã‚¿ãƒƒãƒ•äºˆå®šè¨­å®š</title>
  <style>
    tr.schedule-working {
    background-color: #e0f7ff !important;
  }

  tr.schedule-off {
    background-color: #ffeaea !important;
  }
  </style>
</head>
<body class="container-fluid py-3 loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­...</p>
  </div>

  <div id="app" style="display:none;">

  <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('20_staff_main_staff')">â† æˆ»ã‚‹</button>
  <h4 class="text-center mb-3">ğŸï¸ ã‚¹ã‚¿ãƒƒãƒ•äºˆå®šè¨­å®š</h4>

  <div id="success-message" class="alert alert-success text-center" style="display: none;"></div>

  <!-- ğŸ”„ åˆæœŸè¡¨ç¤ºãã‚‹ãã‚‹ -->
  <div id="global-spinner" class="text-center my-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <p class="mt-3">ã‚¹ã‚¿ãƒƒãƒ•äºˆå®šãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦</p>
  </div>

  <!-- ğŸ”„ ä¿å­˜ä¸­ãã‚‹ãã‚‹ -->
  <div id="saving-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ä¿å­˜ä¸­...</span>
    </div>
    <p class="mt-2">ä¿å­˜ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  <!-- ğŸ”„ å‰Šé™¤ä¸­ãã‚‹ãã‚‹ -->
  <div id="delete-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-danger" role="status">
      <span class="visually-hidden">å‰Šé™¤ä¸­...</span>
    </div>
    <p class="mt-2">å‰Šé™¤ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  <div id="main-content">

    <h5>ğŸ“‹ ç™»éŒ²æ¸ˆã¿äºˆå®šå±¥æ­´</h5>
    <div class="table-wrapper mb-0">
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>æ—¥ä»˜</th>
              <th>ã‚¹ã‚¿ãƒƒãƒ•ID</th>
              <th>ã‚¹ã‚¿ãƒƒãƒ•å</th>
              <th>çŠ¶æ…‹</th>
              <th>æ™‚é–“</th>
              <th>å‚™è€ƒ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- JSã§åŸ‹ã‚è¾¼ã¿ -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="form-wrapper mt-3 mb-3">
      <button id="toggleFormBtn" class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#leaveForm" aria-expanded="false" aria-controls="leaveForm">
        ï¼‹ æ–°è¦ä½œæˆ
      </button>
    </div>

    <div class="collapse" id="leaveForm">
      <div class="form-wrapper">
        <h5>ã‚¹ã‚¿ãƒƒãƒ•äºˆå®šç™»éŒ²</h5>
        <!-- âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="error-message" class="alert alert-danger text-center" style="display: none;"></div>
        <input type="hidden" id="formMode" value="new" />
        <div class="mb-3">
          <label for="staffId" class="form-label">ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ</label>
          <select id="staffId" class="form-select">
            <option value="">ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="startDate" class="form-label">ğŸ“… é–‹å§‹æ—¥</label>
          <input type="date" class="form-control" id="startDate" />
        </div>
        <div class="mb-3">
          <label for="endDate" class="form-label">ğŸ“… çµ‚äº†æ—¥</label>
          <input type="date" class="form-control" id="endDate" />
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸ›Œ çŠ¶æ…‹</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="status" id="working" value="ä¼‘å‡º">
            <label class="form-check-label" for="working">ä¼‘å‡º</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="status" id="off" value="äºˆå®šä¼‘">
            <label class="form-check-label" for="off">äºˆå®šä¼‘</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="status" id="radio-time" value="æ™‚é–“ä¼‘">
            <label class="form-check-label" for="radio-time">æ™‚é–“ä¼‘</label>
          </div>
        </div>
        <!-- âœ… æ™‚é–“å…¥åŠ›æ¬„ï¼šé–‹å§‹ãƒ»çµ‚äº† -->
        <div class="mb-3">
          <label class="form-label">â° æ™‚é–“å¸¯</label>
          <div class="row gx-2">
            <div class="col">
              <input type="time" class="form-control" id="startTime" disabled />
            </div>
            <div class="col-auto d-flex align-items-center">ã€œ</div>
            <div class="col">
              <input type="time" class="form-control" id="endTime" disabled />
            </div>
          </div>
          <small class="form-text text-muted ms-1">
            â€»ã€Œæ™‚é–“ä¼‘ã€ã€Œä¼‘å‡ºã€ã‚’é¸æŠã™ã‚‹ã¨æ™‚é–“å¸¯ã‚’å…¥åŠ›ã§ãã¾ã™<br>
            â€»ä¼‘å‡ºã®æ™‚é–“å¸¯ã§ã‚‚ã€Œå–¶æ¥­è¨­å®šã®ä¼‘æ†©æ™‚é–“ã€ã¯äºˆç´„ä¸å¯ã«ãªã‚Šã¾ã™
          </small>
        </div>
        <div class="mb-3">
          <label for="note" class="form-label">ğŸ“ å‚™è€ƒ</label>
          <textarea class="form-control" id="note" rows="2"></textarea>
        </div>
        <div class="d-grid gap-2">
          <button id="saveBtn" class="btn btn-primary mt-2" disabled>ç™»éŒ²</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmSaveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ä¿å­˜ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">å…¥åŠ›å†…å®¹ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-primary" id="confirm-save-btn">ä¿å­˜ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">ã“ã®ä¼‘æš‡ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>

  <script>
  const Utils = {
    sanitize(str) {
      return String(str || "").replace(/[<>"'&]/g, s => ({
        "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;", "&": "&amp;"
      }[s]));
    },
    validate({ staffId, startDate, endDate, status, startTime, endTime }) {
      if (!staffId) throw new Error("âš  ã‚¹ã‚¿ãƒƒãƒ•ã¯å¿…é ˆã§ã™");
      if (!startDate) throw new Error("âš  é–‹å§‹æ—¥ã¯å¿…é ˆã§ã™");
      if (!status) throw new Error("âš  çŠ¶æ…‹ã¯å¿…é ˆã§ã™");

      if (endDate && new Date(startDate) > new Date(endDate)) {
        throw new Error("âš  çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã«ã—ã¦ãã ã•ã„");
      }
      if (status === "æ™‚é–“ä¼‘") {
        if (!startTime || !endTime) throw new Error("âš  æ™‚é–“å¸¯ã¯å¿…é ˆã§ã™");
        if (startTime >= endTime) throw new Error("âš  é–‹å§‹æ™‚é–“ã¯çµ‚äº†æ™‚é–“ã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„");
      }
    }
  };
    
  const prefillStaffId = '<?= staffId ?>';
  const prefillDate = '<?= date ?>';
  const prefillStatus = '<?= status ?>';
  const prefillNote = '<?= note ?>';
  const prefillStartDate = '<?= startDate ?>';
  const prefillEndDate = '<?= endDate ?>';
  const prefillStartTime = '<?= startTime ?>';
  const prefillEndTime = '<?= endTime ?>';

  let leaveData = [];
  let staffList = [];
  let collapseForm;
  let deleteTarget = {};
  let originalLeaveData = null;
  let isEditMode = false;

  window.onload = () => {
    document.getElementById("main-content").style.display = "none";
    document.getElementById("global-spinner").style.display = "block";

    google.script.run.withSuccessHandler(data => {
      renderStaffOptions(data);

      google.script.run.withSuccessHandler(history => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const filtered = history.filter(item => {
          const endDate = new Date(item.endDate || item.startDate);
          return endDate >= today;
        });

        renderHistory(filtered);

        setTimeout(() => {
          document.getElementById("global-spinner").style.display = "none";
          document.getElementById("main-content").style.display = "block";
          document.getElementById("main-content").classList.add("show");

          // âœ… ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼šãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
          if (prefillStaffId && (prefillStartDate || prefillDate) && prefillStatus) {
            document.getElementById("staffId").value = prefillStaffId;

            // startDate / endDate ãŒã‚ã‚Œã°ãã£ã¡ã‚’å„ªå…ˆ
            document.getElementById("startDate").value = prefillStartDate || prefillDate;
            document.getElementById("endDate").value = prefillEndDate || prefillDate;

            const radio = document.querySelector(`input[name='status'][value='${prefillStatus}']`);
            if (radio) radio.checked = true;

            if (prefillNote) {
              document.getElementById("note").value = prefillNote.replace(/\\n/g, "\n");
            }

            if (prefillStartTime) document.getElementById("startTime").value = prefillStartTime;
            if (prefillEndTime) document.getElementById("endTime").value = prefillEndTime;

            originalLeaveData = {
              staffId: prefillStaffId,
              startDate: prefillStartDate || prefillDate,
              endDate: prefillEndDate || prefillDate,
              status: prefillStatus,
              startTime: prefillStartTime || "",
              endTime: prefillEndTime || "",
              note: prefillNote || ""
            };

            document.getElementById("saveBtn").textContent = "æ›´æ–°";
            isEditMode = true;
          } else {
            // æ–°è¦ç™»éŒ²æ‰±ã„
            if (prefillStaffId) document.getElementById("staffId").value = prefillStaffId;
            if (prefillStartDate || prefillDate) {
              document.getElementById("startDate").value = prefillStartDate || prefillDate;
              document.getElementById("endDate").value = prefillEndDate || prefillDate;
            }
          }


          updateTimeInputs();
          collapseForm.show();
          setTimeout(() => {
            document.getElementById("leaveForm").scrollIntoView({ behavior: "smooth", block: "start" });
          }, 300);
        }, 50);
      }).getScheduleHistory();
    }).getStaffList();

    setupInputChangeHandler();
  };

  document.getElementById("startDate").addEventListener("change", () => {
    const startDate = document.getElementById("startDate").value;
    const endDateEl = document.getElementById("endDate");

    if (!endDateEl.value) {
      endDateEl.value = startDate;
    }

    const status = document.querySelector("input[name='status']:checked")?.value;
    if (status === "ä¼‘å‡º" && startDate) {
      google.script.run.withSuccessHandler((map) => {
        const hours = map[startDate];
        if (!hours || hours.length === 0) return;

        const start = hours.map(h => h.start).sort()[0];
        const end = hours.map(h => h.end).sort().reverse()[0];

        const startTimeEl = document.getElementById("startTime");
        const endTimeEl = document.getElementById("endTime");
        startTimeEl.value = start;
        endTimeEl.value = end;
      }).getBusinessHourMap(startDate);
    }
  });



  // âœ… ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³å¤‰æ›´æ™‚ã«æ™‚é–“å…¥åŠ›åˆ¶å¾¡
  function setupRadioControl() {
    const radios = document.querySelectorAll('input[name="status"]');
    radios.forEach(radio => {
      radio.addEventListener("change", () => {
        updateTimeInputs();
      });
    });

    // åˆæœŸçŠ¶æ…‹ã«ã‚‚åæ˜ 
    updateTimeInputs();

    document.getElementById("startTime").addEventListener("change", () => {
      const start = document.getElementById("startTime");
      const end = document.getElementById("endTime");
      if (!end.value) {
        end.value = start.value;
      }
    });
  }

  document.querySelectorAll("input[name='status']").forEach(radio => {
    radio.addEventListener("change", () => {
      updateTimeInputs();

      const selected = document.querySelector("input[name='status']:checked")?.value;
      const startDate = document.getElementById("startDate").value;

      if (selected === "ä¼‘å‡º" && startDate) {
        google.script.run.withSuccessHandler((map) => {
          const hours = map[startDate];
          if (!hours || hours.length === 0) return;

          const start = hours.map(h => h.start).sort()[0];
          const end = hours.map(h => h.end).sort().reverse()[0];

          const startTimeEl = document.getElementById("startTime");
          const endTimeEl = document.getElementById("endTime");
          startTimeEl.value = start;
          endTimeEl.value = end;
        }).getBusinessHourMap(startDate);
      }
    });
  });


  function updateTimeInputs() {
    const selected = document.querySelector("input[name='status']:checked");
    const isTimeRequired = selected && (selected.value === "æ™‚é–“ä¼‘" || selected.value === "ä¼‘å‡º");

    const start = document.getElementById("startTime");
    const end = document.getElementById("endTime");

    start.disabled = !isTimeRequired;
    end.disabled = !isTimeRequired;

    if (!isTimeRequired) {
      start.value = "";
      end.value = "";
    }
  }


  // âœ… ä¿å­˜ãƒœã‚¿ãƒ³ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  function handleSaveClick() {
    try {
      const formData = {
        staffId: document.getElementById("staffId").value.trim(),
        startDate: document.getElementById("startDate").value.trim(),
        endDate: document.getElementById("endDate").value.trim(),
        status: document.querySelector("input[name='status']:checked")?.value,
        startTime: document.getElementById("startTime").value,
        endTime: document.getElementById("endTime").value,
        note: document.getElementById("note").value.trim()
      };

      Utils.validate(formData);

      // ã‚µãƒ‹ã‚¿ã‚¤ã‚º
      const sanitized = {
        staffId: Utils.sanitize(formData.staffId),
        startDate: formData.startDate,
        endDate: formData.endDate,
        status: formData.status,
        startTime: formData.startTime,
        endTime: formData.endTime,
        note: Utils.sanitize(formData.note)
      };

      isEditMode = !!originalLeaveData;

      showDiffModal(sanitized);

    } catch (err) {
      showMessage(err.message, true);
    }
  }

  function showDiffModal(newData) {
    const modalTitle = document.querySelector("#confirmSaveModal .modal-title");
    modalTitle.textContent = originalLeaveData ? "æ›´æ–°ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ" : "ç™»éŒ²ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";

    const labels = {
      staffId: "ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•",
      startDate: "ğŸ“… é–‹å§‹æ—¥",
      endDate: "ğŸ“… çµ‚äº†æ—¥",
      status: "ğŸ›Œ çŠ¶æ…‹",
      startTime: "â° é–‹å§‹æ™‚é–“",
      endTime: "â° çµ‚äº†æ™‚é–“",
      note: "ğŸ“ å‚™è€ƒ"
    };

    const isNew = !originalLeaveData;

    let diffHtml = '<ul class="list-group list-group-flush">';

    for (const key of Object.keys(labels)) {
      const label = labels[key];
      const oldValRaw = originalLeaveData?.[key] ?? "";
      const newValRaw = newData[key] ?? "";

      let oldVal = oldValRaw;
      let newVal = newValRaw;

      // âœ… ã‚¹ã‚¿ãƒƒãƒ•åã®è¡¨ç¤ºå¤‰æ›
      if (key === "staffId") {
        oldVal = staffList.find(s => s.id === oldValRaw)?.name || oldValRaw;
        newVal = staffList.find(s => s.id === newValRaw)?.name || newValRaw;
      }

      if (isNew) {
        diffHtml += `<li class="list-group-item">${label}ï¼š${newVal || "-"}</li>`;
      } else {
        const changed = oldValRaw !== newValRaw;
        const klass = changed ? "text-danger fw-bold" : "";
        const arrow = changed ? ` â†’ ${newVal || "-"}` : "";
        diffHtml += `<li class="list-group-item ${klass}">${label}ï¼š${oldVal || "-"}${arrow}</li>`;
      }
    }

    diffHtml += '</ul>';

    document.querySelector("#confirmSaveModal .modal-body").innerHTML = diffHtml;

    const confirmBtn = document.getElementById("confirm-save-btn");
    confirmBtn.textContent = originalLeaveData ? "æ›´æ–°" : "ç™»éŒ²";

    new bootstrap.Modal(document.getElementById("confirmSaveModal")).show();
  }


  function setupSaveHandler() {
    document.getElementById("saveBtn").addEventListener("click", handleSaveClick);

    document.getElementById("confirm-save-btn")?.addEventListener("click", () => {
      // âœ… ã“ã£ã¡ã§åæ˜ 
      const savingText = isEditMode ? "æ›´æ–°ã—ã¦ã„ã¾ã™â€¦" : "ç™»éŒ²ã—ã¦ã„ã¾ã™â€¦";
      document.getElementById("saving-spinner").querySelector("p").textContent = savingText;

      const staffId = document.getElementById("staffId").value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const status = document.querySelector("input[name='status']:checked").value;
      const note = document.getElementById("note").value;

      let startTime = "";
      let endTime = "";
      if (status === "æ™‚é–“ä¼‘" || status === "ä¼‘å‡º")  {
        startTime = document.getElementById("startTime").value;
        endTime = document.getElementById("endTime").value;
      }

      const payload = {
        staffId: Utils.sanitize(staffId),
        status,
        startDate,
        endDate,
        startTime,
        endTime,
        note: Utils.sanitize(note),
        originalStaffId: originalLeaveData?.staffId || "",
        originalStartDate: originalLeaveData?.startDate || "",
        originalEndDate: originalLeaveData?.endDate || ""
      };

      // âœ… ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
      if (!validateSafeInputs(payload)) {
        alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
        return;
      }

      const modal = bootstrap.Modal.getInstance(document.getElementById("confirmSaveModal"));
      modal.hide();

      collapseForm.hide();

      document.getElementById("main-content").style.display = "none";
      document.getElementById("saving-spinner").style.display = "block";

      google.script.run.withSuccessHandler(() => {
        clearForm();
        google.script.run.withSuccessHandler(history => {
          renderHistory(history);
          setTimeout(() => {
            document.getElementById("saving-spinner").style.display = "none";
            document.getElementById("main-content").style.display = "block";
            showMessage("âœ… ç™»éŒ²å®Œäº†ï¼");
            document.getElementById("saveBtn").disabled = true;
          }, 50);
        }).getScheduleHistory();
      }).withFailureHandler(e => {
        document.getElementById("saving-spinner").style.display = "none";
        document.getElementById("main-content").style.display = "block";
        showMessage("âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š" + e.message, true);
      }).saveScheduleEntry(payload);
    });
  }

  function clearForm() {
    document.getElementById("staffId").value = "";
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("note").value = "";
    document.getElementById("startTime").value = "";
    document.getElementById("endTime").value = "";
    document.getElementById("startTime").disabled = true;
    document.getElementById("endTime").disabled = true;
    document.querySelectorAll("input[name='status']").forEach(r => r.checked = false);

    updateTimeInputs();

    // â¬‡ï¸ ãƒœã‚¿ãƒ³æ–‡è¨€ãƒªã‚»ãƒƒãƒˆ
    document.getElementById("saveBtn").textContent = "ç™»éŒ²";

    // â¬‡ï¸ ç·¨é›†ãƒ•ãƒ©ã‚°ã‚¯ãƒªã‚¢
    originalLeaveData = null;
  }



  function renderStaffOptions(data) {
    const select = document.getElementById("staffId");
    staffList = data;
    select.innerHTML = '<option value="">ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

    data.forEach(staff => {
      const opt = document.createElement("option");
      opt.value = staff.id;
      opt.textContent = `${staff.id}ï¼š${staff.name}`;
      select.appendChild(opt);
    });

    // â† ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã§åæ˜ ã™ã‚‹
    if (prefillStaffId) {
      select.value = prefillStaffId;
    }
  }

  function renderHistory(data) {
    leaveData = data;

    // âœ… é–‹å§‹æ—¥ã§ã‚½ãƒ¼ãƒˆ
    data.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

    const tbody = document.getElementById("historyTableBody");
    tbody.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
    } else {
      data.forEach((item, index) => {
        const dateDisplay = item.startDate === item.endDate || !item.endDate
          ? item.startDate
          : `${item.startDate}ã€œ${item.endDate}`;

        const timeDisplay = item.startTime && item.endTime
          ? `${item.startTime}ã€œ${item.endTime}`
          : "";

        const tr = document.createElement("tr");
        tr.classList.add(item.status === "ä¼‘å‡º" ? "schedule-working" : "schedule-off");

        tr.innerHTML = `
          <td>${dateDisplay}</td>
          <td>${item.staffId}</td>
          <td>${item.staffName || ""}</td>
          <td>${item.status}</td>
          <td>${timeDisplay}</td>
          <td>${item.note || ""}</td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-warning me-1" onclick="loadToForm(${index})">ç·¨é›†</button>
            <button class="btn btn-sm btn-danger" onclick="deleteLeave('${item.staffId}', '${item.startDate}', '${item.endDate || ""}')">å‰Šé™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  }

  function loadToForm(index) {
    const item = leaveData[index];
    const formEl = document.getElementById("leaveForm");
    collapseForm.show();
    setTimeout(() => {
      formEl.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 300);

    // ç·¨é›†å‰ãƒ‡ãƒ¼ã‚¿ä¿æŒ
    originalLeaveData = { ...item };

    document.getElementById("staffId").value = item.staffId;
    document.getElementById("startDate").value = item.startDate || "";
    document.getElementById("endDate").value = item.endDate || "";
    document.getElementById("note").value = item.note || "";

    const radio = document.querySelector(`input[name='status'][value='${item.status}']`);
    if (radio) radio.checked = true;

    const isTimeOff = item.status === "æ™‚é–“ä¼‘";
    document.getElementById("startTime").disabled = !isTimeOff;
    document.getElementById("endTime").disabled = !isTimeOff;
    document.getElementById("startTime").value = item.startTime || "";
    document.getElementById("endTime").value = item.endTime || "";

    updateTimeInputs();

    document.getElementById("saveBtn").textContent = "æ›´æ–°";
  }



  function deleteLeave(staffId, startDate, endDate) {
    deleteTarget = { staffId, startDate, endDate };
    const modal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
    modal.show();
  }

  function setupDeleteHandler() {
    document.getElementById("confirm-delete-btn")?.addEventListener("click", () => {
      const { staffId, startDate, endDate } = deleteTarget;
      const modal = bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal"));
      modal.hide();

      if (collapseForm) collapseForm.hide();
      clearForm();

      document.getElementById("main-content").style.display = "none";
      document.getElementById("delete-spinner").style.display = "block";

      google.script.run
        .withSuccessHandler(() => {
          google.script.run.withSuccessHandler(history => {
            renderHistory(history);
            setTimeout(() => {
              document.getElementById("delete-spinner").style.display = "none";
              document.getElementById("main-content").style.display = "block";
              showMessage("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");
            }, 50);
          }).getScheduleHistory();
        })
        .withFailureHandler(e => {
          showMessage("âŒ å‰Šé™¤å¤±æ•—ï¼š" + e.message, true);
          document.getElementById("delete-spinner").style.display = "none";
          document.getElementById("main-content").style.display = "block";
        })
        .deleteScheduleEntry(staffId, startDate, endDate);
    });
  }

  function showMessage(msg, isError = false) {
    const success = document.getElementById("success-message");
    const error = document.getElementById("error-message");
    success.style.display = "none";
    error.style.display = "none";

    const target = isError ? error : success;
    target.textContent = msg;
    target.style.display = "block";
    setTimeout(() => (target.style.display = "none"), 4000);
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("[CHILD] DOMContentLoaded â†’ child-ready ã‚’è¦ªã¸é€ä¿¡");
    try {
      window.top.postMessage(
        { type: "misemaru:child-ready", origin: location.origin },
        "*" // è¦ªå´ã§å¿…ãš event.origin ã‚’æ¤œè¨¼ã™ã‚‹ã®ã§å®‰å…¨
      );
    } catch (err) {
      console.error("[CHILD] child-ready é€ä¿¡å¤±æ•—:", err);
    }

    const toggleBtn = document.getElementById("toggleFormBtn");
    const formEl = document.getElementById("leaveForm");
    collapseForm = new bootstrap.Collapse(formEl, { toggle: false });

    toggleBtn.addEventListener("click", () => {
      const visible = formEl.classList.contains("show");
      if (visible) {
        collapseForm.hide();
      } else {
        collapseForm.show();
        setTimeout(() => {
          formEl.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      }
    });

    formEl.addEventListener("hide.bs.collapse", () => {
      toggleBtn.textContent = "ï¼‹ æ–°è¦ä½œæˆ";
      clearForm();
    });

    formEl.addEventListener("show.bs.collapse", () => {
      toggleBtn.textContent = "âˆ’ é–‰ã˜ã‚‹";
    });

    // âœ… ã“ã“ã«è¿½åŠ 
    setupRadioControl();
    setupSaveHandler();
    setupDeleteHandler();
    setupTimeSync();
  });

  function setupTimeSync() {
    const startInput = document.getElementById("startTime");
    const endInput = document.getElementById("endTime");

    let autoSyncEnabled = true;

    if (startInput && endInput) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ endTime ã‚’æ‰‹å‹•ã§å¤‰æ›´ã—ãŸã‚‰åŒæœŸã‚„ã‚ã‚‹
      endInput.addEventListener("input", () => {
        autoSyncEnabled = false;
      });

      // startTime ã‚’å¤‰æ›´ã—ãŸã‚‰ endTime ã«åæ˜ ï¼ˆåŒæœŸä¸­ã®ã¿ï¼‰
      startInput.addEventListener("input", () => {
        if (autoSyncEnabled) {
          endInput.value = startInput.value;
        }
      });
    }
  }

  function setupInputChangeHandler() {
    const form = document.getElementById("leaveForm");
    const saveBtn = document.getElementById("saveBtn");

    form.addEventListener("input", () => {
      saveBtn.disabled = !hasFormChanged();
    });

    form.addEventListener("change", () => {
      saveBtn.disabled = !hasFormChanged();
    });
  }

  function hasFormChanged() {
    const staffId = document.getElementById("staffId").value;
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;
    const status = document.querySelector("input[name='status']:checked")?.value;
    const startTime = document.getElementById("startTime").value;
    const endTime = document.getElementById("endTime").value;
    const note = document.getElementById("note").value;

    const newData = {
      staffId,
      startDate,
      endDate,
      status,
      startTime: status === "æ™‚é–“ä¼‘" ? startTime : "",
      endTime: status === "æ™‚é–“ä¼‘" ? endTime : "",
      note
    };

    if (!originalLeaveData) {
      // æ–°è¦ â†’ ã™ã¹ã¦ç©ºãªã‚‰ false
      return !!(staffId && startDate && endDate && status);
    } else {
      // æ›´æ–° â†’ å·®åˆ†ãŒ1ã¤ã§ã‚‚ã‚ã‚Œã° true
      return Object.keys(newData).some(k => newData[k] !== originalLeaveData[k]);
    }
  }



  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
