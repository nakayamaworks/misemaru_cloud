<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>ğŸ§‘â€ğŸ’¼ ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²</title>
  <style>
    .btn-register-wrapper {
    max-width: 440px;
    margin: auto;
  }

  .weekdays label {
    margin-right: 0.5rem;
  }

  </style>
</head>
<body class="container-fluid py-3 loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­...</p>
  </div>
  <div id="app" style="display:none;">

  <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('20_staff_main_staff')">â† æˆ»ã‚‹</button>
  <h4 class="text-center mb-1">ğŸ§‘â€ğŸ’¼ ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²</h4>

  <!-- ğŸ”„ åˆæœŸèª­ã¿è¾¼ã¿ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="init-spinner" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <p class="mt-3">ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</p>
  </div>

  <!-- ğŸ”„ ä¿å­˜ä¸­ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="saving-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ä¿å­˜ä¸­...</span>
    </div>
    <p class="mt-2">ä¿å­˜ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  <!-- ğŸ”„ å‰Šé™¤ä¸­ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="deleting-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-danger" role="status">
      <span class="visually-hidden">å‰Šé™¤ä¸­...</span>
    </div>
    <p class="mt-2">å‰Šé™¤ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  <div id="main-content" style="display: none;">
    <!-- ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ• ä¸€è¦§ï¼ˆã“ã“ã¯å¾Œã»ã©JSã§å‹•çš„ã«ç”Ÿæˆï¼‰ -->
    <div id="staffListArea" class="mb-0">
      <h5>ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•</h5>
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>åå‰</th>
              <th>æ€§åˆ¥</th>
              <th>å½¹è·</th>
              <th>æ‹…å½“</th>
              <th>ãƒ¡ãƒ¼ãƒ«</th>
              <th>é€šçŸ¥</th>
              <th>å‚™è€ƒ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="staffTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ï¼‹æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ -->
    <div class="form-wrapper mb-3">
      <button id="toggleFormBtn" class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#staffForm" aria-expanded="false" aria-controls="staffForm">
        ï¼‹ æ–°è¦ä½œæˆ
      </button>
    </div>

    <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="collapse" id="staffForm">
       <div class="form-wrapper">
        <h5 class="mb-2 mt-0">ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h5>
        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="formErrorMsg" class="alert alert-danger py-2 px-3 my-2" style="display: none;"></div>

        <input type="hidden" id="staffId" />
        <div class="mb-3">
          <label class="form-label">åå‰</label>
          <input type="text" class="form-control" id="staffName" required />
        </div>

        <div class="mb-3">
          <label class="form-label">æ€§åˆ¥ <span class="text-muted">(ä»»æ„)</span></label>
          <select class="form-select" id="staffGender">
            <option value="">æœªå›ç­”</option>
            <option value="ç”·æ€§">ç”·æ€§</option>
            <option value="å¥³æ€§">å¥³æ€§</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">å½¹è·</label>
          <input type="text" class="form-control" id="staffPosition" />
        </div>

        <!-- æ‹…å½“ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰ -->
        <div class="mb-3">
          <label class="form-label">æ‹…å½“ã‚µãƒ¼ãƒ“ã‚¹</label>
          <div id="assignedServiceContainer" class="border rounded p-2 bg-white" style="max-height: 200px; overflow-y: auto;">
            <!-- ã“ã“ã«èª­ã¿è¾¼ã¿ã‚¹ãƒ”ãƒŠãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚¹ãƒˆãŒå‹•çš„ã«å…¥ã‚‹ -->
            <div id="service-loading-spinner" class="text-center my-2">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
              </div>
              <p class="mt-2 mb-0 text-muted">ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</p>
            </div>
          </div>
          <small class="text-muted">â€»æ‹…å½“ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆè¤‡æ•°å¯ï¼‰</small>
        </div>


        <div class="mb-3">
          <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="text-muted">(ä»»æ„)</span></label>
          <input type="email" class="form-control" id="staffEmail" placeholder="example@example.com" />
        </div>

        <div class="mb-3">
          <label class="form-label">é€šçŸ¥è¨­å®š</label>
          <select class="form-select" id="staffNotification">
            <option value="ON">ONï¼ˆé€šçŸ¥ã‚’å—ã‘å–ã‚‹ï¼‰</option>
            <option value="OFF" selected>OFFï¼ˆé€šçŸ¥ãªã—ï¼‰</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">å‚™è€ƒ</label>
          <textarea class="form-control" id="staffNote" rows="2"></textarea>
        </div>

        <div class="d-grid btn-register-wrapper">
          <button class="btn btn-primary w-100" id="submitBtn" onclick="openConfirmModal()" disabled>ç™»éŒ²</button>
        </div>
      </div>
    </div>

    <!-- ç™»éŒ²ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ã“ã®å†…å®¹ã§ç™»éŒ²ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modal-body-text">å†…å®¹ç¢ºèªä¸­...</div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" id="confirm-register-btn">ç™»éŒ²</button>
          </div>
        </div>
      </div>
    </div>

    <!-- âœ… å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="delete-modal-body">ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-btn">å‰Šé™¤ã™ã‚‹</button>
          </div>
        </div>
      </div>
    </div>
  </div>  


  <script>
    let deleteTargetId = null;
    let collapseInstance = null;
    let cachedServiceList = null;
    
    document.addEventListener("DOMContentLoaded", () => {
      console.log("[CHILD] DOMContentLoaded â†’ child-ready ã‚’è¦ªã¸é€ä¿¡");
      try {
        window.top.postMessage(
          { type: "misemaru:child-ready", origin: location.origin },
          "*" // è¦ªå´ã§å¿…ãš event.origin ã‚’æ¤œè¨¼ã™ã‚‹ã®ã§å®‰å…¨
        );
      } catch (err) {
        console.error("[CHILD] child-ready é€ä¿¡å¤±æ•—:", err);
      }

      // âœ… ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«
      const confirmBtn = document.getElementById("confirm-register-btn");
      if (confirmBtn) {
        confirmBtn.addEventListener("click", () => {
          const modalEl = document.getElementById("confirmModal");
          const modal = bootstrap.Modal.getInstance(modalEl);
          if (modal) modal.hide();

          saveStaff();  // ä¿å­˜å®Ÿè¡Œ
        });
      }

      // âœ… å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«
      const deleteBtn = document.getElementById("confirm-delete-btn");
      if (deleteBtn) {
        deleteBtn.addEventListener("click", () => {
          if (!deleteTargetId) return;

          document.getElementById("deleting-spinner").style.display = "block";
          document.getElementById("main-content").style.display = "none";

          const modalEl = document.getElementById("deleteModal");
          const modal = bootstrap.Modal.getInstance(modalEl);
          if (modal) modal.hide();

          google.script.run
            .withSuccessHandler(() => {
              deleteTargetId = null;
              google.script.run.withSuccessHandler((list) => {
                renderStaffList(list);
                document.getElementById("deleting-spinner").style.display = "none";
                document.getElementById("main-content").style.display = "block";

                collapseInstance?.hide();
                resetForm();
                
              }).getStaffList();
            })
            .deleteStaff(deleteTargetId);
        });
      }

      // âœ… Collapseï¼ˆãƒ•ã‚©ãƒ¼ãƒ é–‹é–‰ï¼‰
      const btnEl = document.getElementById("toggleFormBtn");
      const formEl = document.getElementById("staffForm");

      if (!collapseInstance) {
        collapseInstance = new bootstrap.Collapse(formEl, { toggle: false });
      }

      btnEl.addEventListener("click", () => {
        const isVisible = formEl.classList.contains("show");

        if (isVisible) {
          collapseInstance.hide();
        } else {
          collapseInstance.show();
          setTimeout(() => {
            formEl.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 300);
        }
      });

      formEl.addEventListener("show.bs.collapse", () => {
        btnEl.textContent = "âˆ’ é–‰ã˜ã‚‹";
      });

      formEl.addEventListener("hide.bs.collapse", () => {
        btnEl.textContent = "ï¼‹ æ–°è¦ä½œæˆ";
        resetForm();
      });

      //å…¥åŠ›æ¬„ãƒ»ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã« validateForm å‘¼ã¶
      ["staffName", "staffGender", "staffEmail", "staffNotification", "staffPosition", "staffNote"].forEach(id => {
        document.getElementById(id).addEventListener("input", validateForm);
      });
      document.getElementById("assignedServiceContainer").addEventListener("change", validateForm);

    });



    window.onload = function () {
      google.script.run.withSuccessHandler((list) => {
        renderStaffList(list);
        document.getElementById("init-spinner").style.display = "none";
        document.getElementById("main-content").style.display = "block";
      }).getStaffList();

      google.script.run.withSuccessHandler(serviceList => {
        cachedServiceList = serviceList;
        renderServiceList(serviceList);
      }).getServiceList();
    };

    function renderStaffList(data) {
      const tbody = document.getElementById("staffTableBody");
      tbody.innerHTML = "";

      if (!Array.isArray(data) || data.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 8;
        td.className = "text-center";
        td.textContent = "ç™»éŒ²ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•ãŒã„ã¾ã›ã‚“";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      data.forEach((item, i) => {
        const tr = document.createElement("tr");

        const createTd = (text) => {
          const td = document.createElement("td");
          td.textContent = text || "-";
          return td;
        };

        tr.appendChild(createTd(item.name));
        tr.appendChild(createTd(item.gender));
        tr.appendChild(createTd(item.position));
        tr.appendChild(createTd(item.assignedServices));
        tr.appendChild(createTd(item.email));
        tr.appendChild(createTd(item.notification));
        tr.appendChild(createTd(item.note));

        const actionTd = document.createElement("td");

        const editBtn = document.createElement("button");
        editBtn.className = "btn btn-sm btn-warning";
        editBtn.textContent = "ç·¨é›†";
        editBtn.onclick = () => editStaff(i);
        actionTd.appendChild(editBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-sm btn-danger";
        deleteBtn.textContent = "å‰Šé™¤";
        deleteBtn.onclick = () => deleteStaff(item.id);
        actionTd.appendChild(deleteBtn);

        tr.appendChild(actionTd);
        tbody.appendChild(tr);
      });


      // ğŸ‘‰ ã“ã“ã§ staffData ã«ã‚µãƒ¼ãƒ“ã‚¹IDã‚‚ä¿æŒã—ã¦ãŠã
      window.staffData = data.map(d => ({
        ...d,
        assignedServiceIds: d.assignedServiceIds || [], // â† ã“ã‚Œã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå´ã‹ã‚‰å–ã‚‹
      }));
    }


    function renderServiceList(serviceList) {
      const container = document.getElementById("assignedServiceContainer");
      container.innerHTML = ""; // åˆæœŸåŒ–

      if (!Array.isArray(serviceList) || serviceList.length === 0) {
        container.innerHTML = "<div>ã‚µãƒ¼ãƒ“ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>";
        return;
      }

      serviceList.forEach(service => {
        const div = document.createElement("div");
        div.className = "form-check";

        const checkbox = document.createElement("input");
        checkbox.className = "form-check-input";
        checkbox.type = "checkbox";
        checkbox.id = `service-${service.id}`;
        checkbox.value = service.id;
        checkbox.name = "assignedService";

        const label = document.createElement("label");
        label.className = "form-check-label";
        label.htmlFor = `service-${service.id}`;
        label.textContent = service.name;

        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    function getFormData() {
      return {
        id: document.getElementById("staffId").value,
        name: document.getElementById("staffName").value,
        gender: document.getElementById("staffGender").value,
        email: document.getElementById("staffEmail").value,
        notification: document.getElementById("staffNotification").value,
        position: document.getElementById("staffPosition").value,
        // role: å‰Šé™¤
        note: document.getElementById("staffNote").value,
        assignedServiceIds: Array.from(document.querySelectorAll('input[name="assignedService"]:checked')).map(cb => cb.value)
      };
    }

    function saveStaff() {
      const data = getFormData();
      const isEdit = !!data.id;

      // âœ… ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
      if (!validateSafeInputs(data)) {
        alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
        return;
      }

      // ğŸ” è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼šä¿å­˜ä¸­ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤º
      document.getElementById("saving-spinner").style.display = "block";
      document.querySelector("#saving-spinner p").textContent = isEdit ? "æ›´æ–°ã—ã¦ã„ã¾ã™â€¦" : "ç™»éŒ²ã—ã¦ã„ã¾ã™â€¦";
      document.getElementById("main-content").style.display = "none";

      google.script.run
        .withSuccessHandler(() => {
          google.script.run.withSuccessHandler((list) => {
            renderStaffList(list);
            collapseInstance?.hide();
            resetForm();

            // ğŸ” è¡¨ç¤ºå¾©å¸°
            document.getElementById("saving-spinner").style.display = "none";
            document.getElementById("main-content").style.display = "block";
          }).getStaffList();
        })
        .saveStaff(data);
    }

    function openConfirmModal() {
      const name = document.getElementById("staffName").value.trim();
      const gender = document.getElementById("staffGender").value.trim();
      const email = document.getElementById("staffEmail").value.trim();
      const notification = document.getElementById("staffNotification").value;
      const errorEl = document.getElementById("formErrorMsg");

      // âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
      let errorMsg = "";
      if (!name) errorMsg = "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      else if (notification === "ON" && !email) errorMsg = "é€šçŸ¥ONã®å ´åˆã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™ã€‚";
      else if (email && !/^[\w\-.]+@[\w\-.]+\.\w+$/.test(email)) errorMsg = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚";

      if (errorMsg) {
        errorEl.textContent = errorMsg;
        errorEl.style.display = "block";
        return;
      } else {
        errorEl.style.display = "none";
      }

      const isEdit = !!document.getElementById("staffId").value;
      const newData = getFormData();
      const oldData = editingStaffIndex !== null ? staffData[editingStaffIndex] : null;

      const modalTitle = document.querySelector("#confirmModal .modal-title");
      modalTitle.textContent = isEdit ? "ã“ã®å†…å®¹ã§æ›´æ–°ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ" : "ã“ã®å†…å®¹ã§ç™»éŒ²ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";

      const confirmBtn = document.getElementById("confirm-register-btn");
      confirmBtn.textContent = isEdit ? "æ›´æ–°" : "ç™»éŒ²";

      const modalBody = document.getElementById("modal-body-text");
      modalBody.innerHTML = "";

      const ul = document.createElement("ul");
      ul.className = "list-group list-group-flush";

      const createLi = (label, oldVal, newVal) => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        const changed = oldData && oldVal !== newVal;
        if (changed) li.classList.add("text-danger", "fw-bold");

        const text = oldData
          ? `${oldVal || "-"} â†’ ${newVal || "-"}`
          : `${newVal || "-"}`;
        li.textContent = `${label}ï¼š${text}`;
        return li;
      };

      ul.appendChild(createLi("åå‰", oldData?.name, newData.name));
      ul.appendChild(createLi("æ€§åˆ¥", oldData?.gender, newData.gender));
      ul.appendChild(createLi("å½¹è·", oldData?.position, newData.position));
      ul.appendChild(createLi("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", oldData?.email, newData.email));
      ul.appendChild(createLi("é€šçŸ¥è¨­å®š", oldData?.notification, newData.notification));
      ul.appendChild(createLi("å‚™è€ƒ", oldData?.note, newData.note));

      // âœ… æ‹…å½“ã‚µãƒ¼ãƒ“ã‚¹
      const newServices = Array.from(document.querySelectorAll('input[name="assignedService"]:checked'))
        .map(cb => cb.nextSibling.textContent.trim());
      const newServiceText = newServices.join("ã€");

      const serviceLi = document.createElement("li");
      serviceLi.className = "list-group-item";
      if (oldData) {
        const oldServiceText = oldData.assignedServices || "-";
        const changed = oldServiceText !== newServiceText;
        if (changed) serviceLi.classList.add("text-danger", "fw-bold");
        serviceLi.textContent = `æ‹…å½“ã‚µãƒ¼ãƒ“ã‚¹ï¼š${oldServiceText} â†’ ${newServiceText || "-"}`;
      } else {
        serviceLi.textContent = `æ‹…å½“ã‚µãƒ¼ãƒ“ã‚¹ï¼š${newServiceText || "-"}`;
      }
      ul.appendChild(serviceLi);

      modalBody.appendChild(ul);

      new bootstrap.Modal(document.getElementById("confirmModal")).show();
    }

    window.editingStaffIndex = null;

    function editStaff(index) {
      const data = staffData[index];
      window.editingStaffIndex = index;
      if (!data) return;

      document.getElementById("staffId").value = data.id;
      document.getElementById("staffName").value = data.name;
      document.getElementById("staffGender").value = data.gender || "";
      document.getElementById("staffEmail").value = data.email || "";
      document.getElementById("staffNotification").value = data.notification || "OFF";
      document.getElementById("staffPosition").value = data.position || "";
      document.getElementById("staffNote").value = data.note || "";

      // âœ… å†æç”» ï¼† ãƒã‚§ãƒƒã‚¯åæ˜ ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰
      renderServiceList(cachedServiceList);
      document.querySelectorAll('input[name="assignedService"]').forEach(cb => cb.checked = false);
      (data.assignedServiceIds || []).forEach(serviceId => {
        const cb = document.getElementById(`service-${serviceId}`);
        if (cb) cb.checked = true;
      });

      // Collapse é–‹ãå‡¦ç†ã¯ãã®ã¾ã¾
      const formEl = document.getElementById("staffForm");
      if (!collapseInstance) {
        collapseInstance = new bootstrap.Collapse(formEl, { toggle: false });
      }

      if (!formEl.classList.contains("show")) {
        formEl.addEventListener("shown.bs.collapse", function handler() {
          formEl.scrollIntoView({ behavior: "smooth", block: "start" });
          formEl.removeEventListener("shown.bs.collapse", handler);
        });
        collapseInstance.show();
      } else {
        formEl.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      updateSubmitButtonText();
      validateForm();
    }



    function deleteStaff(staffId) {
      deleteTargetId = staffId;

      // åå‰è¡¨ç¤ºï¼ˆä»»æ„ã§è¡¨ç¤ºåãŒã‚ã‚Œã°ï¼‰
      const target = staffData.find(s => s.id === staffId);
      const name = target ? target.name : "ã“ã®ã‚¹ã‚¿ãƒƒãƒ•";

      document.getElementById("delete-modal-body").innerHTML = `
        <div>ã‚¹ã‚¿ãƒƒãƒ•ï¼š<strong>${name}</strong><br>ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
      `;

      const modal = new bootstrap.Modal(document.getElementById("deleteModal"));
      modal.show();
    }

    function resetForm() {
      document.getElementById("staffId").value = "";
      document.getElementById("staffName").value = "";
      document.getElementById("staffGender").value = "";
      document.getElementById("staffEmail").value = "";
      document.getElementById("staffNotification").value = "OFF";
      document.getElementById("staffPosition").value = "";
      document.getElementById("staffNote").value = "";
      editingStaffIndex = null;

      // âœ… æ‹…å½“ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒã‚§ãƒƒã‚¯ã‚’å…¨éƒ¨å¤–ã™
      document.querySelectorAll('input[name="assignedService"]').forEach(cb => cb.checked = false);
      updateSubmitButtonText();
      document.getElementById("formErrorMsg").style.display = "none";
      validateForm();
    }

    function updateSubmitButtonText() {
      const isEdit = !!document.getElementById("staffId").value;
      const btn = document.querySelector('#staffForm button.btn-primary');
      btn.textContent = isEdit ? "æ›´æ–°" : "ç™»éŒ²";
    }

    function validateForm() {
      const name = document.getElementById("staffName").value.trim();
      const gender = document.getElementById("staffGender").value.trim();
      const email = document.getElementById("staffEmail").value.trim();

      const isEdit = !!document.getElementById("staffId").value;
      const currentData = getFormData();
      const oldData = editingStaffIndex !== null ? staffData[editingStaffIndex] : null;

      let changed = false;

      if (!isEdit) {
        // æ–°è¦ â†’ 1ã¤ã§ã‚‚å…¥åŠ›ã‚ã‚Œã°æ´»æ€§åŒ–
        changed = !!(name || gender || email);
      } else {
        if (!oldData) return false;
        changed = (
          oldData.name !== currentData.name ||
          oldData.gender !== currentData.gender ||
          oldData.position !== currentData.position ||
          oldData.email !== currentData.email ||
          oldData.notification !== currentData.notification ||
          oldData.note !== currentData.note ||
          JSON.stringify(oldData.assignedServiceIds || []) !== JSON.stringify(currentData.assignedServiceIds || [])
        );
      }

      document.getElementById("submitBtn").disabled = !changed;
    }

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
