<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>⏰ 営業時間</title>
  <style>
    .time-row td {
    vertical-align: middle;
  }

  .time-row input[type="time"],
  .time-row select {
    width: 100%;
    min-width: 90px;
  }

  .table-responsive {
    overflow-x: auto;
  }

  th:nth-child(n+4):nth-child(-n+10),
  td:nth-child(n+4):nth-child(-n+10) {
    text-align: center;
  }

  </style>
</head>
<body class="loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>認証チェック中...</p>
  </div>
  <div id="app" style="display:none;">

<div class="container-fluid py-3">
  <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('40_setting_main_admin')">← 戻る</button>
  <h4 class="mb-3 text-center">⏰ 営業時間設定</h4>

  <div id="success-message" class="alert alert-success text-center" style="display: none;"></div>
  <div id="error-message" class="alert alert-danger text-center" style="display: none;"></div>

  <div id="form-area">
    <div class="form-wrapper">
      <div class="mb-3">
        <label for="scheduleSelect" class="form-label">🗂 営業時間設定の選択</label>
        <select id="scheduleSelect" class="form-select">
          <option value="new">＋ 新しい営業時間設定を作成</option>
        </select>
      </div>

      <div class="mb-3" id="applyDateWrapper">
        <label for="applyDate" class="form-label">🗓 適用開始日</label>
        <input type="date" id="applyDate" class="form-control">
        <small id="applyDateNotice" class="text-danger ms-1" style="display: none;">
          ※既存データは適用開始日を変更できません
        </small>
      </div>

      <div class="mb-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="holidayCloseFlag">
            <label class="form-check-label fw-bold" for="holidayCloseFlag">祝日休業</label>
          </div>
          <div class="text-muted small mt-1">※ONで日本の祝日を終日「休業日」扱いにします</div>
      </div>
    </div>

    <div class="table-responsive px-2">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="col-narrow">開始</th>
            <th class="col-narrow">終了</th>
            <th class="col-narrow">区分</th>
            <th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="timeTableBody"></tbody>
      </table>
      <p class="text-muted small mt-0">※ 行の追加・削除は右端の＋ / － ボタンから操作してください</p>
      </div>
      <div class="form-wrapper">
        <div class="d-grid gap-2 mt-3 mb-3">
          <button class="btn btn-primary" id="saveButton">登録</button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn btn-danger" id="deleteButton" style="display:none;">削除</button>
        </div>
      </div>
  </div>

  <!-- 🔄 初期表示ぐるぐる -->
  <div id="loading-init" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">読み込み中...</span>
    </div>
    <p class="mt-3">営業時間設定を読み込んでいます…</p>
  </div>

  <!-- 🔄 保存中ぐるぐる -->
  <div id="saving-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">保存中...</span>
    </div>
    <p class="mt-2">設定を保存しています…</p>
  </div>

  <!-- 🔄 保存中ぐるぐる -->
  <div id="delete-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">保存中...</span>
    </div>
    <p class="mt-2">設定を削除しています…</p>
  </div>

  <!-- ✅ 保存確認モーダル -->
  <div class="modal fade" id="confirmSaveModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmSaveModalTitle">保存してもよろしいですか？</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmSaveModalBody">入力内容を保存します。よろしいですか？</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="confirm-save-btn">保存する</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ 削除確認モーダル -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">削除してもよろしいですか？</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">この営業時間設定を完全に削除します。よろしいですか？</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn">削除する</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="afterSaveModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">営業時間と出勤予定の整合性について</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          登録・更新が完了しました。<br />
          スタッフの出勤予定を営業時間に合わせて調整しますか？
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">あとで</button>
          <button class="btn btn-primary" id="go-to-shift-btn">スタッフシフト設定へ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let maxRows = 10;
let allSettings = {};
let initialRows = [];
let initialApplyDate = "";
let isNewMode = true;  // ← 新規 or 既存を管理する
let lastSavedDate = "";
let initialHolidayClose = false;

// 受け取った settings を {dateKey: {rows, holidayClose}} に正規化
function normalizeSettingsMap(raw) {
  const out = {};
  Object.keys(raw || {}).forEach(k => {
    const v = raw[k];
    if (Array.isArray(v)) {
      // 旧形式: ただの行配列
      out[k] = { rows: v, holidayClose: false };
    } else if (v && typeof v === "object") {
      // 新形式: { rows, holidayClose }
      out[k] = {
        rows: Array.isArray(v.rows) ? v.rows : [],
        holidayClose: !!v.holidayClose
      };
    }
  });
  return out;
}

document.addEventListener("DOMContentLoaded", () => {
  console.log("[CHILD] DOMContentLoaded → child-ready を親へ送信");
  try {
    window.top.postMessage(
      { type: "misemaru:child-ready", origin: location.origin },
      "*" // 親側で必ず event.origin を検証するので安全
    );
  } catch (err) {
    console.error("[CHILD] child-ready 送信失敗:", err);
  }

  const select = document.getElementById("scheduleSelect");
  const applyDateWrapper = document.getElementById("applyDateWrapper");
  const applyDateInput = document.getElementById("applyDate");
  const saveBtn = document.getElementById("saveButton");
  const deleteBtn = document.getElementById("deleteButton");
  applyDateInput.addEventListener("input", updateSaveButtonState);
  const modalTitle = document.getElementById("confirmSaveModalTitle");
  const modalBody = document.getElementById("confirmSaveModalBody");
  const confirmSaveBtn = document.getElementById("confirm-save-btn");
  const deleteModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));

  initTable();

  document.getElementById("loading-init").style.display = "block";
  document.getElementById("form-area").style.display = "none";
  document.getElementById("timeTableBody").addEventListener("input", updateSaveButtonState);
  document.getElementById("timeTableBody").addEventListener("change", updateSaveButtonState);

  google.script.run.withSuccessHandler((settings) => {
    allSettings = normalizeSettingsMap(settings);  // ★正規化
    populateScheduleOptions(allSettings);

    select.value = "new";
    select.dispatchEvent(new Event("change"));

    document.getElementById("loading-init").style.display = "none";
    document.getElementById("form-area").style.display = "block";
  }).getAllBusinessHourSettings();

  select.addEventListener("change", () => {
    const selected = select.value;
    const notice = document.getElementById("applyDateNotice");  // ← ここで取得

    applyDateWrapper.style.display = "block";

    if (selected === "new") {
      isNewMode = true;
      applyDateInput.removeAttribute("readonly");
      applyDateInput.value = "";
      initTable();
      document.getElementById("holidayCloseFlag").checked = false;
      initialHolidayClose = false;
      deleteBtn.style.display = "none";
      saveBtn.textContent = "登録";
      modalTitle.textContent = "登録してもよろしいですか？";
      modalBody.textContent = "入力内容を登録します。よろしいですか？";
      confirmSaveBtn.textContent = "登録";
      notice.style.display = "none"; // ← 新規のときは非表示
    } else {
      isNewMode = false;
      applyDateInput.setAttribute("readonly", true);
      applyDateInput.value = selected;
      loadScheduleRows(selected, allSettings);
      deleteBtn.style.display = "block";
      saveBtn.textContent = "更新";
      modalTitle.textContent = "更新してもよろしいですか？";
      modalBody.textContent = "入力内容を更新します。よろしいですか？";
      confirmSaveBtn.textContent = "更新";
      notice.style.display = "block"; // ← 既存のときだけ表示
    }

    updateSaveButtonState();
  });

  saveBtn.addEventListener("click", () => {
    updateSaveButtonState();
    const modal = new bootstrap.Modal(document.getElementById("confirmSaveModal"));
    modal.show();
  });

  confirmSaveBtn.addEventListener("click", () => {
    const modal = bootstrap.Modal.getInstance(document.getElementById("confirmSaveModal"));
    modal.hide();

    let payload;
    try {
      payload = getScheduleData();
      lastSavedDate = payload.applyDate; // ✅ 日付を記録しておく
    } catch (err) {
      showMessage(err.message, true);
      return;
    }

    if (!payload.applyDate) {
      alert("適用開始日を入力してください。");
      return;
    }

    document.getElementById("form-area").style.display = "none";
    document.getElementById("saving-spinner").style.display = "block";

    google.script.run.withSuccessHandler(() => {
      google.script.run.withSuccessHandler((settings) => {
        allSettings = normalizeSettingsMap(settings);
        populateScheduleOptions(allSettings);
        select.value = "new";
        select.dispatchEvent(new Event("change"));
        document.getElementById("saving-spinner").style.display = "none";
        document.getElementById("form-area").style.display = "block";
        showMessage("✅ 保存が完了しました！");

        const afterModal = new bootstrap.Modal(document.getElementById("afterSaveModal"));
        afterModal.show();

      }).getAllBusinessHourSettings();
    }).withFailureHandler(e => {
      alert("保存失敗: " + e.message);
      showMessage("❌ 保存に失敗しました: " + e.message, true);
      document.getElementById("saving-spinner").style.display = "none";
      document.getElementById("form-area").style.display = "block";
    }).saveBusinessHourSetting(payload.applyDate, payload.rows, payload.holidayClose);
  });

  document.getElementById("go-to-shift-btn").addEventListener("click", () => {
    const date = lastSavedDate;
    if (!date) return alert("日付が取得できませんでした");

    const btn = document.getElementById("go-to-shift-btn");
    btn.disabled = true; // 二重クリック防止

    // 親へ postMessage → 静的サイト側のルーターで iframe 切替
    // （ヒストリ残したくなければ第3引数に { replace: true } を渡してね）
    setTimeout(() => {
      goTo("22_staff_shift_admin", { date });
    }, 300); // スピナー描画などを少し優先
  });

  deleteBtn.addEventListener("click", () => {
    deleteModal.show();
  });

  document.getElementById("confirm-delete-btn").addEventListener("click", () => {
    const selected = select.value;
    deleteModal.hide();

    if (!selected || selected === "new") return;

    document.getElementById("form-area").style.display = "none";
    document.getElementById("delete-spinner").style.display = "block";

    google.script.run.withSuccessHandler(() => {
      google.script.run.withSuccessHandler((settings) => {
        allSettings = normalizeSettingsMap(settings);
        populateScheduleOptions(settings);
        select.value = "new";
        select.dispatchEvent(new Event("change"));
        document.getElementById("delete-spinner").style.display = "none";
        document.getElementById("form-area").style.display = "block";
        showMessage("🗑 設定を削除しました！");
      }).getAllBusinessHourSettings();
    }).withFailureHandler(e => {
      alert("削除失敗: " + e.message);
      showMessage("❌ 削除に失敗しました: " + e.message, true);
      document.getElementById("delete-spinner").style.display = "none";
      document.getElementById("form-area").style.display = "block";
    }).deleteBusinessHourSetting(selected);
  });
});

function loadScheduleRows(dateKey, allData) {
  const applyDateInput = document.getElementById("applyDate");
  applyDateInput.value = dateKey;
  initialApplyDate = dateKey;
  isNewMode = false;

  const pack = allData[dateKey] || { rows: [], holidayClose: false }; // ★
  const rows = pack.rows || [];
  document.getElementById("holidayCloseFlag").checked = !!pack.holidayClose; // ★
  initialHolidayClose = !!pack.holidayClose;

  initialRows = JSON.parse(JSON.stringify(rows));

  const tbody = document.getElementById("timeTableBody");
  tbody.innerHTML = "";

  rows.forEach((row, i) => {
    const tr = createRow(i);
    tbody.appendChild(tr);

    const getEl = (name) => tr.querySelector(`[name='${name}-${i}']`);
    getEl("start").value = row.start || "";
    getEl("end").value   = row.end   || "";
    getEl("type").value  = row.type  || "営業";
    ["sun","mon","tue","wed","thu","fri","sat"].forEach(d => {
      if (row[d]) getEl(d).checked = true;
    });
  });

  updateSaveButtonState();
}


function updateSaveButtonState() {
  const saveBtn = document.getElementById("saveButton");
  const applyDateInput = document.getElementById("applyDate");
  const nowHoliday = document.getElementById("holidayCloseFlag").checked;

  let nowRows = [];
  try {
    nowRows = getScheduleData().rows;
  } catch (_) {
    saveBtn.disabled = true;
    console.log("[保存ボタン] データ取得エラー → ボタン非活性");
    return;
  }

  // ✅ index を除去しつつ、キー順をソート
  const sortObject = obj => Object.keys(obj).sort().reduce((sorted, key) => {
    sorted[key] = obj[key];
    return sorted;
  }, {});

  const normalizeRows = rows => rows.map(({ index, ...rest }) => sortObject(rest));

  const initialNormalized = normalizeRows(initialRows);
  const nowNormalized = normalizeRows(nowRows);

  const initialJson = JSON.stringify(initialNormalized);
  const nowJson = JSON.stringify(nowNormalized);

  const isChanged = (
    initialJson !== nowJson ||
    applyDateInput.value !== initialApplyDate ||
    nowHoliday !== initialHolidayClose 
  );

  // ✅ ログ出力（開発時だけ）
  console.log("[保存ボタン] isNewMode:", isNewMode);
  console.log("[保存ボタン] initialRows (normalized):", initialNormalized);
  console.log("[保存ボタン] nowRows (normalized):", nowNormalized);
  console.log("[保存ボタン] JSON 比較:", initialJson === nowJson ? "一致" : "不一致");
  console.log("[保存ボタン] applyDate:", initialApplyDate, "→", applyDateInput.value);
  console.log("[保存ボタン] isChanged:", isChanged);

  // ✅ ボタンの制御
  if (isNewMode) {
    saveBtn.disabled = !(applyDateInput.value && nowRows.length > 0);
    console.log("[保存ボタン] 新規モード → ボタン:", saveBtn.disabled ? "非活性" : "活性");
  } else {
    saveBtn.disabled = !isChanged;
    console.log("[保存ボタン] 既存モード → ボタン:", saveBtn.disabled ? "非活性" : "活性");
  }
}






// ✅ 初期化時に保存ボタンを有効化（新規は常に押せる）
function initTable() {
  const tbody = document.getElementById("timeTableBody");
  tbody.innerHTML = "";
  insertRow(-1);

  initialRows = [];  // 新規は空とする
  initialApplyDate = ""; // 新規は空とする
  isNewMode = true;  // ← 新規フラグ

  updateSaveButtonState();
}


function createRow(index) {
  const tr = document.createElement("tr");
  tr.classList.add("time-row");

  const timeStart = `<td class="col-narrow"><input type="time" class="form-control" name="start-${index}"></td>`;
  const timeEnd = `<td class="col-narrow"><input type="time" class="form-control" name="end-${index}"></td>`;
  const typeSelect = `<td class="col-narrow"><select class="form-select form-select-sm" name="type-${index}">
    <option value="営業">営業</option>
    <option value="休憩">休憩</option>
    <option value="研修">研修</option>
    <option value="その他">その他</option>
  </select></td>`;

  let days = "";
    const dayKeys = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
    dayKeys.forEach(day => {
      days += `
        <td class="text-center">
          <div class="form-check m-0 d-flex justify-content-center">
            <input class="form-check-input" type="checkbox" name="${day}-${index}">
          </div>
        </td>`;
    });


  const action = `
  <td class="text-center">
    <div class="d-flex justify-content-center gap-1 flex-wrap">
      <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0 fw-bold" onclick="insertRow(${index})">＋</button>
      <button type="button" class="btn btn-outline-danger btn-sm px-2 py-0 fw-bold" onclick="deleteRow(this)">－</button>
    </div>
  </td>`;


  tr.innerHTML = timeStart + timeEnd + typeSelect + days + action;
  return tr;
}

function insertRow(position) {
  const tbody = document.getElementById("timeTableBody");
  if (tbody.children.length >= maxRows) return;

  const newRow = createRow(tbody.children.length); // 仮の行
  tbody.insertBefore(newRow, tbody.children[position + 1] || null);

  // 前の行の終了時間 → 新しい行の開始時間にコピー
  if (position >= 0 && tbody.children[position]) {
    const prevRow = tbody.children[position];
    const prevEndInput = prevRow.querySelector("input[type='time'][name^='end-']");
    const newStartInput = newRow.querySelector("input[type='time'][name^='start-']");
    if (prevEndInput && prevEndInput.value && newStartInput) {
      newStartInput.value = prevEndInput.value;
    }
  }

    // ✅ 前の行の曜日チェックをコピー
  if (position >= 0 && tbody.children[position]) {
    const prevRow = tbody.children[position];
    const newCheckboxes = newRow.querySelectorAll("input[type='checkbox']");
    const prevCheckboxes = prevRow.querySelectorAll("input[type='checkbox']");

    newCheckboxes.forEach((checkbox, i) => {
      checkbox.checked = prevCheckboxes[i].checked;
    });
  }

  renumberRows();
}


function renumberRows() {
  const rows = document.querySelectorAll("#timeTableBody tr");
  rows.forEach((tr, i) => {
    const inputs = tr.querySelectorAll("[name]");
    inputs.forEach(input => {
      const nameParts = input.name.split("-");
      input.name = `${nameParts[0]}-${i}`;
    });
  });
}


function deleteRow(button) {
  const tbody = document.getElementById("timeTableBody");
  const row = button.closest("tr");
  if (tbody.children.length <= 1) {
    alert("最低1行は残してください");
    return;
  }
  tbody.removeChild(row);
}

document.getElementById("holidayCloseFlag").addEventListener("change", updateSaveButtonState); 

function getScheduleData() {
  const applyDate = document.getElementById("applyDate").value;
  const holidayClose = document.getElementById("holidayCloseFlag").checked;
  const tbody = document.getElementById("timeTableBody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const data = [];

  // ① 先に配列にデータを詰める（後でかぶりチェックに使う）
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const getVal = name => row.querySelector(`[name='${name}-${i}']`);
    const start = getVal("start")?.value || "";
    const end = getVal("end")?.value || "";

    if (!start && !end) continue; // 空行は無視

    data.push({
      index: i + 1,
      start,
      end,
      type: getVal("type")?.value || "営業",
      sun: getVal("sun")?.checked || false,
      mon: getVal("mon")?.checked || false,
      tue: getVal("tue")?.checked || false,
      wed: getVal("wed")?.checked || false,
      thu: getVal("thu")?.checked || false,
      fri: getVal("fri")?.checked || false,
      sat: getVal("sat")?.checked || false
    });
  }

  // ② バリデーション
  for (let i = 0; i < data.length; i++) {
    const row = data[i];

    if (!row.start || !row.end) {
      throw new Error(`⚠ 行${row.index}：開始・終了時間を入力してください。`);
    }

    if (row.start >= row.end) {
      throw new Error(`⚠ 行${row.index}：開始時間は終了時間より前にしてください。`);
    }

    // 他の行との重複チェック
    for (let j = 0; j < data.length; j++) {
      if (i === j) continue;
      const other = data[j];
      if (
        (row.start < other.end) && (row.end > other.start)
      ) {
        throw new Error(`⚠ 行${row.index} と 行${other.index} で重複している時間があります。`);
      }
    }
  }

  return { applyDate, holidayClose, rows: data };
}

  // select に選択肢を追加
  function populateScheduleOptions(data) {
    const select = document.getElementById("scheduleSelect");
    select.innerHTML = "";

    const defaultOption = document.createElement("option");
    defaultOption.value = "new";
    defaultOption.textContent = "＋ 新しい営業時間設定";
    select.appendChild(defaultOption);

    if (!data || typeof data !== 'object') {
      console.warn("設定データが取得できませんでした");
      return;
    }

    Object.keys(data).sort().forEach(dateKey => {
      const option = document.createElement("option");
      option.value = dateKey;
      option.textContent = `${dateKey}から適用`;
      select.appendChild(option);
    });
  }

  function showMessage(text, isError = false) {
    const successEl = document.getElementById("success-message");
    const errorEl = document.getElementById("error-message");

    // 一旦両方消す
    successEl.style.display = "none";
    errorEl.style.display = "none";

    if (isError) {
      errorEl.textContent = text;
      errorEl.style.display = "block";
      setTimeout(() => errorEl.style.display = "none", 5000);
    } else {
      successEl.textContent = text;
      successEl.style.display = "block";
      setTimeout(() => successEl.style.display = "none", 3000);
    }
  }



</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
