<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>â° å–¶æ¥­æ™‚é–“</title>
  <style>
    .time-row td {
    vertical-align: middle;
  }

  .time-row input[type="time"],
  .time-row select {
    width: 100%;
    min-width: 90px;
  }

  .table-responsive {
    overflow-x: auto;
  }

  th:nth-child(n+4):nth-child(-n+10),
  td:nth-child(n+4):nth-child(-n+10) {
    text-align: center;
  }

  </style>
</head>
<body class="loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­...</p>
  </div>
  <div id="app" style="display:none;">

<div class="container-fluid py-3">
  <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('40_setting_main_admin')">â† æˆ»ã‚‹</button>
  <h4 class="mb-3 text-center">â° å–¶æ¥­æ™‚é–“è¨­å®š</h4>

  <div id="success-message" class="alert alert-success text-center" style="display: none;"></div>
  <div id="error-message" class="alert alert-danger text-center" style="display: none;"></div>

  <div id="form-area">
    <div class="form-wrapper">
      <div class="mb-3">
        <label for="scheduleSelect" class="form-label">ğŸ—‚ å–¶æ¥­æ™‚é–“è¨­å®šã®é¸æŠ</label>
        <select id="scheduleSelect" class="form-select">
          <option value="new">ï¼‹ æ–°ã—ã„å–¶æ¥­æ™‚é–“è¨­å®šã‚’ä½œæˆ</option>
        </select>
      </div>

      <div class="mb-3" id="applyDateWrapper">
        <label for="applyDate" class="form-label">ğŸ—“ é©ç”¨é–‹å§‹æ—¥</label>
        <input type="date" id="applyDate" class="form-control">
        <small id="applyDateNotice" class="text-danger ms-1" style="display: none;">
          â€»æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯é©ç”¨é–‹å§‹æ—¥ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“
        </small>
      </div>

      <div class="mb-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="holidayCloseFlag">
            <label class="form-check-label fw-bold" for="holidayCloseFlag">ç¥æ—¥ä¼‘æ¥­</label>
          </div>
          <div class="text-muted small mt-1">â€»ONã§æ—¥æœ¬ã®ç¥æ—¥ã‚’çµ‚æ—¥ã€Œä¼‘æ¥­æ—¥ã€æ‰±ã„ã«ã—ã¾ã™</div>
      </div>
    </div>

    <div class="table-responsive px-2">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="col-narrow">é–‹å§‹</th>
            <th class="col-narrow">çµ‚äº†</th>
            <th class="col-narrow">åŒºåˆ†</th>
            <th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="timeTableBody"></tbody>
      </table>
      <p class="text-muted small mt-0">â€» è¡Œã®è¿½åŠ ãƒ»å‰Šé™¤ã¯å³ç«¯ã®ï¼‹ / ï¼ ãƒœã‚¿ãƒ³ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„</p>
      </div>
      <div class="form-wrapper">
        <div class="d-grid gap-2 mt-3 mb-3">
          <button class="btn btn-primary" id="saveButton">ç™»éŒ²</button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn btn-danger" id="deleteButton" style="display:none;">å‰Šé™¤</button>
        </div>
      </div>
  </div>

  <!-- ğŸ”„ åˆæœŸè¡¨ç¤ºãã‚‹ãã‚‹ -->
  <div id="loading-init" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <p class="mt-3">å–¶æ¥­æ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦</p>
  </div>

  <!-- ğŸ”„ ä¿å­˜ä¸­ãã‚‹ãã‚‹ -->
  <div id="saving-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ä¿å­˜ä¸­...</span>
    </div>
    <p class="mt-2">è¨­å®šã‚’ä¿å­˜ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  <!-- ğŸ”„ ä¿å­˜ä¸­ãã‚‹ãã‚‹ -->
  <div id="delete-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ä¿å­˜ä¸­...</span>
    </div>
    <p class="mt-2">è¨­å®šã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  <!-- âœ… ä¿å­˜ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="confirmSaveModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmSaveModalTitle">ä¿å­˜ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmSaveModalBody">å…¥åŠ›å†…å®¹ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-primary" id="confirm-save-btn">ä¿å­˜ã™ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">ã“ã®å–¶æ¥­æ™‚é–“è¨­å®šã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn">å‰Šé™¤ã™ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="afterSaveModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">å–¶æ¥­æ™‚é–“ã¨å‡ºå‹¤äºˆå®šã®æ•´åˆæ€§ã«ã¤ã„ã¦</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          ç™»éŒ²ãƒ»æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br />
          ã‚¹ã‚¿ãƒƒãƒ•ã®å‡ºå‹¤äºˆå®šã‚’å–¶æ¥­æ™‚é–“ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¾ã™ã‹ï¼Ÿ
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">ã‚ã¨ã§</button>
          <button class="btn btn-primary" id="go-to-shift-btn">ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆè¨­å®šã¸</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let maxRows = 10;
let allSettings = {};
let initialRows = [];
let initialApplyDate = "";
let isNewMode = true;  // â† æ–°è¦ or æ—¢å­˜ã‚’ç®¡ç†ã™ã‚‹
let lastSavedDate = "";
let initialHolidayClose = false;

// å—ã‘å–ã£ãŸ settings ã‚’ {dateKey: {rows, holidayClose}} ã«æ­£è¦åŒ–
function normalizeSettingsMap(raw) {
  const out = {};
  Object.keys(raw || {}).forEach(k => {
    const v = raw[k];
    if (Array.isArray(v)) {
      // æ—§å½¢å¼: ãŸã ã®è¡Œé…åˆ—
      out[k] = { rows: v, holidayClose: false };
    } else if (v && typeof v === "object") {
      // æ–°å½¢å¼: { rows, holidayClose }
      out[k] = {
        rows: Array.isArray(v.rows) ? v.rows : [],
        holidayClose: !!v.holidayClose
      };
    }
  });
  return out;
}

document.addEventListener("DOMContentLoaded", () => {
  console.log("[CHILD] DOMContentLoaded â†’ child-ready ã‚’è¦ªã¸é€ä¿¡");
  try {
    window.top.postMessage(
      { type: "misemaru:child-ready", origin: location.origin },
      "*" // è¦ªå´ã§å¿…ãš event.origin ã‚’æ¤œè¨¼ã™ã‚‹ã®ã§å®‰å…¨
    );
  } catch (err) {
    console.error("[CHILD] child-ready é€ä¿¡å¤±æ•—:", err);
  }

  const select = document.getElementById("scheduleSelect");
  const applyDateWrapper = document.getElementById("applyDateWrapper");
  const applyDateInput = document.getElementById("applyDate");
  const saveBtn = document.getElementById("saveButton");
  const deleteBtn = document.getElementById("deleteButton");
  applyDateInput.addEventListener("input", updateSaveButtonState);
  const modalTitle = document.getElementById("confirmSaveModalTitle");
  const modalBody = document.getElementById("confirmSaveModalBody");
  const confirmSaveBtn = document.getElementById("confirm-save-btn");
  const deleteModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));

  initTable();

  document.getElementById("loading-init").style.display = "block";
  document.getElementById("form-area").style.display = "none";
  document.getElementById("timeTableBody").addEventListener("input", updateSaveButtonState);
  document.getElementById("timeTableBody").addEventListener("change", updateSaveButtonState);

  google.script.run.withSuccessHandler((settings) => {
    allSettings = normalizeSettingsMap(settings);  // â˜…æ­£è¦åŒ–
    populateScheduleOptions(allSettings);

    select.value = "new";
    select.dispatchEvent(new Event("change"));

    document.getElementById("loading-init").style.display = "none";
    document.getElementById("form-area").style.display = "block";
  }).getAllBusinessHourSettings();

  select.addEventListener("change", () => {
    const selected = select.value;
    const notice = document.getElementById("applyDateNotice");  // â† ã“ã“ã§å–å¾—

    applyDateWrapper.style.display = "block";

    if (selected === "new") {
      isNewMode = true;
      applyDateInput.removeAttribute("readonly");
      applyDateInput.value = "";
      initTable();
      document.getElementById("holidayCloseFlag").checked = false;
      initialHolidayClose = false;
      deleteBtn.style.display = "none";
      saveBtn.textContent = "ç™»éŒ²";
      modalTitle.textContent = "ç™»éŒ²ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
      modalBody.textContent = "å…¥åŠ›å†…å®¹ã‚’ç™»éŒ²ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
      confirmSaveBtn.textContent = "ç™»éŒ²";
      notice.style.display = "none"; // â† æ–°è¦ã®ã¨ãã¯éè¡¨ç¤º
    } else {
      isNewMode = false;
      applyDateInput.setAttribute("readonly", true);
      applyDateInput.value = selected;
      loadScheduleRows(selected, allSettings);
      deleteBtn.style.display = "block";
      saveBtn.textContent = "æ›´æ–°";
      modalTitle.textContent = "æ›´æ–°ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
      modalBody.textContent = "å…¥åŠ›å†…å®¹ã‚’æ›´æ–°ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
      confirmSaveBtn.textContent = "æ›´æ–°";
      notice.style.display = "block"; // â† æ—¢å­˜ã®ã¨ãã ã‘è¡¨ç¤º
    }

    updateSaveButtonState();
  });

  saveBtn.addEventListener("click", () => {
    updateSaveButtonState();
    const modal = new bootstrap.Modal(document.getElementById("confirmSaveModal"));
    modal.show();
  });

  confirmSaveBtn.addEventListener("click", () => {
    const modal = bootstrap.Modal.getInstance(document.getElementById("confirmSaveModal"));
    modal.hide();

    let payload;
    try {
      payload = getScheduleData();
      lastSavedDate = payload.applyDate; // âœ… æ—¥ä»˜ã‚’è¨˜éŒ²ã—ã¦ãŠã
    } catch (err) {
      showMessage(err.message, true);
      return;
    }

    if (!payload.applyDate) {
      alert("é©ç”¨é–‹å§‹æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    document.getElementById("form-area").style.display = "none";
    document.getElementById("saving-spinner").style.display = "block";

    google.script.run.withSuccessHandler(() => {
      google.script.run.withSuccessHandler((settings) => {
        allSettings = normalizeSettingsMap(settings);
        populateScheduleOptions(allSettings);
        select.value = "new";
        select.dispatchEvent(new Event("change"));
        document.getElementById("saving-spinner").style.display = "none";
        document.getElementById("form-area").style.display = "block";
        showMessage("âœ… ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼");

        const afterModal = new bootstrap.Modal(document.getElementById("afterSaveModal"));
        afterModal.show();

      }).getAllBusinessHourSettings();
    }).withFailureHandler(e => {
      alert("ä¿å­˜å¤±æ•—: " + e.message);
      showMessage("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message, true);
      document.getElementById("saving-spinner").style.display = "none";
      document.getElementById("form-area").style.display = "block";
    }).saveBusinessHourSetting(payload.applyDate, payload.rows, payload.holidayClose);
  });

  document.getElementById("go-to-shift-btn").addEventListener("click", () => {
    const date = lastSavedDate;
    if (!date) return alert("æ—¥ä»˜ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");

    const btn = document.getElementById("go-to-shift-btn");
    btn.disabled = true; // äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢

    // è¦ªã¸ postMessage â†’ é™çš„ã‚µã‚¤ãƒˆå´ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã§ iframe åˆ‡æ›¿
    // ï¼ˆãƒ’ã‚¹ãƒˆãƒªæ®‹ã—ãŸããªã‘ã‚Œã°ç¬¬3å¼•æ•°ã« { replace: true } ã‚’æ¸¡ã—ã¦ã­ï¼‰
    setTimeout(() => {
      goTo("22_staff_shift_admin", { date });
    }, 300); // ã‚¹ãƒ”ãƒŠãƒ¼æç”»ãªã©ã‚’å°‘ã—å„ªå…ˆ
  });

  deleteBtn.addEventListener("click", () => {
    deleteModal.show();
  });

  document.getElementById("confirm-delete-btn").addEventListener("click", () => {
    const selected = select.value;
    deleteModal.hide();

    if (!selected || selected === "new") return;

    document.getElementById("form-area").style.display = "none";
    document.getElementById("delete-spinner").style.display = "block";

    google.script.run.withSuccessHandler(() => {
      google.script.run.withSuccessHandler((settings) => {
        allSettings = normalizeSettingsMap(settings);
        populateScheduleOptions(settings);
        select.value = "new";
        select.dispatchEvent(new Event("change"));
        document.getElementById("delete-spinner").style.display = "none";
        document.getElementById("form-area").style.display = "block";
        showMessage("ğŸ—‘ è¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼");
      }).getAllBusinessHourSettings();
    }).withFailureHandler(e => {
      alert("å‰Šé™¤å¤±æ•—: " + e.message);
      showMessage("âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message, true);
      document.getElementById("delete-spinner").style.display = "none";
      document.getElementById("form-area").style.display = "block";
    }).deleteBusinessHourSetting(selected);
  });
});

function loadScheduleRows(dateKey, allData) {
  const applyDateInput = document.getElementById("applyDate");
  applyDateInput.value = dateKey;
  initialApplyDate = dateKey;
  isNewMode = false;

  const pack = allData[dateKey] || { rows: [], holidayClose: false }; // â˜…
  const rows = pack.rows || [];
  document.getElementById("holidayCloseFlag").checked = !!pack.holidayClose; // â˜…
  initialHolidayClose = !!pack.holidayClose;

  initialRows = JSON.parse(JSON.stringify(rows));

  const tbody = document.getElementById("timeTableBody");
  tbody.innerHTML = "";

  rows.forEach((row, i) => {
    const tr = createRow(i);
    tbody.appendChild(tr);

    const getEl = (name) => tr.querySelector(`[name='${name}-${i}']`);
    getEl("start").value = row.start || "";
    getEl("end").value   = row.end   || "";
    getEl("type").value  = row.type  || "å–¶æ¥­";
    ["sun","mon","tue","wed","thu","fri","sat"].forEach(d => {
      if (row[d]) getEl(d).checked = true;
    });
  });

  updateSaveButtonState();
}


function updateSaveButtonState() {
  const saveBtn = document.getElementById("saveButton");
  const applyDateInput = document.getElementById("applyDate");
  const nowHoliday = document.getElementById("holidayCloseFlag").checked;

  let nowRows = [];
  try {
    nowRows = getScheduleData().rows;
  } catch (_) {
    saveBtn.disabled = true;
    console.log("[ä¿å­˜ãƒœã‚¿ãƒ³] ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ â†’ ãƒœã‚¿ãƒ³éæ´»æ€§");
    return;
  }

  // âœ… index ã‚’é™¤å»ã—ã¤ã¤ã€ã‚­ãƒ¼é †ã‚’ã‚½ãƒ¼ãƒˆ
  const sortObject = obj => Object.keys(obj).sort().reduce((sorted, key) => {
    sorted[key] = obj[key];
    return sorted;
  }, {});

  const normalizeRows = rows => rows.map(({ index, ...rest }) => sortObject(rest));

  const initialNormalized = normalizeRows(initialRows);
  const nowNormalized = normalizeRows(nowRows);

  const initialJson = JSON.stringify(initialNormalized);
  const nowJson = JSON.stringify(nowNormalized);

  const isChanged = (
    initialJson !== nowJson ||
    applyDateInput.value !== initialApplyDate ||
    nowHoliday !== initialHolidayClose 
  );

  // âœ… ãƒ­ã‚°å‡ºåŠ›ï¼ˆé–‹ç™ºæ™‚ã ã‘ï¼‰
  console.log("[ä¿å­˜ãƒœã‚¿ãƒ³] isNewMode:", isNewMode);
  console.log("[ä¿å­˜ãƒœã‚¿ãƒ³] initialRows (normalized):", initialNormalized);
  console.log("[ä¿å­˜ãƒœã‚¿ãƒ³] nowRows (normalized):", nowNormalized);
  console.log("[ä¿å­˜ãƒœã‚¿ãƒ³] JSON æ¯”è¼ƒ:", initialJson === nowJson ? "ä¸€è‡´" : "ä¸ä¸€è‡´");
  console.log("[ä¿å­˜ãƒœã‚¿ãƒ³] applyDate:", initialApplyDate, "â†’", applyDateInput.value);
  console.log("[ä¿å­˜ãƒœã‚¿ãƒ³] isChanged:", isChanged);

  // âœ… ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
  if (isNewMode) {
    saveBtn.disabled = !(applyDateInput.value && nowRows.length > 0);
    console.log("[ä¿å­˜ãƒœã‚¿ãƒ³] æ–°è¦ãƒ¢ãƒ¼ãƒ‰ â†’ ãƒœã‚¿ãƒ³:", saveBtn.disabled ? "éæ´»æ€§" : "æ´»æ€§");
  } else {
    saveBtn.disabled = !isChanged;
    console.log("[ä¿å­˜ãƒœã‚¿ãƒ³] æ—¢å­˜ãƒ¢ãƒ¼ãƒ‰ â†’ ãƒœã‚¿ãƒ³:", saveBtn.disabled ? "éæ´»æ€§" : "æ´»æ€§");
  }
}






// âœ… åˆæœŸåŒ–æ™‚ã«ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆæ–°è¦ã¯å¸¸ã«æŠ¼ã›ã‚‹ï¼‰
function initTable() {
  const tbody = document.getElementById("timeTableBody");
  tbody.innerHTML = "";
  insertRow(-1);

  initialRows = [];  // æ–°è¦ã¯ç©ºã¨ã™ã‚‹
  initialApplyDate = ""; // æ–°è¦ã¯ç©ºã¨ã™ã‚‹
  isNewMode = true;  // â† æ–°è¦ãƒ•ãƒ©ã‚°

  updateSaveButtonState();
}


function createRow(index) {
  const tr = document.createElement("tr");
  tr.classList.add("time-row");

  const timeStart = `<td class="col-narrow"><input type="time" class="form-control" name="start-${index}"></td>`;
  const timeEnd = `<td class="col-narrow"><input type="time" class="form-control" name="end-${index}"></td>`;
  const typeSelect = `<td class="col-narrow"><select class="form-select form-select-sm" name="type-${index}">
    <option value="å–¶æ¥­">å–¶æ¥­</option>
    <option value="ä¼‘æ†©">ä¼‘æ†©</option>
    <option value="ç ”ä¿®">ç ”ä¿®</option>
    <option value="ãã®ä»–">ãã®ä»–</option>
  </select></td>`;

  let days = "";
    const dayKeys = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
    dayKeys.forEach(day => {
      days += `
        <td class="text-center">
          <div class="form-check m-0 d-flex justify-content-center">
            <input class="form-check-input" type="checkbox" name="${day}-${index}">
          </div>
        </td>`;
    });


  const action = `
  <td class="text-center">
    <div class="d-flex justify-content-center gap-1 flex-wrap">
      <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0 fw-bold" onclick="insertRow(${index})">ï¼‹</button>
      <button type="button" class="btn btn-outline-danger btn-sm px-2 py-0 fw-bold" onclick="deleteRow(this)">ï¼</button>
    </div>
  </td>`;


  tr.innerHTML = timeStart + timeEnd + typeSelect + days + action;
  return tr;
}

function insertRow(position) {
  const tbody = document.getElementById("timeTableBody");
  if (tbody.children.length >= maxRows) return;

  const newRow = createRow(tbody.children.length); // ä»®ã®è¡Œ
  tbody.insertBefore(newRow, tbody.children[position + 1] || null);

  // å‰ã®è¡Œã®çµ‚äº†æ™‚é–“ â†’ æ–°ã—ã„è¡Œã®é–‹å§‹æ™‚é–“ã«ã‚³ãƒ”ãƒ¼
  if (position >= 0 && tbody.children[position]) {
    const prevRow = tbody.children[position];
    const prevEndInput = prevRow.querySelector("input[type='time'][name^='end-']");
    const newStartInput = newRow.querySelector("input[type='time'][name^='start-']");
    if (prevEndInput && prevEndInput.value && newStartInput) {
      newStartInput.value = prevEndInput.value;
    }
  }

    // âœ… å‰ã®è¡Œã®æ›œæ—¥ãƒã‚§ãƒƒã‚¯ã‚’ã‚³ãƒ”ãƒ¼
  if (position >= 0 && tbody.children[position]) {
    const prevRow = tbody.children[position];
    const newCheckboxes = newRow.querySelectorAll("input[type='checkbox']");
    const prevCheckboxes = prevRow.querySelectorAll("input[type='checkbox']");

    newCheckboxes.forEach((checkbox, i) => {
      checkbox.checked = prevCheckboxes[i].checked;
    });
  }

  renumberRows();
}


function renumberRows() {
  const rows = document.querySelectorAll("#timeTableBody tr");
  rows.forEach((tr, i) => {
    const inputs = tr.querySelectorAll("[name]");
    inputs.forEach(input => {
      const nameParts = input.name.split("-");
      input.name = `${nameParts[0]}-${i}`;
    });
  });
}


function deleteRow(button) {
  const tbody = document.getElementById("timeTableBody");
  const row = button.closest("tr");
  if (tbody.children.length <= 1) {
    alert("æœ€ä½1è¡Œã¯æ®‹ã—ã¦ãã ã•ã„");
    return;
  }
  tbody.removeChild(row);
}

document.getElementById("holidayCloseFlag").addEventListener("change", updateSaveButtonState); 

function getScheduleData() {
  const applyDate = document.getElementById("applyDate").value;
  const holidayClose = document.getElementById("holidayCloseFlag").checked;
  const tbody = document.getElementById("timeTableBody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const data = [];

  // â‘  å…ˆã«é…åˆ—ã«ãƒ‡ãƒ¼ã‚¿ã‚’è©°ã‚ã‚‹ï¼ˆå¾Œã§ã‹ã¶ã‚Šãƒã‚§ãƒƒã‚¯ã«ä½¿ã†ï¼‰
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const getVal = name => row.querySelector(`[name='${name}-${i}']`);
    const start = getVal("start")?.value || "";
    const end = getVal("end")?.value || "";

    if (!start && !end) continue; // ç©ºè¡Œã¯ç„¡è¦–

    data.push({
      index: i + 1,
      start,
      end,
      type: getVal("type")?.value || "å–¶æ¥­",
      sun: getVal("sun")?.checked || false,
      mon: getVal("mon")?.checked || false,
      tue: getVal("tue")?.checked || false,
      wed: getVal("wed")?.checked || false,
      thu: getVal("thu")?.checked || false,
      fri: getVal("fri")?.checked || false,
      sat: getVal("sat")?.checked || false
    });
  }

  // â‘¡ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  for (let i = 0; i < data.length; i++) {
    const row = data[i];

    if (!row.start || !row.end) {
      throw new Error(`âš  è¡Œ${row.index}ï¼šé–‹å§‹ãƒ»çµ‚äº†æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
    }

    if (row.start >= row.end) {
      throw new Error(`âš  è¡Œ${row.index}ï¼šé–‹å§‹æ™‚é–“ã¯çµ‚äº†æ™‚é–“ã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„ã€‚`);
    }

    // ä»–ã®è¡Œã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
    for (let j = 0; j < data.length; j++) {
      if (i === j) continue;
      const other = data[j];
      if (
        (row.start < other.end) && (row.end > other.start)
      ) {
        throw new Error(`âš  è¡Œ${row.index} ã¨ è¡Œ${other.index} ã§é‡è¤‡ã—ã¦ã„ã‚‹æ™‚é–“ãŒã‚ã‚Šã¾ã™ã€‚`);
      }
    }
  }

  return { applyDate, holidayClose, rows: data };
}

  // select ã«é¸æŠè‚¢ã‚’è¿½åŠ 
  function populateScheduleOptions(data) {
    const select = document.getElementById("scheduleSelect");
    select.innerHTML = "";

    const defaultOption = document.createElement("option");
    defaultOption.value = "new";
    defaultOption.textContent = "ï¼‹ æ–°ã—ã„å–¶æ¥­æ™‚é–“è¨­å®š";
    select.appendChild(defaultOption);

    if (!data || typeof data !== 'object') {
      console.warn("è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
      return;
    }

    Object.keys(data).sort().forEach(dateKey => {
      const option = document.createElement("option");
      option.value = dateKey;
      option.textContent = `${dateKey}ã‹ã‚‰é©ç”¨`;
      select.appendChild(option);
    });
  }

  function showMessage(text, isError = false) {
    const successEl = document.getElementById("success-message");
    const errorEl = document.getElementById("error-message");

    // ä¸€æ—¦ä¸¡æ–¹æ¶ˆã™
    successEl.style.display = "none";
    errorEl.style.display = "none";

    if (isError) {
      errorEl.textContent = text;
      errorEl.style.display = "block";
      setTimeout(() => errorEl.style.display = "none", 5000);
    } else {
      successEl.textContent = text;
      successEl.style.display = "block";
      setTimeout(() => successEl.style.display = "none", 3000);
    }
  }



</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
