<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>🪄 サービス設定</title>
<style>
  @media (max-width: 576px) {
  th, td {
    font-size: 0.85rem;
    padding: 0.2rem 0.3rem;
  }

  th:nth-child(1), td:nth-child(1) {
    display: none; /* 表示順 非表示 */
  }

  th:nth-child(6), td:nth-child(6) { /* 割引 */
    min-width: 90px;
  }

  th:nth-child(7), td:nth-child(7) { /* 担当スタッフ */
    min-width: 110px;
  }

  th:nth-child(8), td:nth-child(8) { /* 同時予約数 */
    min-width: 80px;
  }

  th:nth-child(9), td:nth-child(9) { /* 備考 */
    display: none;
  }

  th:nth-child(10), td:nth-child(10) { /* ✅ 操作列 */
    min-width: 100px;
  }

  .table td:last-child > .d-flex {
    flex-direction: column;
    gap: 0.25rem;
    align-items: stretch;
  }

  .table td:last-child button {
    font-size: 0.75rem;
    padding: 0.3rem;
  }
}

th, td {
  white-space: nowrap;
}

.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.table-responsive table {
  table-layout: auto !important;
  min-width: 800px; /* スクロール幅の最小値を明示的に確保 */
}

.table-responsive th,
.table-responsive td {
  white-space: nowrap !important; /* 折り返しさせない */
}

.btn-register-wrapper {
  max-width: 440px;
  margin-left: auto;
  margin-right: auto;
  width: 100%;
}

td.note-cell {
  white-space: pre-wrap !important;
  word-break: break-word;
  max-width: 160px;
}

td.name-cell {
  white-space: pre-wrap !important;
  word-break: break-word;
  max-width: 160px;
}

@media (min-width: 768px) {
  .table td, .table th {
    vertical-align: top;
    font-size: 0.95rem;
    padding: 0.4rem 0.5rem;
  }

  td.note-cell, td.name-cell {
    white-space: pre-wrap !important;
    line-height: 1.3;
  }

  .table-responsive table {
    min-width: 1000px;
    table-layout: fixed;
  }
}

@media (max-width: 576px) {
  th, td {
    font-size: 0.85rem;
    padding: 0.2rem 0.3rem;
  }

  th:nth-child(1), td:nth-child(1) { display: none; }
  th:nth-child(5), td:nth-child(5) { min-width: 60px; }
  th:nth-child(6), td:nth-child(6) { min-width: 120px; }

  td.note-cell, td.name-cell {
    white-space: pre-wrap;
    word-break: break-word;
  }

  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .table td:last-child > .d-flex {
    flex-direction: row; /* ボタン横並び */
    gap: 0.25rem;
    justify-content: center;
  }

  .table td:last-child button {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
}

/* 機能トグルで列/フォームを隠す */
body.no-price-tax th.col-price,
body.no-price-tax td.col-price,
body.no-price-tax th.col-tax,
body.no-price-tax td.col-tax { display:none; }

body.no-discount th.col-discount,
body.no-discount td.col-discount,
body.no-discount .form-section-discount { display:none; }

body.no-price-tax .form-price,
body.no-price-tax .form-tax { display:none; }
</style>
</head>
<body class="container-fluid py-3 loading no-discount">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>認証チェック中...</p>
  </div>
  <div id="app" style="display:none;">

  <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('40_setting_main_admin')">← 戻る</button>
  <h4 class="text-center mb-4">🪄 サービス</h4>
  <div id="form-container">
  
  <!-- 一覧 -->
  <div id="service-list-area" class="mb-1">
    <!-- ✅ 成功メッセージ -->
  <div id="save-message" class="alert alert-success text-center" style="display: none;">
    登録しました！
  </div>
  <!-- ✅ 削除完了メッセージ -->
  <div id="delete-message" class="alert alert-danger text-center" style="display: none;">
    削除しました！
  </div>
    <h5>登録済みのサービス</h5>
    <div class="table-responsive">
      <table class="table table-striped table-bordered" id="serviceTable">
        <thead>
          <tr>
            <th>表示順</th>
            <th>カテゴリ大</th>
            <th>カテゴリ小</th>
            <th>所要時間</th>
            <th class="col-price">金額(税込)</th>
            <th class="col-tax">税率</th>
            <th class="col-discount">適用割引</th>
            <th>担当スタッフ</th>
            <th>同時予約可能数</th>
            <th>備考</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="serviceTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- 「＋新規作成」ボタン -->
  <div class="d-grid mt-0 mb-3">
    <div class="form-wrapper">
      <button id="toggleFormBtn" class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#serviceForm" aria-expanded="false" aria-controls="serviceForm">
        ＋ 新規作成
      </button>
    </div>
  </div>

  <!-- ✅ フォームエリア（サービス設定） -->

<div id="serviceForm" class="collapse">
<div class="form-wrapper">
  <h5 class="mb-3">サービス登録</h5>

  <!-- 🔻 エラーメッセージ表示欄 -->
  <div id="validation-error" class="alert alert-danger py-2 px-3" style="display: none;"></div>

  <input type="hidden" id="serviceId">

  <div class="mb-3">
    <label class="form-label">表示順</label>
    <input type="number" class="form-control" id="order">
  </div>

  <div class="mb-3">
    <label class="form-label">カテゴリ大</label>
    <input type="text" class="form-control" id="categoryMain">
  </div>

  <div class="mb-3">
    <label class="form-label">カテゴリ小</label>
    <input type="text" class="form-control" id="categorySub">
  </div>


  <div class="row mb-3">
    <div class="col">
      <label class="form-label">所要時間(分)</label>
      <input type="number" class="form-control" id="duration">
    </div>
    <div class="col form-price">
      <label class="form-label">金額(税込)</label>
      <input type="number" class="form-control" id="price" min="0" step="1" inputmode="numeric">
    </div>
    <div class="col form-tax">
      <label class="form-label">税率(%)</label>
      <input type="number" class="form-control" id="tax"   min="0" max="100" step="0.1" inputmode="decimal">
    </div>
  </div>

  <!-- 割引適用 -->
  <div class="mb-3 form-section-discount">
    <label class="form-label">割引適用</label>
    <div id="assignedDiscountContainer" class="border rounded p-2 bg-white" style="max-height: 200px; overflow-y: auto;">
      <!-- スピナー -->
      <div id="discount-loading-spinner" class="text-center my-2">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">読み込み中...</span>
        </div>
        <p class="mt-2 mb-0 text-muted">割引情報を読み込み中です…</p>
      </div>
    </div>
    <small class="text-muted">※適用する割引にチェックを入れてください（複数可）</small>
  </div>

  <!-- 担当スタッフ -->
  <div class="mb-3">
    <label class="form-label">担当スタッフ</label>
    <div id="assignedStaffContainer" class="border rounded p-2 bg-white" style="max-height: 200px; overflow-y: auto;">
      <!-- ここにスピナー -->
      <div id="staff-loading-spinner" class="text-center my-2">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">読み込み中...</span>
        </div>
      </div>
    </div>
    <small class="text-muted">※担当スタッフにチェックを入れてください(複数可)</small>
  </div>

  <div class="mb-3">
    <label class="form-label">同時予約可能数（スタッフ 1名あたり）</label>
    <input type="number" class="form-control" id="capacity">
  </div>

  <div class="mb-3">
    <label class="form-label">備考</label>
    <input type="text" class="form-control" id="note">
  </div>

  <div class="d-grid">
    <button class="btn btn-primary" id="submit-button" onclick="openConfirmModal()">登録</button>
  </div>
</div>
</div>

  </div>
<!-- 🔄 初期読み込みスピナー -->
  <div id="loading-spinner" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">読み込み中...</span>
    </div>
    <p class="mt-3">サービス一覧を読み込み中です…</p>
  </div>

  <!-- 🔄 保存中スピナー -->
  <div id="saving-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">登録中...</span>
    </div>
    <p class="mt-2" id="saving-spinner-text">登録しています…</p>
  </div>

  

  <!-- 🔄 削除中スピナー -->
  <div id="deleting-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-danger" role="status">
      <span class="visually-hidden">削除中...</span>
    </div>
    <p class="mt-2">削除しています…</p>
  </div>

  

  <!-- ✅ 登録確認モーダル -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">この内容で登録してよろしいですか？</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="confirm-modal-body-text">内容を確認し、「登録」を押してください。</div>
          <div class="mt-3" id="modal-body-text">
            <!-- 差分リスト -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="confirm-register-btn">登録</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ 削除確認モーダル -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">このサービスを削除してよろしいですか？</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="delete-modal-body">
            一度削除すると元に戻せません。
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-btn">削除する</button>
          </div>
        </div>
      </div>
    </div>


<script>
  const DISCOUNT_ENABLED = !document.body.classList.contains('no-discount');
  const PRICE_TAX_ENABLED = !document.body.classList.contains('no-price-tax');

  let serviceData = [];
  let collapseInstance;
  let isFormOpened = false;
  let cachedStaffList = null;
  let cachedDiscountList = null;


  window.addEventListener("DOMContentLoaded", () => {
    console.log("[CHILD] DOMContentLoaded → child-ready を親へ送信");
    try {
      window.top.postMessage(
        { type: "misemaru:child-ready", origin: location.origin },
        "*" // 親側で必ず event.origin を検証するので安全
      );
    } catch (err) {
      console.error("[CHILD] child-ready 送信失敗:", err);
    }

    const formEl = document.getElementById("serviceForm");
    const btnEl = document.getElementById("toggleFormBtn");

    collapseInstance = new bootstrap.Collapse(formEl, { toggle: false });

    formEl.addEventListener("show.bs.collapse", () => {
      btnEl.textContent = "− 閉じる";
      isFormOpened = true;
    });

    formEl.addEventListener("hide.bs.collapse", () => {
      btnEl.textContent = "＋ 新規作成";
      resetForm();
      isFormOpened = false;
      updateSubmitButtonState();
    });

    formEl.addEventListener("shown.bs.collapse", () => {
      formEl.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    btnEl.addEventListener("click", () => {
      const collapse = bootstrap.Collapse.getInstance(formEl) || new bootstrap.Collapse(formEl, { toggle: false });
      if (formEl.classList.contains("show")) {
        collapse.hide();
      } else {
        collapse.show();
        setTimeout(() => {
          formEl.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      }
    });

    // ✅ ここから追加（フォーム入力・チェック変更時に登録ボタン制御）
    ["order", "categoryMain", "categorySub", "duration", "price", "tax", "capacity", "note"].forEach(id => {
      document.getElementById(id).addEventListener("input", updateSubmitButtonState);
    });

    document.getElementById("assignedStaffContainer").addEventListener("change", updateSubmitButtonState);
    document.getElementById("assignedDiscountContainer").addEventListener("change", updateSubmitButtonState);

    // ✅ 最初は非活性
    updateSubmitButtonState();
  });




  let originalServiceData = null;

  // ✅ 編集ボタン押下時
  window.editService = function (index) {
    const data = serviceData[index];
    originalServiceData = {
      id: data.id,
      order: data.order,
      categoryMain: data.categoryMain,
      categorySub:  data.categorySub, 
      duration: data.duration,
      price: data.price,
      tax: data.tax,
      capacity: data.capacity,
      note: data.note,
      assignedStaffIds: [...data.assignedStaffIds],
      assignedDiscountIds: [...data.assignedDiscountIds],
      staffNames: data.staffNames || "",
      discountNames: data.discountNames || "",
    };

    document.getElementById("submit-button").textContent = "更新";
    document.getElementById("serviceId").value = data.id;
    document.getElementById("order").value = data.order;
    document.getElementById("categoryMain").value = data.categoryMain;
    document.getElementById("categorySub").value = data.categorySub;
    document.getElementById("duration").value = data.duration;
    document.getElementById("price").value = data.price;
    document.getElementById("tax").value = data.tax;
    document.getElementById("capacity").value = data.capacity;
    document.getElementById("note").value = data.note;

    renderStaffList(cachedStaffList);
    if (DISCOUNT_ENABLED) renderDiscountList(cachedDiscountList);

    data.assignedStaffIds.forEach(staffId => {
      const cb = document.getElementById(`staff-${staffId}`);
      if (cb) cb.checked = true;
    });
    if (DISCOUNT_ENABLED) {
      data.assignedDiscountIds.forEach(discountId => {
        const cb = document.getElementById(`discount-${discountId}`);
        if (cb) cb.checked = true;
      });
    }

    const formEl = document.getElementById("serviceForm");
    if (!isFormOpened) {
      formEl.addEventListener("shown.bs.collapse", function handler() {
        formEl.scrollIntoView({ behavior: "smooth", block: "start" });
        formEl.removeEventListener("shown.bs.collapse", handler);
      });
      collapseInstance.show();
    } else {
      formEl.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    updateSubmitButtonState();
  };



  // 初期表示時に呼ぶ
  window.onload = function () {
    document.getElementById("service-list-area").style.display = "none";
    document.getElementById("toggleFormBtn").closest(".d-grid").style.display = "none";
    document.getElementById("form-container").style.display = "none";

    // 初回のみリスト取得＆描画
    google.script.run.withSuccessHandler(list => {
      cachedStaffList = list;
      renderStaffList(list);
    }).getStaffOptions();

    if (DISCOUNT_ENABLED) {
      google.script.run.withSuccessHandler(list => {
        cachedDiscountList = list;
        renderDiscountList(list);
      }).getDiscountOptions();
    }

    google.script.run.withSuccessHandler(data => {
      document.getElementById("loading-spinner").style.display = "none";
      document.getElementById("service-list-area").style.display = "block";
      document.getElementById("toggleFormBtn").closest(".d-grid").style.display = "block";
      document.getElementById("form-container").style.display = "block";
      renderServiceList(data);
    }).buildServiceListWithLinks();
  };

  // ✅ 表を描画
  function renderServiceList(data) {
    console.log("🔥 renderServiceList 受信データ", data);
    data.sort((a, b) => Number(a.order) - Number(b.order));

    serviceData = data;
    const tbody = document.getElementById("serviceTableBody");
    tbody.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="11">データがありません</td></tr>'; // ← 11列に
      return;
    }

    data.forEach((item, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.order}</td>
        <td class="name-cell">${item.categoryMain || "-"}</td>   <!-- ← 追加 -->
        <td class="name-cell">${item.categorySub  || "-"}</td>   <!-- ← 追加 -->
        <td>${item.duration}分</td>
        <td class="col-price">¥${item.price}</td>
        <td class="col-tax">${item.tax}%</td>
        <td class="note-cell col-discount">${item.discountNames ? item.discountNames.replace(/\n/g,"<br>") : "-"}</td>
        <td class="note-cell">${item.staffNames ? item.staffNames.replace(/\n/g,"<br>") : "-"}</td>
        <td>${item.capacity}</td>
        <td class="note-cell">${item.note || "-"}</td>
        <td>
          <div class="d-flex flex-column gap-1 align-items-center">
            <button class="btn btn-sm btn-warning w-75" onclick="editService(${i})">編集</button>
            <button class="btn btn-sm btn-danger  w-75" onclick="openDeleteModal(${i})">削除</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // 🔽 スタッフ一覧を取得し、セレクトに追加
    google.script.run.withSuccessHandler(staffList => {
    const container = document.getElementById("assignedStaffContainer");
    container.innerHTML = "";

    if (!Array.isArray(staffList) || staffList.length === 0) {
      container.innerHTML = "<div>スタッフが登録されていません</div>";
      return;
    }

    staffList.forEach(staff => {
      const div = document.createElement("div");
      div.className = "form-check";

      const checkbox = document.createElement("input");
      checkbox.className = "form-check-input";
      checkbox.type = "checkbox";
      checkbox.id = `staff-${staff.id}`;
      checkbox.value = staff.id;
      checkbox.name = "assignedStaff";

      const label = document.createElement("label");
      label.className = "form-check-label";
      label.htmlFor = `staff-${staff.id}`;

      // 名前（役職）形式で表示（役職が空なら名前だけ）
      label.textContent = staff.position ? `${staff.name}（${staff.position}）` : staff.name;

      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
    });
  }).getStaffOptions(); // ← position を含むようGAS側でも調整必要

  function openConfirmModal() {
    const data = getFormData();

    // ✅ サニタイズチェック
    if (!validateSafeInputs(data)) {
      alert("❌ 入力内容に不正なタグが含まれています。");
      return;
    }

    const errorBox = document.getElementById("validation-error");
    errorBox.style.display = "none";
    errorBox.textContent = "";

    // 🔽 バリデーションチェック
    const errors = [];
    //if (!data.categoryMain?.trim()) errors.push("カテゴリ大を入力してください"); ※カテゴリ大は任意のため
    if (!data.categorySub?.trim())  errors.push("カテゴリ小を入力してください");
    if (!data.duration || isNaN(data.duration) || Number(data.duration) <= 0) errors.push("所要時間は1以上の数値で入力してください");
    if (!data.price || isNaN(data.price) || Number(data.price) < 0) errors.push("金額は0以上の数値で入力してください");
    if (!data.tax || isNaN(data.tax) || Number(data.tax) < 0 || Number(data.tax) > 100) errors.push("税率は0～100の数値で入力してください");
    if (!data.capacity || isNaN(data.capacity) || Number(data.capacity) <= 0) errors.push("同時予約数は1以上の数値で入力してください");
    if (!Array.isArray(data.assignedStaffIds) || data.assignedStaffIds.length === 0) errors.push("担当スタッフを1人以上選択してください");

    if (errors.length > 0) {
      // 🔴 表示＆内容差し替え
      errorBox.innerHTML = errors.map(e => `・${e}`).join("<br>");
      errorBox.style.display = "block";
      return;
    }

    // 🔴 バリデーション通過 → エラー非表示にしてからモーダルへ
    errorBox.style.display = "none";
    errorBox.textContent = "";
    const orig = originalServiceData || {};
    const isEdit = !!data.id;

    // 🆕 タイトル・本文・ボタン文言 切り替え
    const title = isEdit ? "この内容で更新してよろしいですか？" : "この内容で登録してよろしいですか？";
    const bodyText = isEdit ? "内容を確認し、「更新」を押してください。" : "内容を確認し、「登録」を押してください。";
    const btnText = isEdit ? "更新" : "登録";

    // 差分比較（変更箇所のみ → を表示）
    const diffRow = (label, oldVal, newVal) => {
      if (!isEdit) {
        return `<li class="list-group-item">${label}：${newVal || "-"}</li>`;
      }
      const changed = String(oldVal) !== String(newVal);
      const arrow = changed ? ` → ${newVal || "-"}` : "";
      const klass = changed ? "text-danger fw-bold" : "";
      return `<li class="list-group-item ${klass}">${label}：${oldVal || "-"}${arrow}</li>`;
    };

    // スタッフ
    const staffLabels = Array.from(document.querySelectorAll('input[name="assignedStaff"]:checked'))
      .map(cb => cb.nextSibling.textContent.trim().replace(/（.+）$/, ""))
      .sort();
    const origStaff = (orig.staffNames || "").split("\n").sort().join("、");
    const currStaff = staffLabels.join("、") || "-";
    const staffChanged = isEdit && origStaff !== currStaff;

    // 割引
    const discountLabels = Array.from(document.querySelectorAll('input[name="assignedDiscount"]:checked'))
      .map(cb => cb.nextSibling.textContent.trim())
      .sort();
    const origDiscount = (orig.discountNames || "").split("\n").sort().join("、");
    const currDiscount = discountLabels.join("、") || "-";
    const discountChanged = isEdit && origDiscount !== currDiscount;

    // 差分表示HTML
    const modalHtml = `
      <ul class="list-group list-group-flush">
        ${diffRow("表示順", orig.order ?? "-", data.order ?? "-")}
        ${diffRow("カテゴリ大", orig.categoryMain || "-", data.categoryMain || "-")}
        ${diffRow("カテゴリ小", orig.categorySub  || "-", data.categorySub  || "-")} 
        ${diffRow("所要時間", orig.duration ? orig.duration + "分" : "-", data.duration ? data.duration + "分" : "-")}
        ${PRICE_TAX_ENABLED ? diffRow("金額(税込)", orig.price ? "¥"+orig.price : "-", data.price ? "¥"+data.price : "-") : ""}
        ${PRICE_TAX_ENABLED ? diffRow("税率", orig.tax ? orig.tax+"%" : "-", data.tax ? data.tax+"%" : "-") : ""}
        ${diffRow("同時予約数", orig.capacity ?? "-", data.capacity ?? "-")}
        ${diffRow("備考", orig.note || "-", data.note || "-")}
        ${DISCOUNT_ENABLED ? `
        <li class="list-group-item ${discountChanged ? "text-danger fw-bold" : ""}">
          適用割引：${isEdit ? `${origDiscount || "-"}${discountChanged ? ` → ${currDiscount}` : ""}` : currDiscount}
        </li>` : ""}
        <li class="list-group-item ${staffChanged ? "text-danger fw-bold" : ""}">
          担当スタッフ：${isEdit ? `${origStaff || "-"}${staffChanged ? ` → ${currStaff}` : ""}` : currStaff}
        </li>
      </ul>
    `;

    // 🔄 モーダルに反映
    document.querySelector("#confirmModal .modal-title").textContent = title;
    document.getElementById("confirm-register-btn").textContent = btnText;
    document.getElementById("confirm-modal-body-text").textContent = bodyText;
    document.getElementById("modal-body-text").innerHTML = modalHtml;

    // 表示
    new bootstrap.Modal(document.getElementById("confirmModal")).show();
  }





  document.getElementById("confirm-register-btn").addEventListener("click", () => {
    const modal = bootstrap.Modal.getInstance(document.getElementById("confirmModal"));
    modal.hide();

    const payload = getFormData();
    const isEdit = !!payload.id;

    // 🆕 スピナー文言切り替え
    document.getElementById("saving-spinner-text").textContent = isEdit ? "更新しています…" : "登録しています…";

    // 🔁 表示切り替え（ぐるぐる）
    document.getElementById("saving-spinner").style.display = "block";
    document.getElementById("service-list-area").style.display = "none";
    document.getElementById("toggleFormBtn").style.display = "none";
    document.getElementById("form-container").style.display = "none";

    const callback = () => {
      google.script.run.withSuccessHandler(data => {
        renderServiceList(data);
        document.getElementById("saving-spinner").style.display = "none";
        document.getElementById("service-list-area").style.display = "block";
        document.getElementById("toggleFormBtn").style.display = "block";
        document.getElementById("form-container").style.display = "block";
        document.getElementById("save-message").style.display = "block";
        setTimeout(() => {
          document.getElementById("save-message").style.display = "none";
        }, 3000);
        collapseInstance.hide();
      }).buildServiceListWithLinks();
    };

    if (isEdit) {
      google.script.run.withSuccessHandler(callback).saveService(payload);
    } else {
      google.script.run.withSuccessHandler(callback).insertServiceWithShift(payload);
    }
  });


  // ✅ サービス登録処理
  function saveService() {
    const payload = getFormData();

    const isDuplicateOrder = serviceData.some(item =>
      item.order == payload.order && item.id !== payload.id
    );

    if (isDuplicateOrder) {
      alert("この表示順はすでに使われています。他の番号を入力してください。");
      return;
    }

    // 🔁 表示切り替え（ぐるぐる表示）
    document.getElementById("saving-spinner").style.display = "block";
    document.getElementById("service-list-area").style.display = "none";
    document.getElementById("toggleFormBtn").style.display = "none";
    document.getElementById("form-container").style.display = "none";

    google.script.run
      .withSuccessHandler(() => {
        google.script.run.withSuccessHandler(data => {
          renderServiceList(data);

          // 🔁 表示復帰
          document.getElementById("saving-spinner").style.display = "none";
          document.getElementById("service-list-area").style.display = "block";
          document.getElementById("toggleFormBtn").style.display = "block";
          document.getElementById("form-container").style.display = "block";

          document.getElementById("save-message").style.display = "block";
          setTimeout(() => {
            document.getElementById("save-message").style.display = "none";
          }, 3000);

          collapseInstance.hide();
        }).buildServiceListWithLinks();
      })
      .saveService(payload);
  }


  function getFormData() {
    const checkedStaffIds = Array.from(
      document.querySelectorAll('input[name="assignedStaff"]:checked')
    ).map(cb => cb.value);

    const checkedDiscountIds = Array.from(
      document.querySelectorAll('input[name="assignedDiscount"]:checked')
    ).map(cb => cb.value);

    const data = {
      id: document.getElementById("serviceId").value || "",
      order: document.getElementById("order").value,
      categoryMain: document.getElementById("categoryMain").value,
      categorySub: document.getElementById("categorySub").value,
      duration: document.getElementById("duration").value,
      price: document.getElementById("price").value,
      tax: document.getElementById("tax").value,
      assignedDiscountIds: checkedDiscountIds,
      capacity: document.getElementById("capacity").value,
      note: document.getElementById("note").value,
      assignedStaffIds: checkedStaffIds // ← 中間データに渡す値
    };

    // ← ここがポイント！
    if (!PRICE_TAX_ENABLED) {
      delete data.price;
      delete data.tax;
    }
    if (!DISCOUNT_ENABLED) {
      delete data.assignedDiscountIds;
    }

    return data;
  }

  function resetForm() {
    document.getElementById("submit-button").textContent = "登録";
    document.getElementById("serviceId").value = "";
    originalServiceData = null;
    const usedOrders = serviceData.map(item => Number(item.order)).filter(n => !isNaN(n));
    const nextOrder = usedOrders.length > 0 ? Math.max(...usedOrders) + 1 : 1;
    document.getElementById("order").value = nextOrder;
    document.getElementById("categoryMain").value = "";
    document.getElementById("categorySub").value = "";
    document.getElementById("duration").value = "";
    document.getElementById("price").value = "";
    document.getElementById("tax").value = "";
    document.getElementById("capacity").value = "";
    document.getElementById("note").value = "";
    document.querySelectorAll('input[name="assignedStaff"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[name="assignedDiscount"]').forEach(cb => cb.checked = false);
    document.getElementById("validation-error").style.display = "none";
    document.getElementById("validation-error").textContent = "";
  }


  let deleteTargetIndex = null;

function openDeleteModal(index) {
  deleteTargetIndex = index;

  const row = document.querySelectorAll("#serviceTableBody tr")[index].children;
  const categoryMain = row[1].textContent; // 列順に合わせて調整
  const categorySub  = row[2].textContent; // 列順に合わせて調整

  document.getElementById("delete-modal-body").innerHTML =
    `カテゴリ大：<strong>${categoryMain}</strong><br>
    カテゴリ小：<strong>${categorySub}</strong><br>
    を削除してよろしいですか？`;

  new bootstrap.Modal(document.getElementById("deleteModal")).show();
}

document.getElementById("confirm-delete-btn").addEventListener("click", () => {
  if (deleteTargetIndex === null) return;

  // 🔁 表示切り替え
  document.getElementById("deleting-spinner").style.display = "block";
  document.getElementById("service-list-area").style.display = "none";
  document.getElementById("toggleFormBtn").style.display = "none";
  document.getElementById("form-container").style.display = "none";


  const modal = bootstrap.Modal.getInstance(document.getElementById("deleteModal"));
  modal.hide();

  google.script.run
    .withSuccessHandler(() => {
      google.script.run.withSuccessHandler(data => {
        renderServiceList(data);
        document.getElementById("deleting-spinner").style.display = "none";
        document.getElementById("service-list-area").style.display = "block";
        document.getElementById("toggleFormBtn").style.display = "block";
        document.getElementById("form-container").style.display = "block";


        // ✅ 削除メッセージ表示
        const msg = document.getElementById("delete-message");
        msg.style.display = "block";
        setTimeout(() => {
          msg.style.display = "none";
        }, 3000);
      }).buildServiceListWithLinks();
    })
    .deleteService(deleteTargetIndex);
});


  function loadStaffList(callbackAfterCheck) {
    const container = document.getElementById("assignedStaffContainer");

    container.innerHTML = `
      <div id="staff-loading-spinner" class="text-center my-2">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 mb-0">スタッフ情報を読み込み中です…</p>
      </div>
    `;

    if (!cachedStaffList) {
      google.script.run.withSuccessHandler(staffList => {
        cachedStaffList = staffList;
        renderStaffList(staffList, callbackAfterCheck);
      }).getStaffOptions();
    } else {
      renderStaffList(cachedStaffList, callbackAfterCheck);
    }
  }

  function renderStaffList(staffList) {
    const container = document.getElementById("assignedStaffContainer");
    container.innerHTML = "";

    staffList.forEach(staff => {
      const div = document.createElement("div");
      div.className = "form-check";

      const checkbox = document.createElement("input");
      checkbox.className = "form-check-input";
      checkbox.type = "checkbox";
      checkbox.id = `staff-${staff.id}`;
      checkbox.value = staff.id;
      checkbox.name = "assignedStaff";

      const label = document.createElement("label");
      label.className = "form-check-label";
      label.htmlFor = `staff-${staff.id}`;
      label.textContent = staff.position ? `${staff.name}（${staff.position}）` : staff.name;

      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
    });
  }



  function loadDiscountList(serviceId = "", callbackAfterCheck) {
    const container = document.getElementById("assignedDiscountContainer");

    container.innerHTML = `
      <div id="discount-loading-spinner" class="text-center my-2">
        <div class="spinner-border text-success" role="status"></div>
        <p class="mt-2 mb-0">割引情報を読み込み中です…</p>
      </div>
    `;

    if (!cachedDiscountList) {
      /*google.script.run.withSuccessHandler(discountList => {
        cachedDiscountList = discountList;
        renderDiscountList(discountList, serviceId, callbackAfterCheck);
      }).getDiscountOptions();*/
    } else {
      renderDiscountList(cachedDiscountList, serviceId, callbackAfterCheck);
    }
  }

  // 割引一覧描画（初期表示のみ呼ぶ）
  function renderDiscountList(discountList) {
    const container = document.getElementById("assignedDiscountContainer");
    container.innerHTML = "";

    discountList.forEach(discount => {
      const div = document.createElement("div");
      div.className = "form-check";

      const checkbox = document.createElement("input");
      checkbox.className = "form-check-input";
      checkbox.type = "checkbox";
      checkbox.id = `discount-${discount.id}`;
      checkbox.value = discount.id;
      checkbox.name = "assignedDiscount";

      const label = document.createElement("label");
      label.className = "form-check-label";
      label.htmlFor = `discount-${discount.id}`;
      label.textContent = discount.name;

      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
    });
  }

  
  function getCurrentFormData() {
    return getFormData(); // すでにある getFormData() をそのまま再利用
  }

  function updateSubmitButtonState() {
    const btn = document.getElementById("submit-button");
    const formData = getCurrentFormData();

    const normalizeValue = (v) => typeof v === "number" ? String(v) : (v ?? "");
    const normalizeArray = (arr) => [...(arr || [])].sort(); // ソートして比較

    if (!formData.id) {
      const hasInput = Object.values(formData).some(val =>
        Array.isArray(val) ? val.length > 0 : normalizeValue(val)
      );
      console.log("【新規】入力あり？", hasInput, formData);
      btn.disabled = !hasInput;
    } else {
      const orig = originalServiceData || {};

      const normalizedCurrent = {
        order: normalizeValue(formData.order),
        categoryMain: normalizeValue(formData.categoryMain),  // ← 追加
        categorySub:  normalizeValue(formData.categorySub), 
        duration: normalizeValue(formData.duration),
        price: normalizeValue(formData.price),
        tax: normalizeValue(formData.tax),
        capacity: normalizeValue(formData.capacity),
        note: normalizeValue(formData.note),
        assignedDiscountIds: normalizeArray(formData.assignedDiscountIds),
        assignedStaffIds: normalizeArray(formData.assignedStaffIds),
      };

      const normalizedOriginal = {
        order: normalizeValue(orig.order),
        categoryMain: normalizeValue(orig.categoryMain),
        categorySub:  normalizeValue(orig.categorySub), 
        duration: normalizeValue(orig.duration),
        price: normalizeValue(orig.price),
        tax: normalizeValue(orig.tax),
        capacity: normalizeValue(orig.capacity),
        note: normalizeValue(orig.note),
        assignedDiscountIds: normalizeArray(orig.assignedDiscountIds),
        assignedStaffIds: normalizeArray(orig.assignedStaffIds),
      };

      if (!PRICE_TAX_ENABLED) {
        delete normalizedCurrent.price; delete normalizedCurrent.tax;
        delete normalizedOriginal.price; delete normalizedOriginal.tax;
      }
      if (!DISCOUNT_ENABLED) {
        delete normalizedCurrent.assignedDiscountIds;
        delete normalizedOriginal.assignedDiscountIds;
      }

      const isChanged = JSON.stringify(normalizedCurrent) !== JSON.stringify(normalizedOriginal);
      console.log("【更新】差分あり？", isChanged, { current: normalizedCurrent, original: normalizedOriginal });
      btn.disabled = !isChanged;
    }
  }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
