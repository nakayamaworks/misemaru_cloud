<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>ğŸª„ ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š</title>
<style>
  @media (max-width: 576px) {
  th, td {
    font-size: 0.85rem;
    padding: 0.2rem 0.3rem;
  }

  th:nth-child(1), td:nth-child(1) {
    display: none; /* è¡¨ç¤ºé † éè¡¨ç¤º */
  }

  th:nth-child(6), td:nth-child(6) { /* å‰²å¼• */
    min-width: 90px;
  }

  th:nth-child(7), td:nth-child(7) { /* æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ• */
    min-width: 110px;
  }

  th:nth-child(8), td:nth-child(8) { /* åŒæ™‚äºˆç´„æ•° */
    min-width: 80px;
  }

  th:nth-child(9), td:nth-child(9) { /* å‚™è€ƒ */
    display: none;
  }

  th:nth-child(10), td:nth-child(10) { /* âœ… æ“ä½œåˆ— */
    min-width: 100px;
  }

  .table td:last-child > .d-flex {
    flex-direction: column;
    gap: 0.25rem;
    align-items: stretch;
  }

  .table td:last-child button {
    font-size: 0.75rem;
    padding: 0.3rem;
  }
}

th, td {
  white-space: nowrap;
}

.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.table-responsive table {
  table-layout: auto !important;
  min-width: 800px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¹…ã®æœ€å°å€¤ã‚’æ˜ç¤ºçš„ã«ç¢ºä¿ */
}

.table-responsive th,
.table-responsive td {
  white-space: nowrap !important; /* æŠ˜ã‚Šè¿”ã—ã•ã›ãªã„ */
}

.btn-register-wrapper {
  max-width: 440px;
  margin-left: auto;
  margin-right: auto;
  width: 100%;
}

td.note-cell {
  white-space: pre-wrap !important;
  word-break: break-word;
  max-width: 160px;
}

td.name-cell {
  white-space: pre-wrap !important;
  word-break: break-word;
  max-width: 160px;
}

@media (min-width: 768px) {
  .table td, .table th {
    vertical-align: top;
    font-size: 0.95rem;
    padding: 0.4rem 0.5rem;
  }

  td.note-cell, td.name-cell {
    white-space: pre-wrap !important;
    line-height: 1.3;
  }

  .table-responsive table {
    min-width: 1000px;
    table-layout: fixed;
  }
}

@media (max-width: 576px) {
  th, td {
    font-size: 0.85rem;
    padding: 0.2rem 0.3rem;
  }

  th:nth-child(1), td:nth-child(1) { display: none; }
  th:nth-child(5), td:nth-child(5) { min-width: 60px; }
  th:nth-child(6), td:nth-child(6) { min-width: 120px; }

  td.note-cell, td.name-cell {
    white-space: pre-wrap;
    word-break: break-word;
  }

  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .table td:last-child > .d-flex {
    flex-direction: row; /* ãƒœã‚¿ãƒ³æ¨ªä¸¦ã³ */
    gap: 0.25rem;
    justify-content: center;
  }

  .table td:last-child button {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
}

/* æ©Ÿèƒ½ãƒˆã‚°ãƒ«ã§åˆ—/ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™ */
body.no-price-tax th.col-price,
body.no-price-tax td.col-price,
body.no-price-tax th.col-tax,
body.no-price-tax td.col-tax { display:none; }

body.no-discount th.col-discount,
body.no-discount td.col-discount,
body.no-discount .form-section-discount { display:none; }

body.no-price-tax .form-price,
body.no-price-tax .form-tax { display:none; }
</style>
</head>
<body class="container-fluid py-3 loading no-discount">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­...</p>
  </div>
  <div id="app" style="display:none;">

  <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('40_setting_main_admin')">â† æˆ»ã‚‹</button>
  <h4 class="text-center mb-4">ğŸª„ ã‚µãƒ¼ãƒ“ã‚¹</h4>
  <div id="form-container">
  
  <!-- ä¸€è¦§ -->
  <div id="service-list-area" class="mb-1">
    <!-- âœ… æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div id="save-message" class="alert alert-success text-center" style="display: none;">
    ç™»éŒ²ã—ã¾ã—ãŸï¼
  </div>
  <!-- âœ… å‰Šé™¤å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div id="delete-message" class="alert alert-danger text-center" style="display: none;">
    å‰Šé™¤ã—ã¾ã—ãŸï¼
  </div>
    <h5>ç™»éŒ²æ¸ˆã¿ã®ã‚µãƒ¼ãƒ“ã‚¹</h5>
    <div class="table-responsive">
      <table class="table table-striped table-bordered" id="serviceTable">
        <thead>
          <tr>
            <th>è¡¨ç¤ºé †</th>
            <th>ã‚«ãƒ†ã‚´ãƒªå¤§</th>
            <th>ã‚«ãƒ†ã‚´ãƒªå°</th>
            <th>æ‰€è¦æ™‚é–“</th>
            <th class="col-price">é‡‘é¡(ç¨è¾¼)</th>
            <th class="col-tax">ç¨ç‡</th>
            <th class="col-discount">é©ç”¨å‰²å¼•</th>
            <th>æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</th>
            <th>åŒæ™‚äºˆç´„å¯èƒ½æ•°</th>
            <th>å‚™è€ƒ</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="serviceTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ã€Œï¼‹æ–°è¦ä½œæˆã€ãƒœã‚¿ãƒ³ -->
  <div class="d-grid mt-0 mb-3">
    <div class="form-wrapper">
      <button id="toggleFormBtn" class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#serviceForm" aria-expanded="false" aria-controls="serviceForm">
        ï¼‹ æ–°è¦ä½œæˆ
      </button>
    </div>
  </div>

  <!-- âœ… ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ï¼ˆã‚µãƒ¼ãƒ“ã‚¹è¨­å®šï¼‰ -->

<div id="serviceForm" class="collapse">
<div class="form-wrapper">
  <h5 class="mb-3">ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²</h5>

  <!-- ğŸ”» ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ¬„ -->
  <div id="validation-error" class="alert alert-danger py-2 px-3" style="display: none;"></div>

  <input type="hidden" id="serviceId">

  <div class="mb-3">
    <label class="form-label">è¡¨ç¤ºé †</label>
    <input type="number" class="form-control" id="order">
  </div>

  <div class="mb-3">
    <label class="form-label">ã‚«ãƒ†ã‚´ãƒªå¤§</label>
    <input type="text" class="form-control" id="categoryMain">
  </div>

  <div class="mb-3">
    <label class="form-label">ã‚«ãƒ†ã‚´ãƒªå°</label>
    <input type="text" class="form-control" id="categorySub">
  </div>


  <div class="row mb-3">
    <div class="col">
      <label class="form-label">æ‰€è¦æ™‚é–“(åˆ†)</label>
      <input type="number" class="form-control" id="duration">
    </div>
    <div class="col form-price">
      <label class="form-label">é‡‘é¡(ç¨è¾¼)</label>
      <input type="number" class="form-control" id="price" min="0" step="1" inputmode="numeric">
    </div>
    <div class="col form-tax">
      <label class="form-label">ç¨ç‡(%)</label>
      <input type="number" class="form-control" id="tax"   min="0" max="100" step="0.1" inputmode="decimal">
    </div>
  </div>

  <!-- å‰²å¼•é©ç”¨ -->
  <div class="mb-3 form-section-discount">
    <label class="form-label">å‰²å¼•é©ç”¨</label>
    <div id="assignedDiscountContainer" class="border rounded p-2 bg-white" style="max-height: 200px; overflow-y: auto;">
      <!-- ã‚¹ãƒ”ãƒŠãƒ¼ -->
      <div id="discount-loading-spinner" class="text-center my-2">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
        <p class="mt-2 mb-0 text-muted">å‰²å¼•æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</p>
      </div>
    </div>
    <small class="text-muted">â€»é©ç”¨ã™ã‚‹å‰²å¼•ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆè¤‡æ•°å¯ï¼‰</small>
  </div>

  <!-- æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ• -->
  <div class="mb-3">
    <label class="form-label">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</label>
    <div id="assignedStaffContainer" class="border rounded p-2 bg-white" style="max-height: 200px; overflow-y: auto;">
      <!-- ã“ã“ã«ã‚¹ãƒ”ãƒŠãƒ¼ -->
      <div id="staff-loading-spinner" class="text-center my-2">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
      </div>
    </div>
    <small class="text-muted">â€»æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„(è¤‡æ•°å¯)</small>
  </div>

  <div class="mb-3">
    <label class="form-label">åŒæ™‚äºˆç´„å¯èƒ½æ•°ï¼ˆã‚¹ã‚¿ãƒƒãƒ• 1åã‚ãŸã‚Šï¼‰</label>
    <input type="number" class="form-control" id="capacity">
  </div>

  <div class="mb-3">
    <label class="form-label">å‚™è€ƒ</label>
    <input type="text" class="form-control" id="note">
  </div>

  <div class="d-grid">
    <button class="btn btn-primary" id="submit-button" onclick="openConfirmModal()">ç™»éŒ²</button>
  </div>
</div>
</div>

  </div>
<!-- ğŸ”„ åˆæœŸèª­ã¿è¾¼ã¿ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="loading-spinner" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <p class="mt-3">ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</p>
  </div>

  <!-- ğŸ”„ ä¿å­˜ä¸­ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="saving-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ç™»éŒ²ä¸­...</span>
    </div>
    <p class="mt-2" id="saving-spinner-text">ç™»éŒ²ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  

  <!-- ğŸ”„ å‰Šé™¤ä¸­ã‚¹ãƒ”ãƒŠãƒ¼ -->
  <div id="deleting-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-danger" role="status">
      <span class="visually-hidden">å‰Šé™¤ä¸­...</span>
    </div>
    <p class="mt-2">å‰Šé™¤ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  

  <!-- âœ… ç™»éŒ²ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ã“ã®å†…å®¹ã§ç™»éŒ²ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="confirm-modal-body-text">å†…å®¹ã‚’ç¢ºèªã—ã€ã€Œç™»éŒ²ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
          <div class="mt-3" id="modal-body-text">
            <!-- å·®åˆ†ãƒªã‚¹ãƒˆ -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-primary" id="confirm-register-btn">ç™»éŒ²</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="delete-modal-body">
            ä¸€åº¦å‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-btn">å‰Šé™¤ã™ã‚‹</button>
          </div>
        </div>
      </div>
    </div>


<script>
  const DISCOUNT_ENABLED = !document.body.classList.contains('no-discount');
  const PRICE_TAX_ENABLED = !document.body.classList.contains('no-price-tax');

  let serviceData = [];
  let collapseInstance;
  let isFormOpened = false;
  let cachedStaffList = null;
  let cachedDiscountList = null;


  window.addEventListener("DOMContentLoaded", () => {
    console.log("[CHILD] DOMContentLoaded â†’ child-ready ã‚’è¦ªã¸é€ä¿¡");
    try {
      window.top.postMessage(
        { type: "misemaru:child-ready", origin: location.origin },
        "*" // è¦ªå´ã§å¿…ãš event.origin ã‚’æ¤œè¨¼ã™ã‚‹ã®ã§å®‰å…¨
      );
    } catch (err) {
      console.error("[CHILD] child-ready é€ä¿¡å¤±æ•—:", err);
    }

    const formEl = document.getElementById("serviceForm");
    const btnEl = document.getElementById("toggleFormBtn");

    collapseInstance = new bootstrap.Collapse(formEl, { toggle: false });

    formEl.addEventListener("show.bs.collapse", () => {
      btnEl.textContent = "âˆ’ é–‰ã˜ã‚‹";
      isFormOpened = true;
    });

    formEl.addEventListener("hide.bs.collapse", () => {
      btnEl.textContent = "ï¼‹ æ–°è¦ä½œæˆ";
      resetForm();
      isFormOpened = false;
      updateSubmitButtonState();
    });

    formEl.addEventListener("shown.bs.collapse", () => {
      formEl.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    btnEl.addEventListener("click", () => {
      const collapse = bootstrap.Collapse.getInstance(formEl) || new bootstrap.Collapse(formEl, { toggle: false });
      if (formEl.classList.contains("show")) {
        collapse.hide();
      } else {
        collapse.show();
        setTimeout(() => {
          formEl.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      }
    });

    // âœ… ã“ã“ã‹ã‚‰è¿½åŠ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ãƒ»ãƒã‚§ãƒƒã‚¯å¤‰æ›´æ™‚ã«ç™»éŒ²ãƒœã‚¿ãƒ³åˆ¶å¾¡ï¼‰
    ["order", "categoryMain", "categorySub", "duration", "price", "tax", "capacity", "note"].forEach(id => {
      document.getElementById(id).addEventListener("input", updateSubmitButtonState);
    });

    document.getElementById("assignedStaffContainer").addEventListener("change", updateSubmitButtonState);
    document.getElementById("assignedDiscountContainer").addEventListener("change", updateSubmitButtonState);

    // âœ… æœ€åˆã¯éæ´»æ€§
    updateSubmitButtonState();
  });




  let originalServiceData = null;

  // âœ… ç·¨é›†ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚
  window.editService = function (index) {
    const data = serviceData[index];
    originalServiceData = {
      id: data.id,
      order: data.order,
      categoryMain: data.categoryMain,
      categorySub:  data.categorySub, 
      duration: data.duration,
      price: data.price,
      tax: data.tax,
      capacity: data.capacity,
      note: data.note,
      assignedStaffIds: [...data.assignedStaffIds],
      assignedDiscountIds: [...data.assignedDiscountIds],
      staffNames: data.staffNames || "",
      discountNames: data.discountNames || "",
    };

    document.getElementById("submit-button").textContent = "æ›´æ–°";
    document.getElementById("serviceId").value = data.id;
    document.getElementById("order").value = data.order;
    document.getElementById("categoryMain").value = data.categoryMain;
    document.getElementById("categorySub").value = data.categorySub;
    document.getElementById("duration").value = data.duration;
    document.getElementById("price").value = data.price;
    document.getElementById("tax").value = data.tax;
    document.getElementById("capacity").value = data.capacity;
    document.getElementById("note").value = data.note;

    renderStaffList(cachedStaffList);
    if (DISCOUNT_ENABLED) renderDiscountList(cachedDiscountList);

    data.assignedStaffIds.forEach(staffId => {
      const cb = document.getElementById(`staff-${staffId}`);
      if (cb) cb.checked = true;
    });
    if (DISCOUNT_ENABLED) {
      data.assignedDiscountIds.forEach(discountId => {
        const cb = document.getElementById(`discount-${discountId}`);
        if (cb) cb.checked = true;
      });
    }

    const formEl = document.getElementById("serviceForm");
    if (!isFormOpened) {
      formEl.addEventListener("shown.bs.collapse", function handler() {
        formEl.scrollIntoView({ behavior: "smooth", block: "start" });
        formEl.removeEventListener("shown.bs.collapse", handler);
      });
      collapseInstance.show();
    } else {
      formEl.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    updateSubmitButtonState();
  };



  // åˆæœŸè¡¨ç¤ºæ™‚ã«å‘¼ã¶
  window.onload = function () {
    document.getElementById("service-list-area").style.display = "none";
    document.getElementById("toggleFormBtn").closest(".d-grid").style.display = "none";
    document.getElementById("form-container").style.display = "none";

    // åˆå›ã®ã¿ãƒªã‚¹ãƒˆå–å¾—ï¼†æç”»
    google.script.run.withSuccessHandler(list => {
      cachedStaffList = list;
      renderStaffList(list);
    }).getStaffOptions();

    if (DISCOUNT_ENABLED) {
      google.script.run.withSuccessHandler(list => {
        cachedDiscountList = list;
        renderDiscountList(list);
      }).getDiscountOptions();
    }

    google.script.run.withSuccessHandler(data => {
      document.getElementById("loading-spinner").style.display = "none";
      document.getElementById("service-list-area").style.display = "block";
      document.getElementById("toggleFormBtn").closest(".d-grid").style.display = "block";
      document.getElementById("form-container").style.display = "block";
      renderServiceList(data);
    }).buildServiceListWithLinks();
  };

  // âœ… è¡¨ã‚’æç”»
  function renderServiceList(data) {
    console.log("ğŸ”¥ renderServiceList å—ä¿¡ãƒ‡ãƒ¼ã‚¿", data);
    data.sort((a, b) => Number(a.order) - Number(b.order));

    serviceData = data;
    const tbody = document.getElementById("serviceTableBody");
    tbody.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="11">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'; // â† 11åˆ—ã«
      return;
    }

    data.forEach((item, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.order}</td>
        <td class="name-cell">${item.categoryMain || "-"}</td>   <!-- â† è¿½åŠ  -->
        <td class="name-cell">${item.categorySub  || "-"}</td>   <!-- â† è¿½åŠ  -->
        <td>${item.duration}åˆ†</td>
        <td class="col-price">Â¥${item.price}</td>
        <td class="col-tax">${item.tax}%</td>
        <td class="note-cell col-discount">${item.discountNames ? item.discountNames.replace(/\n/g,"<br>") : "-"}</td>
        <td class="note-cell">${item.staffNames ? item.staffNames.replace(/\n/g,"<br>") : "-"}</td>
        <td>${item.capacity}</td>
        <td class="note-cell">${item.note || "-"}</td>
        <td>
          <div class="d-flex flex-column gap-1 align-items-center">
            <button class="btn btn-sm btn-warning w-75" onclick="editService(${i})">ç·¨é›†</button>
            <button class="btn btn-sm btn-danger  w-75" onclick="openDeleteModal(${i})">å‰Šé™¤</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ğŸ”½ ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã‚’å–å¾—ã—ã€ã‚»ãƒ¬ã‚¯ãƒˆã«è¿½åŠ 
    google.script.run.withSuccessHandler(staffList => {
    const container = document.getElementById("assignedStaffContainer");
    container.innerHTML = "";

    if (!Array.isArray(staffList) || staffList.length === 0) {
      container.innerHTML = "<div>ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>";
      return;
    }

    staffList.forEach(staff => {
      const div = document.createElement("div");
      div.className = "form-check";

      const checkbox = document.createElement("input");
      checkbox.className = "form-check-input";
      checkbox.type = "checkbox";
      checkbox.id = `staff-${staff.id}`;
      checkbox.value = staff.id;
      checkbox.name = "assignedStaff";

      const label = document.createElement("label");
      label.className = "form-check-label";
      label.htmlFor = `staff-${staff.id}`;

      // åå‰ï¼ˆå½¹è·ï¼‰å½¢å¼ã§è¡¨ç¤ºï¼ˆå½¹è·ãŒç©ºãªã‚‰åå‰ã ã‘ï¼‰
      label.textContent = staff.position ? `${staff.name}ï¼ˆ${staff.position}ï¼‰` : staff.name;

      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
    });
  }).getStaffOptions(); // â† position ã‚’å«ã‚€ã‚ˆã†GASå´ã§ã‚‚èª¿æ•´å¿…è¦

  function openConfirmModal() {
    const data = getFormData();

    // âœ… ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    if (!validateSafeInputs(data)) {
      alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
      return;
    }

    const errorBox = document.getElementById("validation-error");
    errorBox.style.display = "none";
    errorBox.textContent = "";

    // ğŸ”½ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    const errors = [];
    //if (!data.categoryMain?.trim()) errors.push("ã‚«ãƒ†ã‚´ãƒªå¤§ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); â€»ã‚«ãƒ†ã‚´ãƒªå¤§ã¯ä»»æ„ã®ãŸã‚
    if (!data.categorySub?.trim())  errors.push("ã‚«ãƒ†ã‚´ãƒªå°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (!data.duration || isNaN(data.duration) || Number(data.duration) <= 0) errors.push("æ‰€è¦æ™‚é–“ã¯1ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (!data.price || isNaN(data.price) || Number(data.price) < 0) errors.push("é‡‘é¡ã¯0ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (!data.tax || isNaN(data.tax) || Number(data.tax) < 0 || Number(data.tax) > 100) errors.push("ç¨ç‡ã¯0ï½100ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (!data.capacity || isNaN(data.capacity) || Number(data.capacity) <= 0) errors.push("åŒæ™‚äºˆç´„æ•°ã¯1ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (!Array.isArray(data.assignedStaffIds) || data.assignedStaffIds.length === 0) errors.push("æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ã‚’1äººä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„");

    if (errors.length > 0) {
      // ğŸ”´ è¡¨ç¤ºï¼†å†…å®¹å·®ã—æ›¿ãˆ
      errorBox.innerHTML = errors.map(e => `ãƒ»${e}`).join("<br>");
      errorBox.style.display = "block";
      return;
    }

    // ğŸ”´ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šé â†’ ã‚¨ãƒ©ãƒ¼éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸
    errorBox.style.display = "none";
    errorBox.textContent = "";
    const orig = originalServiceData || {};
    const isEdit = !!data.id;

    // ğŸ†• ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ»ãƒœã‚¿ãƒ³æ–‡è¨€ åˆ‡ã‚Šæ›¿ãˆ
    const title = isEdit ? "ã“ã®å†…å®¹ã§æ›´æ–°ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ" : "ã“ã®å†…å®¹ã§ç™»éŒ²ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
    const bodyText = isEdit ? "å†…å®¹ã‚’ç¢ºèªã—ã€ã€Œæ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚" : "å†…å®¹ã‚’ç¢ºèªã—ã€ã€Œç™»éŒ²ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
    const btnText = isEdit ? "æ›´æ–°" : "ç™»éŒ²";

    // å·®åˆ†æ¯”è¼ƒï¼ˆå¤‰æ›´ç®‡æ‰€ã®ã¿ â†’ ã‚’è¡¨ç¤ºï¼‰
    const diffRow = (label, oldVal, newVal) => {
      if (!isEdit) {
        return `<li class="list-group-item">${label}ï¼š${newVal || "-"}</li>`;
      }
      const changed = String(oldVal) !== String(newVal);
      const arrow = changed ? ` â†’ ${newVal || "-"}` : "";
      const klass = changed ? "text-danger fw-bold" : "";
      return `<li class="list-group-item ${klass}">${label}ï¼š${oldVal || "-"}${arrow}</li>`;
    };

    // ã‚¹ã‚¿ãƒƒãƒ•
    const staffLabels = Array.from(document.querySelectorAll('input[name="assignedStaff"]:checked'))
      .map(cb => cb.nextSibling.textContent.trim().replace(/ï¼ˆ.+ï¼‰$/, ""))
      .sort();
    const origStaff = (orig.staffNames || "").split("\n").sort().join("ã€");
    const currStaff = staffLabels.join("ã€") || "-";
    const staffChanged = isEdit && origStaff !== currStaff;

    // å‰²å¼•
    const discountLabels = Array.from(document.querySelectorAll('input[name="assignedDiscount"]:checked'))
      .map(cb => cb.nextSibling.textContent.trim())
      .sort();
    const origDiscount = (orig.discountNames || "").split("\n").sort().join("ã€");
    const currDiscount = discountLabels.join("ã€") || "-";
    const discountChanged = isEdit && origDiscount !== currDiscount;

    // å·®åˆ†è¡¨ç¤ºHTML
    const modalHtml = `
      <ul class="list-group list-group-flush">
        ${diffRow("è¡¨ç¤ºé †", orig.order ?? "-", data.order ?? "-")}
        ${diffRow("ã‚«ãƒ†ã‚´ãƒªå¤§", orig.categoryMain || "-", data.categoryMain || "-")}
        ${diffRow("ã‚«ãƒ†ã‚´ãƒªå°", orig.categorySub  || "-", data.categorySub  || "-")} 
        ${diffRow("æ‰€è¦æ™‚é–“", orig.duration ? orig.duration + "åˆ†" : "-", data.duration ? data.duration + "åˆ†" : "-")}
        ${PRICE_TAX_ENABLED ? diffRow("é‡‘é¡(ç¨è¾¼)", orig.price ? "Â¥"+orig.price : "-", data.price ? "Â¥"+data.price : "-") : ""}
        ${PRICE_TAX_ENABLED ? diffRow("ç¨ç‡", orig.tax ? orig.tax+"%" : "-", data.tax ? data.tax+"%" : "-") : ""}
        ${diffRow("åŒæ™‚äºˆç´„æ•°", orig.capacity ?? "-", data.capacity ?? "-")}
        ${diffRow("å‚™è€ƒ", orig.note || "-", data.note || "-")}
        ${DISCOUNT_ENABLED ? `
        <li class="list-group-item ${discountChanged ? "text-danger fw-bold" : ""}">
          é©ç”¨å‰²å¼•ï¼š${isEdit ? `${origDiscount || "-"}${discountChanged ? ` â†’ ${currDiscount}` : ""}` : currDiscount}
        </li>` : ""}
        <li class="list-group-item ${staffChanged ? "text-danger fw-bold" : ""}">
          æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ï¼š${isEdit ? `${origStaff || "-"}${staffChanged ? ` â†’ ${currStaff}` : ""}` : currStaff}
        </li>
      </ul>
    `;

    // ğŸ”„ ãƒ¢ãƒ¼ãƒ€ãƒ«ã«åæ˜ 
    document.querySelector("#confirmModal .modal-title").textContent = title;
    document.getElementById("confirm-register-btn").textContent = btnText;
    document.getElementById("confirm-modal-body-text").textContent = bodyText;
    document.getElementById("modal-body-text").innerHTML = modalHtml;

    // è¡¨ç¤º
    new bootstrap.Modal(document.getElementById("confirmModal")).show();
  }





  document.getElementById("confirm-register-btn").addEventListener("click", () => {
    const modal = bootstrap.Modal.getInstance(document.getElementById("confirmModal"));
    modal.hide();

    const payload = getFormData();
    const isEdit = !!payload.id;

    // ğŸ†• ã‚¹ãƒ”ãƒŠãƒ¼æ–‡è¨€åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById("saving-spinner-text").textContent = isEdit ? "æ›´æ–°ã—ã¦ã„ã¾ã™â€¦" : "ç™»éŒ²ã—ã¦ã„ã¾ã™â€¦";

    // ğŸ” è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼ˆãã‚‹ãã‚‹ï¼‰
    document.getElementById("saving-spinner").style.display = "block";
    document.getElementById("service-list-area").style.display = "none";
    document.getElementById("toggleFormBtn").style.display = "none";
    document.getElementById("form-container").style.display = "none";

    const callback = () => {
      google.script.run.withSuccessHandler(data => {
        renderServiceList(data);
        document.getElementById("saving-spinner").style.display = "none";
        document.getElementById("service-list-area").style.display = "block";
        document.getElementById("toggleFormBtn").style.display = "block";
        document.getElementById("form-container").style.display = "block";
        document.getElementById("save-message").style.display = "block";
        setTimeout(() => {
          document.getElementById("save-message").style.display = "none";
        }, 3000);
        collapseInstance.hide();
      }).buildServiceListWithLinks();
    };

    if (isEdit) {
      google.script.run.withSuccessHandler(callback).saveService(payload);
    } else {
      google.script.run.withSuccessHandler(callback).insertServiceWithShift(payload);
    }
  });


  // âœ… ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²å‡¦ç†
  function saveService() {
    const payload = getFormData();

    const isDuplicateOrder = serviceData.some(item =>
      item.order == payload.order && item.id !== payload.id
    );

    if (isDuplicateOrder) {
      alert("ã“ã®è¡¨ç¤ºé †ã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚ä»–ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    // ğŸ” è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼ˆãã‚‹ãã‚‹è¡¨ç¤ºï¼‰
    document.getElementById("saving-spinner").style.display = "block";
    document.getElementById("service-list-area").style.display = "none";
    document.getElementById("toggleFormBtn").style.display = "none";
    document.getElementById("form-container").style.display = "none";

    google.script.run
      .withSuccessHandler(() => {
        google.script.run.withSuccessHandler(data => {
          renderServiceList(data);

          // ğŸ” è¡¨ç¤ºå¾©å¸°
          document.getElementById("saving-spinner").style.display = "none";
          document.getElementById("service-list-area").style.display = "block";
          document.getElementById("toggleFormBtn").style.display = "block";
          document.getElementById("form-container").style.display = "block";

          document.getElementById("save-message").style.display = "block";
          setTimeout(() => {
            document.getElementById("save-message").style.display = "none";
          }, 3000);

          collapseInstance.hide();
        }).buildServiceListWithLinks();
      })
      .saveService(payload);
  }


  function getFormData() {
    const checkedStaffIds = Array.from(
      document.querySelectorAll('input[name="assignedStaff"]:checked')
    ).map(cb => cb.value);

    const checkedDiscountIds = Array.from(
      document.querySelectorAll('input[name="assignedDiscount"]:checked')
    ).map(cb => cb.value);

    const data = {
      id: document.getElementById("serviceId").value || "",
      order: document.getElementById("order").value,
      categoryMain: document.getElementById("categoryMain").value,
      categorySub: document.getElementById("categorySub").value,
      duration: document.getElementById("duration").value,
      price: document.getElementById("price").value,
      tax: document.getElementById("tax").value,
      assignedDiscountIds: checkedDiscountIds,
      capacity: document.getElementById("capacity").value,
      note: document.getElementById("note").value,
      assignedStaffIds: checkedStaffIds // â† ä¸­é–“ãƒ‡ãƒ¼ã‚¿ã«æ¸¡ã™å€¤
    };

    // â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼
    if (!PRICE_TAX_ENABLED) {
      delete data.price;
      delete data.tax;
    }
    if (!DISCOUNT_ENABLED) {
      delete data.assignedDiscountIds;
    }

    return data;
  }

  function resetForm() {
    document.getElementById("submit-button").textContent = "ç™»éŒ²";
    document.getElementById("serviceId").value = "";
    originalServiceData = null;
    const usedOrders = serviceData.map(item => Number(item.order)).filter(n => !isNaN(n));
    const nextOrder = usedOrders.length > 0 ? Math.max(...usedOrders) + 1 : 1;
    document.getElementById("order").value = nextOrder;
    document.getElementById("categoryMain").value = "";
    document.getElementById("categorySub").value = "";
    document.getElementById("duration").value = "";
    document.getElementById("price").value = "";
    document.getElementById("tax").value = "";
    document.getElementById("capacity").value = "";
    document.getElementById("note").value = "";
    document.querySelectorAll('input[name="assignedStaff"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[name="assignedDiscount"]').forEach(cb => cb.checked = false);
    document.getElementById("validation-error").style.display = "none";
    document.getElementById("validation-error").textContent = "";
  }


  let deleteTargetIndex = null;

function openDeleteModal(index) {
  deleteTargetIndex = index;

  const row = document.querySelectorAll("#serviceTableBody tr")[index].children;
  const categoryMain = row[1].textContent; // åˆ—é †ã«åˆã‚ã›ã¦èª¿æ•´
  const categorySub  = row[2].textContent; // åˆ—é †ã«åˆã‚ã›ã¦èª¿æ•´

  document.getElementById("delete-modal-body").innerHTML =
    `ã‚«ãƒ†ã‚´ãƒªå¤§ï¼š<strong>${categoryMain}</strong><br>
    ã‚«ãƒ†ã‚´ãƒªå°ï¼š<strong>${categorySub}</strong><br>
    ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

  new bootstrap.Modal(document.getElementById("deleteModal")).show();
}

document.getElementById("confirm-delete-btn").addEventListener("click", () => {
  if (deleteTargetIndex === null) return;

  // ğŸ” è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  document.getElementById("deleting-spinner").style.display = "block";
  document.getElementById("service-list-area").style.display = "none";
  document.getElementById("toggleFormBtn").style.display = "none";
  document.getElementById("form-container").style.display = "none";


  const modal = bootstrap.Modal.getInstance(document.getElementById("deleteModal"));
  modal.hide();

  google.script.run
    .withSuccessHandler(() => {
      google.script.run.withSuccessHandler(data => {
        renderServiceList(data);
        document.getElementById("deleting-spinner").style.display = "none";
        document.getElementById("service-list-area").style.display = "block";
        document.getElementById("toggleFormBtn").style.display = "block";
        document.getElementById("form-container").style.display = "block";


        // âœ… å‰Šé™¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        const msg = document.getElementById("delete-message");
        msg.style.display = "block";
        setTimeout(() => {
          msg.style.display = "none";
        }, 3000);
      }).buildServiceListWithLinks();
    })
    .deleteService(deleteTargetIndex);
});


  function loadStaffList(callbackAfterCheck) {
    const container = document.getElementById("assignedStaffContainer");

    container.innerHTML = `
      <div id="staff-loading-spinner" class="text-center my-2">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 mb-0">ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</p>
      </div>
    `;

    if (!cachedStaffList) {
      google.script.run.withSuccessHandler(staffList => {
        cachedStaffList = staffList;
        renderStaffList(staffList, callbackAfterCheck);
      }).getStaffOptions();
    } else {
      renderStaffList(cachedStaffList, callbackAfterCheck);
    }
  }

  function renderStaffList(staffList) {
    const container = document.getElementById("assignedStaffContainer");
    container.innerHTML = "";

    staffList.forEach(staff => {
      const div = document.createElement("div");
      div.className = "form-check";

      const checkbox = document.createElement("input");
      checkbox.className = "form-check-input";
      checkbox.type = "checkbox";
      checkbox.id = `staff-${staff.id}`;
      checkbox.value = staff.id;
      checkbox.name = "assignedStaff";

      const label = document.createElement("label");
      label.className = "form-check-label";
      label.htmlFor = `staff-${staff.id}`;
      label.textContent = staff.position ? `${staff.name}ï¼ˆ${staff.position}ï¼‰` : staff.name;

      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
    });
  }



  function loadDiscountList(serviceId = "", callbackAfterCheck) {
    const container = document.getElementById("assignedDiscountContainer");

    container.innerHTML = `
      <div id="discount-loading-spinner" class="text-center my-2">
        <div class="spinner-border text-success" role="status"></div>
        <p class="mt-2 mb-0">å‰²å¼•æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</p>
      </div>
    `;

    if (!cachedDiscountList) {
      /*google.script.run.withSuccessHandler(discountList => {
        cachedDiscountList = discountList;
        renderDiscountList(discountList, serviceId, callbackAfterCheck);
      }).getDiscountOptions();*/
    } else {
      renderDiscountList(cachedDiscountList, serviceId, callbackAfterCheck);
    }
  }

  // å‰²å¼•ä¸€è¦§æç”»ï¼ˆåˆæœŸè¡¨ç¤ºã®ã¿å‘¼ã¶ï¼‰
  function renderDiscountList(discountList) {
    const container = document.getElementById("assignedDiscountContainer");
    container.innerHTML = "";

    discountList.forEach(discount => {
      const div = document.createElement("div");
      div.className = "form-check";

      const checkbox = document.createElement("input");
      checkbox.className = "form-check-input";
      checkbox.type = "checkbox";
      checkbox.id = `discount-${discount.id}`;
      checkbox.value = discount.id;
      checkbox.name = "assignedDiscount";

      const label = document.createElement("label");
      label.className = "form-check-label";
      label.htmlFor = `discount-${discount.id}`;
      label.textContent = discount.name;

      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
    });
  }

  
  function getCurrentFormData() {
    return getFormData(); // ã™ã§ã«ã‚ã‚‹ getFormData() ã‚’ãã®ã¾ã¾å†åˆ©ç”¨
  }

  function updateSubmitButtonState() {
    const btn = document.getElementById("submit-button");
    const formData = getCurrentFormData();

    const normalizeValue = (v) => typeof v === "number" ? String(v) : (v ?? "");
    const normalizeArray = (arr) => [...(arr || [])].sort(); // ã‚½ãƒ¼ãƒˆã—ã¦æ¯”è¼ƒ

    if (!formData.id) {
      const hasInput = Object.values(formData).some(val =>
        Array.isArray(val) ? val.length > 0 : normalizeValue(val)
      );
      console.log("ã€æ–°è¦ã€‘å…¥åŠ›ã‚ã‚Šï¼Ÿ", hasInput, formData);
      btn.disabled = !hasInput;
    } else {
      const orig = originalServiceData || {};

      const normalizedCurrent = {
        order: normalizeValue(formData.order),
        categoryMain: normalizeValue(formData.categoryMain),  // â† è¿½åŠ 
        categorySub:  normalizeValue(formData.categorySub), 
        duration: normalizeValue(formData.duration),
        price: normalizeValue(formData.price),
        tax: normalizeValue(formData.tax),
        capacity: normalizeValue(formData.capacity),
        note: normalizeValue(formData.note),
        assignedDiscountIds: normalizeArray(formData.assignedDiscountIds),
        assignedStaffIds: normalizeArray(formData.assignedStaffIds),
      };

      const normalizedOriginal = {
        order: normalizeValue(orig.order),
        categoryMain: normalizeValue(orig.categoryMain),
        categorySub:  normalizeValue(orig.categorySub), 
        duration: normalizeValue(orig.duration),
        price: normalizeValue(orig.price),
        tax: normalizeValue(orig.tax),
        capacity: normalizeValue(orig.capacity),
        note: normalizeValue(orig.note),
        assignedDiscountIds: normalizeArray(orig.assignedDiscountIds),
        assignedStaffIds: normalizeArray(orig.assignedStaffIds),
      };

      if (!PRICE_TAX_ENABLED) {
        delete normalizedCurrent.price; delete normalizedCurrent.tax;
        delete normalizedOriginal.price; delete normalizedOriginal.tax;
      }
      if (!DISCOUNT_ENABLED) {
        delete normalizedCurrent.assignedDiscountIds;
        delete normalizedOriginal.assignedDiscountIds;
      }

      const isChanged = JSON.stringify(normalizedCurrent) !== JSON.stringify(normalizedOriginal);
      console.log("ã€æ›´æ–°ã€‘å·®åˆ†ã‚ã‚Šï¼Ÿ", isChanged, { current: normalizedCurrent, original: normalizedOriginal });
      btn.disabled = !isChanged;
    }
  }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
