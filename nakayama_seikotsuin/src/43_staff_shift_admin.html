<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= head ?>
  <?!= commonJs ?>
  <?!= commonCss ?>
  <script>
    const baseUrl = "<?= baseUrl ?>";
  </script>
  <title>ğŸ—“ï¸ ã‚·ãƒ•ãƒˆè¨­å®š</title>
  <style>
    .weekday-checkboxes .form-check {
    min-width: 70px;
  }

  /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã‚‚ã€Œã‚¹ã‚¿ãƒƒãƒ•åã€ã ã‘å›ºå®š */
  .table-sticky { border-collapse: separate; border-spacing: 0; }

  /* è¦‹å‡ºã—ã®ã€Œã‚¹ã‚¿ãƒƒãƒ•åã€ã‚»ãƒ«ï¼ˆ1åˆ—ç›®ãƒ˜ãƒƒãƒ€ï¼‰ã‚’å›ºå®š */
  .table-sticky thead th:first-child {
    position: sticky;
    left: 0;
    z-index: 11;
    background-color: var(--bs-table-bg, #f8f9fa);
    background-clip: padding-box;
    box-shadow: 2px 0 0 rgba(0,0,0,.06);
  }

  /* æœ¬æ–‡1åˆ—ç›®ã‚’å›ºå®š */
  .table-sticky tbody td.sticky-staff {
    position: sticky;
    left: 0;
    z-index: 10; /* å‰é¢ã«å›ºå®š */
    background-color: var(--bs-table-bg, #fff); 
    background-clip: padding-box;
    min-width: 8rem;
    box-shadow: 2px 0 0 rgba(0,0,0,.04);
  }

  /* åŒã˜ã‚¹ã‚¿ãƒƒãƒ•ã®2è¡Œç›®ä»¥é™ã¯ä¸Šãƒœãƒ¼ãƒ€ãƒ¼æ¶ˆã—ã¦ä¸€ä½“åŒ– */
  .table-sticky tbody td.sticky-staff.is-continued {
    border-top-color: transparent !important;
  }

  /* ä»–ã‚»ãƒ«ã¯ä¸€æ®µä¸‹ã’ã¦è¡çªå›é¿ */
  .table-sticky th:not(:first-child),
  .table-sticky td:not(:first-child) {
    position: relative;
    z-index: 1;
  }

  </style>
</head>
<body class="container-fluid py-3 loading">
  <div id="loading" style="text-align:center; margin-top:50px;">
    <div class="auth-spinner"></div>
    <p>èªè¨¼ãƒã‚§ãƒƒã‚¯ä¸­...</p>
  </div>

  <div id="app" style="display:none;">
  <button type="button" class="btn btn-outline-secondary mb-2" onclick="goTo('20_staff_main_staff')">â† æˆ»ã‚‹</button>
  <h4 class="text-center mb-3">ğŸ—“ï¸ ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆè¨­å®š</h4>
  <div id="success-message" class="alert alert-success text-center" style="display: none;"></div>

  <div id="main-content">
    
    <!-- ğŸ§© ä¸€è¦§è¡¨ç¤º -->
    <h5>ğŸ“‹ ç™»éŒ²æ¸ˆã¿ã‚·ãƒ•ãƒˆå±¥æ­´</h5>
    <div class="table-wrapper mb-3">
      <div class="table-responsive">
        <table class="table table-bordered align-middle table-sticky">
          <thead class="table-light">
            <tr>
              <th>ã‚¹ã‚¿ãƒƒãƒ•å</th>
              <th>é–‹å§‹æ—¥</th>
              <th>é–‹å§‹æ™‚é–“</th>
              <th>çµ‚äº†æ™‚é–“</th>
              <th class="text-danger text-center">æ—¥</th>
              <th class="text-center">æœˆ</th>
              <th class="text-center">ç«</th>
              <th class="text-center">æ°´</th>
              <th class="text-center">æœ¨</th>
              <th class="text-center">é‡‘</th>
              <th class="text-primary text-center">åœŸ</th>
              <th>å‚™è€ƒ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- JSã§åŸ‹ã‚è¾¼ã¿ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ğŸ†• ï¼‹æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ -->
    <div class="form-wrapper mb-3">
      <button id="toggleNewShiftFormBtn" class="btn btn-primary w-100" type="button">
        ï¼‹ æ–°è¦ä½œæˆ
      </button>
    </div>

    <!-- ğŸ†• æ–°è¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="collapse" id="newShiftForm">
      
      <!-- ğŸŸ¢ å°ã•ãã¾ã¨ã‚ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ -->
      <div class="form-wrapper mb-3">
        <h5>æ–°è¦ã‚·ãƒ•ãƒˆç™»éŒ²</h5>
        <!-- âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="error-message" class="alert alert-danger text-center" style="display: none;"></div>

        <!-- ã‚¹ã‚¿ãƒƒãƒ•ï¼†é–‹å§‹æ—¥ -->
        <div class="mb-3">
          <label class="form-label">ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ</label>
          <select id="staffId" class="form-select">
            <option value="">ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸ“… é©ç”¨é–‹å§‹æ—¥</label>
          <input type="date" id="startDate" class="form-control">
        </div>

      </div>

      <!-- ğŸŸ¡ ãƒ†ãƒ¼ãƒ–ãƒ«ã¯åºƒã -->
      <div class="table-responsive px-2 mb-3">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>é–‹å§‹æ™‚é–“</th>
              <th>çµ‚äº†æ™‚é–“</th>
              <th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th>
              <th>å‚™è€ƒ</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="shiftTableBody">
            <!-- JSã§åŸ‹ã‚è¾¼ã¿ -->
          </tbody>
        </table>
        <p class="text-muted small mt-0">â€» ï¼‹ ã§è¡Œè¿½åŠ ã€ï¼ ã§å‰Šé™¤ã§ãã¾ã™</p>
      </div>

      <div class="form-wrapper d-grid gap-2">
        <button class="btn btn-primary" id="saveBtn">ç™»éŒ²</button>
      </div>
    </div>


  </div>

    
  <!-- ğŸ”„ åˆæœŸè¡¨ç¤ºãã‚‹ãã‚‹ -->
  <div id="global-spinner" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <p class="mt-3">ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦</p>
  </div>

  <!-- ğŸ”„ ä¿å­˜ä¸­ãã‚‹ãã‚‹ -->
  <div id="saving-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ç™»éŒ²ä¸­...</span>
    </div>
    <p class="mt-2">ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆã‚’ä¿å­˜ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  <!-- ğŸ”„ ä¿å­˜ä¸­ãã‚‹ãã‚‹ -->
  <div id="delete-spinner" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ç™»éŒ²ä¸­...</span>
    </div>
    <p class="mt-2">ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™â€¦</p>
  </div>

  <!-- âœ… ä¿å­˜ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="confirmSaveModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ç™»éŒ²ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="saveModalBody">
          å…¥åŠ›å†…å®¹ã‚’ç™»éŒ²ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-primary" id="confirm-save-btn">ç™»éŒ²</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="deleteModalBody">
          ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn">å‰Šé™¤ã™ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let shiftData = []; // å±¥æ­´ä¸€è¦§
    let staffList = []; // ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿
    let deleteTarget = {};
    let businessHours = [];
    let isEditMode = false;
    let oldStaffId = null;
    let oldStartDate = null;
    let originalLeaveData = null;
    const prefillDate = '<?= date ?>';

    document.addEventListener("DOMContentLoaded", () => {
      console.log("[CHILD] DOMContentLoaded â†’ child-ready ã‚’è¦ªã¸é€ä¿¡");
      try {
        window.top.postMessage(
          { type: "misemaru:child-ready", origin: location.origin },
          "*" // è¦ªå´ã§å¿…ãš event.origin ã‚’æ¤œè¨¼ã™ã‚‹ã®ã§å®‰å…¨
        );
      } catch (err) {
        console.error("[CHILD] child-ready é€ä¿¡å¤±æ•—:", err);
      }

      // åˆæœŸåŒ–å‡¦ç†ã¾ã¨ã‚
      initShiftTable();
      initFormToggle();

      // âœ… ãƒã‚¹ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰ prefill å‡¦ç†ã¸é€²ã‚€
      loadMasterData(() => {
        console.log("ğŸ“¦ ãƒã‚¹ã‚¿ãƒ¼èª­ã¿è¾¼ã¿å®Œäº†");

        if (prefillDate) {
          const collapseEl = document.getElementById("newShiftForm");
          if (collapseEl) {
            const collapse = bootstrap.Collapse.getOrCreateInstance(collapseEl);
            collapse.show();
            console.log("ğŸ“‚ ãƒ•ã‚©ãƒ¼ãƒ ã‚’å±•é–‹ã—ã¾ã—ãŸ");

            // âœ… ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆcollapseå®Œäº†å¾Œï¼‰
            setTimeout(() => {
              collapseEl.scrollIntoView({ behavior: "smooth", block: "start" });
              console.log("ğŸ§­ è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¾ã—ãŸ");
            }, 300); // collapse ãŒçµ‚ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«åˆã‚ã›ã‚‹
          }

          const dateInput = document.getElementById("startDate");
          if (dateInput) {
            dateInput.value = prefillDate;
            console.log("ğŸ–Šï¸ startDate ã«å€¤ã‚’ã‚»ãƒƒãƒˆ:", prefillDate);
            dateInput.dispatchEvent(new Event("change")); // ã“ã“ã§å–¶æ¥­è¨­å®šæç”»ã‚‚ã•ã‚Œã‚‹
          } else {
            console.warn("âš ï¸ startDate input ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
          }
        } else {
          console.log("â›” prefillDate ãŒç©ºã§ã™");
        }
      });
      setupInputChangeHandlerStaffShift();
    });




    // ãƒˆã‚°ãƒ«å‡¦ç†ã¾ã¨ã‚
    function initFormToggle() {
      const toggleBtn = document.getElementById("toggleNewShiftFormBtn");
      const formEl = document.getElementById("newShiftForm");
      const collapse = new bootstrap.Collapse(formEl, { toggle: false });

      toggleBtn.addEventListener("click", () => {
        const isVisible = formEl.classList.contains("show");
        if (isVisible) {
          collapse.hide();
          toggleBtn.textContent = "ï¼‹ æ–°è¦ä½œæˆ";
        } else {
          // âœ… æŠ¼ã—ãŸã¨ãã«ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
          clearForm();
          setNewModeSnapshot();
          isEditMode = false;
          document.getElementById("saveBtn").textContent = "ç™»éŒ²";
          initShiftTable();
          collapse.show();
          toggleBtn.textContent = "âˆ’ é–‰ã˜ã‚‹";
          setTimeout(() => {
            formEl.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 300);
        }
      });
    }


    function renderShiftTable(businessRows) {
      const tbody = document.getElementById("shiftTableBody");
      tbody.innerHTML = "";

      businessRows.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="time" class="form-control" name="start-${i}" value="${row.startTime}"></td>
          <td><input type="time" class="form-control" name="end-${i}" value="${row.endTime}"></td>
          ${["sun", "mon", "tue", "wed", "thu", "fri", "sat"].map(day => `
            <td class="text-center">
              <input class="form-check-input" type="checkbox" name="${day}-${i}" ${row.weekdays[day] ? "checked" : ""}>
            </td>
          `).join("")}
          <td><input type="text" class="form-control" name="note-${i}" value=""></td>
          <td>
            <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0" onclick="insertRow(${i})">ï¼‹</button>
            <button type="button" class="btn btn-outline-danger btn-sm px-2 py-0" onclick="deleteRow(this)">ï¼</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }


    // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ»å±¥æ­´ã®å–å¾—ã¾ã¨ã‚
    function loadMasterData(callback) {
      document.getElementById("main-content").style.display = "none";
      document.getElementById("global-spinner").style.display = "block";

      google.script.run.withSuccessHandler(({ staffList, shiftList, businessHourList }) => {
        businessHours = businessHourList;
        renderStaffOptions(staffList);
        renderHistory(shiftList);

        document.getElementById("global-spinner").style.display = "none";
        document.getElementById("main-content").style.display = "block";

        // âœ… ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°å®Ÿè¡Œ
        if (typeof callback === "function") {
          callback();
        }
      }).getInitialStaffSchedule();
    }


    document.getElementById("startDate").addEventListener("change", () => {
      const dateStr = document.getElementById("startDate").value;
      if (!dateStr) return;

      const businessRows = getBusinessHoursForDateFromCache(dateStr);
      renderShiftTable(businessRows);  // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–¢æ•°
    });



    // âœ… ç™»éŒ²ãƒœã‚¿ãƒ³ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    document.getElementById("saveBtn").addEventListener("click", () => {
      const staffId = document.getElementById("staffId").value;
      const staffName = staffList.find(s => s.id === staffId)?.name || "";
      const startDate = document.getElementById("startDate").value;

      if (!staffId || !startDate) {
        showMessage("âš  ã‚¹ã‚¿ãƒƒãƒ•ãƒ»é–‹å§‹æ—¥ã¯å¿…é ˆã§ã™", true);
        return;
      }

      // âœ… æ–‡è¨€åˆ‡æ›¿
      const actionText = isEditMode ? "æ›´æ–°" : "ç™»éŒ²";

      document.getElementById("saveModalBody").innerHTML =
        `ã‚¹ã‚¿ãƒƒãƒ•ï¼š<strong>${staffName}</strong><br>é©ç”¨é–‹å§‹æ—¥ï¼š<strong>${startDate}</strong><br><br>ã“ã®å†…å®¹ã§<strong>${actionText}</strong>ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

      document.querySelector("#confirmSaveModal .modal-title").textContent = `${actionText}ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
      document.getElementById("confirm-save-btn").textContent = actionText;

      const modal = new bootstrap.Modal(document.getElementById("confirmSaveModal"));
      modal.show();
    });


    // âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ä¿å­˜ç¢ºå®š
    document.getElementById("confirm-save-btn").addEventListener("click", () => {
      const staffId = document.getElementById("staffId").value;
      const startDate = document.getElementById("startDate").value;

      // âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ rows ã‚’ä½œã‚‹
      const rows = [];
      const tbody = document.getElementById("shiftTableBody");
      [...tbody.querySelectorAll("tr")].forEach((tr, i) => {
        const start = tr.querySelector(`input[name="start-${i}"]`).value;
        const end = tr.querySelector(`input[name="end-${i}"]`).value;
        const note = tr.querySelector(`input[name="note-${i}"]`).value;

        const weekdays = {};
        ["sun", "mon", "tue", "wed", "thu", "fri", "sat"].forEach(day => {
          weekdays[day] = tr.querySelector(`input[name="${day}-${i}"]`).checked;
        });

        rows.push({
          start,
          end,
          type: "å‡ºå‹¤",  // ç¨®é¡ã¯å›ºå®šã€Œå‡ºå‹¤ã€
          note,
          ...weekdays
        });
      });

      // âœ… é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã¾ã¨ã‚
      const payload = {
        staffId,
        startDate,
        oldStaffId,
        oldStartDate,
        rows: rows,
      };

      if (!validateSafeInputs(payload)) {
        alert("âŒ å…¥åŠ›å†…å®¹ã«ä¸æ­£ãªã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
        return;
      }

      const modal = bootstrap.Modal.getInstance(document.getElementById("confirmSaveModal"));
      modal.hide();

      document.getElementById("main-content").style.display = "none";
      const savingSpinner = document.getElementById("saving-spinner");
      savingSpinner.querySelector("p").textContent = isEditMode
        ? "ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆã‚’æ›´æ–°ã—ã¦ã„ã¾ã™â€¦"
        : "ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆã‚’ä¿å­˜ã—ã¦ã„ã¾ã™â€¦";
      savingSpinner.style.display = "block";

      // âœ… ç™»éŒ²

      
      google.script.run
        .withSuccessHandler(() => {
          clearForm();
          setNewModeSnapshot();
          google.script.run.withSuccessHandler(history => {
            renderHistory(history);
            setTimeout(() => {
              document.getElementById("saving-spinner").style.display = "none";
              document.getElementById("main-content").style.display = "block";
              showMessage(`âœ… ${isEditMode ? "æ›´æ–°" : "ç™»éŒ²"}å®Œäº†ï¼`);

              // âœ… prefillDate ãŒã‚ã‚‹ãªã‚‰ãƒ•ã‚©ãƒ¼ãƒ å†è¡¨ç¤ºï¼†æ—¥ä»˜å†ã‚»ãƒƒãƒˆ
              if (prefillDate) {
                const formEl = document.getElementById("newShiftForm");
                const collapse = bootstrap.Collapse.getInstance(formEl) || new bootstrap.Collapse(formEl, { toggle: false });
                collapse.show();

                const dateInput = document.getElementById("startDate");
                dateInput.value = prefillDate;
                dateInput.dispatchEvent(new Event("change"));

                setTimeout(() => {
                  formEl.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 300);
              } else {
                // é€šå¸¸é€šã‚Šé–‰ã˜ã‚‹
                const formEl = document.getElementById("newShiftForm");
                const collapse = bootstrap.Collapse.getInstance(formEl) || new bootstrap.Collapse(formEl, { toggle: false });
                collapse.hide();
                document.getElementById("toggleNewShiftFormBtn").textContent = "ï¼‹ æ–°è¦ä½œæˆ";
              }
            }, 50);
          }).getStaffSchedule();
        })
        .withFailureHandler(e => {
          document.getElementById("saving-spinner").style.display = "none";
          document.getElementById("main-content").style.display = "block";
          showMessage("âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š" + e.message, true);
        })
        .saveStaffSchedule(payload);
    });


    // âœ… å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆä¸€è¦§ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
    function deleteShift(staffId, startDate) {
      deleteTarget = { staffId, startDate };
      const staffName = staffList.find(s => s.id === staffId)?.name || "";

      document.getElementById("deleteModalBody").innerHTML =
        `ã‚¹ã‚¿ãƒƒãƒ•ï¼š<strong>${staffName}</strong><br>é©ç”¨é–‹å§‹æ—¥ï¼š<strong>${startDate}</strong><br><br>ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

      const modal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
      modal.show();
    }

    document.getElementById("confirm-delete-btn").addEventListener("click", () => {
      const { staffId, startDate } = deleteTarget;
      const modal = bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal"));
      modal.hide();

      // ğŸ”„ ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤º
      document.getElementById("main-content").style.display = "none";
      document.getElementById("delete-spinner").style.display = "block";

      google.script.run
      .withSuccessHandler(() => {
        // âœ… å‰Šé™¤æˆåŠŸ â†’ å†å–å¾—
        google.script.run.withSuccessHandler(history => {
          renderHistory(history);
          setTimeout(() => {
            document.getElementById("delete-spinner").style.display = "none";
            document.getElementById("main-content").style.display = "block";
            showMessage("ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ");
          }, 50);
        }).getStaffSchedule();
      })
      .withFailureHandler(e => {
        showMessage("âŒ å‰Šé™¤å¤±æ•—ï¼š" + e.message, true);
        document.getElementById("delete-spinner").style.display = "none";
        document.getElementById("main-content").style.display = "block";
      })
      .deleteStaffSchedule(staffId, startDate);

    });

    // âœ… å±¥æ­´è¡¨ç¤º
    function renderHistory(data) {
      shiftData = data;
      const tbody = document.getElementById("historyTableBody");
      tbody.innerHTML = "";

      const grouped = {};
      data.forEach(item => {
        const key = `${item.startDate}_${item.staffId}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(item);
      });

      let colorToggle = false;

      Object.keys(grouped).forEach(groupKey => {
        const rows = grouped[groupKey];
        const rowspan = rows.length;
        const rowClass = colorToggle ? "table-light" : "";

        rows.forEach((item, idx) => {
          const tr = document.createElement("tr");
          tr.className = rowClass;

          const days = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"].map(d =>
            item.weekdays[d] ? "âœ…" : "ä¼‘"
          );

          tr.innerHTML = `
            <td class="sticky-staff ${idx > 0 ? 'is-continued' : ''}">
              ${idx === 0 ? item.staffName : ""}
            </td>
            <td ${idx > 0 ? 'is-continued' : ''}">
              ${idx === 0 ? item.startDate : ""}
            </td>
            <td>${item.startTime}</td>
            <td>${item.endTime}</td>
            <td class="text-center">${days[0]}</td>
            <td class="text-center">${days[1]}</td>
            <td class="text-center">${days[2]}</td>
            <td class="text-center">${days[3]}</td>
            <td class="text-center">${days[4]}</td>
            <td class="text-center">${days[5]}</td>
            <td class="text-center">${days[6]}</td>
            <td>${item.note || ""}</td>
            ${idx === 0 ? `
              <td rowspan="${rowspan}">
                <button class="btn btn-sm btn-warning me-1" onclick="editShift('${item.startDate}', '${item.staffId}')">ç·¨é›†</button>
                <button class="btn btn-sm btn-danger" onclick="deleteShift('${item.staffId}', '${item.startDate}')">å‰Šé™¤</button>
              </td>
            ` : ""}
          `;
          tbody.appendChild(tr);
        });

        colorToggle = !colorToggle;
      });
    }

    function getBusinessHoursForDateFromCache(dateStr) {
      const targetYmd = dateStr;

      const applicable = businessHours
        .filter(row => row.applyDate <= targetYmd)
        .sort((a, b) => b.applyDate.localeCompare(a.applyDate));

      if (!applicable.length) return [];

      const latestApplyDate = applicable[0].applyDate;

      return businessHours
        .filter(row => row.applyDate === latestApplyDate)
        .filter(row => row.type === "å–¶æ¥­");
    }


    function editShift(startDate, staffId) {
      isEditMode = true;
      document.getElementById("saveBtn").textContent = "æ›´æ–°";

      oldStaffId = staffId;
      oldStartDate = startDate;

      const targetRows = shiftData.filter(row => row.startDate === startDate && row.staffId === staffId);
      if (!targetRows.length) {
        alert("è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return;
      }

      document.getElementById("staffId").value = targetRows[0].staffId;
      document.getElementById("startDate").value = targetRows[0].startDate;

      const tbody = document.getElementById("shiftTableBody");
      tbody.innerHTML = "";

      targetRows.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="time" class="form-control" name="start-${i}" value="${row.startTime}"></td>
          <td><input type="time" class="form-control" name="end-${i}" value="${row.endTime}"></td>
          ${["sun", "mon", "tue", "wed", "thu", "fri", "sat"].map(d => `
            <td class="text-center">
              <input class="form-check-input" type="checkbox" name="${d}-${i}" ${row.weekdays[d] ? "checked" : ""}>
            </td>
          `).join("")}
          <td><input type="text" class="form-control" name="note-${i}" value="${row.note || ""}"></td>
          <td>
            <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0" onclick="insertRow(${i})">ï¼‹</button>
            <button type="button" class="btn btn-outline-danger btn-sm px-2 py-0" onclick="deleteRow(this)">ï¼</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // é–‹ã
      const formEl = document.getElementById("newShiftForm");
      const collapse = bootstrap.Collapse.getInstance(formEl) || new bootstrap.Collapse(formEl, { toggle: false });
      collapse.show();
        setTimeout(() => {
          formEl.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      afterEditShiftHookForSnapshot();
    }

    // âœ… ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
    function clearForm() {
      document.getElementById("staffId").value = "";
      document.getElementById("startDate").value = "";
      const tbody = document.getElementById("shiftTableBody");
      tbody.innerHTML = "";  // â† ã‚·ãƒ•ãƒˆåˆæœŸåŒ–
    }


    // âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(msg, isError = false) {
      const success = document.getElementById("success-message");
      const error = document.getElementById("error-message");
      success.style.display = "none";
      error.style.display = "none";

      const target = isError ? error : success;
      target.textContent = msg;
      target.style.display = "block";
      setTimeout(() => (target.style.display = "none"), 4000);
    }

    function renderStaffOptions(data) {
      const select = document.getElementById("staffId");
      staffList = data;

      // åˆæœŸåŒ–ï¼ˆã„ã£ãŸã‚“ç©ºã«ã™ã‚‹ï¼‰
      select.innerHTML = '<option value="">ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

      // ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã‚’è¿½åŠ 
      data.forEach(staff => {
        const opt = document.createElement("option");
        opt.value = staff.id;
        opt.textContent = `${staff.id}ï¼š${staff.name}`;
        select.appendChild(opt);
      });
    }

    function createShiftRow(index) {
      const days = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];

      let dayCheckboxes = days.map(d => `
        <td class="text-center">
          <input class="form-check-input" type="checkbox" name="${d}-${index}">
        </td>
      `).join("");

      return `
        <tr>
          <td><input type="time" class="form-control" name="start-${index}"></td>
          <td><input type="time" class="form-control" name="end-${index}"></td>
          ${dayCheckboxes}
          <td><input type="text" class="form-control" name="note-${index}"></td>
          <td>
            <button type="button" class="btn btn-outline-secondary btn-sm px-2 py-0" onclick="insertRow(${index})">ï¼‹</button>
            <button type="button" class="btn btn-outline-danger btn-sm px-2 py-0" onclick="deleteRow(this)">ï¼</button>
          </td>
        </tr>
      `;
    }

    function insertRow(position) {
      const tbody = document.getElementById("shiftTableBody");
      const newRow = document.createElement("tr");
      const rowIndex = tbody.children.length;
      newRow.innerHTML = createShiftRow(rowIndex);
      tbody.insertBefore(newRow, tbody.children[position + 1] || null);
      notifyFormMutated();
    }

    function deleteRow(button) {
      const row = button.closest("tr");
      const tbody = document.getElementById("shiftTableBody");
      tbody.removeChild(row);
      notifyFormMutated();
    }

    function initShiftTable() {
      const tbody = document.getElementById("shiftTableBody");
      tbody.innerHTML = "";
      insertRow(-1);
    }

  // ===== 1) ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆç¾åœ¨å€¤ï¼‰ä½œæˆ =====
  function serializeCurrentShiftForm() {
    const staffId = document.getElementById("staffId")?.value || "";
    const startDate = document.getElementById("startDate")?.value || "";

    const tbody = document.getElementById("shiftTableBody");
    const rows = [];
    [...tbody.querySelectorAll("tr")].forEach((tr, i) => {
      const start = tr.querySelector(`input[name="start-${i}"]`)?.value || "";
      const end   = tr.querySelector(`input[name="end-${i}"]`)?.value || "";
      const note  = tr.querySelector(`input[name="note-${i}"]`)?.value?.trim() || "";

      const weekdays = {};
      ["sun","mon","tue","wed","thu","fri","sat"].forEach(d=>{
        weekdays[d] = !!tr.querySelector(`input[name="${d}-${i}"]`)?.checked;
      });

      rows.push({ start, end, weekdays, note });
    });

    // ä¸¦ã³é †ã«ã‚ˆã‚‹ãƒ–ãƒ¬ã‚’æ¸›ã‚‰ã™ãŸã‚ã€å®‰å®šã‚­ãƒ¼ã§ã‚½ãƒ¼ãƒˆã—ã¦ãŠã
    const sorted = rows.slice().sort((a,b)=>{
      const ka = `${a.start}|${a.end}|${["sun","mon","tue","wed","thu","fri","sat"].map(d=>a.weekdays[d]?"1":"0").join("")}|${a.note}`;
      const kb = `${b.start}|${b.end}|${["sun","mon","tue","wed","thu","fri","sat"].map(d=>b.weekdays[d]?"1":"0").join("")}|${b.note}`;
      return ka.localeCompare(kb);
    });

    return { staffId, startDate, rows: sorted };
  }

  // æ·±ã„æ¯”è¼ƒï¼ˆJSONåŒ–ã§ååˆ†ï¼‰
  function isEqualSnapshot(a, b) {
    return JSON.stringify(a) === JSON.stringify(b);
  }

  // ===== 2) å¤‰æ›´ç›£è¦–ã¨ãƒœã‚¿ãƒ³æ´»æ€§/éæ´»æ€§åˆ¶å¾¡ =====
  function setupInputChangeHandlerStaffShift() {
    const formEl = document.getElementById("newShiftForm");
    const saveBtn = document.getElementById("saveBtn");
    if (!formEl || !saveBtn) return;

    const update = () => {
      // æ–°è¦ã®ã¨ãã¯ originalLeaveData=null ãŒè‡ªç„¶
      if (!originalLeaveData) {
        const cur = serializeCurrentShiftForm();
        // å¿…é ˆ: staffId, startDate ã¨ã€æœ€ä½1è¡Œã§é–‹å§‹/çµ‚äº†/æ›œæ—¥ã®ã„ãšã‚Œã‹å…¥åŠ›ãŒã‚ã‚‹ã‹
        const hasAnyRowFilled = (cur.rows || []).some(r =>
          r.start || r.end || Object.values(r.weekdays).some(Boolean) || r.note
        );
        saveBtn.disabled = !(cur.staffId && cur.startDate && hasAnyRowFilled);
      } else {
        // ç·¨é›†ã®ã¨ãã¯å®Œå…¨å·®åˆ†æ¯”è¼ƒã§OK
        const cur = serializeCurrentShiftForm();
        saveBtn.disabled = isEqualSnapshot(cur, originalLeaveData);
      }
    };

    // å…¥åŠ›å…¨èˆ¬ï¼ˆå‹•çš„è¿½åŠ ã—ãŸè¡Œã«ã‚‚åŠ¹ãã‚ˆã†ã«ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒªã‚²ãƒ¼ãƒˆï¼‰
    formEl.addEventListener("input", update);
    formEl.addEventListener("change", update);

    // åˆæœŸçŠ¶æ…‹ã‚‚è©•ä¾¡
    update();
  }

  // ===== 3) è¡Œè¿½åŠ /å‰Šé™¤ã®æœ€å¾Œã«ã‚»ãƒ¼ãƒ–çŠ¶æ…‹å†è©•ä¾¡ =====
  function notifyFormMutated() {
    const formEl = document.getElementById("newShiftForm");
    // ã¾ã¨ã‚ã¦1å›ã ã‘çŠ¶æ…‹æ›´æ–°ï¼ˆinputã‚¤ãƒ™ãƒ³ãƒˆã‚’è‡ªç™ºçš„ã«é£›ã°ã™ï¼‰
    if (formEl) formEl.dispatchEvent(new Event("input", { bubbles: true }));
  }

  // ===== 4) â€œå…ƒãƒ‡ãƒ¼ã‚¿â€ã®ã‚»ãƒƒãƒˆç®‡æ‰€ =====
  // - æ–°è¦é–‹å§‹æ™‚: originalLeaveData = null;ï¼ˆsaveBtnã¯ä¸Šã®ãƒ­ã‚¸ãƒƒã‚¯ã§åˆ¶å¾¡ï¼‰
  // - ç·¨é›†é–‹å§‹ç›´å¾Œï¼ˆeditShift ã®æœ«å°¾ï¼‰: ç¾åœ¨æç”»æ¸ˆã¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã—ã¦æ ¼ç´

  // â˜… editShift ã®æœ€å¾Œã«è¿½åŠ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å±•é–‹ï¼†ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ç›´å¾Œã‚ãŸã‚Šï¼‰
  function afterEditShiftHookForSnapshot(){
    // å°‘ã—é…å»¶ã—ã¦DOMåæ˜ å¾Œã«æ’®ã‚‹
    setTimeout(()=>{
      originalLeaveData = serializeCurrentShiftForm();
      notifyFormMutated(); // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’å³åæ˜ 
    }, 0);
  }

  // â˜… æ–°è¦ä½œæˆã‚’é–‹ã„ãŸç›´å¾Œã¯ â€œæ–°è¦ãƒ¢ãƒ¼ãƒ‰â€ ã¨ã—ã¦å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ç ´æ£„
  function setNewModeSnapshot() {
    originalLeaveData = null;
    notifyFormMutated();
  }

  function hasFormChangedStaffShift() {
    if (!originalLeaveData) {
      const cur = serializeCurrentShiftForm();
      const hasAnyRowFilled = (cur.rows || []).some(r =>
        r.start || r.end || Object.values(r.weekdays).some(Boolean) || r.note
      );
      return !!(cur.staffId && cur.startDate && hasAnyRowFilled);
    }
    return !isEqualSnapshot(serializeCurrentShiftForm(), originalLeaveData);
  }

  </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
